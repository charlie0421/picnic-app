workflows:
  # =================== PICNIC APP iOS ===================
  picnic-app-ios:
    name: Picnic App - iOS
    instance_type: mac_mini_m2
    max_build_duration: 120
    integrations:
      app_store_connect: codemagic-picnic
    environment:
      ios_signing:
        distribution_type: app_store
        bundle_identifier: io.iconcasting.picnic.app
      groups:
        - app_store_connect
        - shorebird-config
        - picnic_env
      flutter: 3.32.4
      vars:
        APP_NAME: "picnic_app"
        BUNDLE_ID: "io.iconcasting.picnic.app"
    cache:
      cache_paths:
        - $FLUTTER_ROOT/.pub-cache
        - $HOME/.gradle/caches
        - $HOME/Library/Caches/CocoaPods
    triggering:
      events:
        - push
        - tag
      branch_patterns:
        - pattern: 'main'
          include: true
        - pattern: 'production'
          include: true
      tag_patterns:
        - pattern: 'picnic-v*'
          include: true
      cancel_previous_builds: true
    scripts:
      - name: Get Flutter packages and prepare iOS
        script: |
          cd picnic_app
          echo "=== Flutter íŒ¨í‚¤ì§€ ì„¤ì¹˜ ==="
          flutter packages pub get
          
          echo "=== Flutter iOS ì„¤ì • ìƒì„± (Generated.xcconfig íŒŒì¼ ìƒì„±) ==="
          flutter precache --ios
          flutter build ios --config-only
          
          echo "=== Generated.xcconfig íŒŒì¼ í™•ì¸ ==="
          ls -la ios/Flutter/Generated.xcconfig || echo "âš ï¸ Generated.xcconfig íŒŒì¼ì´ ì•„ì§ ìƒì„±ë˜ì§€ ì•ŠìŒ"

      - name: Install CocoaPods dependencies
        script: |
          cd picnic_app
          
          echo "=== Generated.xcconfig íŒŒì¼ í™•ì¸ ==="
          if [ ! -f "ios/Flutter/Generated.xcconfig" ]; then
            echo "âš ï¸ Generated.xcconfig íŒŒì¼ì´ ì—†ìŒ - Flutter ì„¤ì • ì¬ìƒì„±"
            flutter build ios --config-only
          fi
          
          echo "âœ… Generated.xcconfig íŒŒì¼ ì¡´ì¬ í™•ì¸:"
          ls -la ios/Flutter/Generated.xcconfig
          
          echo "=== CocoaPods ì„¤ì¹˜ ì‹œì‘ ==="
          cd ios
          pod install

      - name: Install Shorebird CLI
        script: |
          echo "=== Shorebird CLI ì„¤ì¹˜ ì‹œì‘ ==="
          
          # ê¸°ì¡´ Shorebird ì„¤ì¹˜ ê°•ì œ ì œê±° (ì¶©ëŒ ë°©ì§€)
          echo "ğŸ§¹ ê¸°ì¡´ Shorebird ì„¤ì¹˜ ì •ë¦¬ ì¤‘..."
          if [ -d "$HOME/.shorebird" ]; then
            rm -rf "$HOME/.shorebird"
            echo "âœ… ê¸°ì¡´ Shorebird ë””ë ‰í† ë¦¬ ì œê±° ì™„ë£Œ"
          fi
          
          # ìµœì‹  ì•ˆì • ë²„ì „ ì‚¬ìš© (v1.6.48)
          echo "ğŸ”§ Shorebird v1.6.48 ìµœì‹  ì•ˆì • ë²„ì „ ì„¤ì¹˜ ì¤‘..."
          
          # ê³µì‹ GitHub ì„¤ì¹˜ ìŠ¤í¬ë¦½íŠ¸ ì‚¬ìš© (ê°€ì¥ ì•ˆì •ì )
          echo "ğŸ“¥ ê³µì‹ ì„¤ì¹˜ ìŠ¤í¬ë¦½íŠ¸ë¡œ ìµœì‹  Shorebird ì„¤ì¹˜..."
          curl --proto '=https' --tlsv1.2 https://raw.githubusercontent.com/shorebirdtech/install/main/install.sh -sSf | bash
          
          export PATH="$HOME/.shorebird/bin:$PATH"
          
          echo "=== Shorebird ì„¤ì¹˜ í™•ì¸ ==="
          if command -v shorebird >/dev/null 2>&1; then
            shorebird --version
            echo "âœ… Shorebird ì„¤ì¹˜ ë° ì„¤ì • ì™„ë£Œ"
          else
            echo "âŒ Shorebird ì„¤ì¹˜ ì‹¤íŒ¨"
            exit 1
          fi

      - name: Verify iOS Signing Configuration
        script: |
          echo "=== iOS ì„œëª… í™˜ê²½ í™•ì¸ ==="
          echo "DEVELOPMENT_TEAM: ${DEVELOPMENT_TEAM:-'24SL34R9HR'}"
          
          # Distribution Certificate ì •ë³´ í™•ì¸
          DIST_CERT_INFO=$(security find-identity -v -p codesigning | grep -i distribution | head -1)
          if [ -n "$DIST_CERT_INFO" ]; then
            echo "âœ… Distribution ì¸ì¦ì„œ: $DIST_CERT_INFO"
          else
            echo "âŒ Distribution ì¸ì¦ì„œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ"
            echo "ì‚¬ìš© ê°€ëŠ¥í•œ ì¸ì¦ì„œë“¤:"
            security find-identity -v -p codesigning
            exit 1
          fi
          
          # Provisioning Profile ì •ë³´ í™•ì¸
          PROFILE_COUNT=$(find "$HOME/Library/MobileDevice/Provisioning Profiles" -name "*.mobileprovision" 2>/dev/null | wc -l)
          echo "ì„¤ì¹˜ëœ í”„ë¡œë¹„ì €ë‹ í”„ë¡œíŒŒì¼ ê°œìˆ˜: $PROFILE_COUNTê°œ"
          
          if [ "$PROFILE_COUNT" -gt 0 ]; then
            echo "âœ… í”„ë¡œë¹„ì €ë‹ í”„ë¡œíŒŒì¼ ëª©ë¡:"
            find "$HOME/Library/MobileDevice/Provisioning Profiles" -name "*.mobileprovision" 2>/dev/null | while read profile; do
              PROFILE_NAME=$(security cms -D -i "$profile" 2>/dev/null | grep -A1 "<key>Name</key>" | tail -1 | sed 's/.*<string>\(.*\)<\/string>.*/\1/' | tr -d '\n')
              echo "  - $(basename "$profile" .mobileprovision): $PROFILE_NAME"
              
              # í”„ë¡œë¹„ì €ë‹ í”„ë¡œíŒŒì¼ì˜ Entitlements í™•ì¸
              if [[ "$PROFILE_NAME" == *"picnic"* ]]; then
                echo "    ğŸ” Picnic í”„ë¡œíŒŒì¼ Entitlements í™•ì¸ ì¤‘..."
                ENTITLEMENTS=$(security cms -D -i "$profile" 2>/dev/null | grep -A 20 "<key>Entitlements</key>" | grep -E "(aps-environment|com.apple.developer.associated-domains|com.apple.developer.applesignin)")
                if [ -n "$ENTITLEMENTS" ]; then
                  echo "    âœ… í•„ìš”í•œ Entitlements ë°œê²¬:"
                  echo "$ENTITLEMENTS" | head -5
                else
                  echo "    âš ï¸ í•„ìš”í•œ Entitlementsê°€ ëˆ„ë½ë¨ (Associated Domains, Push Notifications, Sign in with Apple)"
                fi
              fi
            done
          else
            echo "âŒ í”„ë¡œë¹„ì €ë‹ í”„ë¡œíŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŒ"
            exit 1
          fi

      - name: Configure Xcode Project Signing Strategy
        script: |
          cd picnic_app/ios
          
          echo "=== Xcode í”„ë¡œì íŠ¸ Manual Distribution Signing ì„¤ì • ==="
          
          # Manual Signing ê°•ì œ ì„¤ì • (CodeMagic Integration ì‚¬ìš©)
          echo "ğŸ“ Manual Distribution Signing í™œì„±í™”..."
          sed -i '' "s/CODE_SIGN_STYLE = Automatic;/CODE_SIGN_STYLE = Manual;/g" Runner.xcodeproj/project.pbxproj
          sed -i '' "s/CODE_SIGN_STYLE = \"\";/CODE_SIGN_STYLE = Manual;/g" Runner.xcodeproj/project.pbxproj
          
          # Development Team ì„¤ì • (í•„ìˆ˜)
          sed -i '' "s/DEVELOPMENT_TEAM = \"\";/DEVELOPMENT_TEAM = \"24SL34R9HR\";/g" Runner.xcodeproj/project.pbxproj
          sed -i '' "s/DEVELOPMENT_TEAM = 24SL34R9HR;/DEVELOPMENT_TEAM = \"24SL34R9HR\";/g" Runner.xcodeproj/project.pbxproj
          
          # Distribution ì¸ì¦ì„œ ë° í”„ë¡œíŒŒì¼ ê°•ì œ ì„¤ì •
          echo "ğŸ“ Distribution ì¸ì¦ì„œ ë° í”„ë¡œíŒŒì¼ ê°•ì œ ì„¤ì •..."
          sed -i '' "s/CODE_SIGN_IDENTITY = \"\"/CODE_SIGN_IDENTITY = \"Apple Distribution\"/g" Runner.xcodeproj/project.pbxproj
          sed -i '' "s/CODE_SIGN_IDENTITY = \"Apple Development\"/CODE_SIGN_IDENTITY = \"Apple Distribution\"/g" Runner.xcodeproj/project.pbxproj
          sed -i '' "s/\"CODE_SIGN_IDENTITY\[sdk=iphoneos\*\]\" = \"iPhone Developer\"/\"CODE_SIGN_IDENTITY[sdk=iphoneos*]\" = \"Apple Distribution\"/g" Runner.xcodeproj/project.pbxproj
          
          # í”„ë¡œë¹„ì €ë‹ í”„ë¡œíŒŒì¼ ì„¤ì • (ì„±ê³µí–ˆë˜ ì„¤ì •)
          sed -i '' "s/PROVISIONING_PROFILE_SPECIFIER = \"\"/PROVISIONING_PROFILE_SPECIFIER = \"picnic_app_profile_2025\"/g" Runner.xcodeproj/project.pbxproj
          
          # PROVISIONING_PROFILE_SPECIFIER ì¶”ê°€ (ì¡´ì¬í•˜ì§€ ì•ŠëŠ” ê²½ìš°)
          if ! grep -q "PROVISIONING_PROFILE_SPECIFIER" Runner.xcodeproj/project.pbxproj; then
            sed -i '' '/DEVELOPMENT_TEAM = /a\
                PROVISIONING_PROFILE_SPECIFIER = "picnic_app_profile_2025";' Runner.xcodeproj/project.pbxproj
          fi
          
          # Archive ë¹Œë“œê°€ Release êµ¬ì„±ì„ ì‚¬ìš©í•˜ë„ë¡ ê°•ì œ
          if [ -f "Runner.xcodeproj/xcshareddata/xcschemes/Runner.xcscheme" ]; then
            echo "ğŸ“ Archive ìŠ¤í‚´ Release êµ¬ì„± ê°•ì œ..."
            sed -i '' 's/buildConfiguration = \"Debug\"/buildConfiguration = \"Release\"/g' Runner.xcodeproj/xcshareddata/xcschemes/Runner.xcscheme
          fi
          
          # Development ê´€ë ¨ ì„¤ì • ì™„ì „ ì œê±°
          sed -i '' "/CODE_SIGN_IDENTITY.*=.*iPhone Developer/d" Runner.xcodeproj/project.pbxproj
          sed -i '' "/CODE_SIGN_IDENTITY.*=.*Apple Development/d" Runner.xcodeproj/project.pbxproj
          sed -i '' "/PROVISIONING_PROFILE_SPECIFIER.*=.*Development/d" Runner.xcodeproj/project.pbxproj
          
          # ì¶”ê°€ ê°•ë ¥ ì„¤ì • - perlì„ ì‚¬ìš©í•œ ë” ì •í™•í•œ ì¹˜í™˜
          echo "ğŸ“ ì¶”ê°€ ê°•ë ¥ ì„¤ì • ì ìš©..."
          perl -i -pe 's/CODE_SIGN_STYLE = Automatic;/CODE_SIGN_STYLE = Manual;/g' Runner.xcodeproj/project.pbxproj
          perl -i -pe 's/CODE_SIGN_STYLE = "Automatic";/CODE_SIGN_STYLE = Manual;/g' Runner.xcodeproj/project.pbxproj
          perl -i -pe 's/CODE_SIGN_IDENTITY = "";/CODE_SIGN_IDENTITY = "Apple Distribution";/g' Runner.xcodeproj/project.pbxproj
          perl -i -pe 's/PROVISIONING_PROFILE_SPECIFIER = "";/PROVISIONING_PROFILE_SPECIFIER = "picnic_app_profile_2025";/g' Runner.xcodeproj/project.pbxproj
          perl -i -pe 's/PROVISIONING_PROFILE_SPECIFIER = "match AppStore.*";/PROVISIONING_PROFILE_SPECIFIER = "picnic_app_profile_2025";/g' Runner.xcodeproj/project.pbxproj
          
          # Debug êµ¬ì„±ë„ Manualë¡œ ë³€ê²½ (í˜¹ì‹œ ëª¨ë¥¼ ê²½ìš°ë¥¼ ìœ„í•´)
          perl -i -pe '/Debug.*= {/,/};/{
            s/CODE_SIGN_STYLE = Automatic;/CODE_SIGN_STYLE = Manual;/g;
            s/CODE_SIGN_IDENTITY = "";/CODE_SIGN_IDENTITY = "Apple Distribution";/g;
          }' Runner.xcodeproj/project.pbxproj
          
          echo "ğŸ“‹ ì„¤ì • í›„ í™•ì¸:"
          grep -n "CODE_SIGN_STYLE\|Apple Distribution\|picnic_app_profile_2025" Runner.xcodeproj/project.pbxproj | head -10
          
          echo "âœ… Manual Distribution Signing ê°•ë ¥ ì„¤ì • ì™„ë£Œ"
          echo "- CODE_SIGN_STYLE: Manual (ê°•ì œ)"
          echo "- DEVELOPMENT_TEAM: 24SL34R9HR"
          echo "- CODE_SIGN_IDENTITY: Apple Distribution (ê°•ì œ)"
          echo "- PROVISIONING_PROFILE_SPECIFIER: picnic_app_profile_2025 (ì„±ê³µí–ˆë˜ ì„¤ì •)"

      - name: Shorebird iOS Release (Unified Build & Deploy)
        script: |
          export PATH="$HOME/.shorebird/bin:$PATH"
          cd picnic_app

          echo "=== Shorebird í†µí•© iOS ë¹Œë“œ & ë¦´ë¦¬ì¦ˆ ì‹œì‘ ==="
          echo "ğŸ¯ ë¦´ë¦¬ì¦ˆì™€ íŒ¨ì¹˜ì˜ ì¼ê´€ëœ ë¹Œë“œ í™˜ê²½ì„ ìœ„í•´ Shorebirdë¡œ ì§ì ‘ ë¹Œë“œí•©ë‹ˆë‹¤"
          echo ""

          echo "=== Shorebird ë²„ì „ í™•ì¸ ==="
          shorebird --version

          echo "=== Shorebird ì¸ì¦ í™•ì¸ ==="
          if [ -z "$SHOREBIRD_TOKEN" ]; then
            echo "âŒ SHOREBIRD_TOKEN í™˜ê²½ë³€ìˆ˜ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤"
            exit 1
          else
            echo "âœ… SHOREBIRD_TOKEN í™˜ê²½ë³€ìˆ˜ê°€ ì„¤ì •ë˜ì—ˆìŠµë‹ˆë‹¤"
          fi

          echo "=== iOS ì„œëª… í™˜ê²½ ìµœì¢… í™•ì¸ ==="
          echo "âœ… Manual Distribution Signing ì„¤ì • ì™„ë£Œ"
          echo "âœ… Bundle ID: io.iconcasting.picnic.app"
          echo "âœ… Distribution Type: App Store"
          echo "âœ… Development Team: 24SL34R9HR"
          echo "âœ… CODE_SIGN_IDENTITY: Apple Distribution"
          echo "âœ… PROVISIONING_PROFILE_SPECIFIER: picnic_app_profile_2025"

          echo "=== Shorebird ìºì‹œ ì •ë¦¬ ë° í™˜ê²½ ì¤€ë¹„ ==="
          shorebird cache clean
          flutter clean
          flutter pub get

          echo "=== Shorebird iOS í†µí•© ë¦´ë¦¬ì¦ˆ ì‹¤í–‰ ==="
          echo "ğŸš€ Shorebirdë¡œ iOS ë¹Œë“œ ë° ë¦´ë¦¬ì¦ˆ (ìµœì‹  Flutter ì—”ì§„ ì‚¬ìš©)..."
          RELEASE_RESULT=$(shorebird release ios \
            --dart-define=ENVIRONMENT=prod \
            --flutter-version=latest 2>&1)
          RELEASE_EXIT_CODE=$?
          
          echo "ë¦´ë¦¬ì¦ˆ ê²°ê³¼:"
          echo "$RELEASE_RESULT"
          
          # ë¦´ë¦¬ì¦ˆ ê²°ê³¼ í™•ì¸
          if [ $RELEASE_EXIT_CODE -eq 0 ]; then
            if echo "$RELEASE_RESULT" | grep -i "successfully\|completed\|deployed\|published\|release.*created"; then
              echo "=== Shorebird iOS í†µí•© ë¦´ë¦¬ì¦ˆ ì„±ê³µ ==="
              echo "âœ… iOS ì•±ì´ Shorebird Flutter ì—”ì§„ìœ¼ë¡œ ë¹Œë“œë˜ì–´ ì„±ê³µì ìœ¼ë¡œ ë°°í¬ë˜ì—ˆìŠµë‹ˆë‹¤"
              echo "ğŸ¯ ì´ì œ íŒ¨ì¹˜ ì›Œí¬í”Œë¡œìš°ì™€ ë™ì¼í•œ ë¹Œë“œ í™˜ê²½ì„ ì‚¬ìš©í•©ë‹ˆë‹¤"
              
              # ë¦´ë¦¬ì¦ˆ ì •ë³´ ì¶”ì¶œ ë° í‘œì‹œ
              if echo "$RELEASE_RESULT" | grep -i "release.*version\|build.*version"; then
                echo ""
                echo "ğŸ“± ë¦´ë¦¬ì¦ˆ ì •ë³´:"
                echo "$RELEASE_RESULT" | grep -i "release.*version\|build.*version" | head -3
              fi
            else
              echo "=== Shorebird iOS ë¦´ë¦¬ì¦ˆ ì¬ì‹œë„ í•„ìš” ==="
              echo "âš ï¸ ë¦´ë¦¬ì¦ˆ ê²°ê³¼ê°€ ë¶ˆë¶„ëª…í•©ë‹ˆë‹¤. ì¬ì‹œë„í•©ë‹ˆë‹¤..."
            sleep 5
            
              echo "ğŸ”„ iOS ë¦´ë¦¬ì¦ˆ ì¬ì‹œë„ (ìµœì‹  Flutter)..."
              RETRY_RESULT=$(shorebird release ios --dart-define=ENVIRONMENT=prod --flutter-version=latest 2>&1)
            RETRY_EXIT_CODE=$?
              
            if [ $RETRY_EXIT_CODE -eq 0 ]; then
              echo "âœ… ì¬ì‹œë„ ì„±ê³µ!"
                echo "$RETRY_RESULT"
            else
              echo "âŒ ì¬ì‹œë„ë„ ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤."
                echo "$RETRY_RESULT"
              exit 1
              fi
            fi
          else
            echo "=== Shorebird iOS ë¦´ë¦¬ì¦ˆ ì‹¤íŒ¨ ==="
            echo "âŒ iOS ë¦´ë¦¬ì¦ˆì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤ (ì¢…ë£Œ ì½”ë“œ: $RELEASE_EXIT_CODE)"
            
            # ì‹¤íŒ¨ ì›ì¸ ë¶„ì„
            if echo "$RELEASE_RESULT" | grep -i "no.*account\|profile"; then
              echo "ğŸ” ì„œëª… ê´€ë ¨ ë¬¸ì œë¡œ ë³´ì…ë‹ˆë‹¤"
            elif echo "$RELEASE_RESULT" | grep -i "flutter.*build.*fail"; then
              echo "ğŸ” Flutter ë¹Œë“œ ë¬¸ì œë¡œ ë³´ì…ë‹ˆë‹¤"
            elif echo "$RELEASE_RESULT" | grep -i "no.*release\|app.*not.*found"; then
              echo "ğŸ” ì•± ë“±ë¡ ë¬¸ì œë¡œ ë³´ì…ë‹ˆë‹¤"
            fi
            
            exit 1
          fi

          echo "=== ìµœì¢… ê²°ê³¼ ==="
          echo "âœ… Shorebird í†µí•© iOS ë¹Œë“œ & ë¦´ë¦¬ì¦ˆ ì™„ë£Œ!"
          echo "ğŸ¯ íŒ¨ì¹˜ ì›Œí¬í”Œë¡œìš°ì™€ ë™ì¼í•œ Shorebird Flutter ì—”ì§„ ì‚¬ìš©"
          echo "ğŸ”„ ë¹„ê²°ì •ë¡ ì  ë¹Œë“œ ë¬¸ì œ í•´ê²° ì˜ˆìƒ"

      - name: Build Traditional iOS IPA for TestFlight
        script: |
          cd picnic_app
          
          echo "=== TestFlightìš© ì „í†µì ì¸ iOS IPA ë¹Œë“œ ì‹œì‘ ==="
          echo "ğŸ¯ í•˜ì´ë¸Œë¦¬ë“œ ë°°í¬: Shorebird + TestFlight ëª¨ë‘ ì§€ì›"
          
          echo "=== TestFlightìš© iOS ì„œëª… ì„¤ì • ì¬ì ìš© ==="
          cd ios
          
          # Manual Signing ì„¤ì • ê°•ì œ ì¬ì ìš© (Shorebird ë¹Œë“œ í›„ ì´ˆê¸°í™” ë°©ì§€)
          echo "ğŸ“ Manual Distribution Signing ì¬í™œì„±í™”..."
          perl -i -pe 's/CODE_SIGN_STYLE = Automatic;/CODE_SIGN_STYLE = Manual;/g' Runner.xcodeproj/project.pbxproj
          perl -i -pe 's/CODE_SIGN_STYLE = "Automatic";/CODE_SIGN_STYLE = Manual;/g' Runner.xcodeproj/project.pbxproj
          perl -i -pe 's/CODE_SIGN_IDENTITY = "";/CODE_SIGN_IDENTITY = "Apple Distribution";/g' Runner.xcodeproj/project.pbxproj
          perl -i -pe 's/PROVISIONING_PROFILE_SPECIFIER = "";/PROVISIONING_PROFILE_SPECIFIER = "picnic_app_profile_2025";/g' Runner.xcodeproj/project.pbxproj
          
          echo "âœ… TestFlightìš© Manual Distribution Signing ì¬ì„¤ì • ì™„ë£Œ"
          echo "- CODE_SIGN_STYLE: Manual (ê°•ì œ)"
          echo "- CODE_SIGN_IDENTITY: Apple Distribution"
          echo "- PROVISIONING_PROFILE_SPECIFIER: picnic_app_profile_2025"
          
          cd ..
          
          echo "=== ExportOptions.plist ìƒì„± (TestFlight ìµœì í™”) ==="
          cat > ios/ExportOptions.plist << EOF
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
              <key>method</key>
              <string>app-store</string>
              <key>teamID</key>
              <string>24SL34R9HR</string>
              <key>provisioningProfiles</key>
              <dict>
                  <key>io.iconcasting.picnic.app</key>
                  <string>picnic_app_profile_2025</string>
              </dict>
              <key>signingStyle</key>
              <string>manual</string>
              <key>uploadBitcode</key>
              <false/>
              <key>uploadSymbols</key>
              <true/>
              <key>compileBitcode</key>
              <false/>
          </dict>
          </plist>
          EOF
          
          echo "âœ… ExportOptions.plist ìƒì„± ì™„ë£Œ"
          cat ios/ExportOptions.plist
          
          echo "=== Flutter iOS Archive ë¹Œë“œ (Manual Signing ì‚¬ìš©) ==="
          flutter build ipa \
            --release \
            --dart-define=ENVIRONMENT=prod \
            --export-options-plist=ios/ExportOptions.plist
          
          echo "=== IPA íŒŒì¼ í™•ì¸ ==="
          IPA_PATH=$(find build/ios/ipa -name "*.ipa" | head -1)
          if [ -n "$IPA_PATH" ] && [ -f "$IPA_PATH" ]; then
            echo "âœ… IPA íŒŒì¼ ìƒì„± ì„±ê³µ: $IPA_PATH"
            ls -la "$IPA_PATH"
            
            # IPA íŒŒì¼ í¬ê¸° í™•ì¸
            IPA_SIZE=$(du -h "$IPA_PATH" | cut -f1)
            echo "ğŸ“¦ IPA íŒŒì¼ í¬ê¸°: $IPA_SIZE"
          else
            echo "âŒ IPA íŒŒì¼ ìƒì„± ì‹¤íŒ¨"
            echo "ë¹Œë“œ ë””ë ‰í† ë¦¬ í™•ì¸:"
            find build/ios -name "*.ipa" 2>/dev/null || echo "IPA íŒŒì¼ ì—†ìŒ"
            find build/ios -name "*.xcarchive" 2>/dev/null || echo "xcarchive íŒŒì¼ ì—†ìŒ"
            
            # xcarchiveê°€ ìˆëŠ” ê²½ìš° ìˆ˜ë™ìœ¼ë¡œ export ì‹œë„
            XCARCHIVE_PATH=$(find build/ios -name "*.xcarchive" | head -1)
            if [ -n "$XCARCHIVE_PATH" ] && [ -d "$XCARCHIVE_PATH" ]; then
              echo "âš ï¸ xcarchiveëŠ” ì¡´ì¬í•¨: $XCARCHIVE_PATH"
              echo "ğŸ”„ xcodebuildë¡œ ìˆ˜ë™ export ì‹œë„..."
              
              xcodebuild -exportArchive \
                -archivePath "$XCARCHIVE_PATH" \
                -exportPath build/ios/ipa \
                -exportOptionsPlist ios/ExportOptions.plist
              
              # ìˆ˜ë™ export ê²°ê³¼ í™•ì¸
              IPA_PATH=$(find build/ios/ipa -name "*.ipa" | head -1)
              if [ -n "$IPA_PATH" ] && [ -f "$IPA_PATH" ]; then
                echo "âœ… ìˆ˜ë™ export ì„±ê³µ: $IPA_PATH"
                ls -la "$IPA_PATH"
              else
                echo "âŒ ìˆ˜ë™ exportë„ ì‹¤íŒ¨"
                exit 1
              fi
            else
              echo "âŒ xcarchiveë„ ì—†ìŒ - ì™„ì „í•œ ë¹Œë“œ ì‹¤íŒ¨"
              exit 1
            fi
          fi
          
          echo "=== í•˜ì´ë¸Œë¦¬ë“œ ë°°í¬ ì¤€ë¹„ ì™„ë£Œ ==="
          echo "âœ… Shorebird ë°°í¬: ì™„ë£Œ (ì¦‰ì‹œ ì‚¬ìš©ìì—ê²Œ ì „ë‹¬)"
          echo "âœ… TestFlight IPA: ìƒì„± ì™„ë£Œ (App Store Connect ìŠ¹ì¸ ëŒ€ê¸°)"

    artifacts:
      # í•˜ì´ë¸Œë¦¬ë“œ ì•„í‹°íŒ©íŠ¸: TestFlight + Shorebird ëª¨ë‘
      - picnic_app/build/ios/**/*.ipa
      - picnic_app/build/ios/**/*.xcarchive
      - picnic_app/shorebird.yaml
      - picnic_app/build/shorebird/**/*
      - picnic_app/flutter_drive.log
      - picnic_app/build/ios/**/Runner.app

    publishing:
      # í•˜ì´ë¸Œë¦¬ë“œ ë°°í¬: TestFlight + Shorebird ëª¨ë‘ ì‚¬ìš©
      app_store_connect:
        auth: integration
        submit_to_testflight: true
        beta_groups:
          - App Store Connect Users
      slack:
        channel: '#codemagic-picnic'
        notify_on_build_start: true
        notify:
          success: true
          failure: true
      email:
        recipients:
          - ironlove77@gmail.com
        notify:
          success: true
          failure: true

  # =================== PICNIC APP Android ===================
  picnic-app-android:
    name: Picnic App - Android
    instance_type: mac_mini_m2
    max_build_duration: 120
    environment:
      android_signing:
        - picnic_keystore
      groups:
        - google_play
        - shorebird-config
        - picnic_env
      flutter: 3.32.4
      java: 17
      vars:
        PATH: $PATH:$HOME/.shorebird/bin
        APP_NAME: "picnic_app"
        # CodeMagicì´ android_signingì„ ì¸ì‹í•˜ë„ë¡ ê°•ì œ ì„¤ì •
        FLUTTER_BUILD_MODE: "release"
    cache:
      cache_paths:
        - $FLUTTER_ROOT/.pub-cache
        - $HOME/.gradle/caches
        - $HOME/.gradle/wrapper
        - $HOME/.android/build-cache
        - $HOME/Library/Caches/CocoaPods
        - picnic_app/.dart_tool
        - picnic_app/android/.gradle
    triggering:
      events:
        - push
        - tag
      branch_patterns:
        - pattern: 'main'
          include: true
        - pattern: 'production'
          include: true
      tag_patterns:
        - pattern: 'picnic-v*'
          include: true
      cancel_previous_builds: true
    scripts:
      - name: Install Shorebird CLI
        script: |
          echo "=== Shorebird CLI ì„¤ì¹˜ ì‹œì‘ ==="
          
          # ê¸°ì¡´ Shorebird ì„¤ì¹˜ ê°•ì œ ì œê±° (ì¶©ëŒ ë°©ì§€)
          echo "ğŸ§¹ ê¸°ì¡´ Shorebird ì„¤ì¹˜ ì •ë¦¬ ì¤‘..."
          if [ -d "$HOME/.shorebird" ]; then
            rm -rf "$HOME/.shorebird"
            echo "âœ… ê¸°ì¡´ Shorebird ë””ë ‰í† ë¦¬ ì œê±° ì™„ë£Œ"
          fi
          
          # ìµœì‹  ì•ˆì • ë²„ì „ ì‚¬ìš© (v1.6.48)
          echo "ğŸ”§ Shorebird v1.6.48 ìµœì‹  ì•ˆì • ë²„ì „ ì„¤ì¹˜ ì¤‘..."
          
          # ê³µì‹ GitHub ì„¤ì¹˜ ìŠ¤í¬ë¦½íŠ¸ ì‚¬ìš© (ê°€ì¥ ì•ˆì •ì )
          echo "ğŸ“¥ ê³µì‹ ì„¤ì¹˜ ìŠ¤í¬ë¦½íŠ¸ë¡œ ìµœì‹  Shorebird ì„¤ì¹˜..."
          curl --proto '=https' --tlsv1.2 https://raw.githubusercontent.com/shorebirdtech/install/main/install.sh -sSf | bash
          
          export PATH="$HOME/.shorebird/bin:$PATH"
          
          echo "=== Shorebird ì„¤ì¹˜ í™•ì¸ ==="
          if command -v shorebird >/dev/null 2>&1; then
            shorebird --version
            echo "âœ… Shorebird ì„¤ì¹˜ ë° ì„¤ì • ì™„ë£Œ"
          else
            echo "âŒ Shorebird ì„¤ì¹˜ ì‹¤íŒ¨"
            exit 1
          fi

      - name: Get Flutter packages
        script: |
          cd picnic_app
          flutter packages pub get

      - name: Verify Keystore Configuration
        script: |
          echo "=== í‚¤ìŠ¤í† ì–´ í™˜ê²½ ë³€ìˆ˜ í™•ì¸ ==="
          echo "CM_KEYSTORE_PATH: ${CM_KEYSTORE_PATH:-'ë¯¸ì„¤ì •'}"
          echo "CM_KEYSTORE_PASSWORD: ${CM_KEYSTORE_PASSWORD:-'ë¯¸ì„¤ì •'}"
          echo "CM_KEY_ALIAS: ${CM_KEY_ALIAS:-'ë¯¸ì„¤ì •'}"
          echo "CM_KEY_PASSWORD: ${CM_KEY_PASSWORD:-'ë¯¸ì„¤ì •'}"
          
          if [ -z "$CM_KEYSTORE_PATH" ] || [ -z "$CM_KEYSTORE_PASSWORD" ] || [ -z "$CM_KEY_ALIAS" ] || [ -z "$CM_KEY_PASSWORD" ]; then
            echo "âŒ í‚¤ìŠ¤í† ì–´ í™˜ê²½ ë³€ìˆ˜ê°€ ì˜¬ë°”ë¥´ê²Œ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤"
            echo "CodeMagic ëŒ€ì‹œë³´ë“œì—ì„œ 'picnic_keystore' ê·¸ë£¹ ì„¤ì •ì„ í™•ì¸í•´ì£¼ì„¸ìš”"
            exit 1
          fi
          
          if [ -f "$CM_KEYSTORE_PATH" ]; then
            echo "âœ… í‚¤ìŠ¤í† ì–´ íŒŒì¼ ì¡´ì¬: $CM_KEYSTORE_PATH"
            # í‚¤ìŠ¤í† ì–´ ì •ë³´ í™•ì¸
            keytool -list -v -keystore "$CM_KEYSTORE_PATH" -alias "$CM_KEY_ALIAS" -storepass "$CM_KEYSTORE_PASSWORD" | grep -E "(SHA1|SHA256|Subject|Issuer)" || echo "í‚¤ìŠ¤í† ì–´ ì •ë³´ í™•ì¸ ì‹¤íŒ¨"
          else
            echo "âŒ í‚¤ìŠ¤í† ì–´ íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: $CM_KEYSTORE_PATH"
            exit 1
          fi

      - name: Shorebird Android Release (Unified Build & Deploy)
        script: |
          cd picnic_app
          
          echo "=== Shorebird í†µí•© Android ë¹Œë“œ & ë¦´ë¦¬ì¦ˆ ì‹œì‘ ==="
          echo "ğŸ¯ ë¦´ë¦¬ì¦ˆì™€ íŒ¨ì¹˜ì˜ ì¼ê´€ëœ ë¹Œë“œ í™˜ê²½ì„ ìœ„í•´ Shorebirdë¡œ ì§ì ‘ ë¹Œë“œí•©ë‹ˆë‹¤"
          echo ""
          
          # Shorebird PATH ì„¤ì •
          export PATH="$HOME/.shorebird/bin:$PATH"

          echo "=== Shorebird ë²„ì „ í™•ì¸ ==="
          shorebird --version

          echo "=== Shorebird ì¸ì¦ í™•ì¸ ==="
          if [ -z "$SHOREBIRD_TOKEN" ]; then
            echo "âŒ SHOREBIRD_TOKEN í™˜ê²½ë³€ìˆ˜ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤"
            exit 1
          else
            echo "âœ… SHOREBIRD_TOKEN í™˜ê²½ë³€ìˆ˜ê°€ ì„¤ì •ë˜ì—ˆìŠµë‹ˆë‹¤"
          fi

          echo "=== Android ì„œëª… í™˜ê²½ ìµœì¢… í™•ì¸ ==="
          echo "âœ… Android Signing ì„¤ì • ì™„ë£Œ"
          echo "âœ… í‚¤ìŠ¤í† ì–´ ê²½ë¡œ: $CM_KEYSTORE_PATH"
          echo "âœ… í‚¤ ë³„ì¹­: $CM_KEY_ALIAS"
          echo "âœ… ì„œëª… ê²€ì¦ ì™„ë£Œ"

          echo "=== Gradle ë©”ëª¨ë¦¬ ìµœì í™” ì„¤ì • (Shorebird í˜¸í™˜) ==="
          mkdir -p $HOME/.gradle
          # Shorebirdì™€ í˜¸í™˜ë˜ëŠ” ìµœì í™”ëœ Gradle ì„¤ì •
          echo "org.gradle.jvmargs=-Xmx6144m -XX:MaxMetaspaceSize=512m -XX:+HeapDumpOnOutOfMemoryError -Dfile.encoding=UTF-8" >> $HOME/.gradle/gradle.properties
          echo "org.gradle.daemon=true" >> $HOME/.gradle/gradle.properties
          echo "org.gradle.caching=true" >> $HOME/.gradle/gradle.properties
          echo "org.gradle.parallel=false" >> $HOME/.gradle/gradle.properties
          echo "android.enableJetifier=true" >> $HOME/.gradle/gradle.properties
          echo "android.useAndroidX=true" >> $HOME/.gradle/gradle.properties
          echo "android.enableR8.fullMode=false" >> $HOME/.gradle/gradle.properties

          echo "=== Shorebird ìºì‹œ ì •ë¦¬ ë° í™˜ê²½ ì¤€ë¹„ ==="
          shorebird cache clean
          flutter clean
          flutter pub get

          echo "=== ì‚¬ì „ Flutter ë¹Œë“œ (ë„¤ì´í‹°ë¸Œ ë¼ì´ë¸ŒëŸ¬ë¦¬ ìƒì„±) ==="
          # Shorebird ì‹¤í–‰ ì „ì— Flutter ë¹Œë“œë¡œ ë„¤ì´í‹°ë¸Œ ë¼ì´ë¸ŒëŸ¬ë¦¬ ìƒì„±
          echo "ğŸ”§ Flutter AAB ë¹Œë“œë¥¼ í†µí•œ ë„¤ì´í‹°ë¸Œ ë¼ì´ë¸ŒëŸ¬ë¦¬ ìƒì„±..."
          flutter build appbundle --release --dart-define=ENVIRONMENT=prod || {
            echo "âš ï¸ Flutter ë¹Œë“œ ì‹¤íŒ¨ - ê³„ì† ì§„í–‰"
          }
          
          echo "=== ë„¤ì´í‹°ë¸Œ ë¼ì´ë¸ŒëŸ¬ë¦¬ ì‚¬ì „ ë³µì‚¬ (Shorebird í˜¸í™˜) ==="
          # ì‹¤ì œ ë„¤ì´í‹°ë¸Œ ë¼ì´ë¸ŒëŸ¬ë¦¬ ìœ„ì¹˜ë“¤ (ì—¬ëŸ¬ ê°€ëŠ¥í•œ ê²½ë¡œ)
          POSSIBLE_NATIVE_PATHS=(
            "android/app/build/intermediates/stripped_native_libs/release/stripReleaseDebugSymbols/out/lib"
            "android/app/build/intermediates/stripped_native_libs/release/out/lib"
            "android/app/build/intermediates/merged_native_libs/release/out/lib"
          )
          
          # Shorebirdê°€ ì°¾ëŠ” ìœ„ì¹˜ë“¤
          EXPECTED_PATHS=(
            "build/app/intermediates/stripped_native_libs/release/out/lib"
            "build/app/intermediates/stripped_native_libs/stripReleaseDebugSymbols/release/out/lib"
          )
          
          NATIVE_FOUND=false
          for REAL_NATIVE_PATH in "${POSSIBLE_NATIVE_PATHS[@]}"; do
            if [ -d "$REAL_NATIVE_PATH" ]; then
              echo "âœ… ë„¤ì´í‹°ë¸Œ ë¼ì´ë¸ŒëŸ¬ë¦¬ ë°œê²¬: $REAL_NATIVE_PATH"
              ls -la "$REAL_NATIVE_PATH" 2>/dev/null || echo "ë””ë ‰í† ë¦¬ ë‚´ìš© í™•ì¸ ë¶ˆê°€"
              NATIVE_FOUND=true
              
              for EXPECTED_PATH in "${EXPECTED_PATHS[@]}"; do
                echo "ğŸ“ ì‚¬ì „ ë³µì‚¬: $REAL_NATIVE_PATH -> $EXPECTED_PATH"
                mkdir -p "$(dirname "$EXPECTED_PATH")"
                cp -r "$REAL_NATIVE_PATH" "$(dirname "$EXPECTED_PATH")/"
                
                if [ -d "$EXPECTED_PATH" ]; then
                  echo "âœ… ì‚¬ì „ ë³µì‚¬ ì„±ê³µ: $EXPECTED_PATH"
                  find "$EXPECTED_PATH" -name "*.so" | head -3
                else
                  echo "âŒ ì‚¬ì „ ë³µì‚¬ ì‹¤íŒ¨: $EXPECTED_PATH"
                fi
              done
              break
            fi
          done
          
          if [ "$NATIVE_FOUND" = false ]; then
            echo "âš ï¸ ë„¤ì´í‹°ë¸Œ ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ"
            echo "ğŸ“‹ ê°€ëŠ¥í•œ ìœ„ì¹˜ë“¤ í™•ì¸:"
            find android/app/build/intermediates/ -name "*.so" -type f 2>/dev/null | head -5 || echo "ë„¤ì´í‹°ë¸Œ ë¼ì´ë¸ŒëŸ¬ë¦¬ íŒŒì¼ ì—†ìŒ"
          fi
          
          echo "=== Shorebird Android í†µí•© ë¦´ë¦¬ì¦ˆ ì‹¤í–‰ ==="
          echo "ğŸš€ Shorebirdë¡œ Android ë¹Œë“œ ë° ë¦´ë¦¬ì¦ˆ (ìµœì‹  Flutter ì—”ì§„ ì‚¬ìš©)..."
          echo "ğŸ“‹ ë¹Œë“œ ì „ ë””ë ‰í† ë¦¬ ìƒíƒœ í™•ì¸..."
          ls -la build/ || echo "build ë””ë ‰í† ë¦¬ ì—†ìŒ"
          
          RELEASE_RESULT=$(shorebird release android --dart-define=ENVIRONMENT=prod --flutter-version=latest 2>&1)
          RELEASE_EXIT_CODE=$?
          
          echo "ğŸ“‹ ë¹Œë“œ í›„ ë””ë ‰í† ë¦¬ ìƒíƒœ í™•ì¸..."
          find build/ -name "*.aab" -type f 2>/dev/null || echo "AAB íŒŒì¼ ì—†ìŒ"
          echo "ğŸ“‹ Gradle íƒœìŠ¤í¬ë¡œ AAB íŒŒì¼ ìœ„ì¹˜ ìˆ˜ì • í™•ì¸..."
          ls -la build/app/outputs/bundle/release/ 2>/dev/null || echo "ì˜ˆìƒ ìœ„ì¹˜ì— AAB ì—†ìŒ"
          
          echo "ë¦´ë¦¬ì¦ˆ ê²°ê³¼:"
          echo "$RELEASE_RESULT"
          
          # ë¦´ë¦¬ì¦ˆ ê²°ê³¼ í™•ì¸
          if [ $RELEASE_EXIT_CODE -eq 0 ]; then
            if echo "$RELEASE_RESULT" | grep -i "successfully\|completed\|deployed\|published\|release.*created"; then
              echo "=== Shorebird Android í†µí•© ë¦´ë¦¬ì¦ˆ ì„±ê³µ ==="
              echo "âœ… Android ì•±ì´ Shorebird Flutter ì—”ì§„ìœ¼ë¡œ ë¹Œë“œë˜ì–´ ì„±ê³µì ìœ¼ë¡œ ë°°í¬ë˜ì—ˆìŠµë‹ˆë‹¤"
              echo "ğŸ¯ ì´ì œ íŒ¨ì¹˜ ì›Œí¬í”Œë¡œìš°ì™€ ë™ì¼í•œ ë¹Œë“œ í™˜ê²½ì„ ì‚¬ìš©í•©ë‹ˆë‹¤"
              
              # ë¦´ë¦¬ì¦ˆ ì •ë³´ ì¶”ì¶œ ë° í‘œì‹œ
              if echo "$RELEASE_RESULT" | grep -i "release.*version\|build.*version"; then
                echo ""
                echo "ğŸ“± ë¦´ë¦¬ì¦ˆ ì •ë³´:"
                echo "$RELEASE_RESULT" | grep -i "release.*version\|build.*version" | head -3
              fi
            else
              echo "=== Shorebird Android ë¦´ë¦¬ì¦ˆ ì¬ì‹œë„ í•„ìš” ==="
              echo "âš ï¸ ë¦´ë¦¬ì¦ˆ ê²°ê³¼ê°€ ë¶ˆë¶„ëª…í•©ë‹ˆë‹¤. ì¬ì‹œë„í•©ë‹ˆë‹¤..."
            sleep 5
            
              echo "ğŸ”„ Android ë¦´ë¦¬ì¦ˆ ì¬ì‹œë„ (ìµœì‹  Flutter)..."
              RETRY_RESULT=$(shorebird release android --dart-define=ENVIRONMENT=prod --flutter-version=latest 2>&1)
            RETRY_EXIT_CODE=$?
              
            if [ $RETRY_EXIT_CODE -eq 0 ]; then
              echo "âœ… ì¬ì‹œë„ ì„±ê³µ!"
                echo "$RETRY_RESULT"
            else
              echo "âŒ ì¬ì‹œë„ë„ ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤."
                echo "$RETRY_RESULT"
              exit 1
            fi
            fi
          else
            echo "=== Shorebird Android ë¦´ë¦¬ì¦ˆ ì‹¤íŒ¨ ==="
            echo "âŒ Android ë¦´ë¦¬ì¦ˆì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤ (ì¢…ë£Œ ì½”ë“œ: $RELEASE_EXIT_CODE)"
            
            # ì‹¤íŒ¨ ì›ì¸ ë¶„ì„
            if echo "$RELEASE_RESULT" | grep -i "keystore\|signing"; then
              echo "ğŸ” ì„œëª… ê´€ë ¨ ë¬¸ì œë¡œ ë³´ì…ë‹ˆë‹¤"
            elif echo "$RELEASE_RESULT" | grep -i "flutter.*build.*fail"; then
              echo "ğŸ” Flutter ë¹Œë“œ ë¬¸ì œë¡œ ë³´ì…ë‹ˆë‹¤"
            elif echo "$RELEASE_RESULT" | grep -i "no.*release\|app.*not.*found"; then
              echo "ğŸ” ì•± ë“±ë¡ ë¬¸ì œë¡œ ë³´ì…ë‹ˆë‹¤"
            fi
            
            exit 1
          fi

          echo "=== ìµœì¢… ê²°ê³¼ ==="
          echo "âœ… Shorebird í†µí•© Android ë¹Œë“œ & ë¦´ë¦¬ì¦ˆ ì™„ë£Œ!"
          echo "ğŸ¯ íŒ¨ì¹˜ ì›Œí¬í”Œë¡œìš°ì™€ ë™ì¼í•œ Shorebird Flutter ì—”ì§„ ì‚¬ìš©"
          echo "ğŸ”„ ë¹„ê²°ì •ë¡ ì  ë¹Œë“œ ë¬¸ì œ í•´ê²° ì˜ˆìƒ"

      - name: Prepare AAB for Google Play Upload  
        script: |
          cd picnic_app
          
          echo "=== Google Play ì—…ë¡œë“œìš© AAB íŒŒì¼ ì¤€ë¹„ ==="
          echo "ğŸ¯ Shorebirdì—ì„œ ìƒì„±ëœ AAB íŒŒì¼ì„ Google Play ì—…ë¡œë“œìš©ìœ¼ë¡œ ì¤€ë¹„"
          
          # Shorebirdê°€ ìƒì„±í•œ AAB íŒŒì¼ ì°¾ê¸°
          echo "=== Shorebird ìƒì„± AAB íŒŒì¼ ê²€ìƒ‰ ==="
          SHOREBIRD_AAB=""
          
          # ê°€ëŠ¥í•œ Shorebird AAB ìœ„ì¹˜ë“¤
          POSSIBLE_AAB_PATHS=(
            "build/app/outputs/bundle/release/app-release.aab"
            "build/app/outputs/bundle/release/*.aab"
            "build/shorebird/*.aab"
            "build/outputs/bundle/release/*.aab"
          )
          
          for AAB_PATTERN in "${POSSIBLE_AAB_PATHS[@]}"; do
            AAB_FILES=$(find . -path "*$AAB_PATTERN" -type f 2>/dev/null | head -1)
            if [ -n "$AAB_FILES" ] && [ -f "$AAB_FILES" ]; then
              SHOREBIRD_AAB="$AAB_FILES"
              echo "âœ… Shorebird AAB íŒŒì¼ ë°œê²¬: $SHOREBIRD_AAB"
              break
            fi
          done
          
          # Shorebird AABê°€ ì—†ìœ¼ë©´ ì „í†µì ì¸ ë¹Œë“œë¡œ í´ë°±
          if [ -z "$SHOREBIRD_AAB" ] || [ ! -f "$SHOREBIRD_AAB" ]; then
            echo "âš ï¸ Shorebird AAB íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŒ. ì „í†µì ì¸ ë¹Œë“œë¡œ í´ë°±..."
            
            flutter build appbundle \
              --release \
              --dart-define=ENVIRONMENT=prod
            
            SHOREBIRD_AAB=$(find build/app/outputs/bundle/release -name "*.aab" | head -1)
          fi
          
          # ìµœì¢… AAB íŒŒì¼ í™•ì¸
          if [ -n "$SHOREBIRD_AAB" ] && [ -f "$SHOREBIRD_AAB" ]; then
            echo "âœ… Google Play ì—…ë¡œë“œìš© AAB íŒŒì¼: $SHOREBIRD_AAB"
            ls -la "$SHOREBIRD_AAB"
            
            # AAB íŒŒì¼ í¬ê¸° í™•ì¸
            AAB_SIZE=$(du -h "$SHOREBIRD_AAB" | cut -f1)
            echo "ğŸ“¦ AAB íŒŒì¼ í¬ê¸°: $AAB_SIZE"
            
            # í‘œì¤€ ìœ„ì¹˜ë¡œ ë³µì‚¬ (CodeMagic Google Play ì—…ë¡œë“œìš©)
            mkdir -p build/app/outputs/bundle/release
            cp "$SHOREBIRD_AAB" build/app/outputs/bundle/release/app-release.aab
            
            echo "âœ… Google Play ì—…ë¡œë“œ ì¤€ë¹„ ì™„ë£Œ"
          else
            echo "âŒ AAB íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤"
            echo "ğŸ” ì‚¬ìš© ê°€ëŠ¥í•œ ë¹Œë“œ íŒŒì¼ë“¤:"
            find build/ -name "*.aab" -o -name "*.apk" 2>/dev/null || echo "ë¹Œë“œ íŒŒì¼ ì—†ìŒ"
            exit 1
          fi

    artifacts:
      # Shorebird AAB íŒŒì¼ë§Œ ì§€ì • (ì¤‘ë³µ ì—…ë¡œë“œ ë°©ì§€)
      - picnic_app/build/app/outputs/bundle/release/app-release.aab
      - picnic_app/build/**/outputs/**/*.apk
      - picnic_app/shorebird.yaml
      - picnic_app/build/shorebird/**/*
      - picnic_app/flutter_drive.log
      - picnic_app/build/app/outputs/**/mapping.txt

    publishing:
      # ì¡°ê±´ë¶€ Google Play ë°°í¬ (í™˜ê²½ë³€ìˆ˜ë¡œ ì œì–´)
      google_play:
        credentials: $GCLOUD_SERVICE_ACCOUNT_CREDENTIALS
        track: internal
        submit_as_draft: true
      slack:
        channel: '#codemagic-picnic'
        notify_on_build_start: true
        notify:
          success: true
          failure: true
      email:
        recipients:
          - ironlove77@gmail.com
        notify:
          success: true
          failure: true

  # =================== PICNIC APP iOS Patch (Shorebird) ===================
  picnic-app-patch-ios:
    name: Picnic App - iOS Patch (Shorebird)
    instance_type: mac_mini_m2
    max_build_duration: 60
    integrations:
      app_store_connect: codemagic-picnic
    environment:
      ios_signing:
        distribution_type: app_store
        bundle_identifier: io.iconcasting.picnic.app
      groups:
        - app_store_connect
        - shorebird-config
        - picnic_env
      flutter: 3.32.4
      vars:
        APP_NAME: "picnic_app"
        BUNDLE_ID: "io.iconcasting.picnic.app"
    cache:
      cache_paths:
        - $FLUTTER_ROOT/.pub-cache
        - $HOME/.gradle/caches
        - $HOME/Library/Caches/CocoaPods
    triggering:
      events:
        - push
        - tag
      branch_patterns:
        - pattern: 'hotfix/*'
          include: true
        - pattern: 'patch/*'
          include: true
      tag_patterns:
        - pattern: 'picnic-patch-*'
          include: true
      cancel_previous_builds: true
    scripts:
      - name: Install Shorebird CLI
        script: |
          echo "=== Shorebird CLI ì„¤ì¹˜ ì‹œì‘ ==="
          
          # ê¸°ì¡´ Shorebird ì„¤ì¹˜ ê°•ì œ ì œê±° (ì¶©ëŒ ë°©ì§€)
          echo "ğŸ§¹ ê¸°ì¡´ Shorebird ì„¤ì¹˜ ì •ë¦¬ ì¤‘..."
          if [ -d "$HOME/.shorebird" ]; then
            rm -rf "$HOME/.shorebird"
            echo "âœ… ê¸°ì¡´ Shorebird ë””ë ‰í† ë¦¬ ì œê±° ì™„ë£Œ"
          fi
          
          # ìµœì‹  ì•ˆì • ë²„ì „ ì‚¬ìš© (v1.6.48)
          echo "ğŸ”§ Shorebird v1.6.48 ìµœì‹  ì•ˆì • ë²„ì „ ì„¤ì¹˜ ì¤‘..."
          
          # ê³µì‹ GitHub ì„¤ì¹˜ ìŠ¤í¬ë¦½íŠ¸ ì‚¬ìš© (ê°€ì¥ ì•ˆì •ì )
          echo "ğŸ“¥ ê³µì‹ ì„¤ì¹˜ ìŠ¤í¬ë¦½íŠ¸ë¡œ ìµœì‹  Shorebird ì„¤ì¹˜..."
          curl --proto '=https' --tlsv1.2 https://raw.githubusercontent.com/shorebirdtech/install/main/install.sh -sSf | bash
          
          export PATH="$HOME/.shorebird/bin:$PATH"
          
          echo "=== Shorebird ì„¤ì¹˜ í™•ì¸ ==="
          if command -v shorebird >/dev/null 2>&1; then
            shorebird --version
            echo "âœ… Shorebird ì„¤ì¹˜ ë° ì„¤ì • ì™„ë£Œ"
          else
            echo "âŒ Shorebird ì„¤ì¹˜ ì‹¤íŒ¨"
            exit 1
          fi
          
          # PATH ì„¤ì •ì„ í™˜ê²½ íŒŒì¼ë¡œ ì €ì¥ (ë‹¤ìŒ ë‹¨ê³„ì—ì„œ ì‚¬ìš©)
          echo "export PATH=\"$HOME/.shorebird/bin:\$PATH\"" > /tmp/shorebird_env.sh
          echo "âœ… Shorebird CLI ì„¤ì¹˜ ë° í™˜ê²½ ì„¤ì • ì™„ë£Œ"

      - name: Get Flutter packages and prepare iOS
        script: |
          cd picnic_app
          echo "=== Flutter íŒ¨í‚¤ì§€ ì„¤ì¹˜ ==="
          flutter packages pub get
          
          echo "=== Flutter iOS ì„¤ì • ìƒì„± ==="
          flutter precache --ios
          flutter build ios --config-only

      - name: Install CocoaPods dependencies
        script: |
          cd picnic_app
          
          echo "=== Generated.xcconfig íŒŒì¼ í™•ì¸ ==="
          if [ ! -f "ios/Flutter/Generated.xcconfig" ]; then
            echo "âš ï¸ Generated.xcconfig íŒŒì¼ì´ ì—†ìŒ - Flutter ì„¤ì • ì¬ìƒì„±"
            flutter build ios --config-only
          fi
          
          echo "âœ… Generated.xcconfig íŒŒì¼ ì¡´ì¬ í™•ì¸:"
          ls -la ios/Flutter/Generated.xcconfig
          
          echo "=== CocoaPods ì„¤ì¹˜ ì‹œì‘ ==="
          cd ios
          pod install

      - name: Install Shorebird CLI
        script: |
          echo "=== Shorebird CLI ì„¤ì¹˜ ì‹œì‘ ==="
          
          # ê¸°ì¡´ Shorebird ì„¤ì¹˜ ê°•ì œ ì œê±° (ì¶©ëŒ ë°©ì§€)
          echo "ğŸ§¹ ê¸°ì¡´ Shorebird ì„¤ì¹˜ ì •ë¦¬ ì¤‘..."
          if [ -d "$HOME/.shorebird" ]; then
            rm -rf "$HOME/.shorebird"
            echo "âœ… ê¸°ì¡´ Shorebird ë””ë ‰í† ë¦¬ ì œê±° ì™„ë£Œ"
          fi
          
          # ìµœì‹  ì•ˆì • ë²„ì „ ì‚¬ìš© (v1.6.48)
          echo "ğŸ”§ Shorebird v1.6.48 ìµœì‹  ì•ˆì • ë²„ì „ ì„¤ì¹˜ ì¤‘..."
          
          # ê³µì‹ GitHub ì„¤ì¹˜ ìŠ¤í¬ë¦½íŠ¸ ì‚¬ìš© (ê°€ì¥ ì•ˆì •ì )
          echo "ğŸ“¥ ê³µì‹ ì„¤ì¹˜ ìŠ¤í¬ë¦½íŠ¸ë¡œ ìµœì‹  Shorebird ì„¤ì¹˜..."
          curl --proto '=https' --tlsv1.2 https://raw.githubusercontent.com/shorebirdtech/install/main/install.sh -sSf | bash
          
          export PATH="$HOME/.shorebird/bin:$PATH"
          
          echo "=== Shorebird ì„¤ì¹˜ í™•ì¸ ==="
          if command -v shorebird >/dev/null 2>&1; then
            shorebird --version
            echo "âœ… Shorebird ì„¤ì¹˜ ë° ì„¤ì • ì™„ë£Œ"
          else
            echo "âŒ Shorebird ì„¤ì¹˜ ì‹¤íŒ¨"
            exit 1
          fi

      - name: Verify iOS Signing Configuration
        script: |
          echo "=== iOS ì„œëª… í™˜ê²½ í™•ì¸ ==="
          echo "DEVELOPMENT_TEAM: ${DEVELOPMENT_TEAM:-'24SL34R9HR'}"
          
          # Distribution Certificate ì •ë³´ í™•ì¸
          DIST_CERT_INFO=$(security find-identity -v -p codesigning | grep -i distribution | head -1)
          if [ -n "$DIST_CERT_INFO" ]; then
            echo "âœ… Distribution ì¸ì¦ì„œ: $DIST_CERT_INFO"
          else
            echo "âŒ Distribution ì¸ì¦ì„œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ"
            echo "ì‚¬ìš© ê°€ëŠ¥í•œ ì¸ì¦ì„œë“¤:"
            security find-identity -v -p codesigning
            exit 1
          fi
          
          # Provisioning Profile ì •ë³´ í™•ì¸
          PROFILE_COUNT=$(find "$HOME/Library/MobileDevice/Provisioning Profiles" -name "*.mobileprovision" 2>/dev/null | wc -l)
          echo "ì„¤ì¹˜ëœ í”„ë¡œë¹„ì €ë‹ í”„ë¡œíŒŒì¼ ê°œìˆ˜: $PROFILE_COUNTê°œ"
          
          if [ "$PROFILE_COUNT" -gt 0 ]; then
            echo "âœ… í”„ë¡œë¹„ì €ë‹ í”„ë¡œíŒŒì¼ ëª©ë¡:"
            find "$HOME/Library/MobileDevice/Provisioning Profiles" -name "*.mobileprovision" 2>/dev/null | while read profile; do
              PROFILE_NAME=$(security cms -D -i "$profile" 2>/dev/null | grep -A1 "<key>Name</key>" | tail -1 | sed 's/.*<string>\(.*\)<\/string>.*/\1/' | tr -d '\n')
              echo "  - $(basename "$profile" .mobileprovision): $PROFILE_NAME"
              
              # í”„ë¡œë¹„ì €ë‹ í”„ë¡œíŒŒì¼ì˜ Entitlements í™•ì¸
              if [[ "$PROFILE_NAME" == *"picnic"* ]]; then
                echo "    ğŸ” Picnic í”„ë¡œíŒŒì¼ Entitlements í™•ì¸ ì¤‘..."
                ENTITLEMENTS=$(security cms -D -i "$profile" 2>/dev/null | grep -A 20 "<key>Entitlements</key>" | grep -E "(aps-environment|com.apple.developer.associated-domains|com.apple.developer.applesignin)")
                if [ -n "$ENTITLEMENTS" ]; then
                  echo "    âœ… í•„ìš”í•œ Entitlements ë°œê²¬:"
                  echo "$ENTITLEMENTS" | head -5
                else
                  echo "    âš ï¸ í•„ìš”í•œ Entitlementsê°€ ëˆ„ë½ë¨ (Associated Domains, Push Notifications, Sign in with Apple)"
                fi
              fi
            done
          else
            echo "âŒ í”„ë¡œë¹„ì €ë‹ í”„ë¡œíŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŒ"
            exit 1
          fi

      - name: Configure Xcode Project Signing Strategy
        script: |
          cd picnic_app/ios
          
          echo "=== Xcode í”„ë¡œì íŠ¸ Automatic Signing ì„¤ì • (íŒ¨ì¹˜ìš©) ==="
          
          # Automatic Signing ê°•ì œ ì„¤ì • (CodeMagic App Store Connect Integration ì‚¬ìš©)
          echo "ğŸ“ Automatic Signing í™œì„±í™”..."
          sed -i '' "s/CODE_SIGN_STYLE = Manual;/CODE_SIGN_STYLE = Automatic;/g" Runner.xcodeproj/project.pbxproj
          sed -i '' "s/CODE_SIGN_STYLE = \"\";/CODE_SIGN_STYLE = Automatic;/g" Runner.xcodeproj/project.pbxproj
          
          # Development Team ì„¤ì • (í•„ìˆ˜)
          sed -i '' "s/DEVELOPMENT_TEAM = \"\";/DEVELOPMENT_TEAM = \"24SL34R9HR\";/g" Runner.xcodeproj/project.pbxproj
          sed -i '' "s/DEVELOPMENT_TEAM = 24SL34R9HR;/DEVELOPMENT_TEAM = \"24SL34R9HR\";/g" Runner.xcodeproj/project.pbxproj
          
          # Manual í”„ë¡œë¹„ì €ë‹ í”„ë¡œíŒŒì¼ ì„¤ì • ì œê±° (Automaticê³¼ ì¶©ëŒ ë°©ì§€)
          echo "ğŸ§¹ Manual í”„ë¡œë¹„ì €ë‹ í”„ë¡œíŒŒì¼ ì„¤ì • ì œê±°..."
          sed -i '' "s/PROVISIONING_PROFILE_SPECIFIER = \"picnic_app_profile_2025\";/PROVISIONING_PROFILE_SPECIFIER = \"\";/g" Runner.xcodeproj/project.pbxproj
          sed -i '' "s/PROVISIONING_PROFILE_SPECIFIER = picnic_app_profile_2025;/PROVISIONING_PROFILE_SPECIFIER = \"\";/g" Runner.xcodeproj/project.pbxproj
          
          # CODE_SIGN_IDENTITYë¥¼ ë¹„ì›Œì„œ Automaticì´ ìë™ìœ¼ë¡œ ì„ íƒí•˜ë„ë¡ í•¨
          echo "ğŸ”„ CODE_SIGN_IDENTITY ìë™ ì„¤ì •ìœ¼ë¡œ ë³€ê²½..."
          sed -i '' "s/CODE_SIGN_IDENTITY = \"Apple Distribution\";/CODE_SIGN_IDENTITY = \"\";/g" Runner.xcodeproj/project.pbxproj
          sed -i '' "s/CODE_SIGN_IDENTITY = \"Apple Development\";/CODE_SIGN_IDENTITY = \"\";/g" Runner.xcodeproj/project.pbxproj
          sed -i '' "s/\"CODE_SIGN_IDENTITY\[sdk=iphoneos\*\]\" = \"Apple Distribution\";/\"CODE_SIGN_IDENTITY[sdk=iphoneos*]\" = \"\";/g" Runner.xcodeproj/project.pbxproj
          
          # ì¶”ê°€ ê°•ë ¥ ì„¤ì • - perlì„ ì‚¬ìš©í•œ ë” ì •í™•í•œ ì¹˜í™˜
          echo "ğŸ“ ì¶”ê°€ Automatic Signing ê°•ë ¥ ì„¤ì •..."
          perl -i -pe 's/CODE_SIGN_STYLE = Manual;/CODE_SIGN_STYLE = Automatic;/g' Runner.xcodeproj/project.pbxproj
          perl -i -pe 's/CODE_SIGN_STYLE = "Manual";/CODE_SIGN_STYLE = Automatic;/g' Runner.xcodeproj/project.pbxproj
          perl -i -pe 's/PROVISIONING_PROFILE_SPECIFIER = "picnic_app_profile_2025";/PROVISIONING_PROFILE_SPECIFIER = "";/g' Runner.xcodeproj/project.pbxproj
          perl -i -pe 's/CODE_SIGN_IDENTITY = "Apple Distribution";/CODE_SIGN_IDENTITY = "";/g' Runner.xcodeproj/project.pbxproj
          
          echo "ğŸ“‹ ì„¤ì • í›„ í™•ì¸:"
          grep -n "CODE_SIGN_STYLE\|DEVELOPMENT_TEAM\|PROVISIONING_PROFILE_SPECIFIER" Runner.xcodeproj/project.pbxproj | head -10
          
          echo "âœ… Automatic Signing ì„¤ì • ì™„ë£Œ (íŒ¨ì¹˜ìš©)"
          echo "- CODE_SIGN_STYLE: Automatic (CodeMagic Integration ì‚¬ìš©)"
          echo "- DEVELOPMENT_TEAM: 24SL34R9HR"
          echo "- CODE_SIGN_IDENTITY: \"\" (ìë™ ì„ íƒ)"
          echo "- PROVISIONING_PROFILE_SPECIFIER: \"\" (ìë™ ì„ íƒ)"

      - name: Shorebird iOS Patch
        script: |
          cd picnic_app
          
          # í™˜ê²½ íŒŒì¼ì—ì„œ PATH ì„¤ì • ë¡œë“œ
          if [ -f "/tmp/shorebird_env.sh" ]; then
            source /tmp/shorebird_env.sh
          fi
          
          # PATHë¥¼ ëª…ì‹œì ìœ¼ë¡œ ì„¤ì •
          export PATH="$HOME/.shorebird/bin:$PATH"
          
          # Shorebird CLI ì¡´ì¬ í™•ì¸
          if [ ! -f "$HOME/.shorebird/bin/shorebird" ]; then
            echo "âŒ Shorebird CLIê°€ ì„¤ì¹˜ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤"
            echo "ì„¤ì¹˜ ë‹¨ê³„ë¥¼ ë‹¤ì‹œ í™•ì¸í•´ì£¼ì„¸ìš”"
            exit 1
          fi

          echo "=== Shorebird iOS íŒ¨ì¹˜ ì‹œì‘ ==="
          echo "Shorebird ë²„ì „ í™•ì¸:"
          "$HOME/.shorebird/bin/shorebird" --version || {
            echo "âš ï¸ ì§ì ‘ ê²½ë¡œë¡œ Shorebird ì‹¤í–‰ ì‹¤íŒ¨, PATH í™•ì¸ ì¤‘..."
            echo "PATH: $PATH"
            echo "which shorebird: $(which shorebird || echo 'not found')"
            echo "Shorebird íŒŒì¼ í™•ì¸: $(ls -la $HOME/.shorebird/bin/shorebird 2>/dev/null || echo 'not found')"
            exit 1
          }

          echo "=== Shorebird ì¸ì¦ í™•ì¸ ==="
          if [ -z "$SHOREBIRD_TOKEN" ]; then
            echo "âŒ SHOREBIRD_TOKEN í™˜ê²½ë³€ìˆ˜ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤"
            exit 1
          else
            echo "âœ… SHOREBIRD_TOKEN í™˜ê²½ë³€ìˆ˜ê°€ ì„¤ì •ë˜ì—ˆìŠµë‹ˆë‹¤"
          fi

          echo "=== Shorebird CLI ìƒíƒœ í™•ì¸ ==="
          echo "Shorebird ë²„ì „:"
          "$HOME/.shorebird/bin/shorebird" --version 2>/dev/null || echo "Shorebird ë²„ì „ í™•ì¸ ì‹¤íŒ¨"

          echo "=== Flutter ë¹Œë“œ í…ŒìŠ¤íŠ¸ ==="
          # íŒ¨ì¹˜ ìƒì„± ì „ì— Flutter ë¹Œë“œê°€ ì„±ê³µí•˜ëŠ”ì§€ í™•ì¸
          echo "ğŸ§ª Flutter IPA ë¹Œë“œ í…ŒìŠ¤íŠ¸ ì¤‘..."
          flutter build ios --release --dart-define=ENVIRONMENT=prod --analyze-size 2>/dev/null || {
            echo "âš ï¸ Flutter ë¹Œë“œ í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨ - ê¸°ë³¸ ë¹Œë“œ í™•ì¸"
            flutter build ios --release --dart-define=ENVIRONMENT=prod || echo "Flutter iOS ë¹Œë“œ í™•ì¸ ì‹¤íŒ¨"
          }

          echo "=== Shorebird ìºì‹œ ì •ë¦¬ ë° iOS íŒ¨ì¹˜ ì¤€ë¹„ ==="
          # Shorebird ìºì‹œ ì •ë¦¬
          "$HOME/.shorebird/bin/shorebird" cache clean
          
          # Flutter ìºì‹œ ì •ë¦¬
          flutter clean
          flutter pub get
          
          echo "=== iOS ë¹Œë“œ ë””ë ‰í† ë¦¬ ì¤€ë¹„ ==="
          # iOS ë¹Œë“œ ë””ë ‰í† ë¦¬ ë¯¸ë¦¬ ìƒì„±
          mkdir -p build/ios/iphoneos
          mkdir -p build/ios/Release-iphoneos

          echo "=== Shorebird iOS íŒ¨ì¹˜ ìƒì„± ë° ë°°í¬ ==="
          # íŒ¨ì¹˜ ìƒì„± (ê°€ì¥ ìµœì‹  ë¦´ë¦¬ì¦ˆì— ëŒ€í•œ íŒ¨ì¹˜)
          echo "ğŸš€ iOS íŒ¨ì¹˜ ìƒì„± ì‹œì‘ (ìë™ Flutter ë²„ì „ ê°ì§€)..."
          PATCH_RESULT=$("$HOME/.shorebird/bin/shorebird" patch ios \
            --release-version=latest \
            --no-confirm \
            --dart-define=ENVIRONMENT=prod \
            --verbose 2>&1)
          PATCH_EXIT_CODE=$?
          
          echo "íŒ¨ì¹˜ ê²°ê³¼ ì¶œë ¥:"
          echo "$PATCH_RESULT"
          
          # íŒ¨ì¹˜ ê²°ê³¼ í™•ì¸ ë° ì ì ˆí•œ ì²˜ë¦¬
          if [ $PATCH_EXIT_CODE -eq 0 ]; then
            if echo "$PATCH_RESULT" | grep -i "successfully\|completed\|deployed\|published patch"; then
              echo "=== Shorebird iOS íŒ¨ì¹˜ ì„±ê³µ ==="
              echo "âœ… iOS íŒ¨ì¹˜ê°€ Shorebirdë¥¼ í†µí•´ ì„±ê³µì ìœ¼ë¡œ ë°°í¬ë˜ì—ˆìŠµë‹ˆë‹¤"
              echo "ğŸš€ ì‚¬ìš©ìë“¤ì€ ì•±ì„ ì¬ì‹œì‘í•˜ë©´ ìë™ìœ¼ë¡œ íŒ¨ì¹˜ê°€ ì ìš©ë©ë‹ˆë‹¤"
              
              # íŒ¨ì¹˜ ì •ë³´ ì¶”ì¶œ ë° í‘œì‹œ
              if echo "$PATCH_RESULT" | grep -i "published patch"; then
                echo ""
                echo "ğŸ“± íŒ¨ì¹˜ ë°°í¬ ì •ë³´:"
                echo "$PATCH_RESULT" | grep -A 5 -i "ready to publish\|published patch" | tail -6
              fi
            else
              echo "=== Shorebird iOS íŒ¨ì¹˜ ë¶ˆì™„ì „ ==="
              echo "âš ï¸ íŒ¨ì¹˜ ëª…ë ¹ì–´ëŠ” ì„±ê³µí–ˆì§€ë§Œ ê²°ê³¼ê°€ ë¶ˆë¶„ëª…í•©ë‹ˆë‹¤"
              echo "íŒ¨ì¹˜ ê²°ê³¼ë¥¼ ë‹¤ì‹œ í™•ì¸í•´ì£¼ì„¸ìš”"
              exit 1
            fi
          else
            echo "=== Shorebird iOS íŒ¨ì¹˜ ì‹¤íŒ¨ ==="
            echo "âŒ iOS íŒ¨ì¹˜ ìƒì„±/ë°°í¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤ (ì¢…ë£Œ ì½”ë“œ: $PATCH_EXIT_CODE)"
            
            # ì‹¤íŒ¨ ì›ì¸ ë¶„ì„
            if echo "$PATCH_RESULT" | grep -i "no.*account\|profile"; then
              echo "ğŸ” ì„œëª… ê´€ë ¨ ë¬¸ì œë¡œ ë³´ì…ë‹ˆë‹¤:"
              echo "- CodeMagic iOS ì„œëª… ì„¤ì •ì„ í™•ì¸í•˜ì„¸ìš”"
              echo "- Apple Developer ê³„ì • ì—°ê²° ìƒíƒœë¥¼ í™•ì¸í•˜ì„¸ìš”"
              echo "- í”„ë¡œë¹„ì €ë‹ í”„ë¡œíŒŒì¼ ìœ íš¨ì„±ì„ í™•ì¸í•˜ì„¸ìš”"
            elif echo "$PATCH_RESULT" | grep -i "flutter.*build.*fail"; then
              echo "ğŸ” Flutter ë¹Œë“œ ë¬¸ì œë¡œ ë³´ì…ë‹ˆë‹¤:"
              echo "- Flutter ë²„ì „ í˜¸í™˜ì„±ì„ í™•ì¸í•˜ì„¸ìš”"
              echo "- ì˜ì¡´ì„± íŒ¨í‚¤ì§€ë“¤ì„ í™•ì¸í•˜ì„¸ìš”"
            elif echo "$PATCH_RESULT" | grep -i "no.*release"; then
              echo "ğŸ” ê¸°ì¡´ ë¦´ë¦¬ì¦ˆê°€ ì—†ëŠ” ë¬¸ì œë¡œ ë³´ì…ë‹ˆë‹¤"
            fi
            
            exit 1
          fi

    artifacts:
      - picnic_app/flutter_drive.log

    publishing:
      slack:
        channel: '#codemagic-picnic'
        notify_on_build_start: true
        notify:
          success: true
          failure: true
      email:
        recipients:
          - ironlove77@gmail.com
        notify:
          success: true
          failure: true

  # =================== PICNIC APP Android Patch (Shorebird) ===================
  picnic-app-patch-android:
    name: Picnic App - Android Patch (Shorebird)
    instance_type: mac_mini_m2
    max_build_duration: 60
    environment:
      android_signing:
        - picnic_keystore
      groups:
        - shorebird-config
        - picnic_env
      flutter: 3.32.4
      java: 17
      vars:
        PATH: $PATH:$HOME/.shorebird/bin
        APP_NAME: "picnic_app"
    cache:
      cache_paths:
        - $FLUTTER_ROOT/.pub-cache
        - $HOME/.gradle/caches
        - $HOME/.gradle/wrapper
        - $HOME/.android/build-cache
        - picnic_app/.dart_tool
        - picnic_app/android/.gradle
    triggering:
      events:
        - push
        - tag
      branch_patterns:
        - pattern: 'hotfix/*'
          include: true
        - pattern: 'patch/*'
          include: true
      tag_patterns:
        - pattern: 'picnic-patch-*'
          include: true
      cancel_previous_builds: true
    scripts:
      - name: Install Shorebird CLI
        script: |
          echo "=== Shorebird CLI ì„¤ì¹˜ ì‹œì‘ ==="
          
          # ê¸°ì¡´ Shorebird ì„¤ì¹˜ ê°•ì œ ì œê±° (ì¶©ëŒ ë°©ì§€)
          echo "ğŸ§¹ ê¸°ì¡´ Shorebird ì„¤ì¹˜ ì •ë¦¬ ì¤‘..."
          if [ -d "$HOME/.shorebird" ]; then
            rm -rf "$HOME/.shorebird"
            echo "âœ… ê¸°ì¡´ Shorebird ë””ë ‰í† ë¦¬ ì œê±° ì™„ë£Œ"
          fi
          
          # ìµœì‹  ì•ˆì • ë²„ì „ ì‚¬ìš© (v1.6.48)
          echo "ğŸ”§ Shorebird v1.6.48 ìµœì‹  ì•ˆì • ë²„ì „ ì„¤ì¹˜ ì¤‘..."
          
          # ê³µì‹ GitHub ì„¤ì¹˜ ìŠ¤í¬ë¦½íŠ¸ ì‚¬ìš© (ê°€ì¥ ì•ˆì •ì )
          echo "ğŸ“¥ ê³µì‹ ì„¤ì¹˜ ìŠ¤í¬ë¦½íŠ¸ë¡œ ìµœì‹  Shorebird ì„¤ì¹˜..."
          curl --proto '=https' --tlsv1.2 https://raw.githubusercontent.com/shorebirdtech/install/main/install.sh -sSf | bash
          
          export PATH="$HOME/.shorebird/bin:$PATH"
          
          echo "=== Shorebird ì„¤ì¹˜ í™•ì¸ ==="
          if command -v shorebird >/dev/null 2>&1; then
            shorebird --version
            echo "âœ… Shorebird ì„¤ì¹˜ ë° ì„¤ì • ì™„ë£Œ"
          else
            echo "âŒ Shorebird ì„¤ì¹˜ ì‹¤íŒ¨"
            exit 1
          fi
          
          # PATH ì„¤ì •ì„ í™˜ê²½ íŒŒì¼ë¡œ ì €ì¥ (ë‹¤ìŒ ë‹¨ê³„ì—ì„œ ì‚¬ìš©)
          echo "export PATH=\"$HOME/.shorebird/bin:\$PATH\"" > /tmp/shorebird_env.sh
          echo "âœ… Shorebird CLI ì„¤ì¹˜ ë° í™˜ê²½ ì„¤ì • ì™„ë£Œ"

      - name: Get Flutter packages
        script: |
          cd picnic_app
          flutter packages pub get

      - name: Verify Keystore Configuration
        script: |
          echo "=== í‚¤ìŠ¤í† ì–´ í™˜ê²½ ë³€ìˆ˜ í™•ì¸ ==="
          echo "CM_KEYSTORE_PATH: ${CM_KEYSTORE_PATH:-'ë¯¸ì„¤ì •'}"
          echo "CM_KEYSTORE_PASSWORD: ${CM_KEYSTORE_PASSWORD:-'ë¯¸ì„¤ì •'}"
          echo "CM_KEY_ALIAS: ${CM_KEY_ALIAS:-'ë¯¸ì„¤ì •'}"
          echo "CM_KEY_PASSWORD: ${CM_KEY_PASSWORD:-'ë¯¸ì„¤ì •'}"
          
          if [ -z "$CM_KEYSTORE_PATH" ] || [ -z "$CM_KEYSTORE_PASSWORD" ] || [ -z "$CM_KEY_ALIAS" ] || [ -z "$CM_KEY_PASSWORD" ]; then
            echo "âŒ í‚¤ìŠ¤í† ì–´ í™˜ê²½ ë³€ìˆ˜ê°€ ì˜¬ë°”ë¥´ê²Œ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤"
            echo "CodeMagic ëŒ€ì‹œë³´ë“œì—ì„œ 'picnic_keystore' ê·¸ë£¹ ì„¤ì •ì„ í™•ì¸í•´ì£¼ì„¸ìš”"
            exit 1
          fi
          
          if [ -f "$CM_KEYSTORE_PATH" ]; then
            echo "âœ… í‚¤ìŠ¤í† ì–´ íŒŒì¼ ì¡´ì¬: $CM_KEYSTORE_PATH"
            # í‚¤ìŠ¤í† ì–´ ì •ë³´ í™•ì¸
            keytool -list -v -keystore "$CM_KEYSTORE_PATH" -alias "$CM_KEY_ALIAS" -storepass "$CM_KEYSTORE_PASSWORD" | grep -E "(SHA1|SHA256|Subject|Issuer)" | head -3 || echo "í‚¤ìŠ¤í† ì–´ ì •ë³´ í™•ì¸ ì‹¤íŒ¨"
          else
            echo "âŒ í‚¤ìŠ¤í† ì–´ íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: $CM_KEYSTORE_PATH"
            exit 1
          fi

      - name: Configure Gradle Environment (Identical to Release)
        script: |
          cd picnic_app
          
          echo "=== Gradle ë©”ëª¨ë¦¬ ìµœì í™” ì„¤ì • (Shorebird í˜¸í™˜) ==="
          mkdir -p $HOME/.gradle
          # Shorebirdì™€ í˜¸í™˜ë˜ëŠ” ìµœì í™”ëœ Gradle ì„¤ì •
          echo "org.gradle.jvmargs=-Xmx6144m -XX:MaxMetaspaceSize=512m -XX:+HeapDumpOnOutOfMemoryError -Dfile.encoding=UTF-8" >> $HOME/.gradle/gradle.properties
          echo "org.gradle.daemon=true" >> $HOME/.gradle/gradle.properties
          echo "org.gradle.caching=true" >> $HOME/.gradle/gradle.properties
          echo "org.gradle.parallel=false" >> $HOME/.gradle/gradle.properties
          echo "android.enableJetifier=true" >> $HOME/.gradle/gradle.properties
          echo "android.useAndroidX=true" >> $HOME/.gradle/gradle.properties
          echo "android.enableR8.fullMode=false" >> $HOME/.gradle/gradle.properties

      - name: Shorebird Android Patch (Identical to Release)
        script: |
          cd picnic_app
          
          # í™˜ê²½ íŒŒì¼ì—ì„œ PATH ì„¤ì • ë¡œë“œ
          if [ -f "/tmp/shorebird_env.sh" ]; then
            source /tmp/shorebird_env.sh
          fi
          
          export PATH="$HOME/.shorebird/bin:$PATH"

          echo "=== Shorebird Android íŒ¨ì¹˜ ì‹œì‘ (ë¦´ë¦¬ì¦ˆì™€ ë™ì¼í•œ í™˜ê²½) ==="
          echo "Shorebird ë²„ì „ í™•ì¸:"
          "$HOME/.shorebird/bin/shorebird" --version

          echo "=== Shorebird ì¸ì¦ í™•ì¸ ==="
          if [ -z "$SHOREBIRD_TOKEN" ]; then
            echo "âŒ SHOREBIRD_TOKEN í™˜ê²½ë³€ìˆ˜ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤"
            exit 1
          else
            echo "âœ… SHOREBIRD_TOKEN í™˜ê²½ë³€ìˆ˜ê°€ ì„¤ì •ë˜ì—ˆìŠµë‹ˆë‹¤"
          fi

          echo "=== Shorebird ìºì‹œ ì •ë¦¬ ë° í™˜ê²½ ì¤€ë¹„ ==="
          "$HOME/.shorebird/bin/shorebird" cache clean
          flutter clean
          flutter pub get
          
          echo "=== ì‚¬ì „ Flutter ë¹Œë“œ (ë„¤ì´í‹°ë¸Œ ë¼ì´ë¸ŒëŸ¬ë¦¬ ìƒì„±) ==="
          # Shorebird ì‹¤í–‰ ì „ì— Flutter ë¹Œë“œë¡œ ë„¤ì´í‹°ë¸Œ ë¼ì´ë¸ŒëŸ¬ë¦¬ ìƒì„±
          echo "ğŸ”§ Flutter AAB ë¹Œë“œë¥¼ í†µí•œ ë„¤ì´í‹°ë¸Œ ë¼ì´ë¸ŒëŸ¬ë¦¬ ìƒì„±..."
          flutter build appbundle --release --dart-define=ENVIRONMENT=prod || {
            echo "âš ï¸ Flutter ë¹Œë“œ ì‹¤íŒ¨ - ê³„ì† ì§„í–‰"
          }
          
          echo "=== ë„¤ì´í‹°ë¸Œ ë¼ì´ë¸ŒëŸ¬ë¦¬ ì‚¬ì „ ë³µì‚¬ (Shorebird í˜¸í™˜) ==="
          # ì‹¤ì œ ë„¤ì´í‹°ë¸Œ ë¼ì´ë¸ŒëŸ¬ë¦¬ ìœ„ì¹˜ë“¤ (ì—¬ëŸ¬ ê°€ëŠ¥í•œ ê²½ë¡œ)
          POSSIBLE_NATIVE_PATHS=(
            "android/app/build/intermediates/stripped_native_libs/release/stripReleaseDebugSymbols/out/lib"
            "android/app/build/intermediates/stripped_native_libs/release/out/lib"
            "android/app/build/intermediates/merged_native_libs/release/out/lib"
          )
          
          # Shorebirdê°€ ì°¾ëŠ” ìœ„ì¹˜ë“¤
          EXPECTED_PATHS=(
            "build/app/intermediates/stripped_native_libs/release/out/lib"
            "build/app/intermediates/stripped_native_libs/stripReleaseDebugSymbols/release/out/lib"
          )
          
          NATIVE_FOUND=false
          for REAL_NATIVE_PATH in "${POSSIBLE_NATIVE_PATHS[@]}"; do
            if [ -d "$REAL_NATIVE_PATH" ]; then
              echo "âœ… ë„¤ì´í‹°ë¸Œ ë¼ì´ë¸ŒëŸ¬ë¦¬ ë°œê²¬: $REAL_NATIVE_PATH"
              ls -la "$REAL_NATIVE_PATH" 2>/dev/null || echo "ë””ë ‰í† ë¦¬ ë‚´ìš© í™•ì¸ ë¶ˆê°€"
              NATIVE_FOUND=true
              
              for EXPECTED_PATH in "${EXPECTED_PATHS[@]}"; do
                echo "ğŸ“ ì‚¬ì „ ë³µì‚¬: $REAL_NATIVE_PATH -> $EXPECTED_PATH"
                mkdir -p "$(dirname "$EXPECTED_PATH")"
                cp -r "$REAL_NATIVE_PATH" "$(dirname "$EXPECTED_PATH")/"
                
                if [ -d "$EXPECTED_PATH" ]; then
                  echo "âœ… ì‚¬ì „ ë³µì‚¬ ì„±ê³µ: $EXPECTED_PATH"
                  find "$EXPECTED_PATH" -name "*.so" | head -3
                else
                  echo "âŒ ì‚¬ì „ ë³µì‚¬ ì‹¤íŒ¨: $EXPECTED_PATH"
                fi
              done
              break
            fi
          done
          
          if [ "$NATIVE_FOUND" = false ]; then
            echo "âš ï¸ ë„¤ì´í‹°ë¸Œ ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ"
            echo "ğŸ“‹ ê°€ëŠ¥í•œ ìœ„ì¹˜ë“¤ í™•ì¸:"
            find android/app/build/intermediates/ -name "*.so" -type f 2>/dev/null | head -5 || echo "ë„¤ì´í‹°ë¸Œ ë¼ì´ë¸ŒëŸ¬ë¦¬ íŒŒì¼ ì—†ìŒ"
          fi
          
          echo "=== Shorebird Android íŒ¨ì¹˜ ì‹¤í–‰ ==="
          echo "ğŸš€ Shorebirdë¡œ Android íŒ¨ì¹˜ ìƒì„± ë° ë°°í¬..."
          
          PATCH_RESULT=$("$HOME/.shorebird/bin/shorebird" patch android \
            --release-version=latest \
            --no-confirm \
            --dart-define=ENVIRONMENT=prod 2>&1)
          PATCH_EXIT_CODE=$?
          
          echo "íŒ¨ì¹˜ ê²°ê³¼:"
          echo "$PATCH_RESULT"
          
          # íŒ¨ì¹˜ ê²°ê³¼ í™•ì¸
          if [ $PATCH_EXIT_CODE -eq 0 ]; then
            if echo "$PATCH_RESULT" | grep -i "successfully\|completed\|deployed\|published patch"; then
              echo "=== Shorebird Android íŒ¨ì¹˜ ì„±ê³µ ==="
              echo "âœ… Android íŒ¨ì¹˜ê°€ Shorebirdë¥¼ í†µí•´ ì„±ê³µì ìœ¼ë¡œ ë°°í¬ë˜ì—ˆìŠµë‹ˆë‹¤"
              echo "ğŸš€ ì‚¬ìš©ìë“¤ì€ ì•±ì„ ì¬ì‹œì‘í•˜ë©´ ìë™ìœ¼ë¡œ íŒ¨ì¹˜ê°€ ì ìš©ë©ë‹ˆë‹¤"
              
              # íŒ¨ì¹˜ ì •ë³´ ì¶”ì¶œ ë° í‘œì‹œ
              if echo "$PATCH_RESULT" | grep -i "published patch"; then
                echo ""
                echo "ğŸ“± íŒ¨ì¹˜ ë°°í¬ ì •ë³´:"
                echo "$PATCH_RESULT" | grep -i "published patch" | head -3
              fi
            else
              echo "=== Shorebird Android íŒ¨ì¹˜ ì¬ì‹œë„ í•„ìš” ==="
              echo "âš ï¸ íŒ¨ì¹˜ ê²°ê³¼ê°€ ë¶ˆë¶„ëª…í•©ë‹ˆë‹¤. ì¬ì‹œë„í•©ë‹ˆë‹¤..."
              sleep 5
              
              echo "ğŸ”„ Android íŒ¨ì¹˜ ì¬ì‹œë„..."
              RETRY_RESULT=$("$HOME/.shorebird/bin/shorebird" patch android \
                --release-version=latest \
                --no-confirm \
                --dart-define=ENVIRONMENT=prod 2>&1)
              RETRY_EXIT_CODE=$?
              
              if [ $RETRY_EXIT_CODE -eq 0 ]; then
                echo "âœ… ì¬ì‹œë„ ì„±ê³µ!"
                echo "$RETRY_RESULT"
              else
                echo "âŒ ì¬ì‹œë„ë„ ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤."
                echo "$RETRY_RESULT"
                exit 1
              fi
            fi
          else
            echo "=== Shorebird Android íŒ¨ì¹˜ ì‹¤íŒ¨ ==="
            echo "âŒ Android íŒ¨ì¹˜ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤ (ì¢…ë£Œ ì½”ë“œ: $PATCH_EXIT_CODE)"
            
            # ì‹¤íŒ¨ ì›ì¸ ë¶„ì„
            if echo "$PATCH_RESULT" | grep -i "keystore\|signing"; then
              echo "ğŸ” ì„œëª… ê´€ë ¨ ë¬¸ì œë¡œ ë³´ì…ë‹ˆë‹¤"
            elif echo "$PATCH_RESULT" | grep -i "flutter.*build.*fail\|gradle.*fail"; then
              echo "ğŸ” Flutter/Gradle ë¹Œë“œ ë¬¸ì œë¡œ ë³´ì…ë‹ˆë‹¤"
            elif echo "$PATCH_RESULT" | grep -i "no.*release\|app.*not.*found"; then
              echo "ğŸ” ê¸°ì¡´ ë¦´ë¦¬ì¦ˆ ì—†ìŒ ë¬¸ì œë¡œ ë³´ì…ë‹ˆë‹¤"
            elif echo "$PATCH_RESULT" | grep -i "cannot.*find.*artifacts"; then
              echo "ğŸ” ë¹Œë“œ ì•„í‹°íŒ©íŠ¸ ë¬¸ì œë¡œ ë³´ì…ë‹ˆë‹¤"
            fi
            
            exit 1
          fi

    artifacts:
      - picnic_app/flutter_drive.log

    publishing:
      slack:
        channel: '#codemagic-picnic'
        notify_on_build_start: true
        notify:
          success: true
          failure: true
      email:
        recipients:
          - ironlove77@gmail.com
        notify:
          success: true
          failure: true