workflows:
  # =================== PICNIC APP iOS ===================
  picnic-app-ios:
    name: Picnic App - iOS
    instance_type: mac_mini_m2
    max_build_duration: 120
    integrations:
      app_store_connect: codemagic-picnic
    environment:
      ios_signing:
        distribution_type: app_store
        bundle_identifier: io.iconcasting.picnic.app
      groups:
        - app_store_connect
        - shorebird-config
        - picnic_env
      flutter: 3.32.4
      vars:
        APP_NAME: "picnic_app"
        BUNDLE_ID: "io.iconcasting.picnic.app"
    cache:
      cache_paths:
        - $FLUTTER_ROOT/.pub-cache
        - $HOME/.gradle/caches
        - $HOME/Library/Caches/CocoaPods
    triggering:
      events:
        - push
        - tag
      branch_patterns:
        - pattern: 'production'
          include: true
      tag_patterns:
        - pattern: 'picnic-v*'
          include: true
      cancel_previous_builds: true
    scripts:
      - name: Get Flutter packages and prepare iOS
        script: |
          cd picnic_app
          echo "=== Flutter 패키지 설치 ==="
          flutter packages pub get
          
          echo "=== Flutter iOS 설정 생성 (Generated.xcconfig 파일 생성) ==="
          flutter precache --ios
          flutter build ios --config-only
          
          echo "=== Generated.xcconfig 파일 확인 ==="
          ls -la ios/Flutter/Generated.xcconfig || echo "⚠️ Generated.xcconfig 파일이 아직 생성되지 않음"

      - name: Install CocoaPods dependencies
        script: |
          cd picnic_app
          
          echo "=== Generated.xcconfig 파일 확인 ==="
          if [ ! -f "ios/Flutter/Generated.xcconfig" ]; then
            echo "⚠️ Generated.xcconfig 파일이 없음 - Flutter 설정 재생성"
            flutter build ios --config-only
          fi
          
          echo "✅ Generated.xcconfig 파일 존재 확인:"
          ls -la ios/Flutter/Generated.xcconfig
          
          echo "=== CocoaPods 설치 시작 ==="
          cd ios
          pod install

      - name: Install Shorebird CLI
        script: |
          echo "=== Shorebird CLI 설치 시작 ==="
          
          # 기존 Shorebird 설치 강제 제거 (충돌 방지)
          echo "🧹 기존 Shorebird 설치 정리 중..."
          if [ -d "$HOME/.shorebird" ]; then
            rm -rf "$HOME/.shorebird"
            echo "✅ 기존 Shorebird 디렉토리 제거 완료"
          fi
          
          # 최신 안정 버전 사용 (v1.6.48)
          echo "🔧 Shorebird v1.6.48 최신 안정 버전 설치 중..."
          
          # 공식 GitHub 설치 스크립트 사용 (가장 안정적)
          echo "📥 공식 설치 스크립트로 최신 Shorebird 설치..."
          curl --proto '=https' --tlsv1.2 https://raw.githubusercontent.com/shorebirdtech/install/main/install.sh -sSf | bash
          
          export PATH="$HOME/.shorebird/bin:$PATH"
          
          echo "=== Shorebird 설치 확인 ==="
          if command -v shorebird >/dev/null 2>&1; then
            shorebird --version
            echo "✅ Shorebird 설치 및 설정 완료"
          else
            echo "❌ Shorebird 설치 실패"
            exit 1
          fi

      - name: Verify iOS Signing Configuration
        script: |
          echo "=== iOS 서명 환경 확인 ==="
          echo "DEVELOPMENT_TEAM: ${DEVELOPMENT_TEAM:-'24SL34R9HR'}"
          
          # Distribution Certificate 정보 확인
          DIST_CERT_INFO=$(security find-identity -v -p codesigning | grep -i distribution | head -1)
          if [ -n "$DIST_CERT_INFO" ]; then
            echo "✅ Distribution 인증서: $DIST_CERT_INFO"
          else
            echo "❌ Distribution 인증서를 찾을 수 없음"
            echo "사용 가능한 인증서들:"
            security find-identity -v -p codesigning
            exit 1
          fi
          
          # Provisioning Profile 정보 확인
          PROFILE_COUNT=$(find "$HOME/Library/MobileDevice/Provisioning Profiles" -name "*.mobileprovision" 2>/dev/null | wc -l)
          echo "설치된 프로비저닝 프로파일 개수: $PROFILE_COUNT개"
          
          if [ "$PROFILE_COUNT" -gt 0 ]; then
            echo "✅ 프로비저닝 프로파일 목록:"
            find "$HOME/Library/MobileDevice/Provisioning Profiles" -name "*.mobileprovision" 2>/dev/null | while read profile; do
              PROFILE_NAME=$(security cms -D -i "$profile" 2>/dev/null | grep -A1 "<key>Name</key>" | tail -1 | sed 's/.*<string>\(.*\)<\/string>.*/\1/' | tr -d '\n')
              echo "  - $(basename "$profile" .mobileprovision): $PROFILE_NAME"
            done
          else
            echo "❌ 프로비저닝 프로파일을 찾을 수 없음"
            exit 1
          fi

      - name: Configure Xcode Project for Manual Signing
        script: |
          cd picnic_app/ios
          
          echo "=== Xcode 프로젝트 Manual Signing 설정 ==="
          # Manual Signing 강제 설정 (Distribution 인증서 사용)
          echo "📝 Manual Signing 강제 활성화..."
          sed -i '' "s/CODE_SIGN_STYLE = Automatic;/CODE_SIGN_STYLE = Manual;/g" Runner.xcodeproj/project.pbxproj
          sed -i '' "s/CODE_SIGN_IDENTITY = \"\";/CODE_SIGN_IDENTITY = \"Apple Distribution\";/g" Runner.xcodeproj/project.pbxproj
          sed -i '' "s/CODE_SIGN_IDENTITY = \"Apple Development\";/CODE_SIGN_IDENTITY = \"Apple Distribution\";/g" Runner.xcodeproj/project.pbxproj
          sed -i '' "s/\"CODE_SIGN_IDENTITY\[sdk=iphoneos\*\]\" = \"iPhone Developer\";/\"CODE_SIGN_IDENTITY[sdk=iphoneos*]\" = \"Apple Distribution\";/g" Runner.xcodeproj/project.pbxproj
          
          # 프로비저닝 프로파일 설정
          sed -i '' "s/PROVISIONING_PROFILE_SPECIFIER = \"\";/PROVISIONING_PROFILE_SPECIFIER = \"picnic_app_profile_2025\";/g" Runner.xcodeproj/project.pbxproj
          
          # PROVISIONING_PROFILE_SPECIFIER 추가 (존재하지 않는 경우)
          if ! grep -q "PROVISIONING_PROFILE_SPECIFIER" Runner.xcodeproj/project.pbxproj; then
            sed -i '' '/DEVELOPMENT_TEAM = /a\
          PROVISIONING_PROFILE_SPECIFIER = "picnic_app_profile_2025";' Runner.xcodeproj/project.pbxproj
          fi
          
          # Development Team 설정 유지
          sed -i '' "s/DEVELOPMENT_TEAM = \"\";/DEVELOPMENT_TEAM = \"24SL34R9HR\";/g" Runner.xcodeproj/project.pbxproj
          sed -i '' "s/DEVELOPMENT_TEAM = 24SL34R9HR;/DEVELOPMENT_TEAM = \"24SL34R9HR\";/g" Runner.xcodeproj/project.pbxproj
          
          echo "✅ Manual Signing 설정 완료"
          echo "- CODE_SIGN_STYLE: Manual"  
          echo "- DEVELOPMENT_TEAM: 24SL34R9HR"
          echo "- CODE_SIGN_IDENTITY: Apple Distribution"
          echo "- PROVISIONING_PROFILE_SPECIFIER: picnic_app_profile_2025"

      - name: Shorebird iOS Release (Unified Build & Deploy)
        script: |
          export PATH="$HOME/.shorebird/bin:$PATH"
          cd picnic_app

          echo "=== Shorebird 통합 iOS 빌드 & 릴리즈 시작 ==="
          echo "🎯 릴리즈와 패치의 일관된 빌드 환경을 위해 Shorebird로 직접 빌드합니다"
          echo ""

          echo "=== Shorebird 버전 확인 ==="
          shorebird --version

          echo "=== Shorebird 인증 확인 ==="
          if [ -z "$SHOREBIRD_TOKEN" ]; then
            echo "❌ SHOREBIRD_TOKEN 환경변수가 설정되지 않았습니다"
            exit 1
          else
            echo "✅ SHOREBIRD_TOKEN 환경변수가 설정되었습니다"
          fi

          echo "=== iOS 서명 환경 최종 확인 ==="
          echo "✅ Manual Signing 설정 완료"
          echo "✅ Bundle ID: io.iconcasting.picnic.app"
          echo "✅ Distribution Type: App Store"
          echo "✅ Development Team: 24SL34R9HR"
          echo "✅ Provisioning Profile: picnic_app_profile_2025"

          echo "=== Shorebird 캐시 정리 및 환경 준비 ==="
          shorebird cache clean
          flutter clean
          flutter pub get

          echo "=== Shorebird iOS 통합 릴리즈 실행 ==="
          echo "🚀 Shorebird로 iOS 빌드 및 릴리즈 (최신 Flutter 엔진 사용)..."
          RELEASE_RESULT=$(shorebird release ios --dart-define=ENVIRONMENT=prod --flutter-version=latest 2>&1)
          RELEASE_EXIT_CODE=$?
          
          echo "릴리즈 결과:"
          echo "$RELEASE_RESULT"
          
          # 릴리즈 결과 확인
          if [ $RELEASE_EXIT_CODE -eq 0 ]; then
            if echo "$RELEASE_RESULT" | grep -i "successfully\|completed\|deployed\|published\|release.*created"; then
              echo "=== Shorebird iOS 통합 릴리즈 성공 ==="
              echo "✅ iOS 앱이 Shorebird Flutter 엔진으로 빌드되어 성공적으로 배포되었습니다"
              echo "🎯 이제 패치 워크플로우와 동일한 빌드 환경을 사용합니다"
              
              # 릴리즈 정보 추출 및 표시
              if echo "$RELEASE_RESULT" | grep -i "release.*version\|build.*version"; then
                echo ""
                echo "📱 릴리즈 정보:"
                echo "$RELEASE_RESULT" | grep -i "release.*version\|build.*version" | head -3
              fi
            else
              echo "=== Shorebird iOS 릴리즈 재시도 필요 ==="
              echo "⚠️ 릴리즈 결과가 불분명합니다. 재시도합니다..."
              sleep 5
              
              echo "🔄 iOS 릴리즈 재시도 (최신 Flutter)..."
              RETRY_RESULT=$(shorebird release ios --dart-define=ENVIRONMENT=prod --flutter-version=latest 2>&1)
              RETRY_EXIT_CODE=$?
              
              if [ $RETRY_EXIT_CODE -eq 0 ]; then
                echo "✅ 재시도 성공!"
                echo "$RETRY_RESULT"
              else
                echo "❌ 재시도도 실패했습니다."
                echo "$RETRY_RESULT"
                exit 1
              fi
            fi
          else
            echo "=== Shorebird iOS 릴리즈 실패 ==="
            echo "❌ iOS 릴리즈에 실패했습니다 (종료 코드: $RELEASE_EXIT_CODE)"
            
            # 실패 원인 분석
            if echo "$RELEASE_RESULT" | grep -i "no.*account\|profile"; then
              echo "🔍 서명 관련 문제로 보입니다"
            elif echo "$RELEASE_RESULT" | grep -i "flutter.*build.*fail"; then
              echo "🔍 Flutter 빌드 문제로 보입니다"
            elif echo "$RELEASE_RESULT" | grep -i "no.*release\|app.*not.*found"; then
              echo "🔍 앱 등록 문제로 보입니다"
            fi
            
            exit 1
          fi

          echo "=== 최종 결과 ==="
          echo "✅ Shorebird 통합 iOS 빌드 & 릴리즈 완료!"
          echo "🎯 패치 워크플로우와 동일한 Shorebird Flutter 엔진 사용"
          echo "🔄 비결정론적 빌드 문제 해결 예상"

    artifacts:
      - picnic_app/build/ios/**/*.ipa
      - picnic_app/build/ios/**/*.xcarchive
      - picnic_app/flutter_drive.log

    publishing:
      app_store_connect:
        auth: integration
        submit_to_testflight: true
        beta_groups:
          - App Store Connect Users
      slack:
        channel: '#codemagic-picnic'
        notify_on_build_start: true
        notify:
          success: true
          failure: true
      email:
        recipients:
          - ironlove77@gmail.com
        notify:
          success: true
          failure: true

  # =================== PICNIC APP Android ===================
  picnic-app-android:
    name: Picnic App - Android
    instance_type: mac_mini_m2
    max_build_duration: 120
    environment:
      android_signing:
        - picnic_keystore
      groups:
        - google_play
        - shorebird-config
        - picnic_env
      flutter: 3.32.4
      java: 17
      vars:
        PATH: $PATH:$HOME/.shorebird/bin
        APP_NAME: "picnic_app"
        # CodeMagic이 android_signing을 인식하도록 강제 설정
        FLUTTER_BUILD_MODE: "release"
    cache:
      cache_paths:
        - $FLUTTER_ROOT/.pub-cache
        - $HOME/.gradle/caches
        - $HOME/.gradle/wrapper
        - $HOME/.android/build-cache
        - $HOME/Library/Caches/CocoaPods
        - picnic_app/.dart_tool
        - picnic_app/android/.gradle
    triggering:
      events:
        - push
        - tag
      # production 브랜치 푸시 및 태그로 트리거
      branch_patterns:
        - pattern: 'production'
          include: true
      tag_patterns:
        - pattern: 'picnic-v*'
          include: true
      cancel_previous_builds: true
    scripts:
      - name: Install Shorebird CLI
        script: |
          echo "=== Shorebird CLI 설치 시작 ==="
          
          # 기존 Shorebird 설치 강제 제거 (충돌 방지)
          echo "🧹 기존 Shorebird 설치 정리 중..."
          if [ -d "$HOME/.shorebird" ]; then
            rm -rf "$HOME/.shorebird"
            echo "✅ 기존 Shorebird 디렉토리 제거 완료"
          fi
          
          # 최신 안정 버전 사용 (v1.6.48)
          echo "🔧 Shorebird v1.6.48 최신 안정 버전 설치 중..."
          
          # 공식 GitHub 설치 스크립트 사용 (가장 안정적)
          echo "📥 공식 설치 스크립트로 최신 Shorebird 설치..."
          curl --proto '=https' --tlsv1.2 https://raw.githubusercontent.com/shorebirdtech/install/main/install.sh -sSf | bash
          
          export PATH="$HOME/.shorebird/bin:$PATH"
          
          echo "=== Shorebird 설치 확인 ==="
          if command -v shorebird >/dev/null 2>&1; then
            shorebird --version
            echo "✅ Shorebird 설치 및 설정 완료"
          else
            echo "❌ Shorebird 설치 실패"
            exit 1
          fi

      - name: Get Flutter packages
        script: |
          cd picnic_app
          flutter packages pub get

      - name: Verify Keystore Configuration
        script: |
          echo "=== 키스토어 환경 변수 확인 ==="
          echo "CM_KEYSTORE_PATH: ${CM_KEYSTORE_PATH:-'미설정'}"
          echo "CM_KEYSTORE_PASSWORD: ${CM_KEYSTORE_PASSWORD:-'미설정'}"
          echo "CM_KEY_ALIAS: ${CM_KEY_ALIAS:-'미설정'}"
          echo "CM_KEY_PASSWORD: ${CM_KEY_PASSWORD:-'미설정'}"
          
          if [ -z "$CM_KEYSTORE_PATH" ] || [ -z "$CM_KEYSTORE_PASSWORD" ] || [ -z "$CM_KEY_ALIAS" ] || [ -z "$CM_KEY_PASSWORD" ]; then
            echo "❌ 키스토어 환경 변수가 올바르게 설정되지 않았습니다"
            echo "CodeMagic 대시보드에서 'picnic_keystore' 그룹 설정을 확인해주세요"
            exit 1
          fi
          
          if [ -f "$CM_KEYSTORE_PATH" ]; then
            echo "✅ 키스토어 파일 존재: $CM_KEYSTORE_PATH"
            # 키스토어 정보 확인
            keytool -list -v -keystore "$CM_KEYSTORE_PATH" -alias "$CM_KEY_ALIAS" -storepass "$CM_KEYSTORE_PASSWORD" | grep -E "(SHA1|SHA256|Subject|Issuer)" || echo "키스토어 정보 확인 실패"
          else
            echo "❌ 키스토어 파일을 찾을 수 없습니다: $CM_KEYSTORE_PATH"
            exit 1
          fi

      - name: Shorebird Android Release (Unified Build & Deploy)
        script: |
          cd picnic_app
          
          echo "=== Shorebird 통합 Android 빌드 & 릴리즈 시작 ==="
          echo "🎯 릴리즈와 패치의 일관된 빌드 환경을 위해 Shorebird로 직접 빌드합니다"
          echo ""
          
          # Shorebird PATH 설정
          export PATH="$HOME/.shorebird/bin:$PATH"

          echo "=== Shorebird 버전 확인 ==="
          shorebird --version

          echo "=== Shorebird 인증 확인 ==="
          if [ -z "$SHOREBIRD_TOKEN" ]; then
            echo "❌ SHOREBIRD_TOKEN 환경변수가 설정되지 않았습니다"
            exit 1
          else
            echo "✅ SHOREBIRD_TOKEN 환경변수가 설정되었습니다"
          fi

          echo "=== Android 서명 환경 최종 확인 ==="
          echo "✅ Android Signing 설정 완료"
          echo "✅ 키스토어 경로: $CM_KEYSTORE_PATH"
          echo "✅ 키 별칭: $CM_KEY_ALIAS"
          echo "✅ 서명 검증 완료"

          echo "=== Gradle 메모리 최적화 설정 (Shorebird 호환) ==="
          mkdir -p $HOME/.gradle
          # Shorebird와 호환되는 최적화된 Gradle 설정
          echo "org.gradle.jvmargs=-Xmx6144m -XX:MaxMetaspaceSize=512m -XX:+HeapDumpOnOutOfMemoryError -Dfile.encoding=UTF-8" >> $HOME/.gradle/gradle.properties
          echo "org.gradle.daemon=true" >> $HOME/.gradle/gradle.properties
          echo "org.gradle.caching=true" >> $HOME/.gradle/gradle.properties
          echo "org.gradle.parallel=false" >> $HOME/.gradle/gradle.properties
          echo "android.enableJetifier=true" >> $HOME/.gradle/gradle.properties
          echo "android.useAndroidX=true" >> $HOME/.gradle/gradle.properties
          echo "android.enableR8.fullMode=false" >> $HOME/.gradle/gradle.properties

          echo "=== Shorebird 캐시 정리 및 환경 준비 ==="
          shorebird cache clean
          flutter clean
          flutter pub get

          echo "=== Shorebird Android 통합 릴리즈 실행 ==="
          echo "🚀 Shorebird로 Android 빌드 및 릴리즈 (최신 Flutter 엔진 사용)..."
          echo "📋 빌드 전 디렉토리 상태 확인..."
          ls -la build/ || echo "build 디렉토리 없음"
          
          RELEASE_RESULT=$(shorebird release android --dart-define=ENVIRONMENT=prod --flutter-version=latest 2>&1)
          RELEASE_EXIT_CODE=$?
          
          echo "📋 빌드 후 디렉토리 상태 확인..."
          find build/ -name "*.aab" -type f 2>/dev/null || echo "AAB 파일 없음"
          echo "📋 Gradle 태스크로 AAB 파일 위치 수정 확인..."
          ls -la build/app/outputs/bundle/release/ 2>/dev/null || echo "예상 위치에 AAB 없음"
          
          echo "=== 네이티브 라이브러리 복사 (Shorebird 호환) ==="
          # 실제 네이티브 라이브러리 위치
          REAL_NATIVE_PATH="android/app/build/intermediates/stripped_native_libs/release/stripReleaseDebugSymbols/out/lib"
          # Shorebird가 찾는 위치들
          EXPECTED_PATHS=(
            "build/app/intermediates/stripped_native_libs/release/out/lib"
            "build/app/intermediates/stripped_native_libs/stripReleaseDebugSymbols/release/out/lib"
          )
          
          if [ -d "$REAL_NATIVE_PATH" ]; then
            echo "✅ 네이티브 라이브러리 발견: $REAL_NATIVE_PATH"
            ls -la "$REAL_NATIVE_PATH" 2>/dev/null || echo "디렉토리 내용 확인 불가"
            
            for EXPECTED_PATH in "${EXPECTED_PATHS[@]}"; do
              echo "📁 네이티브 라이브러리 복사: $REAL_NATIVE_PATH -> $EXPECTED_PATH"
              mkdir -p "$(dirname "$EXPECTED_PATH")"
              cp -r "$REAL_NATIVE_PATH" "$(dirname "$EXPECTED_PATH")/"
              
              if [ -d "$EXPECTED_PATH" ]; then
                echo "✅ 복사 성공: $EXPECTED_PATH"
                find "$EXPECTED_PATH" -name "*.so" | head -5
              else
                echo "❌ 복사 실패: $EXPECTED_PATH"
              fi
            done
          else
            echo "⚠️ 네이티브 라이브러리 없음: $REAL_NATIVE_PATH"
            echo "📋 가능한 위치들 확인:"
            find android/app/build/intermediates/ -name "*.so" -type f 2>/dev/null | head -5 || echo "네이티브 라이브러리 파일 없음"
          fi
          
          echo "릴리즈 결과:"
          echo "$RELEASE_RESULT"
          
          # 릴리즈 결과 확인
          if [ $RELEASE_EXIT_CODE -eq 0 ]; then
            if echo "$RELEASE_RESULT" | grep -i "successfully\|completed\|deployed\|published\|release.*created"; then
              echo "=== Shorebird Android 통합 릴리즈 성공 ==="
              echo "✅ Android 앱이 Shorebird Flutter 엔진으로 빌드되어 성공적으로 배포되었습니다"
              echo "🎯 이제 패치 워크플로우와 동일한 빌드 환경을 사용합니다"
              
              # 릴리즈 정보 추출 및 표시
              if echo "$RELEASE_RESULT" | grep -i "release.*version\|build.*version"; then
                echo ""
                echo "📱 릴리즈 정보:"
                echo "$RELEASE_RESULT" | grep -i "release.*version\|build.*version" | head -3
              fi
            else
              echo "=== Shorebird Android 릴리즈 재시도 필요 ==="
              echo "⚠️ 릴리즈 결과가 불분명합니다. 재시도합니다..."
              sleep 5
              
              echo "🔄 Android 릴리즈 재시도 (최신 Flutter)..."
              RETRY_RESULT=$(shorebird release android --dart-define=ENVIRONMENT=prod --flutter-version=latest 2>&1)
              RETRY_EXIT_CODE=$?
              
              if [ $RETRY_EXIT_CODE -eq 0 ]; then
                echo "✅ 재시도 성공!"
                echo "$RETRY_RESULT"
              else
                echo "❌ 재시도도 실패했습니다."
                echo "$RETRY_RESULT"
                exit 1
              fi
            fi
          else
            echo "=== Shorebird Android 릴리즈 실패 ==="
            echo "❌ Android 릴리즈에 실패했습니다 (종료 코드: $RELEASE_EXIT_CODE)"
            
            # 실패 원인 분석
            if echo "$RELEASE_RESULT" | grep -i "keystore\|signing"; then
              echo "🔍 서명 관련 문제로 보입니다"
            elif echo "$RELEASE_RESULT" | grep -i "flutter.*build.*fail"; then
              echo "🔍 Flutter 빌드 문제로 보입니다"
            elif echo "$RELEASE_RESULT" | grep -i "no.*release\|app.*not.*found"; then
              echo "🔍 앱 등록 문제로 보입니다"
            fi
            
            exit 1
          fi

          echo "=== 최종 결과 ==="
          echo "✅ Shorebird 통합 Android 빌드 & 릴리즈 완료!"
          echo "🎯 패치 워크플로우와 동일한 Shorebird Flutter 엔진 사용"
          echo "🔄 비결정론적 빌드 문제 해결 예상"
          echo "📦 AAB/APK 파일이 자동으로 Shorebird에 의해 생성 및 배포됨"

    artifacts:
      - picnic_app/build/**/outputs/**/*.aab
      - picnic_app/build/**/outputs/**/*.apk
      - picnic_app/build/**/outputs/**/mapping.txt
      - picnic_app/flutter_drive.log

    publishing:
      google_play:
        credentials: $GCLOUD_SERVICE_ACCOUNT_CREDENTIALS
        track: internal
        submit_as_draft: true
      slack:
        channel: '#codemagic-picnic'
        notify_on_build_start: true
        notify:
          success: true
          failure: true
      email:
        recipients:
          - ironlove77@gmail.com
        notify:
          success: true
          failure: true

  # =================== PICNIC APP iOS Patch (Shorebird) ===================
  picnic-app-patch-ios:
    name: Picnic App - iOS Patch (Shorebird)
    instance_type: mac_mini_m2
    max_build_duration: 60
    integrations:
      app_store_connect: codemagic-picnic
    environment:
      ios_signing:
        distribution_type: app_store
        bundle_identifier: io.iconcasting.picnic.app
      groups:
        - app_store_connect
        - shorebird-config
        - picnic_env
      flutter: 3.32.4
      vars:
        APP_NAME: "picnic_app"
        BUNDLE_ID: "io.iconcasting.picnic.app"
    cache:
      cache_paths:
        - $FLUTTER_ROOT/.pub-cache
        - $HOME/.gradle/caches
        - $HOME/Library/Caches/CocoaPods
    triggering:
      events:
        - push
        - tag
      # hotfix, patch 브랜치와 patch 태그로 트리거
      branch_patterns:
        - pattern: 'hotfix/*'
          include: true
        - pattern: 'patch/*'
          include: true
      tag_patterns:
        - pattern: 'picnic-patch-*'
          include: true
      cancel_previous_builds: true
    scripts:
      - name: Install Shorebird CLI
        script: |
          echo "=== Shorebird CLI 설치 시작 ==="
          
          # 기존 Shorebird 설치 강제 제거 (충돌 방지)
          echo "🧹 기존 Shorebird 설치 정리 중..."
          if [ -d "$HOME/.shorebird" ]; then
            rm -rf "$HOME/.shorebird"
            echo "✅ 기존 Shorebird 디렉토리 제거 완료"
          fi
          
          # 최신 안정 버전 사용 (v1.6.48)
          echo "🔧 Shorebird v1.6.48 최신 안정 버전 설치 중..."
          
          # 공식 GitHub 설치 스크립트 사용 (가장 안정적)
          echo "📥 공식 설치 스크립트로 최신 Shorebird 설치..."
          curl --proto '=https' --tlsv1.2 https://raw.githubusercontent.com/shorebirdtech/install/main/install.sh -sSf | bash
          
          export PATH="$HOME/.shorebird/bin:$PATH"
          
          echo "=== Shorebird 설치 확인 ==="
          if command -v shorebird >/dev/null 2>&1; then
            shorebird --version
            echo "✅ Shorebird 설치 및 설정 완료"
          else
            echo "❌ Shorebird 설치 실패"
            exit 1
          fi
          
          # PATH 설정을 환경 파일로 저장 (다음 단계에서 사용)
          echo "export PATH=\"$HOME/.shorebird/bin:\$PATH\"" > /tmp/shorebird_env.sh
          echo "✅ Shorebird CLI 설치 및 환경 설정 완료"

      - name: Get Flutter packages and prepare iOS
        script: |
          cd picnic_app
          echo "=== Flutter 패키지 설치 ==="
          flutter packages pub get
          
          echo "=== Flutter iOS 설정 생성 ==="
          flutter precache --ios
          flutter build ios --config-only

      - name: Install CocoaPods dependencies
        script: |
          cd picnic_app
          
          echo "=== Generated.xcconfig 파일 확인 ==="
          if [ ! -f "ios/Flutter/Generated.xcconfig" ]; then
            echo "⚠️ Generated.xcconfig 파일이 없음 - Flutter 설정 재생성"
            flutter build ios --config-only
          fi
          
          echo "✅ Generated.xcconfig 파일 존재 확인:"
          ls -la ios/Flutter/Generated.xcconfig
          
          echo "=== CocoaPods 설치 시작 ==="
          cd ios
          pod install

      - name: Verify iOS Signing Configuration
        script: |
          echo "=== iOS 서명 환경 확인 ==="
          echo "DEVELOPMENT_TEAM: ${DEVELOPMENT_TEAM:-'24SL34R9HR'}"
          
          # Distribution Certificate 정보 확인
          DIST_CERT_INFO=$(security find-identity -v -p codesigning | grep -i distribution | head -1)
          if [ -n "$DIST_CERT_INFO" ]; then
            echo "✅ Distribution 인증서: $DIST_CERT_INFO"
          else
            echo "❌ Distribution 인증서를 찾을 수 없음"
            echo "사용 가능한 인증서들:"
            security find-identity -v -p codesigning
            exit 1
          fi
          
          # Provisioning Profile 정보 확인
          PROFILE_COUNT=$(find "$HOME/Library/MobileDevice/Provisioning Profiles" -name "*.mobileprovision" 2>/dev/null | wc -l)
          echo "설치된 프로비저닝 프로파일 개수: $PROFILE_COUNT개"
          
          if [ "$PROFILE_COUNT" -gt 0 ]; then
            echo "✅ 프로비저닝 프로파일 목록:"
            find "$HOME/Library/MobileDevice/Provisioning Profiles" -name "*.mobileprovision" 2>/dev/null | while read profile; do
              PROFILE_NAME=$(security cms -D -i "$profile" 2>/dev/null | grep -A1 "<key>Name</key>" | tail -1 | sed 's/.*<string>\(.*\)<\/string>.*/\1/' | tr -d '\n')
              echo "  - $(basename "$profile" .mobileprovision): $PROFILE_NAME"
            done
          else
            echo "❌ 프로비저닝 프로파일을 찾을 수 없음"
            exit 1
          fi

      - name: Configure Xcode Project for Manual Signing
        script: |
          cd picnic_app/ios
          
          echo "=== Xcode 프로젝트 Manual Signing 설정 ==="
          # Manual Signing 강제 설정 (Distribution 인증서 사용)
          echo "📝 Manual Signing 강제 활성화..."
          sed -i '' "s/CODE_SIGN_STYLE = Automatic;/CODE_SIGN_STYLE = Manual;/g" Runner.xcodeproj/project.pbxproj
          sed -i '' "s/CODE_SIGN_IDENTITY = \"\";/CODE_SIGN_IDENTITY = \"Apple Distribution\";/g" Runner.xcodeproj/project.pbxproj
          sed -i '' "s/CODE_SIGN_IDENTITY = \"Apple Development\";/CODE_SIGN_IDENTITY = \"Apple Distribution\";/g" Runner.xcodeproj/project.pbxproj
          sed -i '' "s/\"CODE_SIGN_IDENTITY\[sdk=iphoneos\*\]\" = \"iPhone Developer\";/\"CODE_SIGN_IDENTITY[sdk=iphoneos*]\" = \"Apple Distribution\";/g" Runner.xcodeproj/project.pbxproj
          
          # 프로비저닝 프로파일 설정
          sed -i '' "s/PROVISIONING_PROFILE_SPECIFIER = \"\";/PROVISIONING_PROFILE_SPECIFIER = \"picnic_app_profile_2025\";/g" Runner.xcodeproj/project.pbxproj
          
          # PROVISIONING_PROFILE_SPECIFIER 추가 (존재하지 않는 경우)
          if ! grep -q "PROVISIONING_PROFILE_SPECIFIER" Runner.xcodeproj/project.pbxproj; then
            sed -i '' '/DEVELOPMENT_TEAM = /a\
          PROVISIONING_PROFILE_SPECIFIER = "picnic_app_profile_2025";' Runner.xcodeproj/project.pbxproj
          fi
          
          # Development Team 설정 유지
          sed -i '' "s/DEVELOPMENT_TEAM = \"\";/DEVELOPMENT_TEAM = \"24SL34R9HR\";/g" Runner.xcodeproj/project.pbxproj
          sed -i '' "s/DEVELOPMENT_TEAM = 24SL34R9HR;/DEVELOPMENT_TEAM = \"24SL34R9HR\";/g" Runner.xcodeproj/project.pbxproj
          
          echo "✅ Manual Signing 설정 완료"
          echo "- CODE_SIGN_STYLE: Manual"  
          echo "- DEVELOPMENT_TEAM: 24SL34R9HR"
          echo "- CODE_SIGN_IDENTITY: Apple Distribution"
          echo "- PROVISIONING_PROFILE_SPECIFIER: picnic_app_profile_2025"

      - name: Shorebird iOS Patch
        script: |
          cd picnic_app
          
          # 환경 파일에서 PATH 설정 로드
          if [ -f "/tmp/shorebird_env.sh" ]; then
            source /tmp/shorebird_env.sh
          fi
          
          # PATH를 명시적으로 설정
          export PATH="$HOME/.shorebird/bin:$PATH"
          
          # Shorebird CLI 존재 확인
          if [ ! -f "$HOME/.shorebird/bin/shorebird" ]; then
            echo "❌ Shorebird CLI가 설치되지 않았습니다"
            echo "설치 단계를 다시 확인해주세요"
            exit 1
          fi

          echo "=== Shorebird iOS 패치 시작 ==="
          echo "Shorebird 버전 확인:"
          "$HOME/.shorebird/bin/shorebird" --version || {
            echo "⚠️ 직접 경로로 Shorebird 실행 실패, PATH 확인 중..."
            echo "PATH: $PATH"
            echo "which shorebird: $(which shorebird || echo 'not found')"
            echo "Shorebird 파일 확인: $(ls -la $HOME/.shorebird/bin/shorebird 2>/dev/null || echo 'not found')"
            exit 1
          }

          echo "=== Shorebird 인증 확인 ==="
          if [ -z "$SHOREBIRD_TOKEN" ]; then
            echo "❌ SHOREBIRD_TOKEN 환경변수가 설정되지 않았습니다"
            exit 1
          else
            echo "✅ SHOREBIRD_TOKEN 환경변수가 설정되었습니다"
          fi

          echo "=== Shorebird CLI 상태 확인 ==="
          echo "Shorebird 버전:"
          "$HOME/.shorebird/bin/shorebird" --version 2>/dev/null || echo "Shorebird 버전 확인 실패"

          echo "=== Flutter 빌드 테스트 ==="
          # 패치 생성 전에 Flutter 빌드가 성공하는지 확인
          echo "🧪 Flutter IPA 빌드 테스트 중..."
          flutter build ios --release --dart-define=ENVIRONMENT=prod --analyze-size 2>/dev/null || {
            echo "⚠️ Flutter 빌드 테스트 실패 - 기본 빌드 확인"
            flutter build ios --release --dart-define=ENVIRONMENT=prod || echo "Flutter iOS 빌드 확인 실패"
          }

          echo "=== Shorebird 캐시 정리 및 iOS 패치 준비 ==="
          # Shorebird 캐시 정리
          "$HOME/.shorebird/bin/shorebird" cache clean
          
          # Flutter 캐시 정리
          flutter clean
          flutter pub get
          
          echo "=== iOS 빌드 디렉토리 준비 ==="
          # iOS 빌드 디렉토리 미리 생성
          mkdir -p build/ios/iphoneos
          mkdir -p build/ios/Release-iphoneos
          
          echo "=== Shorebird iOS 패치 생성 및 배포 ==="
          # 패치 생성 (가장 최신 릴리즈에 대한 패치)
          echo "🚀 iOS 패치 생성 시작 (자동 Flutter 버전 감지)..."
          PATCH_RESULT=$("$HOME/.shorebird/bin/shorebird" patch ios \
            --release-version=latest \
            --no-confirm \
            --dart-define=ENVIRONMENT=prod \
            --verbose 2>&1)
          PATCH_EXIT_CODE=$?
          
          echo "패치 결과 출력:"
          echo "$PATCH_RESULT"
          
          # 패치 결과 확인 및 적절한 처리
          if [ $PATCH_EXIT_CODE -eq 0 ]; then
            if echo "$PATCH_RESULT" | grep -i "successfully\|completed\|deployed\|published patch"; then
              echo "=== Shorebird iOS 패치 성공 ==="
              echo "✅ iOS 패치가 Shorebird를 통해 성공적으로 배포되었습니다"
              echo "🚀 사용자들은 앱을 재시작하면 자동으로 패치가 적용됩니다"
              
              # 패치 정보 추출 및 표시
              if echo "$PATCH_RESULT" | grep -i "published patch"; then
                echo ""
                echo "📱 패치 배포 정보:"
                echo "$PATCH_RESULT" | grep -A 5 -i "ready to publish\|published patch" | tail -6
              fi
            else
              echo "=== Shorebird iOS 패치 불완전 ==="
              echo "⚠️ 패치 명령어는 성공했지만 결과가 불분명합니다"
              echo "패치 결과를 다시 확인해주세요"
              exit 1
            fi
          else
            echo "=== Shorebird iOS 패치 실패 ==="
            echo "❌ iOS 패치 생성/배포에 실패했습니다 (종료 코드: $PATCH_EXIT_CODE)"
            
            # 실패 원인 분석
            if echo "$PATCH_RESULT" | grep -i "no.*account\|profile"; then
              echo "🔍 서명 관련 문제로 보입니다:"
              echo "- CodeMagic iOS 서명 설정을 확인하세요"
              echo "- Apple Developer 계정 연결 상태를 확인하세요"
              echo "- 프로비저닝 프로파일 유효성을 확인하세요"
            elif echo "$PATCH_RESULT" | grep -i "flutter.*build.*fail"; then
              echo "🔍 Flutter 빌드 문제로 보입니다:"
              echo "- Flutter 버전 호환성을 확인하세요"
              echo "- 의존성 패키지들을 확인하세요"
            elif echo "$PATCH_RESULT" | grep -i "no.*release"; then
              echo "🔍 기존 릴리즈가 없는 문제로 보입니다:"
              echo "- 먼저 전체 릴리즈를 배포한 후 패치를 시도하세요"
            fi
            
            exit 1
          fi

    artifacts:
      - picnic_app/flutter_drive.log

    publishing:
      slack:
        channel: '#codemagic-picnic'
        notify_on_build_start: true
        notify:
          success: true
          failure: true
      email:
        recipients:
          - ironlove77@gmail.com
        notify:
          success: true
          failure: true

  # =================== PICNIC APP Android Patch (Shorebird) ===================
  picnic-app-patch-android:
    name: Picnic App - Android Patch (Shorebird)
    instance_type: mac_mini_m2
    max_build_duration: 60
    environment:
      android_signing:
        - picnic_keystore
      groups:
        - shorebird-config
        - picnic_env
      flutter: 3.32.4
      java: 17
      vars:
        PATH: $PATH:$HOME/.shorebird/bin
        APP_NAME: "picnic_app"
    cache:
      cache_paths:
        - $FLUTTER_ROOT/.pub-cache
        - $HOME/.gradle/caches
        - $HOME/.gradle/wrapper
        - $HOME/.android/build-cache
        - picnic_app/.dart_tool
        - picnic_app/android/.gradle
    triggering:
      events:
        - push
        - tag
      # hotfix, patch 브랜치와 patch 태그로 트리거
      branch_patterns:
        - pattern: 'hotfix/*'
          include: true
        - pattern: 'patch/*'
          include: true
      tag_patterns:
        - pattern: 'picnic-patch-*'
          include: true
      cancel_previous_builds: true
    scripts:
      - name: Install Shorebird CLI
        script: |
          echo "=== Shorebird CLI 설치 시작 ==="
          
          # 기존 Shorebird 설치 강제 제거 (충돌 방지)
          echo "🧹 기존 Shorebird 설치 정리 중..."
          if [ -d "$HOME/.shorebird" ]; then
            rm -rf "$HOME/.shorebird"
            echo "✅ 기존 Shorebird 디렉토리 제거 완료"
          fi
          
          # 최신 안정 버전 사용 (v1.6.48)
          echo "🔧 Shorebird v1.6.48 최신 안정 버전 설치 중..."
          
          # 공식 GitHub 설치 스크립트 사용 (가장 안정적)
          echo "📥 공식 설치 스크립트로 최신 Shorebird 설치..."
          curl --proto '=https' --tlsv1.2 https://raw.githubusercontent.com/shorebirdtech/install/main/install.sh -sSf | bash
          
          export PATH="$HOME/.shorebird/bin:$PATH"
          
          echo "=== Shorebird 설치 확인 ==="
          if command -v shorebird >/dev/null 2>&1; then
            shorebird --version
            echo "✅ Shorebird 설치 및 설정 완료"
          else
            echo "❌ Shorebird 설치 실패"
            exit 1
          fi
          
          # PATH 설정을 환경 파일로 저장 (다음 단계에서 사용)
          echo "export PATH=\"$HOME/.shorebird/bin:\$PATH\"" > /tmp/shorebird_env.sh
          echo "✅ Shorebird CLI 설치 및 환경 설정 완료"

      - name: Get Flutter packages
        script: |
          cd picnic_app
          flutter packages pub get

      - name: Verify Keystore Configuration
        script: |
          echo "=== 키스토어 환경 변수 확인 ==="
          echo "CM_KEYSTORE_PATH: ${CM_KEYSTORE_PATH:-'미설정'}"
          echo "CM_KEYSTORE_PASSWORD: ${CM_KEYSTORE_PASSWORD:-'미설정'}"
          echo "CM_KEY_ALIAS: ${CM_KEY_ALIAS:-'미설정'}"
          echo "CM_KEY_PASSWORD: ${CM_KEY_PASSWORD:-'미설정'}"
          
          if [ -z "$CM_KEYSTORE_PATH" ] || [ -z "$CM_KEYSTORE_PASSWORD" ] || [ -z "$CM_KEY_ALIAS" ] || [ -z "$CM_KEY_PASSWORD" ]; then
            echo "❌ 키스토어 환경 변수가 올바르게 설정되지 않았습니다"
            echo "CodeMagic 대시보드에서 'picnic_keystore' 그룹 설정을 확인해주세요"
            exit 1
          fi
          
          if [ -f "$CM_KEYSTORE_PATH" ]; then
            echo "✅ 키스토어 파일 존재: $CM_KEYSTORE_PATH"
            # 키스토어 정보 확인
            keytool -list -v -keystore "$CM_KEYSTORE_PATH" -alias "$CM_KEY_ALIAS" -storepass "$CM_KEYSTORE_PASSWORD" | grep -E "(SHA1|SHA256|Subject|Issuer)" | head -3 || echo "키스토어 정보 확인 실패"
          else
            echo "❌ 키스토어 파일을 찾을 수 없습니다: $CM_KEYSTORE_PATH"
            exit 1
          fi

      - name: Configure Gradle Consistent with Release (Patch)
        script: |
          cd picnic_app
          
          echo "=== Gradle 메모리 설정 (릴리즈와 동일하게 6GB) ==="
          mkdir -p $HOME/.gradle
          
          # 기존 gradle.properties 정리 (중복 방지)
          rm -f $HOME/.gradle/gradle.properties
          
          # 릴리즈와 완전히 동일한 메모리 설정 (6GB) + 빌드 재현성 강화
          echo "org.gradle.jvmargs=-Xmx6144m -XX:MaxMetaspaceSize=512m -XX:+HeapDumpOnOutOfMemoryError -Dfile.encoding=UTF-8" >> $HOME/.gradle/gradle.properties
          echo "org.gradle.daemon=true" >> $HOME/.gradle/gradle.properties
          echo "org.gradle.caching=true" >> $HOME/.gradle/gradle.properties
          echo "org.gradle.parallel=false" >> $HOME/.gradle/gradle.properties
          echo "android.enableJetifier=true" >> $HOME/.gradle/gradle.properties
          echo "android.useAndroidX=true" >> $HOME/.gradle/gradle.properties
          echo "android.enableR8.fullMode=false" >> $HOME/.gradle/gradle.properties
          
          # 빌드 재현성 강화 (DEX 파일 일관성을 위해) - deprecated 설정 제거
          echo "org.gradle.vfs.watch=false" >> $HOME/.gradle/gradle.properties
          echo "kotlin.incremental=false" >> $HOME/.gradle/gradle.properties
          echo "kotlin.incremental.useClasspathSnapshot=false" >> $HOME/.gradle/gradle.properties
          echo "org.gradle.unsafe.configuration-cache=false" >> $HOME/.gradle/gradle.properties
          echo "android.experimental.enableSourceSetPathsMap=false" >> $HOME/.gradle/gradle.properties
          # android.enableD8.desugaring=false - deprecated, 제거됨
          # android.enableIncrementalDesugaring=false - deprecated, 제거됨
          
          # 시간대 및 로케일 고정 (비결정론적 요소 제거)
          export TZ=UTC
          export LANG=en_US.UTF-8
          export LC_ALL=en_US.UTF-8
          
          echo "✅ Gradle 설정 완료 (릴리즈와 동일한 6GB 설정)"
          
          # JVM 메모리 환경 변수도 릴리즈와 동일하게 설정
          export GRADLE_OPTS="-Xmx6144m -XX:MaxMetaspaceSize=512m"
          export _JAVA_OPTIONS="-Xmx6144m"

      - name: Shorebird Android Patch with Enhanced Build Strategy
        script: |
          cd picnic_app
          
          # 환경 파일에서 PATH 설정 로드
          if [ -f "/tmp/shorebird_env.sh" ]; then
            source /tmp/shorebird_env.sh
          fi
          
          export PATH="$HOME/.shorebird/bin:$PATH"

          echo "=== Shorebird Android 패치 시작 (릴리즈와 동일한 환경) ==="
          echo "Shorebird 버전 확인:"
          "$HOME/.shorebird/bin/shorebird" --version

          echo "=== Shorebird 인증 확인 ==="
          if [ -z "$SHOREBIRD_TOKEN" ]; then
            echo "❌ SHOREBIRD_TOKEN 환경변수가 설정되지 않았습니다"
            exit 1
          else
            echo "✅ SHOREBIRD_TOKEN 환경변수가 설정되었습니다"
          fi

          echo "=== 환경 최적화 및 사전 빌드 테스트 ==="
          # Shorebird 캐시 정리
          "$HOME/.shorebird/bin/shorebird" cache clean
          
          # Flutter 캐시 정리
          flutter clean
          flutter pub get
          
          # 시스템 정리 (릴리즈와 동일한 수준)
          echo "🧹 시스템 정리..."
          
          # 완전한 빌드 환경 정리 (비결정적 요소 제거)
          rm -rf build/ android/app/build/ android/.gradle/ $HOME/.gradle/caches/ $HOME/.gradle/daemon/
          
          # 환경 변수 고정 (빌드 재현성 극대화)
          export TZ=UTC
          export LANG=en_US.UTF-8
          export LC_ALL=en_US.UTF-8
          export SOURCE_DATE_EPOCH=1577836800  # 2020-01-01 고정
          
          # JVM 메모리 최적화 (릴리즈와 동일)
          export GRADLE_OPTS="-Xmx6144m -XX:MaxMetaspaceSize=512m"
          export _JAVA_OPTIONS="-Xmx6144m"
          
          echo "=== Flutter AAB 빌드 사전 테스트 (문제 조기 발견) ==="
          # Flutter AAB 빌드를 먼저 테스트해서 문제가 있는지 확인
          echo "🧪 Flutter AAB 빌드 테스트 시작..."
          AAB_TEST_RESULT=$(flutter build appbundle --release --dart-define=ENVIRONMENT=prod 2>&1)
          AAB_TEST_EXIT_CODE=$?
          
          if [ $AAB_TEST_EXIT_CODE -eq 0 ]; then
            echo "✅ Flutter AAB 빌드 테스트 성공!"
            echo "🎯 Shorebird 패치에서도 AAB 빌드가 성공할 가능성이 높습니다"
            
            # 성공한 빌드의 AAB 파일을 Shorebird가 예상하는 위치로 복사
            echo "📦 표준 Flutter 빌드 결과물 준비..."
            
            # AAB 파일 탐지 및 복사
            if [ -f "build/app/outputs/bundle/release/app-release.aab" ]; then
              AAB_SIZE=$(du -h "build/app/outputs/bundle/release/app-release.aab" | cut -f1)
              echo "✅ AAB 파일 확인됨: build/app/outputs/bundle/release/app-release.aab (크기: $AAB_SIZE)"
            elif [ -f "android/app/build/outputs/bundle/release/app-release.aab" ]; then
              # 다른 위치에 있으면 표준 위치로 복사
              mkdir -p build/app/outputs/bundle/release/
              cp "android/app/build/outputs/bundle/release/app-release.aab" "build/app/outputs/bundle/release/app-release.aab"
              AAB_SIZE=$(du -h "build/app/outputs/bundle/release/app-release.aab" | cut -f1)
              echo "✅ AAB 파일 복사 완료: build/app/outputs/bundle/release/app-release.aab (크기: $AAB_SIZE)"
            else
              echo "⚠️ AAB 파일을 예상 위치에서 찾을 수 없음"
            fi
            
          else
            echo "❌ Flutter AAB 빌드 테스트 실패"
            echo "🔍 AAB 빌드 실패 원인 분석:"
            
            echo "🔄 릴리즈와 동일한 환경으로 빌드 재시도..."
          fi
          
          echo "=== 네이티브 라이브러리 디렉토리 미리 생성 ==="
          # Shorebird가 찾는 디렉토리들을 미리 생성
          mkdir -p build/app/intermediates/stripped_native_libs/stripReleaseDebugSymbols/release/out/lib
          mkdir -p build/app/intermediates/stripped_native_libs/release/out/lib
          
          echo "=== 네이티브 라이브러리 파일 복사 (Shorebird Issue #1798 해결) ==="
          # Flutter가 생성한 네이티브 라이브러리 파일들을 Shorebird가 기대하는 위치로 복사
          echo "📁 네이티브 라이브러리 파일 검색 중..."
          find . -name "libapp.so" -type f 2>/dev/null | head -10
          
          # Shorebird가 기대하는 타겟 경로 (stripReleaseDebugSymbols 없는 경로)
          SHOREBIRD_TARGET_PATH="build/app/intermediates/stripped_native_libs/release/out/lib"
          mkdir -p "$SHOREBIRD_TARGET_PATH"/{armeabi-v7a,arm64-v8a,x86,x86_64}
          
          # 실제 파일이 있는 소스 경로들 (stripReleaseDebugSymbols 포함)
          ACTUAL_SOURCE_PATHS=(
            "android/app/build/intermediates/stripped_native_libs/release/stripReleaseDebugSymbols/out/lib"
            "build/app/intermediates/stripped_native_libs/release/stripReleaseDebugSymbols/out/lib"
            "android/app/build/intermediates/merged_native_libs/release/mergeReleaseNativeLibs/out/lib"
            "build/app/intermediates/merged_native_libs/release/mergeReleaseNativeLibs/out/lib"
            "android/app/build/intermediates/stripped_native_libs/release/out/lib"
            "build/app/intermediates/stripped_native_libs/release/out/lib"
          )
          
          # 소스에서 타겟으로 네이티브 라이브러리 복사
          COPIED_COUNT=0
          FOUND_SOURCE=""
          
          for source in "${ACTUAL_SOURCE_PATHS[@]}"; do
            if [ -d "$source" ] && [ "$(find "$source" -name "*.so" 2>/dev/null | wc -l)" -gt 0 ]; then
              echo "✅ 네이티브 라이브러리 소스 발견: $source"
              FOUND_SOURCE="$source"
              
              # 각 아키텍처별로 복사
              for arch in armeabi-v7a arm64-v8a x86 x86_64; do
                if [ -d "$source/$arch" ] && [ "$(ls -A "$source/$arch" 2>/dev/null)" ]; then
                  echo "📦 $arch 라이브러리 복사 중..."
                  
                  # Shorebird가 기대하는 위치로 복사
                  cp -r "$source/$arch"/* "$SHOREBIRD_TARGET_PATH/$arch/" 2>/dev/null
                  COPY_RESULT=$?
                  
                  # 복사 성공 확인
                  if [ $COPY_RESULT -eq 0 ] && [ -f "$SHOREBIRD_TARGET_PATH/$arch/libapp.so" ]; then
                    COPIED_COUNT=$((COPIED_COUNT + 1))
                    FILE_SIZE=$(du -h "$SHOREBIRD_TARGET_PATH/$arch/libapp.so" | cut -f1)
                    echo "  ✅ libapp.so 복사 성공 ($arch, 크기: $FILE_SIZE)"
                  fi
                  
                  if [ -f "$SHOREBIRD_TARGET_PATH/$arch/libflutter.so" ]; then
                    FILE_SIZE=$(du -h "$SHOREBIRD_TARGET_PATH/$arch/libflutter.so" | cut -f1)
                    echo "  ✅ libflutter.so 복사 성공 ($arch, 크기: $FILE_SIZE)"
                  fi
                fi
              done
              break
            fi
          done
          
          # 복사 결과 확인
          if [ $COPIED_COUNT -gt 0 ]; then
            echo "✅ 네이티브 라이브러리 복사 완료 ($COPIED_COUNT개 아키텍처)"
            echo "🎯 Shorebird가 찾을 경로: $SHOREBIRD_TARGET_PATH"
          else
            echo "⚠️ 네이티브 라이브러리 복사 실패 - 패치가 실패할 수 있습니다"
          fi
          
          echo "=== Shorebird Android 패치 생성 및 배포 (강화된 메모리 설정) ==="
          echo "🚀 Android 패치 시작 (사전 빌드 완료된 환경)..."
          
          # 최종 메모리 설정 확인
          echo "메모리 설정 상태:"
          echo "- GRADLE_OPTS: $GRADLE_OPTS"
          echo "- _JAVA_OPTIONS: $_JAVA_OPTIONS"
          echo "- JAVA_OPTS: $JAVA_OPTS"
          
          # Shorebird 작업 디렉토리 최적화
          echo "🔧 Shorebird 환경 최적화..."
          
          # 1차 시도: 표준 패치 명령어 (환경 고정)
          echo "📱 1차 시도: 표준 Shorebird 패치 (빌드 재현성 극대화)..."
          
          # 환경 변수 재확인 및 고정
          export TZ=UTC
          export LANG=en_US.UTF-8  
          export LC_ALL=en_US.UTF-8
          export SOURCE_DATE_EPOCH=1577836800
          
          echo "빌드 환경 상태:"
          echo "- TZ: $TZ"
          echo "- LANG: $LANG"
          echo "- SOURCE_DATE_EPOCH: $SOURCE_DATE_EPOCH"
          echo "- _JAVA_OPTIONS: $_JAVA_OPTIONS"
          
          echo "📋 패치 빌드 전 디렉토리 상태 확인..."
          ls -la build/ 2>/dev/null || echo "build 디렉토리 없음"
          
          PATCH_RESULT=$("$HOME/.shorebird/bin/shorebird" patch android \
            --release-version=latest \
            --no-confirm \
            --dart-define=ENVIRONMENT=prod 2>&1)
          PATCH_EXIT_CODE=$?
          
          echo "📋 패치 빌드 후 디렉토리 상태 확인..."
          find build/ -name "*.aab" -type f 2>/dev/null || echo "AAB 파일 없음"
          echo "📋 Gradle 태스크로 AAB 파일 위치 수정 확인..."
          ls -la build/app/outputs/bundle/release/ 2>/dev/null || echo "예상 위치에 AAB 없음"
          
          echo "패치 결과 출력:"
          echo "$PATCH_RESULT"
          
          # 패치 결과 확인 및 적절한 처리
          if [ $PATCH_EXIT_CODE -eq 0 ]; then
            if echo "$PATCH_RESULT" | grep -i "successfully\|completed\|deployed\|published patch"; then
              echo "=== Shorebird Android 패치 성공 ==="
              echo "✅ Android 패치가 Shorebird를 통해 성공적으로 배포되었습니다"
              echo "🚀 사용자들은 앱을 재시작하면 자동으로 패치가 적용됩니다"
              
              # 패치 정보 추출 및 표시
              if echo "$PATCH_RESULT" | grep -i "published patch"; then
                echo ""
                echo "📱 패치 배포 정보:"
                echo "$PATCH_RESULT" | grep -A 5 -i "ready to publish\|published patch" | tail -6
              fi
            else
              echo "=== Shorebird Android 패치 불완전 ==="
              echo "⚠️ 패치 명령어는 성공했지만 결과가 불분명합니다"
              echo "패치 결과를 다시 확인해주세요"
              exit 1
            fi
          else
            echo "=== Shorebird Android 패치 1차 실패 ==="
            echo "❌ 1차 패치 시도 실패 (종료 코드: $PATCH_EXIT_CODE)"
            
            # AAB 파일 찾기 문제인지 확인
            if echo "$PATCH_RESULT" | grep -i "failed.*produce.*aab\|couldn.*find.*aab"; then
              echo "🔍 AAB 파일 탐지 실패 문제로 판단됨"
              echo "📦 2차 시도: 수동 AAB 파일 배치 후 재시도..."
              
              # 모든 가능한 위치에서 AAB 파일 찾기
              echo "🔍 시스템 전체에서 AAB 파일 검색..."
              find /Users/builder/clone/picnic_app -name "*.aab" -type f 2>/dev/null | head -10
              
              AAB_FOUND=$(find /Users/builder/clone/picnic_app -name "*.aab" -type f 2>/dev/null | head -1)
              if [ -n "$AAB_FOUND" ]; then
                echo "✅ AAB 파일 발견: $AAB_FOUND"
                
                # 여러 위치에 복사하여 Shorebird가 찾을 수 있도록 함
                mkdir -p build/app/outputs/bundle/release/
                mkdir -p android/app/build/outputs/bundle/release/
                
                cp "$AAB_FOUND" build/app/outputs/bundle/release/app-release.aab
                cp "$AAB_FOUND" android/app/build/outputs/bundle/release/app-release.aab
                
                echo "🔄 2차 패치 시도 (AAB 파일 배치 완료)..."
                echo "📋 2차 시도 전 AAB 파일 배치 확인..."
                ls -la build/app/outputs/bundle/release/ 2>/dev/null || echo "표준 위치 확인 불가"
                ls -la android/app/build/outputs/bundle/release/ 2>/dev/null || echo "Android 위치 확인 불가"
                
                PATCH_RESULT_2=$("$HOME/.shorebird/bin/shorebird" patch android \
                  --release-version=latest \
                  --no-confirm \
                  --dart-define=ENVIRONMENT=prod 2>&1)
                PATCH_EXIT_CODE_2=$?
                
                echo "📋 2차 시도 후 상태 확인..."
                find build/ -name "*.aab" -type f 2>/dev/null || echo "빌드 후 AAB 파일 없음"
                
                if [ $PATCH_EXIT_CODE_2 -eq 0 ]; then
                  echo "✅ 2차 시도 성공! AAB 파일 배치로 문제 해결됨"
                  echo "$PATCH_RESULT_2"
                else
                  echo "❌ 2차 시도도 실패 (종료 코드: $PATCH_EXIT_CODE_2)"
                  echo "$PATCH_RESULT_2"
                  exit 1
                fi
              else
                echo "❌ 시스템에서 AAB 파일을 찾을 수 없음"
                exit 1
              fi
            else
              echo "🔍 다른 종류의 빌드 문제로 보입니다:"
              
              # 실패 원인 분석
              if echo "$PATCH_RESULT" | grep -i "keystore\|signing"; then
                echo "- 서명 관련 문제"
              elif echo "$PATCH_RESULT" | grep -i "flutter.*build.*fail\|gradle.*fail"; then
                echo "- Flutter/Gradle 빌드 문제"
              elif echo "$PATCH_RESULT" | grep -i "no.*release"; then
                echo "- 기존 릴리즈 없음"
              elif echo "$PATCH_RESULT" | grep -i "java.*heap\|out.*of.*memory"; then
                echo "- 메모리 부족"
              fi
              
              exit 1
            fi
          fi

    artifacts:
      - picnic_app/flutter_drive.log

    publishing:
      slack:
        channel: '#codemagic-picnic'
        notify_on_build_start: true
        notify:
          success: true
          failure: true
      email:
        recipients:
          - ironlove77@gmail.com
        notify:
          success: true
          failure: true