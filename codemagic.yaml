workflows:
  # =================== PICNIC APP iOS ===================
  picnic-app-ios:
    name: Picnic App - iOS
    instance_type: mac_mini_m2
    max_build_duration: 120
    integrations:
      app_store_connect: codemagic-picnic
    environment:
      ios_signing:
        distribution_type: app_store
        bundle_identifier: io.iconcasting.picnic.app
      groups:
        - app_store_connect
        - shorebird-config
        - picnic_env
      flutter: 3.32.4
      vars:
        APP_NAME: "picnic_app"
        BUNDLE_ID: "io.iconcasting.picnic.app"
    cache:
      cache_paths:
        - $FLUTTER_ROOT/.pub-cache
        - $HOME/.gradle/caches
        - $HOME/Library/Caches/CocoaPods
    triggering:
      events:
        - push
        - tag
      branch_patterns:
        - pattern: 'production'
          include: true
      tag_patterns:
        - pattern: 'picnic-v*'
          include: true
      cancel_previous_builds: true
    scripts:
      - name: Get Flutter packages and prepare iOS
        script: |
          cd picnic_app
          echo "=== Flutter Ìå®ÌÇ§ÏßÄ ÏÑ§Ïπò ==="
          flutter packages pub get
          
          echo "=== Flutter iOS ÏÑ§Ï†ï ÏÉùÏÑ± (Generated.xcconfig ÌååÏùº ÏÉùÏÑ±) ==="
          flutter precache --ios
          flutter build ios --config-only
          
          echo "=== Generated.xcconfig ÌååÏùº ÌôïÏù∏ ==="
          ls -la ios/Flutter/Generated.xcconfig || echo "‚ö†Ô∏è Generated.xcconfig ÌååÏùºÏù¥ ÏïÑÏßÅ ÏÉùÏÑ±ÎêòÏßÄ ÏïäÏùå"

      - name: Install CocoaPods dependencies
        script: |
          cd picnic_app
          
          echo "=== Generated.xcconfig ÌååÏùº ÌôïÏù∏ ==="
          if [ ! -f "ios/Flutter/Generated.xcconfig" ]; then
            echo "‚ö†Ô∏è Generated.xcconfig ÌååÏùºÏù¥ ÏóÜÏùå - Flutter ÏÑ§Ï†ï Ïû¨ÏÉùÏÑ±"
            flutter build ios --config-only
          fi
          
          echo "‚úÖ Generated.xcconfig ÌååÏùº Ï°¥Ïû¨ ÌôïÏù∏:"
          ls -la ios/Flutter/Generated.xcconfig
          
          echo "=== CocoaPods ÏÑ§Ïπò ÏãúÏûë ==="
          cd ios
          pod install

      - name: Install Shorebird CLI
        script: |
          echo "=== Shorebird CLI ÏÑ§Ïπò ÏãúÏûë ==="
          
          # Flutter 3.32.4 Ìò∏Ìôò Shorebird Î≤ÑÏ†Ñ Í≥†Ï†ï ÏÑ§Ïπò (iOS Î¶¥Î¶¨Ï¶à)
          echo "üîß Flutter 3.32.4 Ìò∏Ìôò Shorebird Í≥†Ï†ï Î≤ÑÏ†Ñ ÏÑ§Ïπò Ï§ë..."
          
          # Flutter 3.32.4ÏôÄ Ï†ïÌôïÌûà Ìò∏ÌôòÎêòÎäî Shorebird Î≤ÑÏ†Ñ
          SHOREBIRD_VERSION="1.6.47"  # Flutter 3.32.4 ÏôÑÎ≤Ω Ìò∏Ìôò Í≤ÄÏ¶ù Î≤ÑÏ†Ñ
          
          # ÌîåÎû´ÌèºÎ≥Ñ Î∞îÏù¥ÎÑàÎ¶¨ Îã§Ïö¥Î°úÎìú
          PLATFORM=$(uname -s | tr '[:upper:]' '[:lower:]')
          ARCH=$(uname -m)
          
          if [ "$ARCH" = "x86_64" ]; then
            ARCH="x64"
          elif [ "$ARCH" = "aarch64" ] || [ "$ARCH" = "arm64" ]; then
            ARCH="arm64"
          fi
          
          echo "ÌîåÎû´Ìèº: $PLATFORM-$ARCH, Í≥†Ï†ï Î≤ÑÏ†Ñ: v$SHOREBIRD_VERSION (Flutter 3.32.4 Ï†ïÌôï Îß§Ïπ≠)"
          
          # GitHub releasesÏóêÏÑú ÌäπÏ†ï Î≤ÑÏ†Ñ Îã§Ïö¥Î°úÎìú
          mkdir -p "$HOME/.shorebird/bin"
          DOWNLOAD_URL="https://github.com/shorebirdtech/shorebird/releases/download/v$SHOREBIRD_VERSION/shorebird-$PLATFORM-$ARCH"
          
          echo "Îã§Ïö¥Î°úÎìú: $DOWNLOAD_URL"
          curl -L "$DOWNLOAD_URL" -o "$HOME/.shorebird/bin/shorebird" --fail --silent --show-error
          
          if [ $? -eq 0 ] && [ -f "$HOME/.shorebird/bin/shorebird" ]; then
            chmod +x "$HOME/.shorebird/bin/shorebird"
            echo "‚úÖ Shorebird v$SHOREBIRD_VERSION Í≥†Ï†ï ÏÑ§Ïπò ÏÑ±Í≥µ (Flutter 3.32.4 Ï†ïÌôï Îß§Ïπ≠)"
          else
            echo "‚ö†Ô∏è Í≥†Ï†ï Î≤ÑÏ†Ñ ÏÑ§Ïπò Ïã§Ìå® - ÏµúÏã† Ïä§ÌÅ¨Î¶ΩÌä∏Î°ú Ìè¥Î∞±"
            curl --proto '=https' --tlsv1.2 https://raw.githubusercontent.com/shorebirdtech/install/main/install.sh -sSf | bash
          fi
          
          export PATH="$HOME/.shorebird/bin:$PATH"
          shorebird --version || echo "Shorebird ÏÑ§Ïπò Ïã§Ìå®"

      - name: Verify iOS Signing Configuration
        script: |
          echo "=== iOS ÏÑúÎ™Ö ÌôòÍ≤Ω ÌôïÏù∏ ==="
          echo "DEVELOPMENT_TEAM: ${DEVELOPMENT_TEAM:-'24SL34R9HR'}"
          
          # Distribution Certificate Ï†ïÎ≥¥ ÌôïÏù∏
          DIST_CERT_INFO=$(security find-identity -v -p codesigning | grep -i distribution | head -1)
          if [ -n "$DIST_CERT_INFO" ]; then
            echo "‚úÖ Distribution Ïù∏Ï¶ùÏÑú: $DIST_CERT_INFO"
          else
            echo "‚ùå Distribution Ïù∏Ï¶ùÏÑúÎ•º Ï∞æÏùÑ Ïàò ÏóÜÏùå"
            echo "ÏÇ¨Ïö© Í∞ÄÎä•Ìïú Ïù∏Ï¶ùÏÑúÎì§:"
            security find-identity -v -p codesigning
            exit 1
          fi
          
          # Provisioning Profile Ï†ïÎ≥¥ ÌôïÏù∏
          PROFILE_COUNT=$(find "$HOME/Library/MobileDevice/Provisioning Profiles" -name "*.mobileprovision" 2>/dev/null | wc -l)
          echo "ÏÑ§ÏπòÎêú ÌîÑÎ°úÎπÑÏ†ÄÎãù ÌîÑÎ°úÌååÏùº Í∞úÏàò: $PROFILE_COUNTÍ∞ú"
          
          if [ "$PROFILE_COUNT" -gt 0 ]; then
            echo "‚úÖ ÌîÑÎ°úÎπÑÏ†ÄÎãù ÌîÑÎ°úÌååÏùº Î™©Î°ù:"
            find "$HOME/Library/MobileDevice/Provisioning Profiles" -name "*.mobileprovision" 2>/dev/null | while read profile; do
              PROFILE_NAME=$(security cms -D -i "$profile" 2>/dev/null | grep -A1 "<key>Name</key>" | tail -1 | sed 's/.*<string>\(.*\)<\/string>.*/\1/' | tr -d '\n')
              echo "  - $(basename "$profile" .mobileprovision): $PROFILE_NAME"
            done
          else
            echo "‚ùå ÌîÑÎ°úÎπÑÏ†ÄÎãù ÌîÑÎ°úÌååÏùºÏùÑ Ï∞æÏùÑ Ïàò ÏóÜÏùå"
            exit 1
          fi

      - name: Configure Xcode Project for Manual Signing
        script: |
          cd picnic_app/ios
          
          echo "=== Xcode ÌîÑÎ°úÏ†ùÌä∏ Manual Signing ÏÑ§Ï†ï ==="
          # Manual Signing Í∞ïÏ†ú ÏÑ§Ï†ï (Distribution Ïù∏Ï¶ùÏÑú ÏÇ¨Ïö©)
          echo "üìù Manual Signing Í∞ïÏ†ú ÌôúÏÑ±Ìôî..."
          sed -i '' "s/CODE_SIGN_STYLE = Automatic;/CODE_SIGN_STYLE = Manual;/g" Runner.xcodeproj/project.pbxproj
          sed -i '' "s/CODE_SIGN_IDENTITY = \"\";/CODE_SIGN_IDENTITY = \"Apple Distribution\";/g" Runner.xcodeproj/project.pbxproj
          sed -i '' "s/CODE_SIGN_IDENTITY = \"Apple Development\";/CODE_SIGN_IDENTITY = \"Apple Distribution\";/g" Runner.xcodeproj/project.pbxproj
          sed -i '' "s/\"CODE_SIGN_IDENTITY\[sdk=iphoneos\*\]\" = \"iPhone Developer\";/\"CODE_SIGN_IDENTITY[sdk=iphoneos*]\" = \"Apple Distribution\";/g" Runner.xcodeproj/project.pbxproj
          
          # ÌîÑÎ°úÎπÑÏ†ÄÎãù ÌîÑÎ°úÌååÏùº ÏÑ§Ï†ï
          sed -i '' "s/PROVISIONING_PROFILE_SPECIFIER = \"\";/PROVISIONING_PROFILE_SPECIFIER = \"picnic_app_profile_2025\";/g" Runner.xcodeproj/project.pbxproj
          
          # PROVISIONING_PROFILE_SPECIFIER Ï∂îÍ∞Ä (Ï°¥Ïû¨ÌïòÏßÄ ÏïäÎäî Í≤ΩÏö∞)
          if ! grep -q "PROVISIONING_PROFILE_SPECIFIER" Runner.xcodeproj/project.pbxproj; then
            sed -i '' '/DEVELOPMENT_TEAM = /a\
          PROVISIONING_PROFILE_SPECIFIER = "picnic_app_profile_2025";' Runner.xcodeproj/project.pbxproj
          fi
          
          # Development Team ÏÑ§Ï†ï Ïú†ÏßÄ
          sed -i '' "s/DEVELOPMENT_TEAM = \"\";/DEVELOPMENT_TEAM = \"24SL34R9HR\";/g" Runner.xcodeproj/project.pbxproj
          sed -i '' "s/DEVELOPMENT_TEAM = 24SL34R9HR;/DEVELOPMENT_TEAM = \"24SL34R9HR\";/g" Runner.xcodeproj/project.pbxproj
          
          echo "‚úÖ Manual Signing ÏÑ§Ï†ï ÏôÑÎ£å"
          echo "- CODE_SIGN_STYLE: Manual"  
          echo "- DEVELOPMENT_TEAM: 24SL34R9HR"
          echo "- CODE_SIGN_IDENTITY: Apple Distribution"
          echo "- PROVISIONING_PROFILE_SPECIFIER: picnic_app_profile_2025"

      - name: Build iOS IPA (Manual Signing)
        script: |
          cd picnic_app
          
          echo "=== iOS IPA ÎπåÎìú ÏãúÏûë (Manual Signing) ==="
          echo "‚úÖ Manual Signing ÌôòÍ≤ΩÏúºÎ°ú ÎπåÎìúÌï©ÎãàÎã§"
          echo "‚úÖ Bundle ID: io.iconcasting.picnic.app"
          echo "‚úÖ Distribution Type: App Store"
          echo ""
          
          # Manual SigningÏö© ExportOptions.plist ÏÉùÏÑ±
          echo "üìù Manual SigningÏö© ExportOptions.plist ÏÉùÏÑ±..."
          echo '<?xml version="1.0" encoding="UTF-8"?>' > ios/ExportOptions.plist
          echo '<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">' >> ios/ExportOptions.plist
          echo '<plist version="1.0">' >> ios/ExportOptions.plist
          echo '<dict>' >> ios/ExportOptions.plist
          echo '    <key>method</key>' >> ios/ExportOptions.plist
          echo '    <string>app-store</string>' >> ios/ExportOptions.plist
          echo '    <key>teamID</key>' >> ios/ExportOptions.plist
          echo '    <string>24SL34R9HR</string>' >> ios/ExportOptions.plist
          echo '    <key>signingStyle</key>' >> ios/ExportOptions.plist
          echo '    <string>manual</string>' >> ios/ExportOptions.plist
          echo '    <key>signingCertificate</key>' >> ios/ExportOptions.plist
          echo '    <string>Apple Distribution</string>' >> ios/ExportOptions.plist
          echo '    <key>provisioningProfiles</key>' >> ios/ExportOptions.plist
          echo '    <dict>' >> ios/ExportOptions.plist
          echo '        <key>io.iconcasting.picnic.app</key>' >> ios/ExportOptions.plist
          echo '        <string>picnic_app_profile_2025</string>' >> ios/ExportOptions.plist
          echo '    </dict>' >> ios/ExportOptions.plist
          echo '    <key>stripSwiftSymbols</key>' >> ios/ExportOptions.plist
          echo '    <true/>' >> ios/ExportOptions.plist
          echo '    <key>uploadBitcode</key>' >> ios/ExportOptions.plist
          echo '    <false/>' >> ios/ExportOptions.plist
          echo '    <key>uploadSymbols</key>' >> ios/ExportOptions.plist
          echo '    <true/>' >> ios/ExportOptions.plist
          echo '</dict>' >> ios/ExportOptions.plist
          echo '</plist>' >> ios/ExportOptions.plist
          
          echo "üöÄ Manual Signing IPA ÎπåÎìú"
          flutter build ipa \
            --release \
            --dart-define=ENVIRONMENT=prod \
            --export-options-plist=ios/ExportOptions.plist
          
          BUILD_RESULT=$?
          
          # ÎπåÎìú Í≤∞Í≥º ÌôïÏù∏
          echo ""
          echo "=== ÎπåÎìú Í≤∞Í≥º ÌôïÏù∏ ==="
          
          if [ $BUILD_RESULT -eq 0 ]; then
            echo "üéâ Flutter IPA ÎπåÎìú Î™ÖÎ†πÏñ¥ ÏÑ±Í≥µ!"
            
            # IPA ÌååÏùº ÏÉùÏÑ± Ïó¨Î∂Ä ÌôïÏù∏
            if [ -f "build/ios/ipa/picnic_app.ipa" ]; then
              IPA_SIZE=$(du -h "build/ios/ipa/picnic_app.ipa" | cut -f1)
              echo "‚úÖ IPA ÌååÏùº ÏÉùÏÑ± ÏôÑÎ£å: build/ios/ipa/picnic_app.ipa (ÌÅ¨Í∏∞: $IPA_SIZE)"
            elif [ -f "build/ios/ipa/Runner.ipa" ]; then
              IPA_SIZE=$(du -h "build/ios/ipa/Runner.ipa" | cut -f1)
              echo "‚úÖ IPA ÌååÏùº ÏÉùÏÑ± ÏôÑÎ£å: build/ios/ipa/Runner.ipa (ÌÅ¨Í∏∞: $IPA_SIZE)"
              
              # picnic_app.ipaÎ°ú Î≥µÏÇ¨
              cp "build/ios/ipa/Runner.ipa" "build/ios/ipa/picnic_app.ipa"
              echo "‚úÖ picnic_app.ipaÎ°ú Î≥µÏÇ¨ ÏôÑÎ£å"
            else
              echo "‚ö†Ô∏è ÎπåÎìú Î™ÖÎ†πÏñ¥Îäî ÏÑ±Í≥µÌñàÏßÄÎßå IPA ÌååÏùºÏùÑ Ï∞æÏùÑ Ïàò ÏóÜÏùå"
              echo "üìÅ ÏÉùÏÑ±Îêú ÌååÏùºÎì§:"
              find build/ios -name "*.ipa" -o -name "*.xcarchive" 2>/dev/null | head -5
              
              # ArchiveÍ∞Ä ÏûàÎäî Í≤ΩÏö∞ Manual SigningÏö© ÏàòÎèô export ÏãúÎèÑ
              XCARCHIVE_PATH=$(find build/ios -name "*.xcarchive" | head -1)
              if [ -n "$XCARCHIVE_PATH" ]; then
                echo ""
                echo "üì¶ ArchiveÍ∞Ä Î∞úÍ≤¨ÎêòÏñ¥ ÏàòÎèô IPA exportÎ•º ÏãúÎèÑÌï©ÎãàÎã§..."
                echo "Archive Í≤ΩÎ°ú: $XCARCHIVE_PATH"
                
                echo "üöÄ Manual SigningÏúºÎ°ú IPA export ÏãúÎèÑ..."
                cd ios
                xcodebuild -exportArchive \
                  -archivePath "../$XCARCHIVE_PATH" \
                  -exportPath "../build/ios/ipa/" \
                  -exportOptionsPlist "ExportOptions.plist"
                
                EXPORT_RESULT=$?
                cd ..
                
                if [ $EXPORT_RESULT -eq 0 ]; then
                  echo "‚úÖ ÏàòÎèô IPA export ÏÑ±Í≥µ!"
                  
                  # IPA ÌååÏùº ÌôïÏù∏ Î∞è Ïù¥Î¶Ñ Ï†ïÍ∑úÌôî
                  if [ -f "build/ios/ipa/picnic_app.ipa" ]; then
                    IPA_SIZE=$(du -h "build/ios/ipa/picnic_app.ipa" | cut -f1)
                    echo "‚úÖ ÏµúÏ¢Ö IPA ÌååÏùº: build/ios/ipa/picnic_app.ipa (ÌÅ¨Í∏∞: $IPA_SIZE)"
                  elif [ -f "build/ios/ipa/Runner.ipa" ]; then
                    IPA_SIZE=$(du -h "build/ios/ipa/Runner.ipa" | cut -f1)
                    echo "‚úÖ ÏµúÏ¢Ö IPA ÌååÏùº: build/ios/ipa/Runner.ipa (ÌÅ¨Í∏∞: $IPA_SIZE)"
                    cp "build/ios/ipa/Runner.ipa" "build/ios/ipa/picnic_app.ipa"
                    echo "‚úÖ picnic_app.ipaÎ°ú Î≥µÏÇ¨ ÏôÑÎ£å"
                  else
                    echo "‚ö†Ô∏è ÎπåÎìú Î™ÖÎ†πÏñ¥Îäî ÏÑ±Í≥µÌñàÏßÄÎßå IPA ÌååÏùºÏùÑ Ï∞æÏùÑ Ïàò ÏóÜÏùå"
                    ls -la build/ios/ipa/ 2>/dev/null || echo "IPA ÎîîÎ†âÌÜ†Î¶¨ ÏóÜÏùå"
                  fi
                else
                  echo "‚ùå ÏàòÎèô IPA export Ïã§Ìå® (Ï¢ÖÎ£å ÏΩîÎìú: $EXPORT_RESULT)"
                fi
              fi
            fi
            
            echo ""
            echo "üéâ Manual Signing IPA ÎπåÎìú ÏôÑÎ£å!"
          else
            echo "‚ùå Flutter IPA ÎπåÎìú Ïã§Ìå® (Ï¢ÖÎ£å ÏΩîÎìú: $BUILD_RESULT)"
            echo ""
            echo "=== ÎîîÎ≤ÑÍπÖ Ï†ïÎ≥¥ ==="
            echo "Flutter Î≤ÑÏ†Ñ:"
            flutter --version | head -3
            echo ""
            echo "Xcode ÌîÑÎ°úÏ†ùÌä∏ ÏÑúÎ™Ö ÏÑ§Ï†ï ÌôïÏù∏:"
            grep -A 5 -B 5 "CODE_SIGN_STYLE\|DEVELOPMENT_TEAM" ios/Runner.xcodeproj/project.pbxproj | head -10
            echo ""
            echo "ÏÑ§ÏπòÎêú Ïù∏Ï¶ùÏÑú:"
            security find-identity -v -p codesigning | head -3
            echo ""
            echo "ÌîÑÎ°úÎπÑÏ†ÄÎãù ÌîÑÎ°úÌååÏùº:"
            ls -la "$HOME/Library/MobileDevice/Provisioning Profiles/" 2>/dev/null | head -3 || echo "ÌîÑÎ°úÎπÑÏ†ÄÎãù ÌîÑÎ°úÌååÏùº ÎîîÎ†âÌÜ†Î¶¨ ÏóÜÏùå"
            
            exit 1
          fi

      - name: Shorebird iOS Release
        script: |
          export PATH="$HOME/.shorebird/bin:$PATH"
          cd picnic_app

          echo "=== Shorebird iOS Î¶¥Î¶¨Ï¶à ÏãúÏûë ==="
          echo "Shorebird Î≤ÑÏ†Ñ ÌôïÏù∏:"
          shorebird --version

          echo "=== Shorebird Ïù∏Ï¶ù ÌôïÏù∏ ==="
          if [ -z "$SHOREBIRD_TOKEN" ]; then
            echo "‚ùå SHOREBIRD_TOKEN ÌôòÍ≤ΩÎ≥ÄÏàòÍ∞Ä ÏÑ§Ï†ïÎêòÏßÄ ÏïäÏïòÏäµÎãàÎã§"
            exit 1
          else
            echo "‚úÖ SHOREBIRD_TOKEN ÌôòÍ≤ΩÎ≥ÄÏàòÍ∞Ä ÏÑ§Ï†ïÎêòÏóàÏäµÎãàÎã§"
          fi

          echo "=== Shorebird iOS Î¶¥Î¶¨Ï¶à Ïã§Ìñâ ==="
          # Ï≤´ Î≤àÏß∏ ÏãúÎèÑ
          echo "üöÄ iOS Î¶¥Î¶¨Ï¶à Ï≤´ Î≤àÏß∏ ÏãúÎèÑ (ÏµúÏã† Flutter 3.32.4 Î™ÖÏãú ÏßÄÏ†ï)..."
          RELEASE_RESULT=$(shorebird release ios --dart-define=ENVIRONMENT=prod --flutter-version=latest 2>&1)
          RELEASE_EXIT_CODE=$?
          
          echo "Î¶¥Î¶¨Ï¶à Í≤∞Í≥º: $RELEASE_RESULT"
          
          # "incomplete" Î©îÏãúÏßÄÍ∞Ä ÏûàÍ±∞ÎÇò Ïã§Ìå®Ìïú Í≤ΩÏö∞ Ïû¨ÏãúÎèÑ
          if [[ $RELEASE_EXIT_CODE -ne 0 ]] || echo "$RELEASE_RESULT" | grep -i "incomplete\|re-run"; then
            echo "‚ö†Ô∏è Î∂àÏôÑÏ†ÑÌïú Î¶¥Î¶¨Ï¶à Í∞êÏßÄ ÎòêÎäî Ïã§Ìå® - Ïû¨ÏãúÎèÑÌï©ÎãàÎã§..."
            sleep 5
            
            echo "üîÑ iOS Î¶¥Î¶¨Ï¶à Ïû¨ÏãúÎèÑ (ÏµúÏã† Flutter 3.32.4)..."
            shorebird release ios --dart-define=ENVIRONMENT=prod --flutter-version=latest
            
            RETRY_EXIT_CODE=$?
            if [ $RETRY_EXIT_CODE -eq 0 ]; then
              echo "‚úÖ Ïû¨ÏãúÎèÑ ÏÑ±Í≥µ!"
            else
              echo "‚ùå Ïû¨ÏãúÎèÑÎèÑ Ïã§Ìå®ÌñàÏäµÎãàÎã§."
              exit 1
            fi
          else
            echo "‚úÖ Ï≤´ Î≤àÏß∏ ÏãúÎèÑ ÏÑ±Í≥µ!"
          fi

          echo "=== Shorebird iOS Î¶¥Î¶¨Ï¶à ÏôÑÎ£å ==="
          echo "‚úÖ iOS Ïï±Ïù¥ ShorebirdÏóê ÏÑ±Í≥µÏ†ÅÏúºÎ°ú Î¶¥Î¶¨Ï¶àÎêòÏóàÏäµÎãàÎã§"

    artifacts:
      - picnic_app/build/ios/ipa/*.ipa
      - picnic_app/build/ios/Runner.xcarchive
      - picnic_app/flutter_drive.log

    publishing:
      app_store_connect:
        auth: integration
        submit_to_testflight: true
        beta_groups:
          - App Store Connect Users
      slack:
        channel: '#codemagic-picnic'
        notify_on_build_start: true
        notify:
          success: true
          failure: true
      email:
        recipients:
          - ironlove77@gmail.com
        notify:
          success: true
          failure: true

  # =================== PICNIC APP Android ===================
  picnic-app-android:
    name: Picnic App - Android
    instance_type: mac_mini_m2
    max_build_duration: 120
    environment:
      android_signing:
        - picnic_keystore
      groups:
        - google_play
        - shorebird-config
        - picnic_env
      flutter: 3.32.4
      java: 17
      vars:
        PATH: $PATH:$HOME/.shorebird/bin
        APP_NAME: "picnic_app"
        # CodeMagicÏù¥ android_signingÏùÑ Ïù∏ÏãùÌïòÎèÑÎ°ù Í∞ïÏ†ú ÏÑ§Ï†ï
        FLUTTER_BUILD_MODE: "release"
    cache:
      cache_paths:
        - $FLUTTER_ROOT/.pub-cache
        - $HOME/.gradle/caches
        - $HOME/.gradle/wrapper
        - $HOME/.android/build-cache
        - $HOME/Library/Caches/CocoaPods
        - picnic_app/.dart_tool
        - picnic_app/android/.gradle
    triggering:
      events:
        - push
        - tag
      # production Î∏åÎûúÏπò Ìë∏Ïãú Î∞è ÌÉúÍ∑∏Î°ú Ìä∏Î¶¨Í±∞
      branch_patterns:
        - pattern: 'production'
          include: true
      tag_patterns:
        - pattern: 'picnic-v*'
          include: true
      cancel_previous_builds: true
    scripts:
      - name: Install Shorebird CLI
        script: |
          echo "=== Shorebird CLI ÏÑ§Ïπò ÏãúÏûë ==="
          
          # Flutter 3.32.4 Ìò∏Ìôò Shorebird Î≤ÑÏ†Ñ Í≥†Ï†ï ÏÑ§Ïπò (Android Î¶¥Î¶¨Ï¶à)
          echo "üîß Flutter 3.32.4 Ìò∏Ìôò Shorebird Í≥†Ï†ï Î≤ÑÏ†Ñ ÏÑ§Ïπò Ï§ë..."
          
          # Flutter 3.32.4ÏôÄ Ï†ïÌôïÌûà Ìò∏ÌôòÎêòÎäî Shorebird Î≤ÑÏ†Ñ
          SHOREBIRD_VERSION="1.6.47"  # Flutter 3.32.4 ÏôÑÎ≤Ω Ìò∏Ìôò Í≤ÄÏ¶ù Î≤ÑÏ†Ñ
          
          # ÌîåÎû´ÌèºÎ≥Ñ Î∞îÏù¥ÎÑàÎ¶¨ Îã§Ïö¥Î°úÎìú
          PLATFORM=$(uname -s | tr '[:upper:]' '[:lower:]')
          ARCH=$(uname -m)
          
          if [ "$ARCH" = "x86_64" ]; then
            ARCH="x64"
          elif [ "$ARCH" = "aarch64" ] || [ "$ARCH" = "arm64" ]; then
            ARCH="arm64"
          fi
          
          echo "ÌîåÎû´Ìèº: $PLATFORM-$ARCH, Í≥†Ï†ï Î≤ÑÏ†Ñ: v$SHOREBIRD_VERSION (Flutter 3.32.4 Ï†ïÌôï Îß§Ïπ≠)"
          
          # GitHub releasesÏóêÏÑú ÌäπÏ†ï Î≤ÑÏ†Ñ Îã§Ïö¥Î°úÎìú
          mkdir -p "$HOME/.shorebird/bin"
          DOWNLOAD_URL="https://github.com/shorebirdtech/shorebird/releases/download/v$SHOREBIRD_VERSION/shorebird-$PLATFORM-$ARCH"
          
          echo "Îã§Ïö¥Î°úÎìú: $DOWNLOAD_URL"
          curl -L "$DOWNLOAD_URL" -o "$HOME/.shorebird/bin/shorebird" --fail --silent --show-error
          
          if [ $? -eq 0 ] && [ -f "$HOME/.shorebird/bin/shorebird" ]; then
            chmod +x "$HOME/.shorebird/bin/shorebird"
            echo "‚úÖ Shorebird v$SHOREBIRD_VERSION Í≥†Ï†ï ÏÑ§Ïπò ÏÑ±Í≥µ (Flutter 3.32.4 Ï†ïÌôï Îß§Ïπ≠)"
          else
            echo "‚ö†Ô∏è Í≥†Ï†ï Î≤ÑÏ†Ñ ÏÑ§Ïπò Ïã§Ìå® - ÏµúÏã† Ïä§ÌÅ¨Î¶ΩÌä∏Î°ú Ìè¥Î∞±"
            curl --proto '=https' --tlsv1.2 https://raw.githubusercontent.com/shorebirdtech/install/main/install.sh -sSf | bash
          fi
          
          export PATH="$HOME/.shorebird/bin:$PATH"
          shorebird --version || echo "Shorebird ÏÑ§Ïπò Ïã§Ìå®"

      - name: Get Flutter packages
        script: |
          cd picnic_app
          flutter packages pub get

      - name: Verify Keystore Configuration
        script: |
          echo "=== ÌÇ§Ïä§ÌÜ†Ïñ¥ ÌôòÍ≤Ω Î≥ÄÏàò ÌôïÏù∏ ==="
          echo "CM_KEYSTORE_PATH: ${CM_KEYSTORE_PATH:-'ÎØ∏ÏÑ§Ï†ï'}"
          echo "CM_KEYSTORE_PASSWORD: ${CM_KEYSTORE_PASSWORD:-'ÎØ∏ÏÑ§Ï†ï'}"
          echo "CM_KEY_ALIAS: ${CM_KEY_ALIAS:-'ÎØ∏ÏÑ§Ï†ï'}"
          echo "CM_KEY_PASSWORD: ${CM_KEY_PASSWORD:-'ÎØ∏ÏÑ§Ï†ï'}"
          
          if [ -z "$CM_KEYSTORE_PATH" ] || [ -z "$CM_KEYSTORE_PASSWORD" ] || [ -z "$CM_KEY_ALIAS" ] || [ -z "$CM_KEY_PASSWORD" ]; then
            echo "‚ùå ÌÇ§Ïä§ÌÜ†Ïñ¥ ÌôòÍ≤Ω Î≥ÄÏàòÍ∞Ä Ïò¨Î∞îÎ•¥Í≤å ÏÑ§Ï†ïÎêòÏßÄ ÏïäÏïòÏäµÎãàÎã§"
            echo "CodeMagic ÎåÄÏãúÎ≥¥ÎìúÏóêÏÑú 'picnic_keystore' Í∑∏Î£π ÏÑ§Ï†ïÏùÑ ÌôïÏù∏Ìï¥Ï£ºÏÑ∏Ïöî"
            exit 1
          fi
          
          if [ -f "$CM_KEYSTORE_PATH" ]; then
            echo "‚úÖ ÌÇ§Ïä§ÌÜ†Ïñ¥ ÌååÏùº Ï°¥Ïû¨: $CM_KEYSTORE_PATH"
            # ÌÇ§Ïä§ÌÜ†Ïñ¥ Ï†ïÎ≥¥ ÌôïÏù∏
            keytool -list -v -keystore "$CM_KEYSTORE_PATH" -alias "$CM_KEY_ALIAS" -storepass "$CM_KEYSTORE_PASSWORD" | grep -E "(SHA1|SHA256|Subject|Issuer)" || echo "ÌÇ§Ïä§ÌÜ†Ïñ¥ Ï†ïÎ≥¥ ÌôïÏù∏ Ïã§Ìå®"
          else
            echo "‚ùå ÌÇ§Ïä§ÌÜ†Ïñ¥ ÌååÏùºÏùÑ Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§: $CM_KEYSTORE_PATH"
            exit 1
          fi

      - name: Build AAB and APK for Distribution
        script: |
          cd picnic_app
          
          echo "=== Gradle Î©îÎ™®Î¶¨ ÏÑ§Ï†ï ÏµúÏ†ÅÌôî (Java Heap Space ÏóêÎü¨ Ìï¥Í≤∞) ==="
          mkdir -p $HOME/.gradle
          # Î©îÎ™®Î¶¨Î•º 6GBÎ°ú Ï¶ùÍ∞ÄÌïòÍ≥† Î©îÎ™®Î¶¨ Í¥ÄÎ†® ÏòµÏÖò ÏµúÏ†ÅÌôî
          echo "org.gradle.jvmargs=-Xmx6144m -XX:MaxMetaspaceSize=512m -XX:+HeapDumpOnOutOfMemoryError -Dfile.encoding=UTF-8" >> $HOME/.gradle/gradle.properties
          echo "org.gradle.daemon=true" >> $HOME/.gradle/gradle.properties
          echo "org.gradle.caching=true" >> $HOME/.gradle/gradle.properties
          echo "org.gradle.parallel=false" >> $HOME/.gradle/gradle.properties
          echo "android.enableJetifier=true" >> $HOME/.gradle/gradle.properties
          echo "android.useAndroidX=true" >> $HOME/.gradle/gradle.properties
          # Shorebird Ìò∏ÌôòÏÑ±ÏùÑ ÏúÑÌïú Ï∂îÍ∞Ä ÏÑ§Ï†ï (deprecated ÏòµÏÖò Ï†úÍ±∞)
          echo "android.enableR8.fullMode=false" >> $HOME/.gradle/gradle.properties
          
          # Shorebird PATH ÏÑ§Ï†ï
          export PATH="$HOME/.shorebird/bin:$PATH"
          
          # Íπ®ÎÅóÌïú ÎπåÎìú ÌôòÍ≤Ω
          flutter clean
          flutter pub get

          echo "=== ÎπåÎìú Í≤ΩÎ°ú ÎØ∏Î¶¨ ÏÑ§Ï†ï ==="
          # FlutterÍ∞Ä ÏòàÏÉÅÌïòÎäî Í≤ΩÎ°úÏóê ÎîîÎ†âÌÜ†Î¶¨ ÎØ∏Î¶¨ ÏÉùÏÑ±
          mkdir -p build/app/outputs/bundle/release/
          mkdir -p build/app/outputs/apk/release/
          mkdir -p build/app/outputs/flutter-apk/

          echo "=== ÏÑúÎ™Ö ÏÑ§Ï†ï ÌôïÏù∏ ==="
          echo "ÌÇ§Ïä§ÌÜ†Ïñ¥ Í≤ΩÎ°ú: $CM_KEYSTORE_PATH"
          echo "ÌÇ§ Î≥ÑÏπ≠: $CM_KEY_ALIAS"

          echo "=== 1Ô∏è‚É£ AAB ÎπåÎìú ÏãúÏûë (ÏÑúÎ™Ö Ï†ÅÏö©) ==="
          AAB_BUILD_SUCCESS=false
          
          # AAB ÎπåÎìú Ïã§Ìñâ (ÏÑ±Í≥µ Ïó¨Î∂ÄÏôÄ Í¥ÄÍ≥ÑÏóÜÏù¥ ÌååÏùº ÌÉêÏßÄ ÏãúÎèÑ)
          echo "üöÄ Flutter AAB ÎπåÎìú Ïã§Ìñâ..."
          flutter build appbundle --release --dart-define=ENVIRONMENT=prod
          AAB_FLUTTER_EXIT_CODE=$?
          
          echo "=== AAB ÌååÏùº ÌÉêÏßÄ Î∞è Î≥µÍµ¨ ==="
          echo "üìÅ Î™®Îì† .aab ÌååÏùº Í≤ÄÏÉâ Ï§ë..."
          find . -name "*.aab" -type f 2>/dev/null | head -10
          
          # Ïó¨Îü¨ ÏúÑÏπòÏóêÏÑú AAB ÌååÏùº ÌÉêÏßÄ
          AAB_FOUND_PATH=""
          POSSIBLE_AAB_PATHS=(
            "build/app/outputs/bundle/release/app-release.aab"
            "android/app/build/outputs/bundle/release/app-release.aab"
            "build/app/outputs/bundle/release/app.aab"
            "android/app/build/outputs/bundle/release/app.aab"
          )
          
          # 1. ÏòàÏÉÅ Í≤ΩÎ°úÏóêÏÑú Î®ºÏ†Ä ÌôïÏù∏
          for path in "${POSSIBLE_AAB_PATHS[@]}"; do
            if [ -f "$path" ]; then
              echo "‚úÖ AAB ÌååÏùº Î∞úÍ≤¨: $path"
              AAB_FOUND_PATH="$path"
              break
            fi
          done
          
          # 2. ÏòàÏÉÅ Í≤ΩÎ°úÏóê ÏóÜÏúºÎ©¥ Ï†ÑÏ≤¥ Í≤ÄÏÉâ
          if [ -z "$AAB_FOUND_PATH" ]; then
            echo "üîç Ï†ÑÏ≤¥ Í≤ÄÏÉâÏúºÎ°ú AAB ÌååÏùº Ï∞æÎäî Ï§ë..."
            AAB_FOUND_PATH=$(find . -name "*.aab" -type f 2>/dev/null | head -1)
            
            if [ -n "$AAB_FOUND_PATH" ]; then
              echo "‚úÖ AAB ÌååÏùº Î∞úÍ≤¨ (Ï†ÑÏ≤¥ Í≤ÄÏÉâ): $AAB_FOUND_PATH"
            else
              echo "‚ùå AAB ÌååÏùºÏùÑ Ï∞æÏùÑ Ïàò ÏóÜÏùå"
            fi
          fi
          
          # 3. AAB ÌååÏùº Î≥µÏÇ¨ Î∞è Ï†ïÎ¶¨
          if [ -n "$AAB_FOUND_PATH" ] && [ -f "$AAB_FOUND_PATH" ]; then
            # FlutterÍ∞Ä ÏòàÏÉÅÌïòÎäî ÏúÑÏπòÎ°ú Î≥µÏÇ¨
            mkdir -p build/app/outputs/bundle/release/
            cp "$AAB_FOUND_PATH" build/app/outputs/bundle/release/app-release.aab
            
            AAB_SIZE=$(du -h build/app/outputs/bundle/release/app-release.aab | cut -f1)
            echo "‚úÖ AAB ÌååÏùº Î≥µÍµ¨ ÏÑ±Í≥µ: build/app/outputs/bundle/release/app-release.aab (ÌÅ¨Í∏∞: $AAB_SIZE)"
            AAB_BUILD_SUCCESS=true
            
            # ÏÑúÎ™Ö Í≤ÄÏ¶ù
            if jarsigner -verify build/app/outputs/bundle/release/app-release.aab > /dev/null 2>&1; then
              echo "‚úÖ AAB ÏÑúÎ™Ö Í≤ÄÏ¶ù ÏÑ±Í≥µ"
            else
              echo "‚ö†Ô∏è AAB ÏÑúÎ™Ö Í≤ÄÏ¶ù Ïã§Ìå®"
            fi
          else
            echo "‚ùå AAB ÌååÏùº Î≥µÍµ¨ Ïã§Ìå®"
            if [ $AAB_FLUTTER_EXIT_CODE -eq 0 ]; then
              echo "‚ö†Ô∏è Flutter Î™ÖÎ†πÏñ¥Îäî ÏÑ±Í≥µÌñàÏßÄÎßå ÌååÏùºÏùÑ Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§"
            else
              echo "‚ùå Flutter AAB ÎπåÎìú Î™ÖÎ†πÏñ¥ÎèÑ Ïã§Ìå®ÌñàÏäµÎãàÎã§ (Ï¢ÖÎ£å ÏΩîÎìú: $AAB_FLUTTER_EXIT_CODE)"
            fi
          fi

          echo "=== 2Ô∏è‚É£ APK ÎπåÎìú ÏãúÏûë (ÏÑúÎ™Ö Ï†ÅÏö©) ==="
          APK_BUILD_SUCCESS=false
          
          # APK ÎπåÎìú Ïã§Ìñâ (ÏÑ±Í≥µ Ïó¨Î∂ÄÏôÄ Í¥ÄÍ≥ÑÏóÜÏù¥ ÌååÏùº ÌÉêÏßÄ ÏãúÎèÑ)
          echo "üöÄ Flutter APK ÎπåÎìú Ïã§Ìñâ..."
          flutter build apk --release --dart-define=ENVIRONMENT=prod
          APK_FLUTTER_EXIT_CODE=$?
          
          echo "=== APK ÌååÏùº ÌÉêÏßÄ Î∞è Î≥µÍµ¨ ==="
          echo "üìÅ Î™®Îì† .apk ÌååÏùº Í≤ÄÏÉâ Ï§ë..."
          find . -name "*.apk" -type f 2>/dev/null | head -10
          
          # Ïó¨Îü¨ ÏúÑÏπòÏóêÏÑú APK ÌååÏùº ÌÉêÏßÄ
          APK_FOUND_PATH=""
          POSSIBLE_APK_PATHS=(
            "build/app/outputs/flutter-apk/app-release.apk"
            "android/app/build/outputs/apk/release/app-release.apk"
            "build/app/outputs/apk/release/app-release.apk"
            "android/app/build/outputs/flutter-apk/app-release.apk"
            "build/app/outputs/flutter-apk/app.apk"
            "android/app/build/outputs/apk/release/app.apk"
          )
          
          # 1. ÏòàÏÉÅ Í≤ΩÎ°úÏóêÏÑú Î®ºÏ†Ä ÌôïÏù∏
          for path in "${POSSIBLE_APK_PATHS[@]}"; do
            if [ -f "$path" ]; then
              echo "‚úÖ APK ÌååÏùº Î∞úÍ≤¨: $path"
              APK_FOUND_PATH="$path"
              break
            fi
          done
          
          # 2. ÏòàÏÉÅ Í≤ΩÎ°úÏóê ÏóÜÏúºÎ©¥ Ï†ÑÏ≤¥ Í≤ÄÏÉâ
          if [ -z "$APK_FOUND_PATH" ]; then
            echo "üîç Ï†ÑÏ≤¥ Í≤ÄÏÉâÏúºÎ°ú APK ÌååÏùº Ï∞æÎäî Ï§ë..."
            APK_FOUND_PATH=$(find . -name "*.apk" -type f 2>/dev/null | head -1)
            
            if [ -n "$APK_FOUND_PATH" ]; then
              echo "‚úÖ APK ÌååÏùº Î∞úÍ≤¨ (Ï†ÑÏ≤¥ Í≤ÄÏÉâ): $APK_FOUND_PATH"
            else
              echo "‚ùå APK ÌååÏùºÏùÑ Ï∞æÏùÑ Ïàò ÏóÜÏùå"
            fi
          fi
          
          # 3. APK ÌååÏùº Î≥µÏÇ¨ Î∞è Ï†ïÎ¶¨
          if [ -n "$APK_FOUND_PATH" ] && [ -f "$APK_FOUND_PATH" ]; then
            # FlutterÍ∞Ä ÏòàÏÉÅÌïòÎäî ÏúÑÏπòÎì§Î°ú Î≥µÏÇ¨
            mkdir -p build/app/outputs/flutter-apk/
            mkdir -p build/app/outputs/apk/release/
            
            cp "$APK_FOUND_PATH" build/app/outputs/flutter-apk/app-release.apk
            cp "$APK_FOUND_PATH" build/app/outputs/apk/release/app-release.apk
            
            APK_SIZE=$(du -h build/app/outputs/flutter-apk/app-release.apk | cut -f1)
            echo "‚úÖ APK ÌååÏùº Î≥µÍµ¨ ÏÑ±Í≥µ: build/app/outputs/flutter-apk/app-release.apk (ÌÅ¨Í∏∞: $APK_SIZE)"
            APK_BUILD_SUCCESS=true
            
            # ÏÑúÎ™Ö Í≤ÄÏ¶ù
            if jarsigner -verify build/app/outputs/flutter-apk/app-release.apk > /dev/null 2>&1; then
              echo "‚úÖ APK ÏÑúÎ™Ö Í≤ÄÏ¶ù ÏÑ±Í≥µ"
            else
              echo "‚ö†Ô∏è APK ÏÑúÎ™Ö Í≤ÄÏ¶ù Ïã§Ìå®"
            fi
          else
            echo "‚ùå APK ÌååÏùº Î≥µÍµ¨ Ïã§Ìå®"
            if [ $APK_FLUTTER_EXIT_CODE -eq 0 ]; then
              echo "‚ö†Ô∏è Flutter Î™ÖÎ†πÏñ¥Îäî ÏÑ±Í≥µÌñàÏßÄÎßå ÌååÏùºÏùÑ Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§"
            else
              echo "‚ùå Flutter APK ÎπåÎìú Î™ÖÎ†πÏñ¥ÎèÑ Ïã§Ìå®ÌñàÏäµÎãàÎã§ (Ï¢ÖÎ£å ÏΩîÎìú: $APK_FLUTTER_EXIT_CODE)"
            fi
            echo "ÎπåÎìúÎ•º Í∞ïÏ†úÎ°ú Í≥ÑÏÜç ÏßÑÌñâÌï©ÎãàÎã§..."
          fi
          
          # 3. Shorebird ÎπåÎìú
          echo "=== 3Ô∏è‚É£ Shorebird ÎπåÎìú ÏãúÏûë ==="
          
          # ÎπåÎìú Í≤∞Í≥º ÌôïÏù∏
          echo "=== ÎπåÎìú Í≤∞Í≥º ÏöîÏïΩ ==="
          if [ "$AAB_BUILD_SUCCESS" = true ]; then
            echo "‚úÖ AAB: ÎπåÎìú Î∞è Î≥µÍµ¨ ÏÑ±Í≥µ"
          else
            echo "‚ùå AAB: ÎπåÎìú Ïã§Ìå® ÎòêÎäî ÌååÏùºÏùÑ Ï∞æÏùÑ Ïàò ÏóÜÏùå"
          fi
          
          if [ "$APK_BUILD_SUCCESS" = true ]; then
            echo "‚úÖ APK: ÎπåÎìú Î∞è Î≥µÍµ¨ ÏÑ±Í≥µ"
          else
            echo "‚ùå APK: ÎπåÎìú Ïã§Ìå® ÎòêÎäî ÌååÏùºÏùÑ Ï∞æÏùÑ Ïàò ÏóÜÏùå"
          fi
          
          # AABÎÇò APK Ï§ë ÌïòÎÇòÎùºÎèÑ ÏÑ±Í≥µÌïòÎ©¥ Shorebird ÏßÑÌñâ
          if [ "$AAB_BUILD_SUCCESS" = true ] || [ "$APK_BUILD_SUCCESS" = true ]; then
            echo "‚úÖ ÏµúÏÜåÌïú ÌïòÎÇòÏùò ÎπåÎìúÍ∞Ä ÏÑ±Í≥µÌñàÏúºÎØÄÎ°ú Shorebird ÏßÑÌñâ"
          else
            echo "‚ùå AABÏôÄ APK Î™®Îëê Ïã§Ìå®ÌñàÏäµÎãàÎã§"
            exit 1
          fi
          
          if [ -z "$SHOREBIRD_TOKEN" ]; then
            echo "‚ùå SHOREBIRD_TOKEN ÌôòÍ≤ΩÎ≥ÄÏàòÍ∞Ä ÏÑ§Ï†ïÎêòÏßÄ ÏïäÏïòÏäµÎãàÎã§"
            exit 1
          fi

          echo "=== ÌëúÏ§Ä Flutter ÎπåÎìú Í∏∞Î∞ò Shorebird Î¶¥Î¶¨Ï¶à ==="
          echo "ÏÇ¨Ïö©Ïûê ÏöîÏ≤≠: ÌîåÎü¨ÌÑ∞ Í∏∞Î≥∏ Î™ÖÎ†πÏñ¥ ÏÇ¨Ïö©ÏúºÎ°ú ÎπåÎìú ÏÜçÎèÑ ÏµúÏ†ÅÌôî"
          echo "‚úÖ AAB/APK ÌååÏùºÏù¥ ÏÑ±Í≥µÏ†ÅÏúºÎ°ú Î≥µÍµ¨ÎêòÏóàÏúºÎØÄÎ°ú Î∞îÎ°ú Î¶¥Î¶¨Ï¶à ÏßÑÌñâÌï©ÎãàÎã§"
          
          # Shorebird Ïù∏Ï¶ù ÌôïÏù∏
          echo "=== Shorebird Ïù∏Ï¶ù ÌôïÏù∏ ==="
          if [ -z "$SHOREBIRD_TOKEN" ]; then
            echo "‚ùå SHOREBIRD_TOKEN ÌôòÍ≤ΩÎ≥ÄÏàòÍ∞Ä ÏÑ§Ï†ïÎêòÏßÄ ÏïäÏïòÏäµÎãàÎã§"
            exit 1
          else
            echo "‚úÖ SHOREBIRD_TOKEN ÌôòÍ≤ΩÎ≥ÄÏàòÍ∞Ä ÏÑ§Ï†ïÎêòÏóàÏäµÎãàÎã§"
          fi
          
          echo "=== Shorebird Ï∫êÏãú Ï†ïÎ¶¨ Î∞è ÎÑ§Ïù¥Ìã∞Î∏å ÎùºÏù¥Î∏åÎü¨Î¶¨ ÎîîÎ†âÌÜ†Î¶¨ Ï§ÄÎπÑ ==="
          # Shorebird Ï∫êÏãú Ï†ïÎ¶¨ (ÏïÑÌã∞Ìå©Ìä∏ Î¨∏Ï†ú Ìï¥Í≤∞)
          shorebird cache clean
          
          echo "=== ÎÑ§Ïù¥Ìã∞Î∏å ÎùºÏù¥Î∏åÎü¨Î¶¨ ÎîîÎ†âÌÜ†Î¶¨ ÎØ∏Î¶¨ ÏÉùÏÑ± ==="
          # ShorebirdÍ∞Ä Ï∞æÎäî ÎîîÎ†âÌÜ†Î¶¨Îì§ÏùÑ ÎØ∏Î¶¨ ÏÉùÏÑ±
          mkdir -p build/app/intermediates/stripped_native_libs/stripReleaseDebugSymbols/release/out/lib
          mkdir -p build/app/intermediates/stripped_native_libs/release/out/lib
          
          echo "=== ÎÑ§Ïù¥Ìã∞Î∏å ÎùºÏù¥Î∏åÎü¨Î¶¨ ÌååÏùº Î≥µÏÇ¨ (Shorebird Issue #1798 Ìï¥Í≤∞) ==="
          # FlutterÍ∞Ä ÏÉùÏÑ±Ìïú ÎÑ§Ïù¥Ìã∞Î∏å ÎùºÏù¥Î∏åÎü¨Î¶¨ ÌååÏùºÎì§ÏùÑ ShorebirdÍ∞Ä Í∏∞ÎåÄÌïòÎäî ÏúÑÏπòÎ°ú Î≥µÏÇ¨
          echo "üìÅ ÎÑ§Ïù¥Ìã∞Î∏å ÎùºÏù¥Î∏åÎü¨Î¶¨ ÌååÏùº Í≤ÄÏÉâ Ï§ë..."
          find . -name "libapp.so" -type f 2>/dev/null | head -10
          
          # ShorebirdÍ∞Ä Í∏∞ÎåÄÌïòÎäî ÌÉÄÍ≤ü Í≤ΩÎ°ú (stripReleaseDebugSymbols ÏóÜÎäî Í≤ΩÎ°ú)
          SHOREBIRD_TARGET_PATH="build/app/intermediates/stripped_native_libs/release/out/lib"
          mkdir -p "$SHOREBIRD_TARGET_PATH"/{armeabi-v7a,arm64-v8a,x86,x86_64}
          
          # Ïã§Ï†ú ÌååÏùºÏù¥ ÏûàÎäî ÏÜåÏä§ Í≤ΩÎ°úÎì§ (stripReleaseDebugSymbols Ìè¨Ìï®)
          ACTUAL_SOURCE_PATHS=(
            "android/app/build/intermediates/stripped_native_libs/release/stripReleaseDebugSymbols/out/lib"
            "build/app/intermediates/stripped_native_libs/release/stripReleaseDebugSymbols/out/lib"
            "android/app/build/intermediates/merged_native_libs/release/mergeReleaseNativeLibs/out/lib"
            "build/app/intermediates/merged_native_libs/release/mergeReleaseNativeLibs/out/lib"
            "android/app/build/intermediates/stripped_native_libs/release/out/lib"
            "build/app/intermediates/stripped_native_libs/release/out/lib"
          )
          
          # ÏÜåÏä§ÏóêÏÑú ÌÉÄÍ≤üÏúºÎ°ú ÎÑ§Ïù¥Ìã∞Î∏å ÎùºÏù¥Î∏åÎü¨Î¶¨ Î≥µÏÇ¨
          COPIED_COUNT=0
          FOUND_SOURCE=""
          
          for source in "${ACTUAL_SOURCE_PATHS[@]}"; do
            if [ -d "$source" ] && [ "$(find "$source" -name "*.so" 2>/dev/null | wc -l)" -gt 0 ]; then
              echo "‚úÖ ÎÑ§Ïù¥Ìã∞Î∏å ÎùºÏù¥Î∏åÎü¨Î¶¨ ÏÜåÏä§ Î∞úÍ≤¨: $source"
              FOUND_SOURCE="$source"
              
              # Í∞Å ÏïÑÌÇ§ÌÖçÏ≤òÎ≥ÑÎ°ú Î≥µÏÇ¨
              for arch in armeabi-v7a arm64-v8a x86 x86_64; do
                if [ -d "$source/$arch" ] && [ "$(ls -A "$source/$arch" 2>/dev/null)" ]; then
                  echo "üì¶ $arch ÎùºÏù¥Î∏åÎü¨Î¶¨ Î≥µÏÇ¨ Ï§ë..."
                  
                  # ShorebirdÍ∞Ä Í∏∞ÎåÄÌïòÎäî ÏúÑÏπòÎ°ú Î≥µÏÇ¨
                  cp -r "$source/$arch"/* "$SHOREBIRD_TARGET_PATH/$arch/" 2>/dev/null
                  COPY_RESULT=$?
                  
                  # Î≥µÏÇ¨ ÏÑ±Í≥µ ÌôïÏù∏
                  if [ $COPY_RESULT -eq 0 ] && [ -f "$SHOREBIRD_TARGET_PATH/$arch/libapp.so" ]; then
                    COPIED_COUNT=$((COPIED_COUNT + 1))
                    FILE_SIZE=$(du -h "$SHOREBIRD_TARGET_PATH/$arch/libapp.so" | cut -f1)
                    echo "  ‚úÖ libapp.so Î≥µÏÇ¨ ÏÑ±Í≥µ ($arch, ÌÅ¨Í∏∞: $FILE_SIZE)"
                  fi
                  
                  if [ -f "$SHOREBIRD_TARGET_PATH/$arch/libflutter.so" ]; then
                    FILE_SIZE=$(du -h "$SHOREBIRD_TARGET_PATH/$arch/libflutter.so" | cut -f1)
                    echo "  ‚úÖ libflutter.so Î≥µÏÇ¨ ÏÑ±Í≥µ ($arch, ÌÅ¨Í∏∞: $FILE_SIZE)"
                  fi
                fi
              done
              break
            fi
          done
          
          # Î≥µÏÇ¨ Í≤∞Í≥º ÌôïÏù∏
          if [ $COPIED_COUNT -gt 0 ]; then
            echo "‚úÖ ÎÑ§Ïù¥Ìã∞Î∏å ÎùºÏù¥Î∏åÎü¨Î¶¨ Î≥µÏÇ¨ ÏôÑÎ£å ($COPIED_COUNTÍ∞ú ÏïÑÌÇ§ÌÖçÏ≤ò)"
            echo "üéØ ShorebirdÍ∞Ä Ï∞æÏùÑ Í≤ΩÎ°ú: $SHOREBIRD_TARGET_PATH"
            
            # ÏµúÏ¢Ö ÌôïÏù∏
            echo "üìã Î≥µÏÇ¨Îêú ÌååÏùº ÌôïÏù∏:"
            find "$SHOREBIRD_TARGET_PATH" -name "*.so" 2>/dev/null | while read file; do
              SIZE=$(du -h "$file" | cut -f1)
              echo "  - $file (ÌÅ¨Í∏∞: $SIZE)"
            done
          else
            echo "‚ùå ÎÑ§Ïù¥Ìã∞Î∏å ÎùºÏù¥Î∏åÎü¨Î¶¨ Î≥µÏÇ¨ Ïã§Ìå®"
            echo "üîç Í≤ÄÏÉâÌïú ÏÜåÏä§ Í≤ΩÎ°úÎì§:"
            for source in "${ACTUAL_SOURCE_PATHS[@]}"; do
              if [ -d "$source" ]; then
                FILE_COUNT=$(find "$source" -name "*.so" 2>/dev/null | wc -l)
                echo "  - $source (*.so ÌååÏùº $FILE_COUNTÍ∞ú)"
              else
                echo "  - $source (ÎîîÎ†âÌÜ†Î¶¨ ÏóÜÏùå)"
              fi
            done
            
            echo "‚ö†Ô∏è Shorebird Î¶¥Î¶¨Ï¶àÍ∞Ä Ïã§Ìå®Ìï† Ïàò ÏûàÏäµÎãàÎã§"
          fi
          
          echo "=== ÌëúÏ§Ä Flutter ÎπåÎìú Í≤∞Í≥ºÎ°ú Shorebird Î¶¥Î¶¨Ï¶à Ïã§Ìñâ ==="
          # Ïù¥ÎØ∏ FlutterÎ°ú ÎπåÎìúÎêú AAB/APKÎ•º ÏÇ¨Ïö©ÌïòÏó¨ Shorebird Î¶¥Î¶¨Ï¶à
          echo "üöÄ Android Î¶¥Î¶¨Ï¶à ÏãúÏûë (ÏµúÏã† Flutter 3.32.4 Î™ÖÏãú ÏßÄÏ†ï)..."
          RELEASE_RESULT=$(shorebird release android --dart-define=ENVIRONMENT=prod --flutter-version=latest 2>&1)
          RELEASE_EXIT_CODE=$?
          
          echo "Î¶¥Î¶¨Ï¶à Í≤∞Í≥º:"
          echo "$RELEASE_RESULT"
          
          # Î¶¥Î¶¨Ï¶à Í≤∞Í≥º ÌôïÏù∏
          if [ $RELEASE_EXIT_CODE -eq 0 ]; then
            if echo "$RELEASE_RESULT" | grep -i "successfully\|completed\|deployed\|published\|release.*created"; then
              echo "=== Shorebird Android Î¶¥Î¶¨Ï¶à ÏÑ±Í≥µ ==="
              echo "‚úÖ Android Î¶¥Î¶¨Ï¶àÍ∞Ä ShorebirdÎ•º ÌÜµÌï¥ ÏÑ±Í≥µÏ†ÅÏúºÎ°ú Î∞∞Ìè¨ÎêòÏóàÏäµÎãàÎã§"
              
              # Î¶¥Î¶¨Ï¶à Ï†ïÎ≥¥ Ï∂îÏ∂ú Î∞è ÌëúÏãú
              if echo "$RELEASE_RESULT" | grep -i "release.*version\|build.*version"; then
                echo ""
                echo "üì± Î¶¥Î¶¨Ï¶à Ï†ïÎ≥¥:"
                echo "$RELEASE_RESULT" | grep -i "release.*version\|build.*version" | head -3
              fi
            else
              echo "=== Shorebird Android Î¶¥Î¶¨Ï¶à Ïû¨ÏãúÎèÑ ÌïÑÏöî ==="
              echo "‚ö†Ô∏è Î¶¥Î¶¨Ï¶à Í≤∞Í≥ºÍ∞Ä Î∂àÎ∂ÑÎ™ÖÌï©ÎãàÎã§. Ïû¨ÏãúÎèÑÌï©ÎãàÎã§..."
              sleep 3
              
              echo "üîÑ Android Î¶¥Î¶¨Ï¶à Ïû¨ÏãúÎèÑ (ÏµúÏã† Flutter 3.32.4)..."
              RETRY_RESULT=$(shorebird release android --dart-define=ENVIRONMENT=prod --flutter-version=latest 2>&1)
              RETRY_EXIT_CODE=$?
              
              if [ $RETRY_EXIT_CODE -eq 0 ]; then
                echo "‚úÖ Ïû¨ÏãúÎèÑ ÏÑ±Í≥µ!"
                echo "$RETRY_RESULT"
              else
                echo "‚ùå Ïû¨ÏãúÎèÑÎèÑ Ïã§Ìå®ÌñàÏäµÎãàÎã§."
                echo "$RETRY_RESULT"
                exit 1
              fi
            fi
          else
            echo "=== Shorebird Android Î¶¥Î¶¨Ï¶à Ïã§Ìå® ==="
            echo "‚ùå Android Î¶¥Î¶¨Ï¶àÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§ (Ï¢ÖÎ£å ÏΩîÎìú: $RELEASE_EXIT_CODE)"
            
            # Ïã§Ìå® ÏõêÏù∏ Î∂ÑÏÑù
            if echo "$RELEASE_RESULT" | grep -i "keystore\|signing"; then
              echo "üîç ÏÑúÎ™Ö Í¥ÄÎ†® Î¨∏Ï†úÎ°ú Î≥¥ÏûÖÎãàÎã§"
            elif echo "$RELEASE_RESULT" | grep -i "flutter.*build.*fail"; then
              echo "üîç Flutter ÎπåÎìú Î¨∏Ï†úÎ°ú Î≥¥ÏûÖÎãàÎã§"
            elif echo "$RELEASE_RESULT" | grep -i "no.*release\|app.*not.*found"; then
              echo "üîç Ïï± Îì±Î°ù Î¨∏Ï†úÎ°ú Î≥¥ÏûÖÎãàÎã§"
            fi
            
            exit 1
          fi

          echo "=== ÏµúÏ¢Ö Artifacts ÏÉÅÌÉú ÏöîÏïΩ ==="
          if [ "$AAB_BUILD_SUCCESS" = true ]; then
            echo "‚úÖ AAB: ÎπåÎìú Î∞è Î≥µÍµ¨ ÏÑ±Í≥µ, Google Play Î∞∞Ìè¨ Í∞ÄÎä•"
            if [ -f "build/app/outputs/bundle/release/app-release.aab" ]; then
              AAB_FINAL_SIZE=$(du -h "build/app/outputs/bundle/release/app-release.aab" | cut -f1)
              echo "   üì¶ AAB ÌååÏùº ÌÅ¨Í∏∞: $AAB_FINAL_SIZE"
            fi
          else
            echo "‚ùå AAB: ÎπåÎìú Ïã§Ìå® ÎòêÎäî Î≥µÍµ¨ Î∂àÍ∞Ä, Google Play Î∞∞Ìè¨ Î∂àÍ∞Ä"
          fi
          
          if [ "$APK_BUILD_SUCCESS" = true ]; then
            echo "‚úÖ APK: ÎπåÎìú Î∞è Î≥µÍµ¨ ÏÑ±Í≥µ, ÏßÅÏ†ë Î∞∞Ìè¨ Í∞ÄÎä•"
            if [ -f "build/app/outputs/flutter-apk/app-release.apk" ]; then
              APK_FINAL_SIZE=$(du -h "build/app/outputs/flutter-apk/app-release.apk" | cut -f1)
              echo "   üì¶ APK ÌååÏùº ÌÅ¨Í∏∞: $APK_FINAL_SIZE"
            fi
          else
            echo "‚ùå APK: ÎπåÎìú Ïã§Ìå® ÎòêÎäî Î≥µÍµ¨ Î∂àÍ∞Ä"
          fi
          
          echo ""
          echo "üéØ Shorebird Î¶¥Î¶¨Ï¶à Î∞è Î™®Îì† ÎπåÎìú ÏûëÏóÖ ÏôÑÎ£å!"
          echo "üìÅ ÏÉùÏÑ±Îêú Artifacts:"
          echo "   - AAB: $([ "$AAB_BUILD_SUCCESS" = true ] && echo "‚úÖ ÏÑ±Í≥µ" || echo "‚ùå Ïã§Ìå®")"
          echo "   - APK: $([ "$APK_BUILD_SUCCESS" = true ] && echo "‚úÖ ÏÑ±Í≥µ" || echo "‚ùå Ïã§Ìå®")"
          echo "   - Shorebird: ‚úÖ Î¶¥Î¶¨Ï¶à ÏôÑÎ£å"

    artifacts:
      - picnic_app/build/app/outputs/bundle/release/app-release.aab
      - picnic_app/build/app/outputs/apk/release/app-release.apk
      - picnic_app/build/app/outputs/flutter-apk/app-release.apk
      - picnic_app/build/**/outputs/**/mapping.txt
      - picnic_app/flutter_drive.log

    publishing:
      google_play:
        credentials: $GCLOUD_SERVICE_ACCOUNT_CREDENTIALS
        track: internal
        submit_as_draft: true
      slack:
        channel: '#codemagic-picnic'
        notify_on_build_start: true
        notify:
          success: true
          failure: true
      email:
        recipients:
          - ironlove77@gmail.com
        notify:
          success: true
          failure: true

  # =================== PICNIC APP iOS Patch (Shorebird) ===================
  picnic-app-patch-ios:
    name: Picnic App - iOS Patch (Shorebird)
    instance_type: mac_mini_m2
    max_build_duration: 60
    integrations:
      app_store_connect: codemagic-picnic
    environment:
      ios_signing:
        distribution_type: app_store
        bundle_identifier: io.iconcasting.picnic.app
      groups:
        - app_store_connect
        - shorebird-config
        - picnic_env
      flutter: 3.32.4
      vars:
        APP_NAME: "picnic_app"
        BUNDLE_ID: "io.iconcasting.picnic.app"
    cache:
      cache_paths:
        - $FLUTTER_ROOT/.pub-cache
        - $HOME/.gradle/caches
        - $HOME/Library/Caches/CocoaPods
    triggering:
      events:
        - push
        - tag
      # hotfix, patch Î∏åÎûúÏπòÏôÄ patch ÌÉúÍ∑∏Î°ú Ìä∏Î¶¨Í±∞
      branch_patterns:
        - pattern: 'hotfix/*'
          include: true
        - pattern: 'patch/*'
          include: true
      tag_patterns:
        - pattern: 'picnic-patch-*'
          include: true
      cancel_previous_builds: true
    scripts:
      - name: Install Shorebird CLI
        script: |
          echo "=== Shorebird CLI ÏÑ§Ïπò ÏãúÏûë ==="
          
          # Í∏∞Ï°¥ ÏÑ§Ïπò ÌôïÏù∏
          if [ -f "$HOME/.shorebird/bin/shorebird" ]; then
            echo "‚úÖ Shorebird CLIÍ∞Ä Ïù¥ÎØ∏ ÏÑ§ÏπòÎêòÏñ¥ ÏûàÏäµÎãàÎã§"
            "$HOME/.shorebird/bin/shorebird" --version
          else
            echo "üîÑ Shorebird CLI ÏÉàÎ°ú ÏÑ§Ïπò..."
            
            # Flutter 3.32.4 Ìò∏Ìôò Shorebird Î≤ÑÏ†Ñ Í≥†Ï†ï ÏÑ§Ïπò (iOS)
            echo "üîß Flutter 3.32.4 Ìò∏Ìôò Shorebird Í≥†Ï†ï Î≤ÑÏ†Ñ ÏÑ§Ïπò Ï§ë..."
            
            # Flutter 3.32.4ÏôÄ Ï†ïÌôïÌûà Ìò∏ÌôòÎêòÎäî Shorebird Î≤ÑÏ†Ñ
            SHOREBIRD_VERSION="1.6.47"  # Flutter 3.32.4 ÏôÑÎ≤Ω Ìò∏Ìôò Í≤ÄÏ¶ù Î≤ÑÏ†Ñ
            
            # ÌîåÎû´ÌèºÎ≥Ñ Î∞îÏù¥ÎÑàÎ¶¨ Îã§Ïö¥Î°úÎìú
            PLATFORM=$(uname -s | tr '[:upper:]' '[:lower:]')
            ARCH=$(uname -m)
            
            if [ "$ARCH" = "x86_64" ]; then
              ARCH="x64"
            elif [ "$ARCH" = "aarch64" ] || [ "$ARCH" = "arm64" ]; then
              ARCH="arm64"
            fi
            
            echo "ÌîåÎû´Ìèº: $PLATFORM-$ARCH, Í≥†Ï†ï Î≤ÑÏ†Ñ: v$SHOREBIRD_VERSION (Flutter 3.32.4 Ï†ïÌôï Îß§Ïπ≠)"
            
            # GitHub releasesÏóêÏÑú ÌäπÏ†ï Î≤ÑÏ†Ñ Îã§Ïö¥Î°úÎìú
            mkdir -p "$HOME/.shorebird/bin"
            DOWNLOAD_URL="https://github.com/shorebirdtech/shorebird/releases/download/v$SHOREBIRD_VERSION/shorebird-$PLATFORM-$ARCH"
            
            echo "Îã§Ïö¥Î°úÎìú: $DOWNLOAD_URL"
            curl -L "$DOWNLOAD_URL" -o "$HOME/.shorebird/bin/shorebird" --fail --silent --show-error
            
            # ÏÑ§Ïπò ÏôÑÎ£å ÌôïÏù∏
            if [ $? -eq 0 ] && [ -f "$HOME/.shorebird/bin/shorebird" ]; then
              chmod +x "$HOME/.shorebird/bin/shorebird"
              echo "‚úÖ Shorebird v$SHOREBIRD_VERSION Í≥†Ï†ï ÏÑ§Ïπò ÏÑ±Í≥µ (Flutter 3.32.4 Ï†ïÌôï Îß§Ïπ≠)"
              "$HOME/.shorebird/bin/shorebird" --version
            else
              echo "‚ö†Ô∏è Í≥†Ï†ï Î≤ÑÏ†Ñ ÏÑ§Ïπò Ïã§Ìå® - ÏµúÏã† Ïä§ÌÅ¨Î¶ΩÌä∏Î°ú Ìè¥Î∞±"
              curl --proto '=https' --tlsv1.2 https://raw.githubusercontent.com/shorebirdtech/install/main/install.sh -sSf | bash
              
              if [ -f "$HOME/.shorebird/bin/shorebird" ]; then
                echo "‚úÖ Ìè¥Î∞±ÏúºÎ°ú Shorebird CLI ÏÑ§Ïπò ÏÑ±Í≥µ"
                "$HOME/.shorebird/bin/shorebird" --version
              else
                echo "‚ùå Î™®Îì† ÏÑ§Ïπò Î∞©Î≤ï Ïã§Ìå®"
                exit 1
              fi
            fi
          fi
          
          # PATH ÏÑ§Ï†ïÏùÑ ÌôòÍ≤Ω ÌååÏùºÎ°ú Ï†ÄÏû• (Îã§Ïùå Îã®Í≥ÑÏóêÏÑú ÏÇ¨Ïö©)
          echo "export PATH=\"$HOME/.shorebird/bin:\$PATH\"" > /tmp/shorebird_env.sh
          echo "‚úÖ Shorebird CLI ÏÑ§Ïπò Î∞è ÌôòÍ≤Ω ÏÑ§Ï†ï ÏôÑÎ£å"

      - name: Get Flutter packages and prepare iOS
        script: |
          cd picnic_app
          echo "=== Flutter Ìå®ÌÇ§ÏßÄ ÏÑ§Ïπò ==="
          flutter packages pub get
          
          echo "=== Flutter iOS ÏÑ§Ï†ï ÏÉùÏÑ± ==="
          flutter precache --ios
          flutter build ios --config-only

      - name: Install CocoaPods dependencies
        script: |
          cd picnic_app
          
          echo "=== Generated.xcconfig ÌååÏùº ÌôïÏù∏ ==="
          if [ ! -f "ios/Flutter/Generated.xcconfig" ]; then
            echo "‚ö†Ô∏è Generated.xcconfig ÌååÏùºÏù¥ ÏóÜÏùå - Flutter ÏÑ§Ï†ï Ïû¨ÏÉùÏÑ±"
            flutter build ios --config-only
          fi
          
          echo "‚úÖ Generated.xcconfig ÌååÏùº Ï°¥Ïû¨ ÌôïÏù∏:"
          ls -la ios/Flutter/Generated.xcconfig
          
          echo "=== CocoaPods ÏÑ§Ïπò ÏãúÏûë ==="
          cd ios
          pod install

      - name: Verify iOS Signing Configuration
        script: |
          echo "=== iOS ÏÑúÎ™Ö ÌôòÍ≤Ω ÌôïÏù∏ ==="
          echo "DEVELOPMENT_TEAM: ${DEVELOPMENT_TEAM:-'24SL34R9HR'}"
          
          # Distribution Certificate Ï†ïÎ≥¥ ÌôïÏù∏
          DIST_CERT_INFO=$(security find-identity -v -p codesigning | grep -i distribution | head -1)
          if [ -n "$DIST_CERT_INFO" ]; then
            echo "‚úÖ Distribution Ïù∏Ï¶ùÏÑú: $DIST_CERT_INFO"
          else
            echo "‚ùå Distribution Ïù∏Ï¶ùÏÑúÎ•º Ï∞æÏùÑ Ïàò ÏóÜÏùå"
            echo "ÏÇ¨Ïö© Í∞ÄÎä•Ìïú Ïù∏Ï¶ùÏÑúÎì§:"
            security find-identity -v -p codesigning
            exit 1
          fi
          
          # Provisioning Profile Ï†ïÎ≥¥ ÌôïÏù∏
          PROFILE_COUNT=$(find "$HOME/Library/MobileDevice/Provisioning Profiles" -name "*.mobileprovision" 2>/dev/null | wc -l)
          echo "ÏÑ§ÏπòÎêú ÌîÑÎ°úÎπÑÏ†ÄÎãù ÌîÑÎ°úÌååÏùº Í∞úÏàò: $PROFILE_COUNTÍ∞ú"
          
          if [ "$PROFILE_COUNT" -gt 0 ]; then
            echo "‚úÖ ÌîÑÎ°úÎπÑÏ†ÄÎãù ÌîÑÎ°úÌååÏùº Î™©Î°ù:"
            find "$HOME/Library/MobileDevice/Provisioning Profiles" -name "*.mobileprovision" 2>/dev/null | while read profile; do
              PROFILE_NAME=$(security cms -D -i "$profile" 2>/dev/null | grep -A1 "<key>Name</key>" | tail -1 | sed 's/.*<string>\(.*\)<\/string>.*/\1/' | tr -d '\n')
              echo "  - $(basename "$profile" .mobileprovision): $PROFILE_NAME"
            done
          else
            echo "‚ùå ÌîÑÎ°úÎπÑÏ†ÄÎãù ÌîÑÎ°úÌååÏùºÏùÑ Ï∞æÏùÑ Ïàò ÏóÜÏùå"
            exit 1
          fi

      - name: Configure Xcode Project for Manual Signing
        script: |
          cd picnic_app/ios
          
          echo "=== Xcode ÌîÑÎ°úÏ†ùÌä∏ Manual Signing ÏÑ§Ï†ï ==="
          # Manual Signing Í∞ïÏ†ú ÏÑ§Ï†ï (Distribution Ïù∏Ï¶ùÏÑú ÏÇ¨Ïö©)
          echo "üìù Manual Signing Í∞ïÏ†ú ÌôúÏÑ±Ìôî..."
          sed -i '' "s/CODE_SIGN_STYLE = Automatic;/CODE_SIGN_STYLE = Manual;/g" Runner.xcodeproj/project.pbxproj
          sed -i '' "s/CODE_SIGN_IDENTITY = \"\";/CODE_SIGN_IDENTITY = \"Apple Distribution\";/g" Runner.xcodeproj/project.pbxproj
          sed -i '' "s/CODE_SIGN_IDENTITY = \"Apple Development\";/CODE_SIGN_IDENTITY = \"Apple Distribution\";/g" Runner.xcodeproj/project.pbxproj
          sed -i '' "s/\"CODE_SIGN_IDENTITY\[sdk=iphoneos\*\]\" = \"iPhone Developer\";/\"CODE_SIGN_IDENTITY[sdk=iphoneos*]\" = \"Apple Distribution\";/g" Runner.xcodeproj/project.pbxproj
          
          # ÌîÑÎ°úÎπÑÏ†ÄÎãù ÌîÑÎ°úÌååÏùº ÏÑ§Ï†ï
          sed -i '' "s/PROVISIONING_PROFILE_SPECIFIER = \"\";/PROVISIONING_PROFILE_SPECIFIER = \"picnic_app_profile_2025\";/g" Runner.xcodeproj/project.pbxproj
          
          # PROVISIONING_PROFILE_SPECIFIER Ï∂îÍ∞Ä (Ï°¥Ïû¨ÌïòÏßÄ ÏïäÎäî Í≤ΩÏö∞)
          if ! grep -q "PROVISIONING_PROFILE_SPECIFIER" Runner.xcodeproj/project.pbxproj; then
            sed -i '' '/DEVELOPMENT_TEAM = /a\
          PROVISIONING_PROFILE_SPECIFIER = "picnic_app_profile_2025";' Runner.xcodeproj/project.pbxproj
          fi
          
          # Development Team ÏÑ§Ï†ï Ïú†ÏßÄ
          sed -i '' "s/DEVELOPMENT_TEAM = \"\";/DEVELOPMENT_TEAM = \"24SL34R9HR\";/g" Runner.xcodeproj/project.pbxproj
          sed -i '' "s/DEVELOPMENT_TEAM = 24SL34R9HR;/DEVELOPMENT_TEAM = \"24SL34R9HR\";/g" Runner.xcodeproj/project.pbxproj
          
          echo "‚úÖ Manual Signing ÏÑ§Ï†ï ÏôÑÎ£å"
          echo "- CODE_SIGN_STYLE: Manual"  
          echo "- DEVELOPMENT_TEAM: 24SL34R9HR"
          echo "- CODE_SIGN_IDENTITY: Apple Distribution"
          echo "- PROVISIONING_PROFILE_SPECIFIER: picnic_app_profile_2025"

      - name: Shorebird iOS Patch
        script: |
          cd picnic_app
          
          # ÌôòÍ≤Ω ÌååÏùºÏóêÏÑú PATH ÏÑ§Ï†ï Î°úÎìú
          if [ -f "/tmp/shorebird_env.sh" ]; then
            source /tmp/shorebird_env.sh
          fi
          
          # PATHÎ•º Î™ÖÏãúÏ†ÅÏúºÎ°ú ÏÑ§Ï†ï
          export PATH="$HOME/.shorebird/bin:$PATH"
          
          # Shorebird CLI Ï°¥Ïû¨ ÌôïÏù∏
          if [ ! -f "$HOME/.shorebird/bin/shorebird" ]; then
            echo "‚ùå Shorebird CLIÍ∞Ä ÏÑ§ÏπòÎêòÏßÄ ÏïäÏïòÏäµÎãàÎã§"
            echo "ÏÑ§Ïπò Îã®Í≥ÑÎ•º Îã§Ïãú ÌôïÏù∏Ìï¥Ï£ºÏÑ∏Ïöî"
            exit 1
          fi

          echo "=== Shorebird iOS Ìå®Ïπò ÏãúÏûë ==="
          echo "Shorebird Î≤ÑÏ†Ñ ÌôïÏù∏:"
          "$HOME/.shorebird/bin/shorebird" --version || {
            echo "‚ö†Ô∏è ÏßÅÏ†ë Í≤ΩÎ°úÎ°ú Shorebird Ïã§Ìñâ Ïã§Ìå®, PATH ÌôïÏù∏ Ï§ë..."
            echo "PATH: $PATH"
            echo "which shorebird: $(which shorebird || echo 'not found')"
            echo "Shorebird ÌååÏùº ÌôïÏù∏: $(ls -la $HOME/.shorebird/bin/shorebird 2>/dev/null || echo 'not found')"
            exit 1
          }

          echo "=== Shorebird Ïù∏Ï¶ù ÌôïÏù∏ ==="
          if [ -z "$SHOREBIRD_TOKEN" ]; then
            echo "‚ùå SHOREBIRD_TOKEN ÌôòÍ≤ΩÎ≥ÄÏàòÍ∞Ä ÏÑ§Ï†ïÎêòÏßÄ ÏïäÏïòÏäµÎãàÎã§"
            exit 1
          else
            echo "‚úÖ SHOREBIRD_TOKEN ÌôòÍ≤ΩÎ≥ÄÏàòÍ∞Ä ÏÑ§Ï†ïÎêòÏóàÏäµÎãàÎã§"
          fi

          echo "=== Shorebird CLI ÏÉÅÌÉú ÌôïÏù∏ ==="
          echo "Shorebird Î≤ÑÏ†Ñ:"
          "$HOME/.shorebird/bin/shorebird" --version 2>/dev/null || echo "Shorebird Î≤ÑÏ†Ñ ÌôïÏù∏ Ïã§Ìå®"

          echo "=== Flutter ÎπåÎìú ÌÖåÏä§Ìä∏ ==="
          # Ìå®Ïπò ÏÉùÏÑ± Ï†ÑÏóê Flutter ÎπåÎìúÍ∞Ä ÏÑ±Í≥µÌïòÎäîÏßÄ ÌôïÏù∏
          echo "üß™ Flutter IPA ÎπåÎìú ÌÖåÏä§Ìä∏ Ï§ë..."
          flutter build ios --release --dart-define=ENVIRONMENT=prod --analyze-size 2>/dev/null || {
            echo "‚ö†Ô∏è Flutter ÎπåÎìú ÌÖåÏä§Ìä∏ Ïã§Ìå® - Í∏∞Î≥∏ ÎπåÎìú ÌôïÏù∏"
            flutter build ios --release --dart-define=ENVIRONMENT=prod || echo "Flutter iOS ÎπåÎìú ÌôïÏù∏ Ïã§Ìå®"
          }

          echo "=== Shorebird Ï∫êÏãú Ï†ïÎ¶¨ Î∞è iOS Ìå®Ïπò Ï§ÄÎπÑ ==="
          # Shorebird Ï∫êÏãú Ï†ïÎ¶¨
          "$HOME/.shorebird/bin/shorebird" cache clean
          
          # Flutter Ï∫êÏãú Ï†ïÎ¶¨
          flutter clean
          flutter pub get
          
          echo "=== iOS ÎπåÎìú ÎîîÎ†âÌÜ†Î¶¨ Ï§ÄÎπÑ ==="
          # iOS ÎπåÎìú ÎîîÎ†âÌÜ†Î¶¨ ÎØ∏Î¶¨ ÏÉùÏÑ±
          mkdir -p build/ios/iphoneos
          mkdir -p build/ios/Release-iphoneos
          
          echo "=== Shorebird iOS Ìå®Ïπò ÏÉùÏÑ± Î∞è Î∞∞Ìè¨ ==="
          # Ìå®Ïπò ÏÉùÏÑ± (Í∞ÄÏû• ÏµúÏã† Î¶¥Î¶¨Ï¶àÏóê ÎåÄÌïú Ìå®Ïπò)
          echo "üöÄ iOS Ìå®Ïπò ÏÉùÏÑ± ÏãúÏûë (ÏûêÎèô Flutter Î≤ÑÏ†Ñ Í∞êÏßÄ)..."
          PATCH_RESULT=$("$HOME/.shorebird/bin/shorebird" patch ios \
            --release-version=latest \
            --no-confirm \
            --dart-define=ENVIRONMENT=prod \
            --verbose 2>&1)
          PATCH_EXIT_CODE=$?
          
          echo "Ìå®Ïπò Í≤∞Í≥º Ï∂úÎ†•:"
          echo "$PATCH_RESULT"
          
          # Ìå®Ïπò Í≤∞Í≥º ÌôïÏù∏ Î∞è Ï†ÅÏ†àÌïú Ï≤òÎ¶¨
          if [ $PATCH_EXIT_CODE -eq 0 ]; then
            if echo "$PATCH_RESULT" | grep -i "successfully\|completed\|deployed\|published patch"; then
              echo "=== Shorebird iOS Ìå®Ïπò ÏÑ±Í≥µ ==="
              echo "‚úÖ iOS Ìå®ÏπòÍ∞Ä ShorebirdÎ•º ÌÜµÌï¥ ÏÑ±Í≥µÏ†ÅÏúºÎ°ú Î∞∞Ìè¨ÎêòÏóàÏäµÎãàÎã§"
              echo "üöÄ ÏÇ¨Ïö©ÏûêÎì§ÏùÄ Ïï±ÏùÑ Ïû¨ÏãúÏûëÌïòÎ©¥ ÏûêÎèôÏúºÎ°ú Ìå®ÏπòÍ∞Ä Ï†ÅÏö©Îê©ÎãàÎã§"
              
              # Ìå®Ïπò Ï†ïÎ≥¥ Ï∂îÏ∂ú Î∞è ÌëúÏãú
              if echo "$PATCH_RESULT" | grep -i "published patch"; then
                echo ""
                echo "üì± Ìå®Ïπò Î∞∞Ìè¨ Ï†ïÎ≥¥:"
                echo "$PATCH_RESULT" | grep -A 5 -i "ready to publish\|published patch" | tail -6
              fi
            else
              echo "=== Shorebird iOS Ìå®Ïπò Î∂àÏôÑÏ†Ñ ==="
              echo "‚ö†Ô∏è Ìå®Ïπò Î™ÖÎ†πÏñ¥Îäî ÏÑ±Í≥µÌñàÏßÄÎßå Í≤∞Í≥ºÍ∞Ä Î∂àÎ∂ÑÎ™ÖÌï©ÎãàÎã§"
              echo "Ìå®Ïπò Í≤∞Í≥ºÎ•º Îã§Ïãú ÌôïÏù∏Ìï¥Ï£ºÏÑ∏Ïöî"
              exit 1
            fi
          else
            echo "=== Shorebird iOS Ìå®Ïπò Ïã§Ìå® ==="
            echo "‚ùå iOS Ìå®Ïπò ÏÉùÏÑ±/Î∞∞Ìè¨Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§ (Ï¢ÖÎ£å ÏΩîÎìú: $PATCH_EXIT_CODE)"
            
            # Ïã§Ìå® ÏõêÏù∏ Î∂ÑÏÑù
            if echo "$PATCH_RESULT" | grep -i "no.*account\|profile"; then
              echo "üîç ÏÑúÎ™Ö Í¥ÄÎ†® Î¨∏Ï†úÎ°ú Î≥¥ÏûÖÎãàÎã§:"
              echo "- CodeMagic iOS ÏÑúÎ™Ö ÏÑ§Ï†ïÏùÑ ÌôïÏù∏ÌïòÏÑ∏Ïöî"
              echo "- Apple Developer Í≥ÑÏ†ï Ïó∞Í≤∞ ÏÉÅÌÉúÎ•º ÌôïÏù∏ÌïòÏÑ∏Ïöî"
              echo "- ÌîÑÎ°úÎπÑÏ†ÄÎãù ÌîÑÎ°úÌååÏùº Ïú†Ìö®ÏÑ±ÏùÑ ÌôïÏù∏ÌïòÏÑ∏Ïöî"
            elif echo "$PATCH_RESULT" | grep -i "flutter.*build.*fail"; then
              echo "üîç Flutter ÎπåÎìú Î¨∏Ï†úÎ°ú Î≥¥ÏûÖÎãàÎã§:"
              echo "- Flutter Î≤ÑÏ†Ñ Ìò∏ÌôòÏÑ±ÏùÑ ÌôïÏù∏ÌïòÏÑ∏Ïöî"
              echo "- ÏùòÏ°¥ÏÑ± Ìå®ÌÇ§ÏßÄÎì§ÏùÑ ÌôïÏù∏ÌïòÏÑ∏Ïöî"
            elif echo "$PATCH_RESULT" | grep -i "no.*release"; then
              echo "üîç Í∏∞Ï°¥ Î¶¥Î¶¨Ï¶àÍ∞Ä ÏóÜÎäî Î¨∏Ï†úÎ°ú Î≥¥ÏûÖÎãàÎã§:"
              echo "- Î®ºÏ†Ä Ï†ÑÏ≤¥ Î¶¥Î¶¨Ï¶àÎ•º Î∞∞Ìè¨Ìïú ÌõÑ Ìå®ÏπòÎ•º ÏãúÎèÑÌïòÏÑ∏Ïöî"
            fi
            
            exit 1
          fi

    artifacts:
      - picnic_app/flutter_drive.log

    publishing:
      slack:
        channel: '#codemagic-picnic'
        notify_on_build_start: true
        notify:
          success: true
          failure: true
      email:
        recipients:
          - ironlove77@gmail.com
        notify:
          success: true
          failure: true

  # =================== PICNIC APP Android Patch (Shorebird) ===================
  picnic-app-patch-android:
    name: Picnic App - Android Patch (Shorebird)
    instance_type: mac_mini_m2
    max_build_duration: 60
    environment:
      android_signing:
        - picnic_keystore
      groups:
        - shorebird-config
        - picnic_env
      flutter: 3.32.4
      java: 17
      vars:
        PATH: $PATH:$HOME/.shorebird/bin
        APP_NAME: "picnic_app"
    cache:
      cache_paths:
        - $FLUTTER_ROOT/.pub-cache
        - $HOME/.gradle/caches
        - $HOME/.gradle/wrapper
        - $HOME/.android/build-cache
        - picnic_app/.dart_tool
        - picnic_app/android/.gradle
    triggering:
      events:
        - push
        - tag
      # hotfix, patch Î∏åÎûúÏπòÏôÄ patch ÌÉúÍ∑∏Î°ú Ìä∏Î¶¨Í±∞
      branch_patterns:
        - pattern: 'hotfix/*'
          include: true
        - pattern: 'patch/*'
          include: true
      tag_patterns:
        - pattern: 'picnic-patch-*'
          include: true
      cancel_previous_builds: true
    scripts:
      - name: Install Shorebird CLI
        script: |
          echo "=== Shorebird CLI ÏÑ§Ïπò ÏãúÏûë ==="
          
          # Í∏∞Ï°¥ ÏÑ§Ïπò ÌôïÏù∏
          if [ -f "$HOME/.shorebird/bin/shorebird" ]; then
            echo "‚úÖ Shorebird CLIÍ∞Ä Ïù¥ÎØ∏ ÏÑ§ÏπòÎêòÏñ¥ ÏûàÏäµÎãàÎã§"
            "$HOME/.shorebird/bin/shorebird" --version
          else
            echo "üîÑ Shorebird CLI ÏÉàÎ°ú ÏÑ§Ïπò..."
            
            # Flutter 3.32.4 Ìò∏Ìôò Shorebird Î≤ÑÏ†Ñ Í≥†Ï†ï ÏÑ§Ïπò (Android)
            echo "üîß Flutter 3.32.4 Ìò∏Ìôò Shorebird Í≥†Ï†ï Î≤ÑÏ†Ñ ÏÑ§Ïπò Ï§ë..."
            
            # Flutter 3.32.4ÏôÄ Ï†ïÌôïÌûà Ìò∏ÌôòÎêòÎäî Shorebird Î≤ÑÏ†Ñ
            SHOREBIRD_VERSION="1.6.47"  # Flutter 3.32.4 ÏôÑÎ≤Ω Ìò∏Ìôò Í≤ÄÏ¶ù Î≤ÑÏ†Ñ
            
            # ÌîåÎû´ÌèºÎ≥Ñ Î∞îÏù¥ÎÑàÎ¶¨ Îã§Ïö¥Î°úÎìú
            PLATFORM=$(uname -s | tr '[:upper:]' '[:lower:]')
            ARCH=$(uname -m)
            
            if [ "$ARCH" = "x86_64" ]; then
              ARCH="x64"
            elif [ "$ARCH" = "aarch64" ] || [ "$ARCH" = "arm64" ]; then
              ARCH="arm64"
            fi
            
            echo "ÌîåÎû´Ìèº: $PLATFORM-$ARCH, Í≥†Ï†ï Î≤ÑÏ†Ñ: v$SHOREBIRD_VERSION (Flutter 3.32.4 Ï†ïÌôï Îß§Ïπ≠)"
            
            # GitHub releasesÏóêÏÑú ÌäπÏ†ï Î≤ÑÏ†Ñ Îã§Ïö¥Î°úÎìú
            mkdir -p "$HOME/.shorebird/bin"
            DOWNLOAD_URL="https://github.com/shorebirdtech/shorebird/releases/download/v$SHOREBIRD_VERSION/shorebird-$PLATFORM-$ARCH"
            
            echo "Îã§Ïö¥Î°úÎìú: $DOWNLOAD_URL"
            curl -L "$DOWNLOAD_URL" -o "$HOME/.shorebird/bin/shorebird" --fail --silent --show-error
            
            # ÏÑ§Ïπò ÏôÑÎ£å ÌôïÏù∏
            if [ $? -eq 0 ] && [ -f "$HOME/.shorebird/bin/shorebird" ]; then
              chmod +x "$HOME/.shorebird/bin/shorebird"
              echo "‚úÖ Shorebird v$SHOREBIRD_VERSION Í≥†Ï†ï ÏÑ§Ïπò ÏÑ±Í≥µ (Flutter 3.32.4 Ï†ïÌôï Îß§Ïπ≠)"
              "$HOME/.shorebird/bin/shorebird" --version
            else
              echo "‚ö†Ô∏è Í≥†Ï†ï Î≤ÑÏ†Ñ ÏÑ§Ïπò Ïã§Ìå® - ÏµúÏã† Ïä§ÌÅ¨Î¶ΩÌä∏Î°ú Ìè¥Î∞±"
              curl --proto '=https' --tlsv1.2 https://raw.githubusercontent.com/shorebirdtech/install/main/install.sh -sSf | bash
              
              if [ -f "$HOME/.shorebird/bin/shorebird" ]; then
                echo "‚úÖ Ìè¥Î∞±ÏúºÎ°ú Shorebird CLI ÏÑ§Ïπò ÏÑ±Í≥µ"
                "$HOME/.shorebird/bin/shorebird" --version
              else
                echo "‚ùå Î™®Îì† ÏÑ§Ïπò Î∞©Î≤ï Ïã§Ìå®"
                exit 1
              fi
            fi
          fi
          
          # PATH ÏÑ§Ï†ïÏùÑ ÌôòÍ≤Ω ÌååÏùºÎ°ú Ï†ÄÏû• (Îã§Ïùå Îã®Í≥ÑÏóêÏÑú ÏÇ¨Ïö©)
          echo "export PATH=\"$HOME/.shorebird/bin:\$PATH\"" > /tmp/shorebird_env.sh
          echo "‚úÖ Shorebird CLI ÏÑ§Ïπò Î∞è ÌôòÍ≤Ω ÏÑ§Ï†ï ÏôÑÎ£å"

      - name: Get Flutter packages
        script: |
          cd picnic_app
          flutter packages pub get

      - name: Verify Keystore Configuration
        script: |
          echo "=== ÌÇ§Ïä§ÌÜ†Ïñ¥ ÌôòÍ≤Ω Î≥ÄÏàò ÌôïÏù∏ ==="
          echo "CM_KEYSTORE_PATH: ${CM_KEYSTORE_PATH:-'ÎØ∏ÏÑ§Ï†ï'}"
          echo "CM_KEYSTORE_PASSWORD: ${CM_KEYSTORE_PASSWORD:-'ÎØ∏ÏÑ§Ï†ï'}"
          echo "CM_KEY_ALIAS: ${CM_KEY_ALIAS:-'ÎØ∏ÏÑ§Ï†ï'}"
          echo "CM_KEY_PASSWORD: ${CM_KEY_PASSWORD:-'ÎØ∏ÏÑ§Ï†ï'}"
          
          if [ -z "$CM_KEYSTORE_PATH" ] || [ -z "$CM_KEYSTORE_PASSWORD" ] || [ -z "$CM_KEY_ALIAS" ] || [ -z "$CM_KEY_PASSWORD" ]; then
            echo "‚ùå ÌÇ§Ïä§ÌÜ†Ïñ¥ ÌôòÍ≤Ω Î≥ÄÏàòÍ∞Ä Ïò¨Î∞îÎ•¥Í≤å ÏÑ§Ï†ïÎêòÏßÄ ÏïäÏïòÏäµÎãàÎã§"
            echo "CodeMagic ÎåÄÏãúÎ≥¥ÎìúÏóêÏÑú 'picnic_keystore' Í∑∏Î£π ÏÑ§Ï†ïÏùÑ ÌôïÏù∏Ìï¥Ï£ºÏÑ∏Ïöî"
            exit 1
          fi
          
          if [ -f "$CM_KEYSTORE_PATH" ]; then
            echo "‚úÖ ÌÇ§Ïä§ÌÜ†Ïñ¥ ÌååÏùº Ï°¥Ïû¨: $CM_KEYSTORE_PATH"
            # ÌÇ§Ïä§ÌÜ†Ïñ¥ Ï†ïÎ≥¥ ÌôïÏù∏
            keytool -list -v -keystore "$CM_KEYSTORE_PATH" -alias "$CM_KEY_ALIAS" -storepass "$CM_KEYSTORE_PASSWORD" | grep -E "(SHA1|SHA256|Subject|Issuer)" | head -3 || echo "ÌÇ§Ïä§ÌÜ†Ïñ¥ Ï†ïÎ≥¥ ÌôïÏù∏ Ïã§Ìå®"
          else
            echo "‚ùå ÌÇ§Ïä§ÌÜ†Ïñ¥ ÌååÏùºÏùÑ Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§: $CM_KEYSTORE_PATH"
            exit 1
          fi

      - name: Configure Gradle Consistent with Release (Patch)
        script: |
          cd picnic_app
          
          echo "=== Gradle Î©îÎ™®Î¶¨ ÏÑ§Ï†ï (Î¶¥Î¶¨Ï¶àÏôÄ ÎèôÏùºÌïòÍ≤å 6GB) ==="
          mkdir -p $HOME/.gradle
          
          # Í∏∞Ï°¥ gradle.properties Ï†ïÎ¶¨ (Ï§ëÎ≥µ Î∞©ÏßÄ)
          rm -f $HOME/.gradle/gradle.properties
          
          # Î¶¥Î¶¨Ï¶àÏôÄ ÏôÑÏ†ÑÌûà ÎèôÏùºÌïú Î©îÎ™®Î¶¨ ÏÑ§Ï†ï (6GB) + ÎπåÎìú Ïû¨ÌòÑÏÑ± Í∞ïÌôî
          echo "org.gradle.jvmargs=-Xmx6144m -XX:MaxMetaspaceSize=512m -XX:+HeapDumpOnOutOfMemoryError -Dfile.encoding=UTF-8" >> $HOME/.gradle/gradle.properties
          echo "org.gradle.daemon=true" >> $HOME/.gradle/gradle.properties
          echo "org.gradle.caching=true" >> $HOME/.gradle/gradle.properties
          echo "org.gradle.parallel=false" >> $HOME/.gradle/gradle.properties
          echo "android.enableJetifier=true" >> $HOME/.gradle/gradle.properties
          echo "android.useAndroidX=true" >> $HOME/.gradle/gradle.properties
          echo "android.enableR8.fullMode=false" >> $HOME/.gradle/gradle.properties
          
          # ÎπåÎìú Ïû¨ÌòÑÏÑ± Í∞ïÌôî (DEX ÌååÏùº ÏùºÍ¥ÄÏÑ±ÏùÑ ÏúÑÌï¥) - deprecated ÏÑ§Ï†ï Ï†úÍ±∞
          echo "org.gradle.vfs.watch=false" >> $HOME/.gradle/gradle.properties
          echo "kotlin.incremental=false" >> $HOME/.gradle/gradle.properties
          echo "kotlin.incremental.useClasspathSnapshot=false" >> $HOME/.gradle/gradle.properties
          echo "org.gradle.unsafe.configuration-cache=false" >> $HOME/.gradle/gradle.properties
          echo "android.experimental.enableSourceSetPathsMap=false" >> $HOME/.gradle/gradle.properties
          # android.enableD8.desugaring=false - deprecated, Ï†úÍ±∞Îê®
          # android.enableIncrementalDesugaring=false - deprecated, Ï†úÍ±∞Îê®
          
          # ÏãúÍ∞ÑÎåÄ Î∞è Î°úÏºÄÏùº Í≥†Ï†ï (ÎπÑÍ≤∞Ï†ïÎ°†Ï†Å ÏöîÏÜå Ï†úÍ±∞)
          export TZ=UTC
          export LANG=en_US.UTF-8
          export LC_ALL=en_US.UTF-8
          
          echo "‚úÖ Gradle ÏÑ§Ï†ï ÏôÑÎ£å (Î¶¥Î¶¨Ï¶àÏôÄ ÎèôÏùºÌïú 6GB ÏÑ§Ï†ï)"
          
          # JVM Î©îÎ™®Î¶¨ ÌôòÍ≤Ω Î≥ÄÏàòÎèÑ Î¶¥Î¶¨Ï¶àÏôÄ ÎèôÏùºÌïòÍ≤å ÏÑ§Ï†ï
          export GRADLE_OPTS="-Xmx6144m -XX:MaxMetaspaceSize=512m"
          export _JAVA_OPTIONS="-Xmx6144m"

      - name: Shorebird Android Patch with Enhanced Build Strategy
        script: |
          cd picnic_app
          
          # ÌôòÍ≤Ω ÌååÏùºÏóêÏÑú PATH ÏÑ§Ï†ï Î°úÎìú
          if [ -f "/tmp/shorebird_env.sh" ]; then
            source /tmp/shorebird_env.sh
          fi
          
          export PATH="$HOME/.shorebird/bin:$PATH"

          echo "=== Shorebird Android Ìå®Ïπò ÏãúÏûë (Î¶¥Î¶¨Ï¶àÏôÄ ÎèôÏùºÌïú ÌôòÍ≤Ω) ==="
          echo "Shorebird Î≤ÑÏ†Ñ ÌôïÏù∏:"
          "$HOME/.shorebird/bin/shorebird" --version

          echo "=== Shorebird Ïù∏Ï¶ù ÌôïÏù∏ ==="
          if [ -z "$SHOREBIRD_TOKEN" ]; then
            echo "‚ùå SHOREBIRD_TOKEN ÌôòÍ≤ΩÎ≥ÄÏàòÍ∞Ä ÏÑ§Ï†ïÎêòÏßÄ ÏïäÏïòÏäµÎãàÎã§"
            exit 1
          else
            echo "‚úÖ SHOREBIRD_TOKEN ÌôòÍ≤ΩÎ≥ÄÏàòÍ∞Ä ÏÑ§Ï†ïÎêòÏóàÏäµÎãàÎã§"
          fi

          echo "=== ÌôòÍ≤Ω ÏµúÏ†ÅÌôî Î∞è ÏÇ¨Ï†Ñ ÎπåÎìú ÌÖåÏä§Ìä∏ ==="
          # Shorebird Ï∫êÏãú Ï†ïÎ¶¨
          "$HOME/.shorebird/bin/shorebird" cache clean
          
          # Flutter Ï∫êÏãú Ï†ïÎ¶¨
          flutter clean
          flutter pub get
          
          # ÏãúÏä§ÌÖú Ï†ïÎ¶¨ (Î¶¥Î¶¨Ï¶àÏôÄ ÎèôÏùºÌïú ÏàòÏ§Ä)
          echo "üßπ ÏãúÏä§ÌÖú Ï†ïÎ¶¨..."
          
          # ÏôÑÏ†ÑÌïú ÎπåÎìú ÌôòÍ≤Ω Ï†ïÎ¶¨ (ÎπÑÍ≤∞Ï†ïÏ†Å ÏöîÏÜå Ï†úÍ±∞)
          rm -rf build/ android/app/build/ android/.gradle/ $HOME/.gradle/caches/ $HOME/.gradle/daemon/
          
          # ÌôòÍ≤Ω Î≥ÄÏàò Í≥†Ï†ï (ÎπåÎìú Ïû¨ÌòÑÏÑ± Í∑πÎåÄÌôî)
          export TZ=UTC
          export LANG=en_US.UTF-8
          export LC_ALL=en_US.UTF-8
          export SOURCE_DATE_EPOCH=1577836800  # 2020-01-01 Í≥†Ï†ï
          
          # JVM Î©îÎ™®Î¶¨ ÏµúÏ†ÅÌôî (Î¶¥Î¶¨Ï¶àÏôÄ ÎèôÏùº)
          export GRADLE_OPTS="-Xmx6144m -XX:MaxMetaspaceSize=512m"
          export _JAVA_OPTIONS="-Xmx6144m"
          
          echo "=== Flutter AAB ÎπåÎìú ÏÇ¨Ï†Ñ ÌÖåÏä§Ìä∏ (Î¨∏Ï†ú Ï°∞Í∏∞ Î∞úÍ≤¨) ==="
          # Flutter AAB ÎπåÎìúÎ•º Î®ºÏ†Ä ÌÖåÏä§Ìä∏Ìï¥ÏÑú Î¨∏Ï†úÍ∞Ä ÏûàÎäîÏßÄ ÌôïÏù∏
          echo "üß™ Flutter AAB ÎπåÎìú ÌÖåÏä§Ìä∏ ÏãúÏûë..."
          AAB_TEST_RESULT=$(flutter build appbundle --release --dart-define=ENVIRONMENT=prod 2>&1)
          AAB_TEST_EXIT_CODE=$?
          
          if [ $AAB_TEST_EXIT_CODE -eq 0 ]; then
            echo "‚úÖ Flutter AAB ÎπåÎìú ÌÖåÏä§Ìä∏ ÏÑ±Í≥µ!"
            echo "üéØ Shorebird Ìå®ÏπòÏóêÏÑúÎèÑ AAB ÎπåÎìúÍ∞Ä ÏÑ±Í≥µÌï† Í∞ÄÎä•ÏÑ±Ïù¥ ÎÜíÏäµÎãàÎã§"
            
            # ÏÑ±Í≥µÌïú ÎπåÎìúÏùò AAB ÌååÏùºÏùÑ ShorebirdÍ∞Ä ÏòàÏÉÅÌïòÎäî ÏúÑÏπòÎ°ú Î≥µÏÇ¨
            echo "üì¶ ÌëúÏ§Ä Flutter ÎπåÎìú Í≤∞Í≥ºÎ¨º Ï§ÄÎπÑ..."
            
            # AAB ÌååÏùº ÌÉêÏßÄ Î∞è Î≥µÏÇ¨
            if [ -f "build/app/outputs/bundle/release/app-release.aab" ]; then
              AAB_SIZE=$(du -h "build/app/outputs/bundle/release/app-release.aab" | cut -f1)
              echo "‚úÖ AAB ÌååÏùº ÌôïÏù∏Îê®: build/app/outputs/bundle/release/app-release.aab (ÌÅ¨Í∏∞: $AAB_SIZE)"
            elif [ -f "android/app/build/outputs/bundle/release/app-release.aab" ]; then
              # Îã§Î•∏ ÏúÑÏπòÏóê ÏûàÏúºÎ©¥ ÌëúÏ§Ä ÏúÑÏπòÎ°ú Î≥µÏÇ¨
              mkdir -p build/app/outputs/bundle/release/
              cp "android/app/build/outputs/bundle/release/app-release.aab" "build/app/outputs/bundle/release/app-release.aab"
              AAB_SIZE=$(du -h "build/app/outputs/bundle/release/app-release.aab" | cut -f1)
              echo "‚úÖ AAB ÌååÏùº Î≥µÏÇ¨ ÏôÑÎ£å: build/app/outputs/bundle/release/app-release.aab (ÌÅ¨Í∏∞: $AAB_SIZE)"
            else
              echo "‚ö†Ô∏è AAB ÌååÏùºÏùÑ ÏòàÏÉÅ ÏúÑÏπòÏóêÏÑú Ï∞æÏùÑ Ïàò ÏóÜÏùå"
            fi
            
          else
            echo "‚ùå Flutter AAB ÎπåÎìú ÌÖåÏä§Ìä∏ Ïã§Ìå®"
            echo "üîç AAB ÎπåÎìú Ïã§Ìå® ÏõêÏù∏ Î∂ÑÏÑù:"
            
            echo "üîÑ Î¶¥Î¶¨Ï¶àÏôÄ ÎèôÏùºÌïú ÌôòÍ≤ΩÏúºÎ°ú ÎπåÎìú Ïû¨ÏãúÎèÑ..."
          fi
          
          echo "=== ÎÑ§Ïù¥Ìã∞Î∏å ÎùºÏù¥Î∏åÎü¨Î¶¨ ÎîîÎ†âÌÜ†Î¶¨ ÎØ∏Î¶¨ ÏÉùÏÑ± ==="
          # ShorebirdÍ∞Ä Ï∞æÎäî ÎîîÎ†âÌÜ†Î¶¨Îì§ÏùÑ ÎØ∏Î¶¨ ÏÉùÏÑ±
          mkdir -p build/app/intermediates/stripped_native_libs/stripReleaseDebugSymbols/release/out/lib
          mkdir -p build/app/intermediates/stripped_native_libs/release/out/lib
          
          echo "=== ÎÑ§Ïù¥Ìã∞Î∏å ÎùºÏù¥Î∏åÎü¨Î¶¨ ÌååÏùº Î≥µÏÇ¨ (Shorebird Issue #1798 Ìï¥Í≤∞) ==="
          # FlutterÍ∞Ä ÏÉùÏÑ±Ìïú ÎÑ§Ïù¥Ìã∞Î∏å ÎùºÏù¥Î∏åÎü¨Î¶¨ ÌååÏùºÎì§ÏùÑ ShorebirdÍ∞Ä Í∏∞ÎåÄÌïòÎäî ÏúÑÏπòÎ°ú Î≥µÏÇ¨
          echo "üìÅ ÎÑ§Ïù¥Ìã∞Î∏å ÎùºÏù¥Î∏åÎü¨Î¶¨ ÌååÏùº Í≤ÄÏÉâ Ï§ë..."
          find . -name "libapp.so" -type f 2>/dev/null | head -10
          
          # ShorebirdÍ∞Ä Í∏∞ÎåÄÌïòÎäî ÌÉÄÍ≤ü Í≤ΩÎ°ú (stripReleaseDebugSymbols ÏóÜÎäî Í≤ΩÎ°ú)
          SHOREBIRD_TARGET_PATH="build/app/intermediates/stripped_native_libs/release/out/lib"
          mkdir -p "$SHOREBIRD_TARGET_PATH"/{armeabi-v7a,arm64-v8a,x86,x86_64}
          
          # Ïã§Ï†ú ÌååÏùºÏù¥ ÏûàÎäî ÏÜåÏä§ Í≤ΩÎ°úÎì§ (stripReleaseDebugSymbols Ìè¨Ìï®)
          ACTUAL_SOURCE_PATHS=(
            "android/app/build/intermediates/stripped_native_libs/release/stripReleaseDebugSymbols/out/lib"
            "build/app/intermediates/stripped_native_libs/release/stripReleaseDebugSymbols/out/lib"
            "android/app/build/intermediates/merged_native_libs/release/mergeReleaseNativeLibs/out/lib"
            "build/app/intermediates/merged_native_libs/release/mergeReleaseNativeLibs/out/lib"
            "android/app/build/intermediates/stripped_native_libs/release/out/lib"
            "build/app/intermediates/stripped_native_libs/release/out/lib"
          )
          
          # ÏÜåÏä§ÏóêÏÑú ÌÉÄÍ≤üÏúºÎ°ú ÎÑ§Ïù¥Ìã∞Î∏å ÎùºÏù¥Î∏åÎü¨Î¶¨ Î≥µÏÇ¨
          COPIED_COUNT=0
          FOUND_SOURCE=""
          
          for source in "${ACTUAL_SOURCE_PATHS[@]}"; do
            if [ -d "$source" ] && [ "$(find "$source" -name "*.so" 2>/dev/null | wc -l)" -gt 0 ]; then
              echo "‚úÖ ÎÑ§Ïù¥Ìã∞Î∏å ÎùºÏù¥Î∏åÎü¨Î¶¨ ÏÜåÏä§ Î∞úÍ≤¨: $source"
              FOUND_SOURCE="$source"
              
              # Í∞Å ÏïÑÌÇ§ÌÖçÏ≤òÎ≥ÑÎ°ú Î≥µÏÇ¨
              for arch in armeabi-v7a arm64-v8a x86 x86_64; do
                if [ -d "$source/$arch" ] && [ "$(ls -A "$source/$arch" 2>/dev/null)" ]; then
                  echo "üì¶ $arch ÎùºÏù¥Î∏åÎü¨Î¶¨ Î≥µÏÇ¨ Ï§ë..."
                  
                  # ShorebirdÍ∞Ä Í∏∞ÎåÄÌïòÎäî ÏúÑÏπòÎ°ú Î≥µÏÇ¨
                  cp -r "$source/$arch"/* "$SHOREBIRD_TARGET_PATH/$arch/" 2>/dev/null
                  COPY_RESULT=$?
                  
                  # Î≥µÏÇ¨ ÏÑ±Í≥µ ÌôïÏù∏
                  if [ $COPY_RESULT -eq 0 ] && [ -f "$SHOREBIRD_TARGET_PATH/$arch/libapp.so" ]; then
                    COPIED_COUNT=$((COPIED_COUNT + 1))
                    FILE_SIZE=$(du -h "$SHOREBIRD_TARGET_PATH/$arch/libapp.so" | cut -f1)
                    echo "  ‚úÖ libapp.so Î≥µÏÇ¨ ÏÑ±Í≥µ ($arch, ÌÅ¨Í∏∞: $FILE_SIZE)"
                  fi
                  
                  if [ -f "$SHOREBIRD_TARGET_PATH/$arch/libflutter.so" ]; then
                    FILE_SIZE=$(du -h "$SHOREBIRD_TARGET_PATH/$arch/libflutter.so" | cut -f1)
                    echo "  ‚úÖ libflutter.so Î≥µÏÇ¨ ÏÑ±Í≥µ ($arch, ÌÅ¨Í∏∞: $FILE_SIZE)"
                  fi
                fi
              done
              break
            fi
          done
          
          # Î≥µÏÇ¨ Í≤∞Í≥º ÌôïÏù∏
          if [ $COPIED_COUNT -gt 0 ]; then
            echo "‚úÖ ÎÑ§Ïù¥Ìã∞Î∏å ÎùºÏù¥Î∏åÎü¨Î¶¨ Î≥µÏÇ¨ ÏôÑÎ£å ($COPIED_COUNTÍ∞ú ÏïÑÌÇ§ÌÖçÏ≤ò)"
            echo "üéØ ShorebirdÍ∞Ä Ï∞æÏùÑ Í≤ΩÎ°ú: $SHOREBIRD_TARGET_PATH"
          else
            echo "‚ö†Ô∏è ÎÑ§Ïù¥Ìã∞Î∏å ÎùºÏù¥Î∏åÎü¨Î¶¨ Î≥µÏÇ¨ Ïã§Ìå® - Ìå®ÏπòÍ∞Ä Ïã§Ìå®Ìï† Ïàò ÏûàÏäµÎãàÎã§"
          fi
          
          echo "=== Shorebird Android Ìå®Ïπò ÏÉùÏÑ± Î∞è Î∞∞Ìè¨ (Í∞ïÌôîÎêú Î©îÎ™®Î¶¨ ÏÑ§Ï†ï) ==="
          echo "üöÄ Android Ìå®Ïπò ÏãúÏûë (ÏÇ¨Ï†Ñ ÎπåÎìú ÏôÑÎ£åÎêú ÌôòÍ≤Ω)..."
          
          # ÏµúÏ¢Ö Î©îÎ™®Î¶¨ ÏÑ§Ï†ï ÌôïÏù∏
          echo "Î©îÎ™®Î¶¨ ÏÑ§Ï†ï ÏÉÅÌÉú:"
          echo "- GRADLE_OPTS: $GRADLE_OPTS"
          echo "- _JAVA_OPTIONS: $_JAVA_OPTIONS"
          echo "- JAVA_OPTS: $JAVA_OPTS"
          
          # Shorebird ÏûëÏóÖ ÎîîÎ†âÌÜ†Î¶¨ ÏµúÏ†ÅÌôî
          echo "üîß Shorebird ÌôòÍ≤Ω ÏµúÏ†ÅÌôî..."
          
          # 1Ï∞® ÏãúÎèÑ: ÌëúÏ§Ä Ìå®Ïπò Î™ÖÎ†πÏñ¥ (ÌôòÍ≤Ω Í≥†Ï†ï)
          echo "üì± 1Ï∞® ÏãúÎèÑ: ÌëúÏ§Ä Shorebird Ìå®Ïπò (ÎπåÎìú Ïû¨ÌòÑÏÑ± Í∑πÎåÄÌôî)..."
          
          # ÌôòÍ≤Ω Î≥ÄÏàò Ïû¨ÌôïÏù∏ Î∞è Í≥†Ï†ï
          export TZ=UTC
          export LANG=en_US.UTF-8  
          export LC_ALL=en_US.UTF-8
          export SOURCE_DATE_EPOCH=1577836800
          
          echo "ÎπåÎìú ÌôòÍ≤Ω ÏÉÅÌÉú:"
          echo "- TZ: $TZ"
          echo "- LANG: $LANG"
          echo "- SOURCE_DATE_EPOCH: $SOURCE_DATE_EPOCH"
          echo "- _JAVA_OPTIONS: $_JAVA_OPTIONS"
          
          PATCH_RESULT=$("$HOME/.shorebird/bin/shorebird" patch android \
            --release-version=latest \
            --no-confirm \
            --dart-define=ENVIRONMENT=prod 2>&1)
          PATCH_EXIT_CODE=$?
          
          echo "Ìå®Ïπò Í≤∞Í≥º Ï∂úÎ†•:"
          echo "$PATCH_RESULT"
          
          # Ìå®Ïπò Í≤∞Í≥º ÌôïÏù∏ Î∞è Ï†ÅÏ†àÌïú Ï≤òÎ¶¨
          if [ $PATCH_EXIT_CODE -eq 0 ]; then
            if echo "$PATCH_RESULT" | grep -i "successfully\|completed\|deployed\|published patch"; then
              echo "=== Shorebird Android Ìå®Ïπò ÏÑ±Í≥µ ==="
              echo "‚úÖ Android Ìå®ÏπòÍ∞Ä ShorebirdÎ•º ÌÜµÌï¥ ÏÑ±Í≥µÏ†ÅÏúºÎ°ú Î∞∞Ìè¨ÎêòÏóàÏäµÎãàÎã§"
              echo "üöÄ ÏÇ¨Ïö©ÏûêÎì§ÏùÄ Ïï±ÏùÑ Ïû¨ÏãúÏûëÌïòÎ©¥ ÏûêÎèôÏúºÎ°ú Ìå®ÏπòÍ∞Ä Ï†ÅÏö©Îê©ÎãàÎã§"
              
              # Ìå®Ïπò Ï†ïÎ≥¥ Ï∂îÏ∂ú Î∞è ÌëúÏãú
              if echo "$PATCH_RESULT" | grep -i "published patch"; then
                echo ""
                echo "üì± Ìå®Ïπò Î∞∞Ìè¨ Ï†ïÎ≥¥:"
                echo "$PATCH_RESULT" | grep -A 5 -i "ready to publish\|published patch" | tail -6
              fi
            else
              echo "=== Shorebird Android Ìå®Ïπò Î∂àÏôÑÏ†Ñ ==="
              echo "‚ö†Ô∏è Ìå®Ïπò Î™ÖÎ†πÏñ¥Îäî ÏÑ±Í≥µÌñàÏßÄÎßå Í≤∞Í≥ºÍ∞Ä Î∂àÎ∂ÑÎ™ÖÌï©ÎãàÎã§"
              echo "Ìå®Ïπò Í≤∞Í≥ºÎ•º Îã§Ïãú ÌôïÏù∏Ìï¥Ï£ºÏÑ∏Ïöî"
              exit 1
            fi
          else
            echo "=== Shorebird Android Ìå®Ïπò 1Ï∞® Ïã§Ìå® ==="
            echo "‚ùå 1Ï∞® Ìå®Ïπò ÏãúÎèÑ Ïã§Ìå® (Ï¢ÖÎ£å ÏΩîÎìú: $PATCH_EXIT_CODE)"
            
            # AAB ÌååÏùº Ï∞æÍ∏∞ Î¨∏Ï†úÏù∏ÏßÄ ÌôïÏù∏
            if echo "$PATCH_RESULT" | grep -i "failed.*produce.*aab\|couldn.*find.*aab"; then
              echo "üîç AAB ÌååÏùº ÌÉêÏßÄ Ïã§Ìå® Î¨∏Ï†úÎ°ú ÌåêÎã®Îê®"
              echo "üì¶ 2Ï∞® ÏãúÎèÑ: ÏàòÎèô AAB ÌååÏùº Î∞∞Ïπò ÌõÑ Ïû¨ÏãúÎèÑ..."
              
              # Î™®Îì† Í∞ÄÎä•Ìïú ÏúÑÏπòÏóêÏÑú AAB ÌååÏùº Ï∞æÍ∏∞
              echo "üîç ÏãúÏä§ÌÖú Ï†ÑÏ≤¥ÏóêÏÑú AAB ÌååÏùº Í≤ÄÏÉâ..."
              find /Users/builder/clone/picnic_app -name "*.aab" -type f 2>/dev/null | head -10
              
              AAB_FOUND=$(find /Users/builder/clone/picnic_app -name "*.aab" -type f 2>/dev/null | head -1)
              if [ -n "$AAB_FOUND" ]; then
                echo "‚úÖ AAB ÌååÏùº Î∞úÍ≤¨: $AAB_FOUND"
                
                # Ïó¨Îü¨ ÏúÑÏπòÏóê Î≥µÏÇ¨ÌïòÏó¨ ShorebirdÍ∞Ä Ï∞æÏùÑ Ïàò ÏûàÎèÑÎ°ù Ìï®
                mkdir -p build/app/outputs/bundle/release/
                mkdir -p android/app/build/outputs/bundle/release/
                
                cp "$AAB_FOUND" build/app/outputs/bundle/release/app-release.aab
                cp "$AAB_FOUND" android/app/build/outputs/bundle/release/app-release.aab
                
                echo "üîÑ 2Ï∞® Ìå®Ïπò ÏãúÎèÑ (AAB ÌååÏùº Î∞∞Ïπò ÏôÑÎ£å)..."
                PATCH_RESULT_2=$("$HOME/.shorebird/bin/shorebird" patch android \
                  --release-version=latest \
                  --no-confirm \
                  --dart-define=ENVIRONMENT=prod 2>&1)
                PATCH_EXIT_CODE_2=$?
                
                if [ $PATCH_EXIT_CODE_2 -eq 0 ]; then
                  echo "‚úÖ 2Ï∞® ÏãúÎèÑ ÏÑ±Í≥µ! AAB ÌååÏùº Î∞∞ÏπòÎ°ú Î¨∏Ï†ú Ìï¥Í≤∞Îê®"
                  echo "$PATCH_RESULT_2"
                else
                  echo "‚ùå 2Ï∞® ÏãúÎèÑÎèÑ Ïã§Ìå® (Ï¢ÖÎ£å ÏΩîÎìú: $PATCH_EXIT_CODE_2)"
                  echo "$PATCH_RESULT_2"
                  exit 1
                fi
              else
                echo "‚ùå ÏãúÏä§ÌÖúÏóêÏÑú AAB ÌååÏùºÏùÑ Ï∞æÏùÑ Ïàò ÏóÜÏùå"
                exit 1
              fi
            else
              echo "üîç Îã§Î•∏ Ï¢ÖÎ•òÏùò ÎπåÎìú Î¨∏Ï†úÎ°ú Î≥¥ÏûÖÎãàÎã§:"
              
              # Ïã§Ìå® ÏõêÏù∏ Î∂ÑÏÑù
              if echo "$PATCH_RESULT" | grep -i "keystore\|signing"; then
                echo "- ÏÑúÎ™Ö Í¥ÄÎ†® Î¨∏Ï†ú"
              elif echo "$PATCH_RESULT" | grep -i "flutter.*build.*fail\|gradle.*fail"; then
                echo "- Flutter/Gradle ÎπåÎìú Î¨∏Ï†ú"
              elif echo "$PATCH_RESULT" | grep -i "no.*release"; then
                echo "- Í∏∞Ï°¥ Î¶¥Î¶¨Ï¶à ÏóÜÏùå"
              elif echo "$PATCH_RESULT" | grep -i "java.*heap\|out.*of.*memory"; then
                echo "- Î©îÎ™®Î¶¨ Î∂ÄÏ°±"
              fi
              
              exit 1
            fi
          fi

    artifacts:
      - picnic_app/flutter_drive.log

    publishing:
      slack:
        channel: '#codemagic-picnic'
        notify_on_build_start: true
        notify:
          success: true
          failure: true
      email:
        recipients:
          - ironlove77@gmail.com
        notify:
          success: true
          failure: true