workflows:
  picnic-app-android:
    name: Picnic App - Android
    instance_type: mac_mini_m2
    max_build_duration: 120
    environment:
      android_signing:
        - picnic_keystore
      groups:
        - google_play
        - shorebird-config
        - picnic_env
      flutter: 3.32.4
      java: 17
      vars:
        PATH: $PATH:$HOME/.shorebird/bin
        APP_NAME: "picnic_app"
        # CodeMagicì´ android_signingì„ ì¸ì‹í•˜ë„ë¡ ê°•ì œ ì„¤ì •
        FLUTTER_BUILD_MODE: "release"
    cache:
      cache_paths:
        - $FLUTTER_ROOT/.pub-cache
        - $HOME/.gradle/caches
        - $HOME/.gradle/wrapper
        - $HOME/.android/build-cache
        - $HOME/Library/Caches/CocoaPods
        - picnic_app/.dart_tool
        - picnic_app/android/.gradle
    triggering:
      events:
        - push
        - tag
      # production ë¸Œëœì¹˜ í‘¸ì‹œ ë° íƒœê·¸ë¡œ íŠ¸ë¦¬ê±°
      branch_patterns:
        - pattern: 'production'
          include: true
      tag_patterns:
        - pattern: 'picnic-v*'
          include: true
      cancel_previous_builds: true
    scripts:
      - name: Install Shorebird CLI
        script: |
          echo "=== Shorebird CLI ì„¤ì¹˜ ì‹œì‘ ==="
          curl --proto '=https' --tlsv1.2 https://raw.githubusercontent.com/shorebirdtech/install/main/install.sh -sSf | bash
          export PATH="$HOME/.shorebird/bin:$PATH"
          shorebird --version || echo "Shorebird ì„¤ì¹˜ ì‹¤íŒ¨"

      - name: Get Flutter packages
        script: |
          cd picnic_app
          flutter packages pub get

      - name: Verify Keystore Configuration
        script: |
          echo "=== í‚¤ìŠ¤í† ì–´ í™˜ê²½ ë³€ìˆ˜ í™•ì¸ ==="
          echo "CM_KEYSTORE_PATH: ${CM_KEYSTORE_PATH:-'ë¯¸ì„¤ì •'}"
          echo "CM_KEYSTORE_PASSWORD: ${CM_KEYSTORE_PASSWORD:-'ë¯¸ì„¤ì •'}"
          echo "CM_KEY_ALIAS: ${CM_KEY_ALIAS:-'ë¯¸ì„¤ì •'}"
          echo "CM_KEY_PASSWORD: ${CM_KEY_PASSWORD:-'ë¯¸ì„¤ì •'}"
          
          if [ -z "$CM_KEYSTORE_PATH" ] || [ -z "$CM_KEYSTORE_PASSWORD" ] || [ -z "$CM_KEY_ALIAS" ] || [ -z "$CM_KEY_PASSWORD" ]; then
            echo "âŒ í‚¤ìŠ¤í† ì–´ í™˜ê²½ ë³€ìˆ˜ê°€ ì˜¬ë°”ë¥´ê²Œ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤"
            echo "CodeMagic ëŒ€ì‹œë³´ë“œì—ì„œ 'picnic_keystore' ê·¸ë£¹ ì„¤ì •ì„ í™•ì¸í•´ì£¼ì„¸ìš”"
            exit 1
          fi
          
          if [ -f "$CM_KEYSTORE_PATH" ]; then
            echo "âœ… í‚¤ìŠ¤í† ì–´ íŒŒì¼ ì¡´ì¬: $CM_KEYSTORE_PATH"
            # í‚¤ìŠ¤í† ì–´ ì •ë³´ í™•ì¸
            keytool -list -v -keystore "$CM_KEYSTORE_PATH" -alias "$CM_KEY_ALIAS" -storepass "$CM_KEYSTORE_PASSWORD" | grep -E "(SHA1|SHA256|Subject|Issuer)" || echo "í‚¤ìŠ¤í† ì–´ ì •ë³´ í™•ì¸ ì‹¤íŒ¨"
          else
            echo "âŒ í‚¤ìŠ¤í† ì–´ íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: $CM_KEYSTORE_PATH"
            exit 1
          fi

      - name: Build AAB and APK for Distribution
        script: |
          cd picnic_app
          
          echo "=== Gradle ë©”ëª¨ë¦¬ ì„¤ì • ìµœì í™” (Java Heap Space ì—ëŸ¬ í•´ê²°) ==="
          mkdir -p $HOME/.gradle
          # ë©”ëª¨ë¦¬ë¥¼ 6GBë¡œ ì¦ê°€í•˜ê³  ë©”ëª¨ë¦¬ ê´€ë ¨ ì˜µì…˜ ìµœì í™”
          echo "org.gradle.jvmargs=-Xmx6144m -XX:MaxMetaspaceSize=512m -XX:+HeapDumpOnOutOfMemoryError -Dfile.encoding=UTF-8" >> $HOME/.gradle/gradle.properties
          echo "org.gradle.daemon=true" >> $HOME/.gradle/gradle.properties
          echo "org.gradle.caching=true" >> $HOME/.gradle/gradle.properties
          echo "org.gradle.parallel=false" >> $HOME/.gradle/gradle.properties
          echo "android.enableJetifier=true" >> $HOME/.gradle/gradle.properties
          echo "android.useAndroidX=true" >> $HOME/.gradle/gradle.properties
          
          # Shorebird PATH ì„¤ì •
          export PATH="$HOME/.shorebird/bin:$PATH"
          
          # ê¹¨ë—í•œ ë¹Œë“œ í™˜ê²½
          flutter clean
          flutter pub get

          echo "=== ë¹Œë“œ ê²½ë¡œ ë¯¸ë¦¬ ì„¤ì • ==="
          # Flutterê°€ ì˜ˆìƒí•˜ëŠ” ê²½ë¡œì— ë””ë ‰í† ë¦¬ ë¯¸ë¦¬ ìƒì„±
          mkdir -p build/app/outputs/bundle/release/
          mkdir -p build/app/outputs/apk/release/
          mkdir -p build/app/outputs/flutter-apk/

          echo "=== ì„œëª… ì„¤ì • í™•ì¸ ==="
          echo "í‚¤ìŠ¤í† ì–´ ê²½ë¡œ: $CM_KEYSTORE_PATH"
          echo "í‚¤ ë³„ì¹­: $CM_KEY_ALIAS"

          echo "=== AAB ë¹Œë“œ ì‹œì‘ (ì„œëª… ì ìš©) ==="
          flutter build appbundle \
            --release \
            --dart-define=ENVIRONMENT=prod

          echo "=== APK ë¹Œë“œ ì‹œì‘ (ì„œëª… ì ìš©) ==="
          flutter build apk \
            --release \
            --dart-define=ENVIRONMENT=prod

          echo "=== ë¹Œë“œ ê²°ê³¼ í™•ì¸ ë° ê²½ë¡œ ë™ê¸°í™” ==="
          # ì‹¤ì œ ìƒì„±ëœ íŒŒì¼ì„ Flutterê°€ ì°¾ëŠ” ê²½ë¡œë¡œ ë³µì‚¬
          if [ -f "android/app/build/outputs/bundle/release/app-release.aab" ]; then
            # AAB ì„œëª… ê²€ì¦
            if jarsigner -verify "android/app/build/outputs/bundle/release/app-release.aab" > /dev/null 2>&1; then
              cp android/app/build/outputs/bundle/release/app-release.aab build/app/outputs/bundle/release/
              AAB_SIZE=$(du -h android/app/build/outputs/bundle/release/app-release.aab | cut -f1)
              echo "âœ… ì„œëª…ëœ AAB íŒŒì¼ì„ ì˜¬ë°”ë¥¸ ê²½ë¡œë¡œ ë³µì‚¬ë¨ (í¬ê¸°: $AAB_SIZE)"
              
              # ì„œëª… ì •ë³´ ì¶œë ¥
              echo "ğŸ“‹ AAB ì„œëª… ì •ë³´:"
              jarsigner -verify -verbose -certs "android/app/build/outputs/bundle/release/app-release.aab" | grep -E "(Certificate|Subject|Issuer)" | head -5
            else
              echo "âŒ AAB íŒŒì¼ì´ ì„œëª…ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤!"
              exit 1
            fi
          else
            echo "âŒ AAB íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤"
            echo "=== ë¹Œë“œ ë””ë ‰í† ë¦¬ êµ¬ì¡° í™•ì¸ ==="
            find . -name "*.aab" 2>/dev/null | head -5
            find build/ -type f -name "*" 2>/dev/null | grep -E "\.(aab|apk)$" | head -5
            find android/ -type f -name "*" 2>/dev/null | grep -E "\.(aab|apk)$" | head -5
            exit 1
          fi
          
          # 2. APK ë¹Œë“œ
          echo "=== 2ï¸âƒ£ APK ë¹Œë“œ ì‹œì‘ ==="
          flutter build apk --release --dart-define=ENVIRONMENT=prod --build-number=$BUILD_NUMBER
          
          # APK ë¹Œë“œ ê²°ê³¼ í™•ì¸
          echo "=== APK ë¹Œë“œ ê²°ê³¼ í™•ì¸ ==="
          if [ -f "build/app/outputs/flutter-apk/app-release.apk" ]; then
            APK_SIZE=$(du -h "build/app/outputs/flutter-apk/app-release.apk" | cut -f1)
            echo "âœ… APK ë¹Œë“œ ì„±ê³µ: build/app/outputs/flutter-apk/app-release.apk (í¬ê¸°: $APK_SIZE)"
          elif [ -f "android/app/build/outputs/apk/release/app-release.apk" ]; then
            # ê²½ë¡œ ìˆ˜ì •
            mkdir -p build/app/outputs/flutter-apk/
            mkdir -p build/app/outputs/apk/release/
            cp android/app/build/outputs/apk/release/app-release.apk build/app/outputs/flutter-apk/
            cp android/app/build/outputs/apk/release/app-release.apk build/app/outputs/apk/release/
            APK_SIZE=$(du -h "build/app/outputs/flutter-apk/app-release.apk" | cut -f1)
            echo "âœ… APK ë¹Œë“œ ì„±ê³µ (ê²½ë¡œ ìˆ˜ì •): build/app/outputs/flutter-apk/app-release.apk (í¬ê¸°: $APK_SIZE)"
          else
            echo "âŒ APK íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤"
            find . -name "*.apk" 2>/dev/null | head -5
            exit 1
          fi
          
          # 3. Shorebird ë¹Œë“œ
          echo "=== 3ï¸âƒ£ Shorebird ë¹Œë“œ ì‹œì‘ ==="
          if [ -z "$SHOREBIRD_TOKEN" ]; then
            echo "âŒ SHOREBIRD_TOKEN í™˜ê²½ë³€ìˆ˜ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤"
            exit 1
          fi

          echo "=== Shorebird ë¹Œë“œ ì‹œì‘ ==="
          shorebird release android --flutter-version 3.32.0 --dart-define=ENVIRONMENT=prod

          echo "=== ë¹Œë“œ ê²°ê³¼ í™•ì¸ ë° ê²½ë¡œ ì„¤ì • ==="
          # ëª¨ë“  ë¹Œë“œ ê²°ê³¼ íŒŒì¼ ì°¾ê¸°
          echo "ğŸ“ ìƒì„±ëœ ëª¨ë“  AAB íŒŒì¼:"
          find . -name "*.aab" -type f 2>/dev/null || echo "AAB íŒŒì¼ ì—†ìŒ"
          
          echo "ğŸ“ ìƒì„±ëœ ëª¨ë“  APK íŒŒì¼:"
          find . -name "*.apk" -type f 2>/dev/null || echo "APK íŒŒì¼ ì—†ìŒ"

          # artifactsê°€ ì°¾ì„ ìˆ˜ ìˆë„ë¡ ë””ë ‰í† ë¦¬ ìƒì„± ë° íŒŒì¼ ë³µì‚¬
          mkdir -p build/app/outputs/bundle/release/
          mkdir -p build/app/outputs/apk/release/
          mkdir -p build/app/outputs/flutter-apk/

          # AAB íŒŒì¼ ë³µì‚¬ (ì„œëª…ëœ íŒŒì¼ë§Œ)
          AAB_FILES=$(find . -name "*.aab" -type f 2>/dev/null)
          if [ -n "$AAB_FILES" ]; then
            for aab in $AAB_FILES; do
              echo "ğŸ” AAB íŒŒì¼ ê²€ì‚¬: $aab"
              # AAB íŒŒì¼ ì„œëª… ìƒíƒœ í™•ì¸
              if jarsigner -verify "$aab" > /dev/null 2>&1; then
                # íŒŒì¼ëª…ì„ app-release.aabë¡œ í†µì¼í•˜ì—¬ ë³µì‚¬
                cp "$aab" build/app/outputs/bundle/release/app-release.aab
                echo "âœ… ì„œëª…ëœ AAB ë³µì‚¬ë¨: $aab â†’ build/app/outputs/bundle/release/app-release.aab"
                
                # ì„œëª… ì •ë³´ ì¶œë ¥
                echo "ğŸ“‹ AAB ì„œëª… ì •ë³´:"
                jarsigner -verify -verbose -certs "$aab" | grep -E "(Certificate|Subject|Issuer)" | head -3
              else
                echo "âš ï¸ ì„œëª…ë˜ì§€ ì•Šì€ AAB íŒŒì¼ ê±´ë„ˆëœ€: $aab (Google Play ì—…ë¡œë“œ ë¶ˆê°€)"
              fi
            done
          else
            echo "âŒ AAB íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤"
          fi

          # APK íŒŒì¼ ë³µì‚¬ (ì„œëª…ëœ íŒŒì¼ë§Œ)
          APK_FILES=$(find . -name "*.apk" -type f 2>/dev/null)
          if [ -n "$APK_FILES" ]; then
            for apk in $APK_FILES; do
              echo "ğŸ” APK íŒŒì¼ ê²€ì‚¬: $apk"
              if jarsigner -verify "$apk" > /dev/null 2>&1; then
                cp "$apk" build/app/outputs/apk/release/app-release.apk
                cp "$apk" build/app/outputs/flutter-apk/app-release.apk
                echo "âœ… ì„œëª…ëœ APK ë³µì‚¬ë¨: $apk â†’ app-release.apk"
              else
                echo "âš ï¸ ì„œëª…ë˜ì§€ ì•Šì€ APK íŒŒì¼ ê±´ë„ˆëœ€: $apk"
              fi
            done
          else
            echo "âŒ APK íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤"
          fi

          echo "=== Artifact ì •ë¦¬ ì™„ë£Œ ==="

    artifacts:
      - picnic_app/build/app/outputs/bundle/release/app-release.aab
      - picnic_app/build/app/outputs/apk/release/app-release.apk
      - picnic_app/build/app/outputs/flutter-apk/app-release.apk
      - picnic_app/build/**/outputs/**/mapping.txt
      - picnic_app/flutter_drive.log

    publishing:
      google_play:
        credentials: $GCLOUD_SERVICE_ACCOUNT_CREDENTIALS
        track: internal
        submit_as_draft: true
      slack:
        channel: '#codemagic-picnic'
        notify_on_build_start: true
        notify:
          success: true
          failure: true
      email:
        recipients:
          - ironlove77@gmail.com
        notify:
          success: true
          failure: true

  # =================== PICNIC APP iOS ===================
  picnic-app-ios:
    name: Picnic App - iOS
    instance_type: mac_mini_m2
    max_build_duration: 120
    integrations:
      app_store_connect: codemagic-picnic
    environment:
      ios_signing:
        distribution_type: app_store
        bundle_identifier: io.iconcasting.picnic.app
      groups:
        - app_store_connect
        - shorebird-config
        - picnic_env
      flutter: 3.32.4
      vars:
        APP_NAME: "picnic_app"
        BUNDLE_ID: "io.iconcasting.picnic.app"
    cache:
      cache_paths:
        - $FLUTTER_ROOT/.pub-cache
        - $HOME/.gradle/caches
        - $HOME/Library/Caches/CocoaPods
    triggering:
      events:
        - push
        - tag
      branch_patterns:
        - pattern: 'production'
          include: true
      tag_patterns:
        - pattern: 'picnic-v*'
          include: true
      cancel_previous_builds: true
    scripts:
      - name: Get Flutter packages and prepare iOS
        script: |
          cd picnic_app
          echo "=== Flutter íŒ¨í‚¤ì§€ ì„¤ì¹˜ ==="
          flutter packages pub get
          
          echo "=== Flutter iOS ì„¤ì • ìƒì„± (Generated.xcconfig íŒŒì¼ ìƒì„±) ==="
          flutter precache --ios
          flutter build ios --config-only
          
          echo "=== Generated.xcconfig íŒŒì¼ í™•ì¸ ==="
          ls -la ios/Flutter/Generated.xcconfig || echo "âš ï¸ Generated.xcconfig íŒŒì¼ì´ ì•„ì§ ìƒì„±ë˜ì§€ ì•ŠìŒ"

      - name: Install CocoaPods dependencies
        script: |
          cd picnic_app
          
          echo "=== Generated.xcconfig íŒŒì¼ í™•ì¸ ==="
          if [ ! -f "ios/Flutter/Generated.xcconfig" ]; then
            echo "âš ï¸ Generated.xcconfig íŒŒì¼ì´ ì—†ìŒ - Flutter ì„¤ì • ì¬ìƒì„±"
            flutter build ios --config-only
          fi
          
          echo "âœ… Generated.xcconfig íŒŒì¼ ì¡´ì¬ í™•ì¸:"
          ls -la ios/Flutter/Generated.xcconfig
          
          echo "=== CocoaPods ì„¤ì¹˜ ì‹œì‘ ==="
          cd ios
          pod install

      - name: Install Shorebird CLI
        script: |
          echo "=== Shorebird CLI ì„¤ì¹˜ ì‹œì‘ ==="
          curl --proto '=https' --tlsv1.2 https://raw.githubusercontent.com/shorebirdtech/install/main/install.sh -sSf | bash
          export PATH="$HOME/.shorebird/bin:$PATH"
          shorebird --version || echo "Shorebird ì„¤ì¹˜ ì‹¤íŒ¨"

      - name: Build iOS IPA (CodeMagic Automatic Signing)
        script: |
          cd picnic_app
          
          echo "=== CodeMagic Automatic Signing IPA ë¹Œë“œ ==="
          echo "âœ… CodeMagic ìë™ ì„œëª… í™˜ê²½ ìµœì í™”"
          echo "âœ… Bundle ID: io.iconcasting.picnic.app"
          echo "âœ… Distribution Type: App Store"
          echo ""
          
          # CodeMagic ì„œëª… í™˜ê²½ í™•ì¸
          echo "=== CodeMagic ì„œëª… í™˜ê²½ í™•ì¸ ==="
          echo "DEVELOPMENT_TEAM: ${DEVELOPMENT_TEAM:-'24SL34R9HR'}"
          
          # Distribution Certificate ì •ë³´ í™•ì¸
          DIST_CERT_INFO=$(security find-identity -v -p codesigning | grep -i distribution | head -1)
          if [ -n "$DIST_CERT_INFO" ]; then
            echo "Distribution ì¸ì¦ì„œ: $DIST_CERT_INFO"
          else
            echo "âš ï¸ Distribution ì¸ì¦ì„œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ"
          fi
          
          # Provisioning Profile ì •ë³´ í™•ì¸
          PROFILE_COUNT=$(find "$HOME/Library/MobileDevice/Provisioning Profiles" -name "*.mobileprovision" 2>/dev/null | wc -l)
          echo "ì„¤ì¹˜ëœ í”„ë¡œë¹„ì €ë‹ í”„ë¡œíŒŒì¼ ê°œìˆ˜: $PROFILE_COUNTê°œ"
          
          if [ "$PROFILE_COUNT" -gt 0 ]; then
            echo "í”„ë¡œë¹„ì €ë‹ í”„ë¡œíŒŒì¼ ëª©ë¡:"
            find "$HOME/Library/MobileDevice/Provisioning Profiles" -name "*.mobileprovision" 2>/dev/null | while read profile; do
              PROFILE_NAME=$(security cms -D -i "$profile" 2>/dev/null | grep -A1 "<key>Name</key>" | tail -1 | sed 's/.*<string>\(.*\)<\/string>.*/\1/' | tr -d '\n')
              echo "  - $(basename "$profile" .mobileprovision): $PROFILE_NAME"
            done
          fi
          echo ""
          
          # Xcode í”„ë¡œì íŠ¸ê°€ Automatic Signingì„ ì‚¬ìš©í•˜ë„ë¡ í™•ì¸
          echo "=== Xcode í”„ë¡œì íŠ¸ Automatic Signing ì„¤ì • í™•ì¸ ==="
          cd ios
          
          # Automatic Signing ê°•ì œ ì„¤ì • (CodeMagic í™˜ê²½ì— ìµœì í™”)
          echo "ğŸ“ Automatic Signing ê°•ì œ í™œì„±í™”..."
          sed -i '' "s/CODE_SIGN_STYLE = Manual;/CODE_SIGN_STYLE = Automatic;/g" Runner.xcodeproj/project.pbxproj
          sed -i '' "s/CODE_SIGN_IDENTITY = \"Apple Distribution\";/CODE_SIGN_IDENTITY = \"\";/g" Runner.xcodeproj/project.pbxproj
          sed -i '' "s/\"CODE_SIGN_IDENTITY\[sdk=iphoneos\*\]\" = \"Apple Distribution\";/\"CODE_SIGN_IDENTITY[sdk=iphoneos*]\" = \"iPhone Developer\";/g" Runner.xcodeproj/project.pbxproj
          sed -i '' "/PROVISIONING_PROFILE_SPECIFIER = /d" Runner.xcodeproj/project.pbxproj
          
          # Development Team ì„¤ì •ì€ ìœ ì§€
          sed -i '' "s/DEVELOPMENT_TEAM = \"\";/DEVELOPMENT_TEAM = \"24SL34R9HR\";/g" Runner.xcodeproj/project.pbxproj
          sed -i '' "s/DEVELOPMENT_TEAM = 24SL34R9HR;/DEVELOPMENT_TEAM = \"24SL34R9HR\";/g" Runner.xcodeproj/project.pbxproj
          
          echo "âœ… Automatic Signing ì„¤ì • ì™„ë£Œ"
          echo "- CODE_SIGN_STYLE: Automatic"
          echo "- DEVELOPMENT_TEAM: 24SL34R9HR"
          echo "- CODE_SIGN_IDENTITY: (ìë™)"
          echo "- PROVISIONING_PROFILE: (ìë™)"
          
          cd ..
          echo ""
          
          # Flutter IPA ë¹Œë“œ (Automatic Signing)
          echo "=== Flutter IPA ë¹Œë“œ ì‹œì‘ ==="
          echo "CodeMagic Automatic Signingìœ¼ë¡œ ë¹Œë“œí•©ë‹ˆë‹¤."
          
          echo "ğŸš€ Automatic Signing IPA ë¹Œë“œ"
          flutter build ipa \
            --release \
            --dart-define=ENVIRONMENT=prod \
            --export-method=app-store
          
          BUILD_RESULT=$?
          
          # ë¹Œë“œ ê²°ê³¼ í™•ì¸
          echo ""
          echo "=== ë¹Œë“œ ê²°ê³¼ í™•ì¸ ==="
          
          if [ $BUILD_RESULT -eq 0 ]; then
            echo "ğŸ‰ Flutter IPA ë¹Œë“œ ëª…ë ¹ì–´ ì„±ê³µ!"
            
            # IPA íŒŒì¼ ìƒì„± ì—¬ë¶€ í™•ì¸
            if [ -f "build/ios/ipa/picnic_app.ipa" ]; then
              IPA_SIZE=$(du -h "build/ios/ipa/picnic_app.ipa" | cut -f1)
              echo "âœ… IPA íŒŒì¼ ìƒì„± ì™„ë£Œ: build/ios/ipa/picnic_app.ipa (í¬ê¸°: $IPA_SIZE)"
            elif [ -f "build/ios/ipa/Runner.ipa" ]; then
              IPA_SIZE=$(du -h "build/ios/ipa/Runner.ipa" | cut -f1)
              echo "âœ… IPA íŒŒì¼ ìƒì„± ì™„ë£Œ: build/ios/ipa/Runner.ipa (í¬ê¸°: $IPA_SIZE)"
              
              # picnic_app.ipaë¡œ ë³µì‚¬
              cp "build/ios/ipa/Runner.ipa" "build/ios/ipa/picnic_app.ipa"
              echo "âœ… picnic_app.ipaë¡œ ë³µì‚¬ ì™„ë£Œ"
            else
              echo "âš ï¸ ë¹Œë“œ ëª…ë ¹ì–´ëŠ” ì„±ê³µí–ˆì§€ë§Œ IPA íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŒ"
              echo "ğŸ“ ìƒì„±ëœ íŒŒì¼ë“¤:"
              find build/ios -name "*.ipa" -o -name "*.xcarchive" 2>/dev/null | head -5
              
              # Archiveê°€ ìˆëŠ” ê²½ìš° Manual Signingìš© ìˆ˜ë™ export ì‹œë„
              XCARCHIVE_PATH=$(find build/ios -name "*.xcarchive" | head -1)
              if [ -n "$XCARCHIVE_PATH" ]; then
                echo ""
                echo "ğŸ“¦ Archiveê°€ ë°œê²¬ë˜ì–´ ìˆ˜ë™ IPA exportë¥¼ ì‹œë„í•©ë‹ˆë‹¤..."
                echo "Archive ê²½ë¡œ: $XCARCHIVE_PATH"
                
                # ì„¤ì¹˜ëœ í”„ë¡œë¹„ì €ë‹ í”„ë¡œíŒŒì¼ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
                PROFILE_PATH=$(find "$HOME/Library/MobileDevice/Provisioning Profiles" -name "*.mobileprovision" | head -1)
                PROFILE_UUID=$(basename "$PROFILE_PATH" .mobileprovision)
                
                # í”„ë¡œë¹„ì €ë‹ í”„ë¡œíŒŒì¼ì—ì„œ ì‹¤ì œ ì´ë¦„ ì¶”ì¶œ
                PROFILE_NAME=$(security cms -D -i "$PROFILE_PATH" 2>/dev/null | grep -A1 "<key>Name</key>" | tail -1 | sed 's/.*<string>\(.*\)<\/string>.*/\1/' | tr -d '\n\t ')
                
                echo "í”„ë¡œë¹„ì €ë‹ í”„ë¡œíŒŒì¼ ê²½ë¡œ: $PROFILE_PATH"
                echo "í”„ë¡œë¹„ì €ë‹ í”„ë¡œíŒŒì¼ UUID: $PROFILE_UUID"
                echo "í”„ë¡œë¹„ì €ë‹ í”„ë¡œíŒŒì¼ ì‹¤ì œ ì´ë¦„: $PROFILE_NAME"
                
                # ì‹¤ì œ ì´ë¦„ì´ ìˆìœ¼ë©´ ì‚¬ìš©, ì—†ìœ¼ë©´ UUID ì‚¬ìš©
                if [ -n "$PROFILE_NAME" ] && [ "$PROFILE_NAME" != "" ]; then
                  PROFILE_IDENTIFIER="$PROFILE_NAME"
                  echo "ì‚¬ìš©í•  ì‹ë³„ì: ì‹¤ì œ ì´ë¦„ ($PROFILE_NAME)"
                else
                  PROFILE_IDENTIFIER="$PROFILE_UUID"
                  echo "ì‚¬ìš©í•  ì‹ë³„ì: UUID ($PROFILE_UUID)"
                fi
                
                # Manual Signingìš© ExportOptions.plist ìƒì„±
                echo "ğŸ“ Manual Signingìš© ExportOptions.plist ìƒì„±..."
                echo '<?xml version="1.0" encoding="UTF-8"?>' > ios/ExportOptions.plist
                echo '<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">' >> ios/ExportOptions.plist
                echo '<plist version="1.0">' >> ios/ExportOptions.plist
                echo '<dict>' >> ios/ExportOptions.plist
                echo '    <key>method</key>' >> ios/ExportOptions.plist
                echo '    <string>app-store-connect</string>' >> ios/ExportOptions.plist
                echo '    <key>teamID</key>' >> ios/ExportOptions.plist
                echo '    <string>24SL34R9HR</string>' >> ios/ExportOptions.plist
                echo '    <key>signingStyle</key>' >> ios/ExportOptions.plist
                echo '    <string>manual</string>' >> ios/ExportOptions.plist
                echo '    <key>signingCertificate</key>' >> ios/ExportOptions.plist
                echo '    <string>Apple Distribution</string>' >> ios/ExportOptions.plist
                echo '    <key>provisioningProfiles</key>' >> ios/ExportOptions.plist
                echo '    <dict>' >> ios/ExportOptions.plist
                echo '        <key>io.iconcasting.picnic.app</key>' >> ios/ExportOptions.plist
                echo "        <string>$PROFILE_IDENTIFIER</string>" >> ios/ExportOptions.plist
                echo '    </dict>' >> ios/ExportOptions.plist
                echo '    <key>stripSwiftSymbols</key>' >> ios/ExportOptions.plist
                echo '    <true/>' >> ios/ExportOptions.plist
                echo '    <key>uploadBitcode</key>' >> ios/ExportOptions.plist
                echo '    <false/>' >> ios/ExportOptions.plist
                echo '    <key>uploadSymbols</key>' >> ios/ExportOptions.plist
                echo '    <true/>' >> ios/ExportOptions.plist
                echo '</dict>' >> ios/ExportOptions.plist
                echo '</plist>' >> ios/ExportOptions.plist
                
                echo "ğŸš€ Manual Signingìœ¼ë¡œ IPA export ì‹œë„..."
                cd ios
                xcodebuild -exportArchive \
                  -archivePath "../$XCARCHIVE_PATH" \
                  -exportPath "../build/ios/ipa/" \
                  -exportOptionsPlist "ExportOptions.plist"
                
                EXPORT_RESULT=$?
                cd ..
                
                if [ $EXPORT_RESULT -eq 0 ]; then
                  echo "âœ… ìˆ˜ë™ IPA export ì„±ê³µ!"
                  
                  # IPA íŒŒì¼ í™•ì¸ ë° ì´ë¦„ ì •ê·œí™”
                  if [ -f "build/ios/ipa/picnic_app.ipa" ]; then
                    IPA_SIZE=$(du -h "build/ios/ipa/picnic_app.ipa" | cut -f1)
                    echo "âœ… ìµœì¢… IPA íŒŒì¼: build/ios/ipa/picnic_app.ipa (í¬ê¸°: $IPA_SIZE)"
                  elif [ -f "build/ios/ipa/Runner.ipa" ]; then
                    IPA_SIZE=$(du -h "build/ios/ipa/Runner.ipa" | cut -f1)
                    echo "âœ… ìµœì¢… IPA íŒŒì¼: build/ios/ipa/Runner.ipa (í¬ê¸°: $IPA_SIZE)"
                    cp "build/ios/ipa/Runner.ipa" "build/ios/ipa/picnic_app.ipa"
                    echo "âœ… picnic_app.ipaë¡œ ë³µì‚¬ ì™„ë£Œ"
                  else
                    echo "âš ï¸ ExportëŠ” ì„±ê³µí–ˆì§€ë§Œ IPA íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŒ"
                    ls -la build/ios/ipa/ 2>/dev/null || echo "IPA ë””ë ‰í† ë¦¬ ì—†ìŒ"
                  fi
                else
                  echo "âŒ ìˆ˜ë™ IPA export ì‹¤íŒ¨ (ì¢…ë£Œ ì½”ë“œ: $EXPORT_RESULT)"
                fi
              fi
            fi
            
            echo ""
            echo "ğŸ‰ CodeMagic Automatic Signing IPA ë¹Œë“œ ì™„ë£Œ!"
          else
            echo "âŒ Flutter IPA ë¹Œë“œ ì‹¤íŒ¨ (ì¢…ë£Œ ì½”ë“œ: $BUILD_RESULT)"
            echo ""
            echo "=== ë””ë²„ê¹… ì •ë³´ ==="
            echo "Flutter ë²„ì „:"
            flutter --version | head -3
            echo ""
            echo "Xcode í”„ë¡œì íŠ¸ ì„œëª… ì„¤ì • í™•ì¸:"
            grep -A 5 -B 5 "CODE_SIGN_STYLE\|DEVELOPMENT_TEAM" ios/Runner.xcodeproj/project.pbxproj | head -10
            echo ""
            echo "ì„¤ì¹˜ëœ ì¸ì¦ì„œ:"
            security find-identity -v -p codesigning | head -3
            echo ""
            echo "í”„ë¡œë¹„ì €ë‹ í”„ë¡œíŒŒì¼:"
            ls -la "$HOME/Library/MobileDevice/Provisioning Profiles/" 2>/dev/null | head -3 || echo "í”„ë¡œë¹„ì €ë‹ í”„ë¡œíŒŒì¼ ë””ë ‰í† ë¦¬ ì—†ìŒ"
            
            exit 1
          fi

      - name: Shorebird iOS Release
        script: |
          export PATH="$HOME/.shorebird/bin:$PATH"
          cd picnic_app

          echo "=== Shorebird iOS ë¦´ë¦¬ì¦ˆ ì‹œì‘ ==="
          echo "Shorebird ë²„ì „ í™•ì¸:"
          shorebird --version

          echo "=== Shorebird ì¸ì¦ í™•ì¸ ==="
          if [ -z "$SHOREBIRD_TOKEN" ]; then
            echo "âŒ SHOREBIRD_TOKEN í™˜ê²½ë³€ìˆ˜ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤"
            exit 1
          else
            echo "âœ… SHOREBIRD_TOKEN í™˜ê²½ë³€ìˆ˜ê°€ ì„¤ì •ë˜ì—ˆìŠµë‹ˆë‹¤"
          fi

          echo "=== Shorebird iOS ë¦´ë¦¬ì¦ˆ ì‹¤í–‰ ==="
          shorebird release ios \
            --flutter-version 3.32.0 \
            --dart-define=ENVIRONMENT=prod

          echo "=== Shorebird iOS ë¦´ë¦¬ì¦ˆ ì™„ë£Œ ==="
          echo "âœ… iOS ì•±ì´ Shorebirdì— ì„±ê³µì ìœ¼ë¡œ ë¦´ë¦¬ì¦ˆë˜ì—ˆìŠµë‹ˆë‹¤"

    artifacts:
      - picnic_app/build/ios/ipa/*.ipa
      - picnic_app/build/ios/Runner.xcarchive
      - picnic_app/flutter_drive.log

    publishing:
      app_store_connect:
        auth: integration
        submit_to_testflight: true
        beta_groups:
          - App Store Connect Users
      slack:
        channel: '#codemagic-picnic'
        notify_on_build_start: true
        notify:
          success: true
          failure: true
      email:
        recipients:
          - ironlove77@gmail.com
        notify:
          success: true
          failure: true

  # =================== TTJA APP Android (ë¹„í™œì„±í™”) ===================
  # ttja-app-android:
  #   name: TTJA App - Android
  #   instance_type: mac_mini_m2
  #   max_build_duration: 120
  #   environment:
  #     android_signing:
  #       - ttja_keystore
  #     groups:
  #       - google_play
  #       - ttja_env
  #     flutter: 3.32.0
  #     java: 17
  #     vars:
  #       APP_NAME: "ttja_app"
  #   cache:
  #     cache_paths:
  #       - $FLUTTER_ROOT/.pub-cache
  #       - $HOME/.gradle/caches
  #       - $HOME/Library/Caches/CocoaPods
  #   triggering:
  #     events:
  #       - push
  #     # TTJAëŠ” íƒœê·¸ë¡œë§Œ íŠ¸ë¦¬ê±° (ë¸Œëœì¹˜ íŠ¸ë¦¬ê±° ì œê±°)
  #     tag_patterns:
  #       - pattern: 'ttja-v*'
  #         include: true
  #     cancel_previous_builds: true
  #   scripts:
  #     - name: Set up debug keystore
  #       script: |
  #         set -e
  #         set -x
  #         keystore_path="/tmp/keystore.keystore"
  #         if [ -f "$keystore_path" ]; then
  #           echo "Keystore already exists"
  #         else
  #           keytool -genkey -v -keystore "$keystore_path" -alias androiddebugkey -storepass android -keypass android -keyalg RSA -keysize 2048 -validity 10000 -dname "CN=Android Debug,O=Android,C=US"
  #         fi

  #     - name: Get Flutter packages
  #       script: |
  #         cd ttja_app
  #         flutter packages pub get

  #     - name: Build AAB and APK for Distribution
  #       script: |
  #         cd ttja_app
  #         flutter clean
  #         flutter pub get

  #         echo "=== AAB ë¹Œë“œ ì‹œì‘ ==="
  #         flutter build appbundle --release --dart-define=ENVIRONMENT=prod

  #         echo "=== APK ë¹Œë“œ ì‹œì‘ ==="
  #         flutter build apk --release --dart-define=ENVIRONMENT=prod

  #         echo "=== ë¹Œë“œ ê²½ë¡œ ì„¤ì • ==="
  #         # Flutterê°€ ì˜ˆìƒí•˜ëŠ” ê²½ë¡œì— ë””ë ‰í† ë¦¬ ìƒì„±
  #         mkdir -p build/app/outputs/bundle/release/
  #         mkdir -p build/app/outputs/apk/release/
  #         mkdir -p build/app/outputs/flutter-apk/

  #         # ì‹¤ì œ ìƒì„±ëœ íŒŒì¼ì„ Flutterê°€ ì°¾ëŠ” ê²½ë¡œë¡œ ë³µì‚¬
  #         if [ -f "android/app/build/outputs/bundle/release/app-release.aab" ]; then
  #           cp android/app/build/outputs/bundle/release/app-release.aab build/app/outputs/bundle/release/
  #           echo "âœ… AAB íŒŒì¼ì„ ì˜¬ë°”ë¥¸ ê²½ë¡œë¡œ ë³µì‚¬ë¨"
  #         fi

  #         if [ -f "android/app/build/outputs/apk/release/app-release.apk" ]; then
  #           cp android/app/build/outputs/apk/release/app-release.apk build/app/outputs/apk/release/
  #           cp android/app/build/outputs/apk/release/app-release.apk build/app/outputs/flutter-apk/
  #           echo "âœ… APK íŒŒì¼ì„ ì˜¬ë°”ë¥¸ ê²½ë¡œë¡œ ë³µì‚¬ë¨"
  #         fi

  #         echo "=== ë¹Œë“œ ê²°ê³¼ í™•ì¸ ==="
  #         find build/app/outputs/ -name "*.aab" -o -name "*.apk" | head -10
  #         find android/app/build/outputs/ -name "*.aab" -o -name "*.apk" | head -10

  #   artifacts:
  #     - ttja_app/build/**/outputs/**/*.aab
  #     - ttja_app/build/**/outputs/**/*.apk
  #     - ttja_app/build/**/outputs/**/mapping.txt
  #     - ttja_app/flutter_drive.log

  #   publishing:
  #     google_play:
  #       credentials: $GCLOUD_SERVICE_ACCOUNT_CREDENTIALS
  #       track: internal
  #       submit_as_draft: true
  #     slack:
  #       channel: '#codemagic-ttja'
  #       notify_on_build_start: true
  #       notify:
  #         success: true
  #         failure: true
  #     email:
  #       recipients:
  #         - ironlove77@gmail.com
  #       notify:
  #         success: true
  #         failure: true

  # =================== TTJA APP iOS (ë¹„í™œì„±í™”) ===================
  # ttja-app-ios:
  #   name: TTJA App - iOS
  #   instance_type: mac_mini_m2
  #   max_build_duration: 120
  #   integrations:
  #     app_store_connect: codemagic-picnic
  #   environment:
  #     ios_signing:
  #       distribution_type: app_store
  #       bundle_identifier: com.fasoo.TTJA
  #       # CodeMagicì´ ìë™ìœ¼ë¡œ í”„ë¡œë¹„ì €ë‹ í”„ë¡œíŒŒì¼ì„ ìƒì„±í•˜ë„ë¡ ì„¤ì •
  #     groups:
  #       - app_store_connect
  #       - ttja_env
  #     flutter: 3.32.0
  #     vars:
  #       APP_NAME: "ttja_app"
  #       BUNDLE_ID: "com.fasoo.TTJA"
  #   cache:
  #     cache_paths:
  #       - $FLUTTER_ROOT/.pub-cache
  #       - $HOME/.gradle/caches
  #       - $HOME/Library/Caches/CocoaPods
  #   triggering:
  #     events:
  #       - push
  #     # TTJAëŠ” íƒœê·¸ë¡œë§Œ íŠ¸ë¦¬ê±° (ë¸Œëœì¹˜ íŠ¸ë¦¬ê±° ì œê±°)
  #     tag_patterns:
  #       - pattern: 'ttja-v*'
  #         include: true
  #     cancel_previous_builds: true
  #   scripts:
  #     - name: Get Flutter packages
  #       script: |
  #         cd ttja_app
  #         flutter packages pub get

  #     - name: Install CocoaPods dependencies
  #       script: |
  #         cd ttja_app/ios
  #         pod install

  #     - name: Build iOS Archive
  #       script: |
  #         cd ttja_app
  #         flutter clean
  #         flutter pub get

  #         echo "=== iOS Archive ë¹Œë“œ ì‹œì‘ ==="
  #         flutter build ipa --release --dart-define=ENVIRONMENT=prod

  #         echo "=== iOS ë¹Œë“œ ê²½ë¡œ ì„¤ì • ==="
  #         # Flutterê°€ ì˜ˆìƒí•˜ëŠ” ê²½ë¡œì— ë””ë ‰í† ë¦¬ ìƒì„±
  #         mkdir -p build/ios/archive/Runner/
  #         mkdir -p build/ios/ipa/

  #         # ì‹¤ì œ ìƒì„±ëœ IPA íŒŒì¼ì„ Flutterê°€ ì°¾ëŠ” ê²½ë¡œë¡œ ë³µì‚¬
  #         if [ -f "build/ios/ipa/ttja_app.ipa" ]; then
  #           echo "âœ… IPA íŒŒì¼ì´ ì´ë¯¸ ì˜¬ë°”ë¥¸ ê²½ë¡œì— ìˆìŠµë‹ˆë‹¤"
  #         else
  #           # IPA íŒŒì¼ ì°¾ê¸° ë° ë³µì‚¬
  #           IPA_FILE=$(find . -name "*.ipa" -type f | head -1)
  #           if [ -n "$IPA_FILE" ]; then
  #             cp "$IPA_FILE" build/ios/ipa/ttja_app.ipa
  #             echo "âœ… IPA íŒŒì¼ì„ ì˜¬ë°”ë¥¸ ê²½ë¡œë¡œ ë³µì‚¬ë¨: $IPA_FILE"
  #           fi
  #         fi

  #         echo "=== ë¹Œë“œ ê²°ê³¼ í™•ì¸ ==="
  #         find build/ios/ -name "*.ipa" | head -10
  #         find . -name "*.ipa" 2>/dev/null | head -10

  #   artifacts:
  #     - ttja_app/build/ios/ipa/*.ipa
  #     - ttja_app/build/ios/archive/Runner.xcarchive
  #     - ttja_app/flutter_drive.log

  #   publishing:
  #     app_store_connect:
  #       auth: integration
  #       submit_to_testflight: true
  #       beta_groups:
  #         - App Store Connect Users
  #     slack:
  #       channel: '#codemagic-ttja'
  #       notify_on_build_start: true
  #       notify:
  #         success: true
  #         failure: true
  #     email:
  #       recipients:
  #         - ironlove77@gmail.com
  #       notify:
  #         success: true
  #         failure: true