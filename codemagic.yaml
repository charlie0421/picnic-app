workflows:
  # =================== PICNIC APP iOS ===================
  picnic-app-ios:
    name: Picnic App - iOS
    instance_type: mac_mini_m2
    max_build_duration: 120
    integrations:
      app_store_connect: codemagic-picnic
    environment:
      ios_signing:
        distribution_type: app_store
        bundle_identifier: io.iconcasting.picnic.app
      groups:
        - app_store_connect
        - shorebird-config
        - picnic_env
      flutter: 3.32.4
      vars:
        APP_NAME: "picnic_app"
        BUNDLE_ID: "io.iconcasting.picnic.app"
    cache:
      cache_paths:
        - $FLUTTER_ROOT/.pub-cache
        - $HOME/.gradle/caches
        - $HOME/Library/Caches/CocoaPods
    triggering:
      events:
        - push
        - tag
      branch_patterns:
        - pattern: 'production'
          include: true
      tag_patterns:
        - pattern: 'picnic-v*'
          include: true
      cancel_previous_builds: true
    scripts:
      - name: Get Flutter packages and prepare iOS
        script: |
          cd picnic_app
          echo "=== Flutter íŒ¨í‚¤ì§€ ì„¤ì¹˜ ==="
          flutter packages pub get
          
          echo "=== Flutter iOS ì„¤ì • ìƒì„± (Generated.xcconfig íŒŒì¼ ìƒì„±) ==="
          flutter precache --ios
          flutter build ios --config-only
          
          echo "=== Generated.xcconfig íŒŒì¼ í™•ì¸ ==="
          ls -la ios/Flutter/Generated.xcconfig || echo "âš ï¸ Generated.xcconfig íŒŒì¼ì´ ì•„ì§ ìƒì„±ë˜ì§€ ì•ŠìŒ"

      - name: Install CocoaPods dependencies
        script: |
          cd picnic_app
          
          echo "=== Generated.xcconfig íŒŒì¼ í™•ì¸ ==="
          if [ ! -f "ios/Flutter/Generated.xcconfig" ]; then
            echo "âš ï¸ Generated.xcconfig íŒŒì¼ì´ ì—†ìŒ - Flutter ì„¤ì • ì¬ìƒì„±"
            flutter build ios --config-only
          fi
          
          echo "âœ… Generated.xcconfig íŒŒì¼ ì¡´ì¬ í™•ì¸:"
          ls -la ios/Flutter/Generated.xcconfig
          
          echo "=== CocoaPods ì„¤ì¹˜ ì‹œì‘ ==="
          cd ios
          pod install

      - name: Install Shorebird CLI
        script: |
          echo "=== Shorebird CLI ì„¤ì¹˜ ì‹œì‘ ==="
          curl --proto '=https' --tlsv1.2 https://raw.githubusercontent.com/shorebirdtech/install/main/install.sh -sSf | bash
          export PATH="$HOME/.shorebird/bin:$PATH"
          shorebird --version || echo "Shorebird ì„¤ì¹˜ ì‹¤íŒ¨"

      - name: Verify iOS Signing Configuration
        script: |
          echo "=== iOS ì„œëª… í™˜ê²½ í™•ì¸ ==="
          echo "DEVELOPMENT_TEAM: ${DEVELOPMENT_TEAM:-'24SL34R9HR'}"
          
          # Distribution Certificate ì •ë³´ í™•ì¸
          DIST_CERT_INFO=$(security find-identity -v -p codesigning | grep -i distribution | head -1)
          if [ -n "$DIST_CERT_INFO" ]; then
            echo "âœ… Distribution ì¸ì¦ì„œ: $DIST_CERT_INFO"
          else
            echo "âŒ Distribution ì¸ì¦ì„œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ"
            echo "ì‚¬ìš© ê°€ëŠ¥í•œ ì¸ì¦ì„œë“¤:"
            security find-identity -v -p codesigning
            exit 1
          fi
          
          # Provisioning Profile ì •ë³´ í™•ì¸
          PROFILE_COUNT=$(find "$HOME/Library/MobileDevice/Provisioning Profiles" -name "*.mobileprovision" 2>/dev/null | wc -l)
          echo "ì„¤ì¹˜ëœ í”„ë¡œë¹„ì €ë‹ í”„ë¡œíŒŒì¼ ê°œìˆ˜: $PROFILE_COUNTê°œ"
          
          if [ "$PROFILE_COUNT" -gt 0 ]; then
            echo "âœ… í”„ë¡œë¹„ì €ë‹ í”„ë¡œíŒŒì¼ ëª©ë¡:"
            find "$HOME/Library/MobileDevice/Provisioning Profiles" -name "*.mobileprovision" 2>/dev/null | while read profile; do
              PROFILE_NAME=$(security cms -D -i "$profile" 2>/dev/null | grep -A1 "<key>Name</key>" | tail -1 | sed 's/.*<string>\(.*\)<\/string>.*/\1/' | tr -d '\n')
              echo "  - $(basename "$profile" .mobileprovision): $PROFILE_NAME"
            done
          else
            echo "âŒ í”„ë¡œë¹„ì €ë‹ í”„ë¡œíŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŒ"
            exit 1
          fi

      - name: Configure Xcode Project for Manual Signing
        script: |
          cd picnic_app/ios
          
          echo "=== Xcode í”„ë¡œì íŠ¸ Manual Signing ì„¤ì • ==="
          # Manual Signing ê°•ì œ ì„¤ì • (Distribution ì¸ì¦ì„œ ì‚¬ìš©)
          echo "ğŸ“ Manual Signing ê°•ì œ í™œì„±í™”..."
          sed -i '' "s/CODE_SIGN_STYLE = Automatic;/CODE_SIGN_STYLE = Manual;/g" Runner.xcodeproj/project.pbxproj
          sed -i '' "s/CODE_SIGN_IDENTITY = \"\";/CODE_SIGN_IDENTITY = \"Apple Distribution\";/g" Runner.xcodeproj/project.pbxproj
          sed -i '' "s/CODE_SIGN_IDENTITY = \"Apple Development\";/CODE_SIGN_IDENTITY = \"Apple Distribution\";/g" Runner.xcodeproj/project.pbxproj
          sed -i '' "s/\"CODE_SIGN_IDENTITY\[sdk=iphoneos\*\]\" = \"iPhone Developer\";/\"CODE_SIGN_IDENTITY[sdk=iphoneos*]\" = \"Apple Distribution\";/g" Runner.xcodeproj/project.pbxproj
          
          # í”„ë¡œë¹„ì €ë‹ í”„ë¡œíŒŒì¼ ì„¤ì •
          sed -i '' "s/PROVISIONING_PROFILE_SPECIFIER = \"\";/PROVISIONING_PROFILE_SPECIFIER = \"picnic_app_profile_2025\";/g" Runner.xcodeproj/project.pbxproj
          
          # PROVISIONING_PROFILE_SPECIFIER ì¶”ê°€ (ì¡´ì¬í•˜ì§€ ì•ŠëŠ” ê²½ìš°)
          if ! grep -q "PROVISIONING_PROFILE_SPECIFIER" Runner.xcodeproj/project.pbxproj; then
            sed -i '' '/DEVELOPMENT_TEAM = /a\
          PROVISIONING_PROFILE_SPECIFIER = "picnic_app_profile_2025";' Runner.xcodeproj/project.pbxproj
          fi
          
          # Development Team ì„¤ì • ìœ ì§€
          sed -i '' "s/DEVELOPMENT_TEAM = \"\";/DEVELOPMENT_TEAM = \"24SL34R9HR\";/g" Runner.xcodeproj/project.pbxproj
          sed -i '' "s/DEVELOPMENT_TEAM = 24SL34R9HR;/DEVELOPMENT_TEAM = \"24SL34R9HR\";/g" Runner.xcodeproj/project.pbxproj
          
          echo "âœ… Manual Signing ì„¤ì • ì™„ë£Œ"
          echo "- CODE_SIGN_STYLE: Manual"  
          echo "- DEVELOPMENT_TEAM: 24SL34R9HR"
          echo "- CODE_SIGN_IDENTITY: Apple Distribution"
          echo "- PROVISIONING_PROFILE_SPECIFIER: picnic_app_profile_2025"

      - name: Build iOS IPA (Manual Signing)
        script: |
          cd picnic_app
          
          echo "=== iOS IPA ë¹Œë“œ ì‹œì‘ (Manual Signing) ==="
          echo "âœ… Manual Signing í™˜ê²½ìœ¼ë¡œ ë¹Œë“œí•©ë‹ˆë‹¤"
          echo "âœ… Bundle ID: io.iconcasting.picnic.app"
          echo "âœ… Distribution Type: App Store"
          echo ""
          
          # Manual Signingìš© ExportOptions.plist ìƒì„±
          echo "ğŸ“ Manual Signingìš© ExportOptions.plist ìƒì„±..."
          echo '<?xml version="1.0" encoding="UTF-8"?>' > ios/ExportOptions.plist
          echo '<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">' >> ios/ExportOptions.plist
          echo '<plist version="1.0">' >> ios/ExportOptions.plist
          echo '<dict>' >> ios/ExportOptions.plist
          echo '    <key>method</key>' >> ios/ExportOptions.plist
          echo '    <string>app-store</string>' >> ios/ExportOptions.plist
          echo '    <key>teamID</key>' >> ios/ExportOptions.plist
          echo '    <string>24SL34R9HR</string>' >> ios/ExportOptions.plist
          echo '    <key>signingStyle</key>' >> ios/ExportOptions.plist
          echo '    <string>manual</string>' >> ios/ExportOptions.plist
          echo '    <key>signingCertificate</key>' >> ios/ExportOptions.plist
          echo '    <string>Apple Distribution</string>' >> ios/ExportOptions.plist
          echo '    <key>provisioningProfiles</key>' >> ios/ExportOptions.plist
          echo '    <dict>' >> ios/ExportOptions.plist
          echo '        <key>io.iconcasting.picnic.app</key>' >> ios/ExportOptions.plist
          echo '        <string>picnic_app_profile_2025</string>' >> ios/ExportOptions.plist
          echo '    </dict>' >> ios/ExportOptions.plist
          echo '    <key>stripSwiftSymbols</key>' >> ios/ExportOptions.plist
          echo '    <true/>' >> ios/ExportOptions.plist
          echo '    <key>uploadBitcode</key>' >> ios/ExportOptions.plist
          echo '    <false/>' >> ios/ExportOptions.plist
          echo '    <key>uploadSymbols</key>' >> ios/ExportOptions.plist
          echo '    <true/>' >> ios/ExportOptions.plist
          echo '</dict>' >> ios/ExportOptions.plist
          echo '</plist>' >> ios/ExportOptions.plist
          
          echo "ğŸš€ Manual Signing IPA ë¹Œë“œ"
          flutter build ipa \
            --release \
            --dart-define=ENVIRONMENT=prod \
            --export-options-plist=ios/ExportOptions.plist
          
          BUILD_RESULT=$?
          
          # ë¹Œë“œ ê²°ê³¼ í™•ì¸
          echo ""
          echo "=== ë¹Œë“œ ê²°ê³¼ í™•ì¸ ==="
          
          if [ $BUILD_RESULT -eq 0 ]; then
            echo "ğŸ‰ Flutter IPA ë¹Œë“œ ëª…ë ¹ì–´ ì„±ê³µ!"
            
            # IPA íŒŒì¼ ìƒì„± ì—¬ë¶€ í™•ì¸
            if [ -f "build/ios/ipa/picnic_app.ipa" ]; then
              IPA_SIZE=$(du -h "build/ios/ipa/picnic_app.ipa" | cut -f1)
              echo "âœ… IPA íŒŒì¼ ìƒì„± ì™„ë£Œ: build/ios/ipa/picnic_app.ipa (í¬ê¸°: $IPA_SIZE)"
            elif [ -f "build/ios/ipa/Runner.ipa" ]; then
              IPA_SIZE=$(du -h "build/ios/ipa/Runner.ipa" | cut -f1)
              echo "âœ… IPA íŒŒì¼ ìƒì„± ì™„ë£Œ: build/ios/ipa/Runner.ipa (í¬ê¸°: $IPA_SIZE)"
              
              # picnic_app.ipaë¡œ ë³µì‚¬
              cp "build/ios/ipa/Runner.ipa" "build/ios/ipa/picnic_app.ipa"
              echo "âœ… picnic_app.ipaë¡œ ë³µì‚¬ ì™„ë£Œ"
            else
              echo "âš ï¸ ë¹Œë“œ ëª…ë ¹ì–´ëŠ” ì„±ê³µí–ˆì§€ë§Œ IPA íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŒ"
              echo "ğŸ“ ìƒì„±ëœ íŒŒì¼ë“¤:"
              find build/ios -name "*.ipa" -o -name "*.xcarchive" 2>/dev/null | head -5
              
              # Archiveê°€ ìˆëŠ” ê²½ìš° Manual Signingìš© ìˆ˜ë™ export ì‹œë„
              XCARCHIVE_PATH=$(find build/ios -name "*.xcarchive" | head -1)
              if [ -n "$XCARCHIVE_PATH" ]; then
                echo ""
                echo "ğŸ“¦ Archiveê°€ ë°œê²¬ë˜ì–´ ìˆ˜ë™ IPA exportë¥¼ ì‹œë„í•©ë‹ˆë‹¤..."
                echo "Archive ê²½ë¡œ: $XCARCHIVE_PATH"
                
                echo "ğŸš€ Manual Signingìœ¼ë¡œ IPA export ì‹œë„..."
                cd ios
                xcodebuild -exportArchive \
                  -archivePath "../$XCARCHIVE_PATH" \
                  -exportPath "../build/ios/ipa/" \
                  -exportOptionsPlist "ExportOptions.plist"
                
                EXPORT_RESULT=$?
                cd ..
                
                if [ $EXPORT_RESULT -eq 0 ]; then
                  echo "âœ… ìˆ˜ë™ IPA export ì„±ê³µ!"
                  
                  # IPA íŒŒì¼ í™•ì¸ ë° ì´ë¦„ ì •ê·œí™”
                  if [ -f "build/ios/ipa/picnic_app.ipa" ]; then
                    IPA_SIZE=$(du -h "build/ios/ipa/picnic_app.ipa" | cut -f1)
                    echo "âœ… ìµœì¢… IPA íŒŒì¼: build/ios/ipa/picnic_app.ipa (í¬ê¸°: $IPA_SIZE)"
                  elif [ -f "build/ios/ipa/Runner.ipa" ]; then
                    IPA_SIZE=$(du -h "build/ios/ipa/Runner.ipa" | cut -f1)
                    echo "âœ… ìµœì¢… IPA íŒŒì¼: build/ios/ipa/Runner.ipa (í¬ê¸°: $IPA_SIZE)"
                    cp "build/ios/ipa/Runner.ipa" "build/ios/ipa/picnic_app.ipa"
                    echo "âœ… picnic_app.ipaë¡œ ë³µì‚¬ ì™„ë£Œ"
                  else
                    echo "âš ï¸ ë¹Œë“œ ëª…ë ¹ì–´ëŠ” ì„±ê³µí–ˆì§€ë§Œ IPA íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŒ"
                    ls -la build/ios/ipa/ 2>/dev/null || echo "IPA ë””ë ‰í† ë¦¬ ì—†ìŒ"
                  fi
                else
                  echo "âŒ ìˆ˜ë™ IPA export ì‹¤íŒ¨ (ì¢…ë£Œ ì½”ë“œ: $EXPORT_RESULT)"
                fi
              fi
            fi
            
            echo ""
            echo "ğŸ‰ Manual Signing IPA ë¹Œë“œ ì™„ë£Œ!"
          else
            echo "âŒ Flutter IPA ë¹Œë“œ ì‹¤íŒ¨ (ì¢…ë£Œ ì½”ë“œ: $BUILD_RESULT)"
            echo ""
            echo "=== ë””ë²„ê¹… ì •ë³´ ==="
            echo "Flutter ë²„ì „:"
            flutter --version | head -3
            echo ""
            echo "Xcode í”„ë¡œì íŠ¸ ì„œëª… ì„¤ì • í™•ì¸:"
            grep -A 5 -B 5 "CODE_SIGN_STYLE\|DEVELOPMENT_TEAM" ios/Runner.xcodeproj/project.pbxproj | head -10
            echo ""
            echo "ì„¤ì¹˜ëœ ì¸ì¦ì„œ:"
            security find-identity -v -p codesigning | head -3
            echo ""
            echo "í”„ë¡œë¹„ì €ë‹ í”„ë¡œíŒŒì¼:"
            ls -la "$HOME/Library/MobileDevice/Provisioning Profiles/" 2>/dev/null | head -3 || echo "í”„ë¡œë¹„ì €ë‹ í”„ë¡œíŒŒì¼ ë””ë ‰í† ë¦¬ ì—†ìŒ"
            
            exit 1
          fi

      - name: Shorebird iOS Release
        script: |
          export PATH="$HOME/.shorebird/bin:$PATH"
          cd picnic_app

          echo "=== Shorebird iOS ë¦´ë¦¬ì¦ˆ ì‹œì‘ ==="
          echo "Shorebird ë²„ì „ í™•ì¸:"
          shorebird --version

          echo "=== Shorebird ì¸ì¦ í™•ì¸ ==="
          if [ -z "$SHOREBIRD_TOKEN" ]; then
            echo "âŒ SHOREBIRD_TOKEN í™˜ê²½ë³€ìˆ˜ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤"
            exit 1
          else
            echo "âœ… SHOREBIRD_TOKEN í™˜ê²½ë³€ìˆ˜ê°€ ì„¤ì •ë˜ì—ˆìŠµë‹ˆë‹¤"
          fi

          echo "=== Shorebird iOS ë¦´ë¦¬ì¦ˆ ì‹¤í–‰ ==="
          # ì²« ë²ˆì§¸ ì‹œë„
          echo "ğŸš€ iOS ë¦´ë¦¬ì¦ˆ ì²« ë²ˆì§¸ ì‹œë„ (ìµœì‹  Flutter 3.32.4 ëª…ì‹œ ì§€ì •)..."
          RELEASE_RESULT=$(shorebird release ios --dart-define=ENVIRONMENT=prod --flutter-version=latest 2>&1)
          RELEASE_EXIT_CODE=$?
          
          echo "ë¦´ë¦¬ì¦ˆ ê²°ê³¼: $RELEASE_RESULT"
          
          # "incomplete" ë©”ì‹œì§€ê°€ ìˆê±°ë‚˜ ì‹¤íŒ¨í•œ ê²½ìš° ì¬ì‹œë„
          if [[ $RELEASE_EXIT_CODE -ne 0 ]] || echo "$RELEASE_RESULT" | grep -i "incomplete\|re-run"; then
            echo "âš ï¸ ë¶ˆì™„ì „í•œ ë¦´ë¦¬ì¦ˆ ê°ì§€ ë˜ëŠ” ì‹¤íŒ¨ - ì¬ì‹œë„í•©ë‹ˆë‹¤..."
            sleep 5
            
            echo "ğŸ”„ iOS ë¦´ë¦¬ì¦ˆ ì¬ì‹œë„ (ìµœì‹  Flutter 3.32.4)..."
            shorebird release ios --dart-define=ENVIRONMENT=prod --flutter-version=latest
            
            RETRY_EXIT_CODE=$?
            if [ $RETRY_EXIT_CODE -eq 0 ]; then
              echo "âœ… ì¬ì‹œë„ ì„±ê³µ!"
            else
              echo "âŒ ì¬ì‹œë„ë„ ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤."
              exit 1
            fi
          else
            echo "âœ… ì²« ë²ˆì§¸ ì‹œë„ ì„±ê³µ!"
          fi

          echo "=== Shorebird iOS ë¦´ë¦¬ì¦ˆ ì™„ë£Œ ==="
          echo "âœ… iOS ì•±ì´ Shorebirdì— ì„±ê³µì ìœ¼ë¡œ ë¦´ë¦¬ì¦ˆë˜ì—ˆìŠµë‹ˆë‹¤"

    artifacts:
      - picnic_app/build/ios/ipa/*.ipa
      - picnic_app/build/ios/Runner.xcarchive
      - picnic_app/flutter_drive.log

    publishing:
      app_store_connect:
        auth: integration
        submit_to_testflight: true
        beta_groups:
          - App Store Connect Users
      slack:
        channel: '#codemagic-picnic'
        notify_on_build_start: true
        notify:
          success: true
          failure: true
      email:
        recipients:
          - ironlove77@gmail.com
        notify:
          success: true
          failure: true

  # =================== PICNIC APP Android ===================
  picnic-app-android:
    name: Picnic App - Android
    instance_type: mac_mini_m2
    max_build_duration: 120
    environment:
      android_signing:
        - picnic_keystore
      groups:
        - google_play
        - shorebird-config
        - picnic_env
      flutter: 3.32.4
      java: 17
      vars:
        PATH: $PATH:$HOME/.shorebird/bin
        APP_NAME: "picnic_app"
        # CodeMagicì´ android_signingì„ ì¸ì‹í•˜ë„ë¡ ê°•ì œ ì„¤ì •
        FLUTTER_BUILD_MODE: "release"
    cache:
      cache_paths:
        - $FLUTTER_ROOT/.pub-cache
        - $HOME/.gradle/caches
        - $HOME/.gradle/wrapper
        - $HOME/.android/build-cache
        - $HOME/Library/Caches/CocoaPods
        - picnic_app/.dart_tool
        - picnic_app/android/.gradle
    triggering:
      events:
        - push
        - tag
      # production ë¸Œëœì¹˜ í‘¸ì‹œ ë° íƒœê·¸ë¡œ íŠ¸ë¦¬ê±°
      branch_patterns:
        - pattern: 'production'
          include: true
      tag_patterns:
        - pattern: 'picnic-v*'
          include: true
      cancel_previous_builds: true
    scripts:
      - name: Install Shorebird CLI
        script: |
          echo "=== Shorebird CLI ì„¤ì¹˜ ì‹œì‘ ==="
          curl --proto '=https' --tlsv1.2 https://raw.githubusercontent.com/shorebirdtech/install/main/install.sh -sSf | bash
          export PATH="$HOME/.shorebird/bin:$PATH"
          shorebird --version || echo "Shorebird ì„¤ì¹˜ ì‹¤íŒ¨"

      - name: Get Flutter packages
        script: |
          cd picnic_app
          flutter packages pub get

      - name: Verify Keystore Configuration
        script: |
          echo "=== í‚¤ìŠ¤í† ì–´ í™˜ê²½ ë³€ìˆ˜ í™•ì¸ ==="
          echo "CM_KEYSTORE_PATH: ${CM_KEYSTORE_PATH:-'ë¯¸ì„¤ì •'}"
          echo "CM_KEYSTORE_PASSWORD: ${CM_KEYSTORE_PASSWORD:-'ë¯¸ì„¤ì •'}"
          echo "CM_KEY_ALIAS: ${CM_KEY_ALIAS:-'ë¯¸ì„¤ì •'}"
          echo "CM_KEY_PASSWORD: ${CM_KEY_PASSWORD:-'ë¯¸ì„¤ì •'}"
          
          if [ -z "$CM_KEYSTORE_PATH" ] || [ -z "$CM_KEYSTORE_PASSWORD" ] || [ -z "$CM_KEY_ALIAS" ] || [ -z "$CM_KEY_PASSWORD" ]; then
            echo "âŒ í‚¤ìŠ¤í† ì–´ í™˜ê²½ ë³€ìˆ˜ê°€ ì˜¬ë°”ë¥´ê²Œ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤"
            echo "CodeMagic ëŒ€ì‹œë³´ë“œì—ì„œ 'picnic_keystore' ê·¸ë£¹ ì„¤ì •ì„ í™•ì¸í•´ì£¼ì„¸ìš”"
            exit 1
          fi
          
          if [ -f "$CM_KEYSTORE_PATH" ]; then
            echo "âœ… í‚¤ìŠ¤í† ì–´ íŒŒì¼ ì¡´ì¬: $CM_KEYSTORE_PATH"
            # í‚¤ìŠ¤í† ì–´ ì •ë³´ í™•ì¸
            keytool -list -v -keystore "$CM_KEYSTORE_PATH" -alias "$CM_KEY_ALIAS" -storepass "$CM_KEYSTORE_PASSWORD" | grep -E "(SHA1|SHA256|Subject|Issuer)" || echo "í‚¤ìŠ¤í† ì–´ ì •ë³´ í™•ì¸ ì‹¤íŒ¨"
          else
            echo "âŒ í‚¤ìŠ¤í† ì–´ íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: $CM_KEYSTORE_PATH"
            exit 1
          fi

      - name: Build AAB and APK for Distribution
        script: |
          cd picnic_app
          
          echo "=== Gradle ë©”ëª¨ë¦¬ ì„¤ì • ìµœì í™” (Java Heap Space ì—ëŸ¬ í•´ê²°) ==="
          mkdir -p $HOME/.gradle
          # ë©”ëª¨ë¦¬ë¥¼ 6GBë¡œ ì¦ê°€í•˜ê³  ë©”ëª¨ë¦¬ ê´€ë ¨ ì˜µì…˜ ìµœì í™”
          echo "org.gradle.jvmargs=-Xmx6144m -XX:MaxMetaspaceSize=512m -XX:+HeapDumpOnOutOfMemoryError -Dfile.encoding=UTF-8" >> $HOME/.gradle/gradle.properties
          echo "org.gradle.daemon=true" >> $HOME/.gradle/gradle.properties
          echo "org.gradle.caching=true" >> $HOME/.gradle/gradle.properties
          echo "org.gradle.parallel=false" >> $HOME/.gradle/gradle.properties
          echo "android.enableJetifier=true" >> $HOME/.gradle/gradle.properties
          echo "android.useAndroidX=true" >> $HOME/.gradle/gradle.properties
          # Shorebird í˜¸í™˜ì„±ì„ ìœ„í•œ ì¶”ê°€ ì„¤ì • (deprecated ì˜µì…˜ ì œê±°)
          echo "android.enableR8.fullMode=false" >> $HOME/.gradle/gradle.properties
          
          # Shorebird PATH ì„¤ì •
          export PATH="$HOME/.shorebird/bin:$PATH"
          
          # ê¹¨ë—í•œ ë¹Œë“œ í™˜ê²½
          flutter clean
          flutter pub get

          echo "=== ë¹Œë“œ ê²½ë¡œ ë¯¸ë¦¬ ì„¤ì • ==="
          # Flutterê°€ ì˜ˆìƒí•˜ëŠ” ê²½ë¡œì— ë””ë ‰í† ë¦¬ ë¯¸ë¦¬ ìƒì„±
          mkdir -p build/app/outputs/bundle/release/
          mkdir -p build/app/outputs/apk/release/
          mkdir -p build/app/outputs/flutter-apk/

          echo "=== ì„œëª… ì„¤ì • í™•ì¸ ==="
          echo "í‚¤ìŠ¤í† ì–´ ê²½ë¡œ: $CM_KEYSTORE_PATH"
          echo "í‚¤ ë³„ì¹­: $CM_KEY_ALIAS"

          echo "=== 1ï¸âƒ£ AAB ë¹Œë“œ ì‹œì‘ (ì„œëª… ì ìš©) ==="
          AAB_BUILD_SUCCESS=false
          
          # AAB ë¹Œë“œ ì‹¤í–‰ (ì„±ê³µ ì—¬ë¶€ì™€ ê´€ê³„ì—†ì´ íŒŒì¼ íƒì§€ ì‹œë„)
          echo "ğŸš€ Flutter AAB ë¹Œë“œ ì‹¤í–‰..."
          flutter build appbundle --release --dart-define=ENVIRONMENT=prod
          AAB_FLUTTER_EXIT_CODE=$?
          
          echo "=== AAB íŒŒì¼ íƒì§€ ë° ë³µêµ¬ ==="
          echo "ğŸ“ ëª¨ë“  .aab íŒŒì¼ ê²€ìƒ‰ ì¤‘..."
          find . -name "*.aab" -type f 2>/dev/null | head -10
          
          # ì—¬ëŸ¬ ìœ„ì¹˜ì—ì„œ AAB íŒŒì¼ íƒì§€
          AAB_FOUND_PATH=""
          POSSIBLE_AAB_PATHS=(
            "build/app/outputs/bundle/release/app-release.aab"
            "android/app/build/outputs/bundle/release/app-release.aab"
            "build/app/outputs/bundle/release/app.aab"
            "android/app/build/outputs/bundle/release/app.aab"
          )
          
          # 1. ì˜ˆìƒ ê²½ë¡œì—ì„œ ë¨¼ì € í™•ì¸
          for path in "${POSSIBLE_AAB_PATHS[@]}"; do
            if [ -f "$path" ]; then
              echo "âœ… AAB íŒŒì¼ ë°œê²¬: $path"
              AAB_FOUND_PATH="$path"
              break
            fi
          done
          
          # 2. ì˜ˆìƒ ê²½ë¡œì— ì—†ìœ¼ë©´ ì „ì²´ ê²€ìƒ‰
          if [ -z "$AAB_FOUND_PATH" ]; then
            echo "ğŸ” ì „ì²´ ê²€ìƒ‰ìœ¼ë¡œ AAB íŒŒì¼ ì°¾ëŠ” ì¤‘..."
            AAB_FOUND_PATH=$(find . -name "*.aab" -type f 2>/dev/null | head -1)
            
            if [ -n "$AAB_FOUND_PATH" ]; then
              echo "âœ… AAB íŒŒì¼ ë°œê²¬ (ì „ì²´ ê²€ìƒ‰): $AAB_FOUND_PATH"
            else
              echo "âŒ AAB íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŒ"
            fi
          fi
          
          # 3. AAB íŒŒì¼ ë³µì‚¬ ë° ì •ë¦¬
          if [ -n "$AAB_FOUND_PATH" ] && [ -f "$AAB_FOUND_PATH" ]; then
            # Flutterê°€ ì˜ˆìƒí•˜ëŠ” ìœ„ì¹˜ë¡œ ë³µì‚¬
            mkdir -p build/app/outputs/bundle/release/
            cp "$AAB_FOUND_PATH" build/app/outputs/bundle/release/app-release.aab
            
            AAB_SIZE=$(du -h build/app/outputs/bundle/release/app-release.aab | cut -f1)
            echo "âœ… AAB íŒŒì¼ ë³µêµ¬ ì„±ê³µ: build/app/outputs/bundle/release/app-release.aab (í¬ê¸°: $AAB_SIZE)"
            AAB_BUILD_SUCCESS=true
            
            # ì„œëª… ê²€ì¦
            if jarsigner -verify build/app/outputs/bundle/release/app-release.aab > /dev/null 2>&1; then
              echo "âœ… AAB ì„œëª… ê²€ì¦ ì„±ê³µ"
            else
              echo "âš ï¸ AAB ì„œëª… ê²€ì¦ ì‹¤íŒ¨"
            fi
          else
            echo "âŒ AAB íŒŒì¼ ë³µêµ¬ ì‹¤íŒ¨"
            if [ $AAB_FLUTTER_EXIT_CODE -eq 0 ]; then
              echo "âš ï¸ Flutter ëª…ë ¹ì–´ëŠ” ì„±ê³µí–ˆì§€ë§Œ íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤"
            else
              echo "âŒ Flutter AAB ë¹Œë“œ ëª…ë ¹ì–´ë„ ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤ (ì¢…ë£Œ ì½”ë“œ: $AAB_FLUTTER_EXIT_CODE)"
            fi
          fi

          echo "=== 2ï¸âƒ£ APK ë¹Œë“œ ì‹œì‘ (ì„œëª… ì ìš©) ==="
          APK_BUILD_SUCCESS=false
          
          # APK ë¹Œë“œ ì‹¤í–‰ (ì„±ê³µ ì—¬ë¶€ì™€ ê´€ê³„ì—†ì´ íŒŒì¼ íƒì§€ ì‹œë„)
          echo "ğŸš€ Flutter APK ë¹Œë“œ ì‹¤í–‰..."
          flutter build apk --release --dart-define=ENVIRONMENT=prod
          APK_FLUTTER_EXIT_CODE=$?
          
          echo "=== APK íŒŒì¼ íƒì§€ ë° ë³µêµ¬ ==="
          echo "ğŸ“ ëª¨ë“  .apk íŒŒì¼ ê²€ìƒ‰ ì¤‘..."
          find . -name "*.apk" -type f 2>/dev/null | head -10
          
          # ì—¬ëŸ¬ ìœ„ì¹˜ì—ì„œ APK íŒŒì¼ íƒì§€
          APK_FOUND_PATH=""
          POSSIBLE_APK_PATHS=(
            "build/app/outputs/flutter-apk/app-release.apk"
            "android/app/build/outputs/apk/release/app-release.apk"
            "build/app/outputs/apk/release/app-release.apk"
            "android/app/build/outputs/flutter-apk/app-release.apk"
            "build/app/outputs/flutter-apk/app.apk"
            "android/app/build/outputs/apk/release/app.apk"
          )
          
          # 1. ì˜ˆìƒ ê²½ë¡œì—ì„œ ë¨¼ì € í™•ì¸
          for path in "${POSSIBLE_APK_PATHS[@]}"; do
            if [ -f "$path" ]; then
              echo "âœ… APK íŒŒì¼ ë°œê²¬: $path"
              APK_FOUND_PATH="$path"
              break
            fi
          done
          
          # 2. ì˜ˆìƒ ê²½ë¡œì— ì—†ìœ¼ë©´ ì „ì²´ ê²€ìƒ‰
          if [ -z "$APK_FOUND_PATH" ]; then
            echo "ğŸ” ì „ì²´ ê²€ìƒ‰ìœ¼ë¡œ APK íŒŒì¼ ì°¾ëŠ” ì¤‘..."
            APK_FOUND_PATH=$(find . -name "*.apk" -type f 2>/dev/null | head -1)
            
            if [ -n "$APK_FOUND_PATH" ]; then
              echo "âœ… APK íŒŒì¼ ë°œê²¬ (ì „ì²´ ê²€ìƒ‰): $APK_FOUND_PATH"
            else
              echo "âŒ APK íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŒ"
            fi
          fi
          
          # 3. APK íŒŒì¼ ë³µì‚¬ ë° ì •ë¦¬
          if [ -n "$APK_FOUND_PATH" ] && [ -f "$APK_FOUND_PATH" ]; then
            # Flutterê°€ ì˜ˆìƒí•˜ëŠ” ìœ„ì¹˜ë“¤ë¡œ ë³µì‚¬
            mkdir -p build/app/outputs/flutter-apk/
            mkdir -p build/app/outputs/apk/release/
            
            cp "$APK_FOUND_PATH" build/app/outputs/flutter-apk/app-release.apk
            cp "$APK_FOUND_PATH" build/app/outputs/apk/release/app-release.apk
            
            APK_SIZE=$(du -h build/app/outputs/flutter-apk/app-release.apk | cut -f1)
            echo "âœ… APK íŒŒì¼ ë³µêµ¬ ì„±ê³µ: build/app/outputs/flutter-apk/app-release.apk (í¬ê¸°: $APK_SIZE)"
            APK_BUILD_SUCCESS=true
            
            # ì„œëª… ê²€ì¦
            if jarsigner -verify build/app/outputs/flutter-apk/app-release.apk > /dev/null 2>&1; then
              echo "âœ… APK ì„œëª… ê²€ì¦ ì„±ê³µ"
            else
              echo "âš ï¸ APK ì„œëª… ê²€ì¦ ì‹¤íŒ¨"
            fi
          else
            echo "âŒ APK íŒŒì¼ ë³µêµ¬ ì‹¤íŒ¨"
            if [ $APK_FLUTTER_EXIT_CODE -eq 0 ]; then
              echo "âš ï¸ Flutter ëª…ë ¹ì–´ëŠ” ì„±ê³µí–ˆì§€ë§Œ íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤"
            else
              echo "âŒ Flutter APK ë¹Œë“œ ëª…ë ¹ì–´ë„ ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤ (ì¢…ë£Œ ì½”ë“œ: $APK_FLUTTER_EXIT_CODE)"
            fi
            echo "ë¹Œë“œë¥¼ ê°•ì œë¡œ ê³„ì† ì§„í–‰í•©ë‹ˆë‹¤..."
          fi
          
          # 3. Shorebird ë¹Œë“œ
          echo "=== 3ï¸âƒ£ Shorebird ë¹Œë“œ ì‹œì‘ ==="
          
          # ë¹Œë“œ ê²°ê³¼ í™•ì¸
          echo "=== ë¹Œë“œ ê²°ê³¼ ìš”ì•½ ==="
          if [ "$AAB_BUILD_SUCCESS" = true ]; then
            echo "âœ… AAB: ë¹Œë“œ ë° ë³µêµ¬ ì„±ê³µ"
          else
            echo "âŒ AAB: ë¹Œë“œ ì‹¤íŒ¨ ë˜ëŠ” íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŒ"
          fi
          
          if [ "$APK_BUILD_SUCCESS" = true ]; then
            echo "âœ… APK: ë¹Œë“œ ë° ë³µêµ¬ ì„±ê³µ"
          else
            echo "âŒ APK: ë¹Œë“œ ì‹¤íŒ¨ ë˜ëŠ” íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŒ"
          fi
          
          # AABë‚˜ APK ì¤‘ í•˜ë‚˜ë¼ë„ ì„±ê³µí•˜ë©´ Shorebird ì§„í–‰
          if [ "$AAB_BUILD_SUCCESS" = true ] || [ "$APK_BUILD_SUCCESS" = true ]; then
            echo "âœ… ìµœì†Œí•œ í•˜ë‚˜ì˜ ë¹Œë“œê°€ ì„±ê³µí–ˆìœ¼ë¯€ë¡œ Shorebird ì§„í–‰"
          else
            echo "âŒ AABì™€ APK ëª¨ë‘ ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤"
            exit 1
          fi
          
          if [ -z "$SHOREBIRD_TOKEN" ]; then
            echo "âŒ SHOREBIRD_TOKEN í™˜ê²½ë³€ìˆ˜ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤"
            exit 1
          fi

          echo "=== í‘œì¤€ Flutter ë¹Œë“œ ê¸°ë°˜ Shorebird ë¦´ë¦¬ì¦ˆ ==="
          echo "ì‚¬ìš©ì ìš”ì²­: í”ŒëŸ¬í„° ê¸°ë³¸ ëª…ë ¹ì–´ ì‚¬ìš©ìœ¼ë¡œ ë¹Œë“œ ì†ë„ ìµœì í™”"
          echo "âœ… AAB/APK íŒŒì¼ì´ ì„±ê³µì ìœ¼ë¡œ ë³µêµ¬ë˜ì—ˆìœ¼ë¯€ë¡œ ë°”ë¡œ ë¦´ë¦¬ì¦ˆ ì§„í–‰í•©ë‹ˆë‹¤"
          
          # Shorebird ì¸ì¦ í™•ì¸
          echo "=== Shorebird ì¸ì¦ í™•ì¸ ==="
          if [ -z "$SHOREBIRD_TOKEN" ]; then
            echo "âŒ SHOREBIRD_TOKEN í™˜ê²½ë³€ìˆ˜ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤"
            exit 1
          else
            echo "âœ… SHOREBIRD_TOKEN í™˜ê²½ë³€ìˆ˜ê°€ ì„¤ì •ë˜ì—ˆìŠµë‹ˆë‹¤"
          fi
          
          echo "=== Shorebird ìºì‹œ ì •ë¦¬ ë° ë„¤ì´í‹°ë¸Œ ë¼ì´ë¸ŒëŸ¬ë¦¬ ë””ë ‰í† ë¦¬ ì¤€ë¹„ ==="
          # Shorebird ìºì‹œ ì •ë¦¬ (ì•„í‹°íŒ©íŠ¸ ë¬¸ì œ í•´ê²°)
          shorebird cache clean
          
          echo "=== ë„¤ì´í‹°ë¸Œ ë¼ì´ë¸ŒëŸ¬ë¦¬ ë””ë ‰í† ë¦¬ ë¯¸ë¦¬ ìƒì„± ==="
          # Shorebirdê°€ ì°¾ëŠ” ë””ë ‰í† ë¦¬ë“¤ì„ ë¯¸ë¦¬ ìƒì„±
          mkdir -p build/app/intermediates/stripped_native_libs/stripReleaseDebugSymbols/release/out/lib
          mkdir -p build/app/intermediates/stripped_native_libs/release/out/lib
          
          echo "=== ë„¤ì´í‹°ë¸Œ ë¼ì´ë¸ŒëŸ¬ë¦¬ íŒŒì¼ ë³µì‚¬ (Shorebird Issue #1798 í•´ê²°) ==="
          # Flutterê°€ ìƒì„±í•œ ë„¤ì´í‹°ë¸Œ ë¼ì´ë¸ŒëŸ¬ë¦¬ íŒŒì¼ë“¤ì„ Shorebirdê°€ ê¸°ëŒ€í•˜ëŠ” ìœ„ì¹˜ë¡œ ë³µì‚¬
          echo "ğŸ“ ë„¤ì´í‹°ë¸Œ ë¼ì´ë¸ŒëŸ¬ë¦¬ íŒŒì¼ ê²€ìƒ‰ ì¤‘..."
          find . -name "libapp.so" -type f 2>/dev/null | head -10
          
          # Shorebirdê°€ ê¸°ëŒ€í•˜ëŠ” íƒ€ê²Ÿ ê²½ë¡œ (stripReleaseDebugSymbols ì—†ëŠ” ê²½ë¡œ)
          SHOREBIRD_TARGET_PATH="build/app/intermediates/stripped_native_libs/release/out/lib"
          mkdir -p "$SHOREBIRD_TARGET_PATH"/{armeabi-v7a,arm64-v8a,x86,x86_64}
          
          # ì‹¤ì œ íŒŒì¼ì´ ìˆëŠ” ì†ŒìŠ¤ ê²½ë¡œë“¤ (stripReleaseDebugSymbols í¬í•¨)
          ACTUAL_SOURCE_PATHS=(
            "android/app/build/intermediates/stripped_native_libs/release/stripReleaseDebugSymbols/out/lib"
            "build/app/intermediates/stripped_native_libs/release/stripReleaseDebugSymbols/out/lib"
            "android/app/build/intermediates/merged_native_libs/release/mergeReleaseNativeLibs/out/lib"
            "build/app/intermediates/merged_native_libs/release/mergeReleaseNativeLibs/out/lib"
            "android/app/build/intermediates/stripped_native_libs/release/out/lib"
            "build/app/intermediates/stripped_native_libs/release/out/lib"
          )
          
          # ì†ŒìŠ¤ì—ì„œ íƒ€ê²Ÿìœ¼ë¡œ ë„¤ì´í‹°ë¸Œ ë¼ì´ë¸ŒëŸ¬ë¦¬ ë³µì‚¬
          COPIED_COUNT=0
          FOUND_SOURCE=""
          
          for source in "${ACTUAL_SOURCE_PATHS[@]}"; do
            if [ -d "$source" ] && [ "$(find "$source" -name "*.so" 2>/dev/null | wc -l)" -gt 0 ]; then
              echo "âœ… ë„¤ì´í‹°ë¸Œ ë¼ì´ë¸ŒëŸ¬ë¦¬ ì†ŒìŠ¤ ë°œê²¬: $source"
              FOUND_SOURCE="$source"
              
              # ê° ì•„í‚¤í…ì²˜ë³„ë¡œ ë³µì‚¬
              for arch in armeabi-v7a arm64-v8a x86 x86_64; do
                if [ -d "$source/$arch" ] && [ "$(ls -A "$source/$arch" 2>/dev/null)" ]; then
                  echo "ğŸ“¦ $arch ë¼ì´ë¸ŒëŸ¬ë¦¬ ë³µì‚¬ ì¤‘..."
                  
                  # Shorebirdê°€ ê¸°ëŒ€í•˜ëŠ” ìœ„ì¹˜ë¡œ ë³µì‚¬
                  cp -r "$source/$arch"/* "$SHOREBIRD_TARGET_PATH/$arch/" 2>/dev/null
                  COPY_RESULT=$?
                  
                  # ë³µì‚¬ ì„±ê³µ í™•ì¸
                  if [ $COPY_RESULT -eq 0 ] && [ -f "$SHOREBIRD_TARGET_PATH/$arch/libapp.so" ]; then
                    COPIED_COUNT=$((COPIED_COUNT + 1))
                    FILE_SIZE=$(du -h "$SHOREBIRD_TARGET_PATH/$arch/libapp.so" | cut -f1)
                    echo "  âœ… libapp.so ë³µì‚¬ ì„±ê³µ ($arch, í¬ê¸°: $FILE_SIZE)"
                  fi
                  
                  if [ -f "$SHOREBIRD_TARGET_PATH/$arch/libflutter.so" ]; then
                    FILE_SIZE=$(du -h "$SHOREBIRD_TARGET_PATH/$arch/libflutter.so" | cut -f1)
                    echo "  âœ… libflutter.so ë³µì‚¬ ì„±ê³µ ($arch, í¬ê¸°: $FILE_SIZE)"
                  fi
                fi
              done
              break
            fi
          done
          
          # ë³µì‚¬ ê²°ê³¼ í™•ì¸
          if [ $COPIED_COUNT -gt 0 ]; then
            echo "âœ… ë„¤ì´í‹°ë¸Œ ë¼ì´ë¸ŒëŸ¬ë¦¬ ë³µì‚¬ ì™„ë£Œ ($COPIED_COUNTê°œ ì•„í‚¤í…ì²˜)"
            echo "ğŸ¯ Shorebirdê°€ ì°¾ì„ ê²½ë¡œ: $SHOREBIRD_TARGET_PATH"
            
            # ìµœì¢… í™•ì¸
            echo "ğŸ“‹ ë³µì‚¬ëœ íŒŒì¼ í™•ì¸:"
            find "$SHOREBIRD_TARGET_PATH" -name "*.so" 2>/dev/null | while read file; do
              SIZE=$(du -h "$file" | cut -f1)
              echo "  - $file (í¬ê¸°: $SIZE)"
            done
          else
            echo "âŒ ë„¤ì´í‹°ë¸Œ ë¼ì´ë¸ŒëŸ¬ë¦¬ ë³µì‚¬ ì‹¤íŒ¨"
            echo "ğŸ” ê²€ìƒ‰í•œ ì†ŒìŠ¤ ê²½ë¡œë“¤:"
            for source in "${ACTUAL_SOURCE_PATHS[@]}"; do
              if [ -d "$source" ]; then
                FILE_COUNT=$(find "$source" -name "*.so" 2>/dev/null | wc -l)
                echo "  - $source (*.so íŒŒì¼ $FILE_COUNTê°œ)"
              else
                echo "  - $source (ë””ë ‰í† ë¦¬ ì—†ìŒ)"
              fi
            done
            
            echo "âš ï¸ Shorebird ë¦´ë¦¬ì¦ˆê°€ ì‹¤íŒ¨í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤"
          fi
          
          echo "=== í‘œì¤€ Flutter ë¹Œë“œ ê²°ê³¼ë¡œ Shorebird ë¦´ë¦¬ì¦ˆ ì‹¤í–‰ ==="
          # ì´ë¯¸ Flutterë¡œ ë¹Œë“œëœ AAB/APKë¥¼ ì‚¬ìš©í•˜ì—¬ Shorebird ë¦´ë¦¬ì¦ˆ
          echo "ğŸš€ Android ë¦´ë¦¬ì¦ˆ ì‹œì‘ (ìµœì‹  Flutter 3.32.4 ëª…ì‹œ ì§€ì •)..."
          RELEASE_RESULT=$(shorebird release android --dart-define=ENVIRONMENT=prod --flutter-version=latest 2>&1)
          RELEASE_EXIT_CODE=$?
          
          echo "ë¦´ë¦¬ì¦ˆ ê²°ê³¼:"
          echo "$RELEASE_RESULT"
          
          # ë¦´ë¦¬ì¦ˆ ê²°ê³¼ í™•ì¸
          if [ $RELEASE_EXIT_CODE -eq 0 ]; then
            if echo "$RELEASE_RESULT" | grep -i "successfully\|completed\|deployed\|published\|release.*created"; then
              echo "=== Shorebird Android ë¦´ë¦¬ì¦ˆ ì„±ê³µ ==="
              echo "âœ… Android ë¦´ë¦¬ì¦ˆê°€ Shorebirdë¥¼ í†µí•´ ì„±ê³µì ìœ¼ë¡œ ë°°í¬ë˜ì—ˆìŠµë‹ˆë‹¤"
              
              # ë¦´ë¦¬ì¦ˆ ì •ë³´ ì¶”ì¶œ ë° í‘œì‹œ
              if echo "$RELEASE_RESULT" | grep -i "release.*version\|build.*version"; then
                echo ""
                echo "ğŸ“± ë¦´ë¦¬ì¦ˆ ì •ë³´:"
                echo "$RELEASE_RESULT" | grep -i "release.*version\|build.*version" | head -3
              fi
            else
              echo "=== Shorebird Android ë¦´ë¦¬ì¦ˆ ì¬ì‹œë„ í•„ìš” ==="
              echo "âš ï¸ ë¦´ë¦¬ì¦ˆ ê²°ê³¼ê°€ ë¶ˆë¶„ëª…í•©ë‹ˆë‹¤. ì¬ì‹œë„í•©ë‹ˆë‹¤..."
              sleep 3
              
              echo "ğŸ”„ Android ë¦´ë¦¬ì¦ˆ ì¬ì‹œë„ (ìµœì‹  Flutter 3.32.4)..."
              RETRY_RESULT=$(shorebird release android --dart-define=ENVIRONMENT=prod --flutter-version=latest 2>&1)
              RETRY_EXIT_CODE=$?
              
              if [ $RETRY_EXIT_CODE -eq 0 ]; then
                echo "âœ… ì¬ì‹œë„ ì„±ê³µ!"
                echo "$RETRY_RESULT"
              else
                echo "âŒ ì¬ì‹œë„ë„ ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤."
                echo "$RETRY_RESULT"
                exit 1
              fi
            fi
          else
            echo "=== Shorebird Android ë¦´ë¦¬ì¦ˆ ì‹¤íŒ¨ ==="
            echo "âŒ Android ë¦´ë¦¬ì¦ˆì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤ (ì¢…ë£Œ ì½”ë“œ: $RELEASE_EXIT_CODE)"
            
            # ì‹¤íŒ¨ ì›ì¸ ë¶„ì„
            if echo "$RELEASE_RESULT" | grep -i "keystore\|signing"; then
              echo "ğŸ” ì„œëª… ê´€ë ¨ ë¬¸ì œë¡œ ë³´ì…ë‹ˆë‹¤"
            elif echo "$RELEASE_RESULT" | grep -i "flutter.*build.*fail"; then
              echo "ğŸ” Flutter ë¹Œë“œ ë¬¸ì œë¡œ ë³´ì…ë‹ˆë‹¤"
            elif echo "$RELEASE_RESULT" | grep -i "no.*release\|app.*not.*found"; then
              echo "ğŸ” ì•± ë“±ë¡ ë¬¸ì œë¡œ ë³´ì…ë‹ˆë‹¤"
            fi
            
            exit 1
          fi

          echo "=== ìµœì¢… Artifacts ìƒíƒœ ìš”ì•½ ==="
          if [ "$AAB_BUILD_SUCCESS" = true ]; then
            echo "âœ… AAB: ë¹Œë“œ ë° ë³µêµ¬ ì„±ê³µ, Google Play ë°°í¬ ê°€ëŠ¥"
            if [ -f "build/app/outputs/bundle/release/app-release.aab" ]; then
              AAB_FINAL_SIZE=$(du -h "build/app/outputs/bundle/release/app-release.aab" | cut -f1)
              echo "   ğŸ“¦ AAB íŒŒì¼ í¬ê¸°: $AAB_FINAL_SIZE"
            fi
          else
            echo "âŒ AAB: ë¹Œë“œ ì‹¤íŒ¨ ë˜ëŠ” ë³µêµ¬ ë¶ˆê°€, Google Play ë°°í¬ ë¶ˆê°€"
          fi
          
          if [ "$APK_BUILD_SUCCESS" = true ]; then
            echo "âœ… APK: ë¹Œë“œ ë° ë³µêµ¬ ì„±ê³µ, ì§ì ‘ ë°°í¬ ê°€ëŠ¥"
            if [ -f "build/app/outputs/flutter-apk/app-release.apk" ]; then
              APK_FINAL_SIZE=$(du -h "build/app/outputs/flutter-apk/app-release.apk" | cut -f1)
              echo "   ğŸ“¦ APK íŒŒì¼ í¬ê¸°: $APK_FINAL_SIZE"
            fi
          else
            echo "âŒ APK: ë¹Œë“œ ì‹¤íŒ¨ ë˜ëŠ” ë³µêµ¬ ë¶ˆê°€"
          fi
          
          echo ""
          echo "ğŸ¯ Shorebird ë¦´ë¦¬ì¦ˆ ë° ëª¨ë“  ë¹Œë“œ ì‘ì—… ì™„ë£Œ!"
          echo "ğŸ“ ìƒì„±ëœ Artifacts:"
          echo "   - AAB: $([ "$AAB_BUILD_SUCCESS" = true ] && echo "âœ… ì„±ê³µ" || echo "âŒ ì‹¤íŒ¨")"
          echo "   - APK: $([ "$APK_BUILD_SUCCESS" = true ] && echo "âœ… ì„±ê³µ" || echo "âŒ ì‹¤íŒ¨")"
          echo "   - Shorebird: âœ… ë¦´ë¦¬ì¦ˆ ì™„ë£Œ"

    artifacts:
      - picnic_app/build/app/outputs/bundle/release/app-release.aab
      - picnic_app/build/app/outputs/apk/release/app-release.apk
      - picnic_app/build/app/outputs/flutter-apk/app-release.apk
      - picnic_app/build/**/outputs/**/mapping.txt
      - picnic_app/flutter_drive.log

    publishing:
      google_play:
        credentials: $GCLOUD_SERVICE_ACCOUNT_CREDENTIALS
        track: internal
        submit_as_draft: true
      slack:
        channel: '#codemagic-picnic'
        notify_on_build_start: true
        notify:
          success: true
          failure: true
      email:
        recipients:
          - ironlove77@gmail.com
        notify:
          success: true
          failure: true

  # =================== PICNIC APP iOS Patch (Shorebird) ===================
  picnic-app-patch-ios:
    name: Picnic App - iOS Patch (Shorebird)
    instance_type: mac_mini_m2
    max_build_duration: 60
    integrations:
      app_store_connect: codemagic-picnic
    environment:
      ios_signing:
        distribution_type: app_store
        bundle_identifier: io.iconcasting.picnic.app
      groups:
        - app_store_connect
        - shorebird-config
        - picnic_env
      flutter: 3.32.4
      vars:
        APP_NAME: "picnic_app"
        BUNDLE_ID: "io.iconcasting.picnic.app"
    cache:
      cache_paths:
        - $FLUTTER_ROOT/.pub-cache
        - $HOME/.gradle/caches
        - $HOME/Library/Caches/CocoaPods
    triggering:
      events:
        - push
        - tag
      # hotfix, patch ë¸Œëœì¹˜ì™€ patch íƒœê·¸ë¡œ íŠ¸ë¦¬ê±°
      branch_patterns:
        - pattern: 'hotfix/*'
          include: true
        - pattern: 'patch/*'
          include: true
      tag_patterns:
        - pattern: 'picnic-patch-*'
          include: true
      cancel_previous_builds: true
    scripts:
      - name: Install Shorebird CLI
        script: |
          echo "=== Shorebird CLI ì„¤ì¹˜ ì‹œì‘ ==="
          curl --proto '=https' --tlsv1.2 https://raw.githubusercontent.com/shorebirdtech/install/main/install.sh -sSf | bash
          export PATH="$HOME/.shorebird/bin:$PATH"
          
          echo "Shorebird ë²„ì „ í™•ì¸:"
          shorebird --version || echo "Shorebird ì„¤ì¹˜ ì‹¤íŒ¨"

      - name: Get Flutter packages and prepare iOS
        script: |
          cd picnic_app
          echo "=== Flutter íŒ¨í‚¤ì§€ ì„¤ì¹˜ ==="
          flutter packages pub get
          
          echo "=== Flutter iOS ì„¤ì • ìƒì„± ==="
          flutter precache --ios
          flutter build ios --config-only

      - name: Install CocoaPods dependencies
        script: |
          cd picnic_app
          
          echo "=== Generated.xcconfig íŒŒì¼ í™•ì¸ ==="
          if [ ! -f "ios/Flutter/Generated.xcconfig" ]; then
            echo "âš ï¸ Generated.xcconfig íŒŒì¼ì´ ì—†ìŒ - Flutter ì„¤ì • ì¬ìƒì„±"
            flutter build ios --config-only
          fi
          
          echo "âœ… Generated.xcconfig íŒŒì¼ ì¡´ì¬ í™•ì¸:"
          ls -la ios/Flutter/Generated.xcconfig
          
          echo "=== CocoaPods ì„¤ì¹˜ ì‹œì‘ ==="
          cd ios
          pod install

      - name: Verify iOS Signing Configuration
        script: |
          echo "=== iOS ì„œëª… í™˜ê²½ í™•ì¸ ==="
          echo "DEVELOPMENT_TEAM: ${DEVELOPMENT_TEAM:-'24SL34R9HR'}"
          
          # Distribution Certificate ì •ë³´ í™•ì¸
          DIST_CERT_INFO=$(security find-identity -v -p codesigning | grep -i distribution | head -1)
          if [ -n "$DIST_CERT_INFO" ]; then
            echo "âœ… Distribution ì¸ì¦ì„œ: $DIST_CERT_INFO"
          else
            echo "âŒ Distribution ì¸ì¦ì„œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ"
            echo "ì‚¬ìš© ê°€ëŠ¥í•œ ì¸ì¦ì„œë“¤:"
            security find-identity -v -p codesigning
            exit 1
          fi
          
          # Provisioning Profile ì •ë³´ í™•ì¸
          PROFILE_COUNT=$(find "$HOME/Library/MobileDevice/Provisioning Profiles" -name "*.mobileprovision" 2>/dev/null | wc -l)
          echo "ì„¤ì¹˜ëœ í”„ë¡œë¹„ì €ë‹ í”„ë¡œíŒŒì¼ ê°œìˆ˜: $PROFILE_COUNTê°œ"
          
          if [ "$PROFILE_COUNT" -gt 0 ]; then
            echo "âœ… í”„ë¡œë¹„ì €ë‹ í”„ë¡œíŒŒì¼ ëª©ë¡:"
            find "$HOME/Library/MobileDevice/Provisioning Profiles" -name "*.mobileprovision" 2>/dev/null | while read profile; do
              PROFILE_NAME=$(security cms -D -i "$profile" 2>/dev/null | grep -A1 "<key>Name</key>" | tail -1 | sed 's/.*<string>\(.*\)<\/string>.*/\1/' | tr -d '\n')
              echo "  - $(basename "$profile" .mobileprovision): $PROFILE_NAME"
            done
          else
            echo "âŒ í”„ë¡œë¹„ì €ë‹ í”„ë¡œíŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŒ"
            exit 1
          fi

      - name: Configure Xcode Project for Manual Signing
        script: |
          cd picnic_app/ios
          
          echo "=== Xcode í”„ë¡œì íŠ¸ Manual Signing ì„¤ì • ==="
          # Manual Signing ê°•ì œ ì„¤ì • (Distribution ì¸ì¦ì„œ ì‚¬ìš©)
          echo "ğŸ“ Manual Signing ê°•ì œ í™œì„±í™”..."
          sed -i '' "s/CODE_SIGN_STYLE = Automatic;/CODE_SIGN_STYLE = Manual;/g" Runner.xcodeproj/project.pbxproj
          sed -i '' "s/CODE_SIGN_IDENTITY = \"\";/CODE_SIGN_IDENTITY = \"Apple Distribution\";/g" Runner.xcodeproj/project.pbxproj
          sed -i '' "s/CODE_SIGN_IDENTITY = \"Apple Development\";/CODE_SIGN_IDENTITY = \"Apple Distribution\";/g" Runner.xcodeproj/project.pbxproj
          sed -i '' "s/\"CODE_SIGN_IDENTITY\[sdk=iphoneos\*\]\" = \"iPhone Developer\";/\"CODE_SIGN_IDENTITY[sdk=iphoneos*]\" = \"Apple Distribution\";/g" Runner.xcodeproj/project.pbxproj
          
          # í”„ë¡œë¹„ì €ë‹ í”„ë¡œíŒŒì¼ ì„¤ì •
          sed -i '' "s/PROVISIONING_PROFILE_SPECIFIER = \"\";/PROVISIONING_PROFILE_SPECIFIER = \"picnic_app_profile_2025\";/g" Runner.xcodeproj/project.pbxproj
          
          # PROVISIONING_PROFILE_SPECIFIER ì¶”ê°€ (ì¡´ì¬í•˜ì§€ ì•ŠëŠ” ê²½ìš°)
          if ! grep -q "PROVISIONING_PROFILE_SPECIFIER" Runner.xcodeproj/project.pbxproj; then
            sed -i '' '/DEVELOPMENT_TEAM = /a\
          PROVISIONING_PROFILE_SPECIFIER = "picnic_app_profile_2025";' Runner.xcodeproj/project.pbxproj
          fi
          
          # Development Team ì„¤ì • ìœ ì§€
          sed -i '' "s/DEVELOPMENT_TEAM = \"\";/DEVELOPMENT_TEAM = \"24SL34R9HR\";/g" Runner.xcodeproj/project.pbxproj
          sed -i '' "s/DEVELOPMENT_TEAM = 24SL34R9HR;/DEVELOPMENT_TEAM = \"24SL34R9HR\";/g" Runner.xcodeproj/project.pbxproj
          
          echo "âœ… Manual Signing ì„¤ì • ì™„ë£Œ"
          echo "- CODE_SIGN_STYLE: Manual"  
          echo "- DEVELOPMENT_TEAM: 24SL34R9HR"
          echo "- CODE_SIGN_IDENTITY: Apple Distribution"
          echo "- PROVISIONING_PROFILE_SPECIFIER: picnic_app_profile_2025"

      - name: Shorebird iOS Patch
        script: |
          cd picnic_app
          export PATH="$HOME/.shorebird/bin:$PATH"

          echo "=== Shorebird iOS íŒ¨ì¹˜ ì‹œì‘ ==="
          echo "Shorebird ë²„ì „ í™•ì¸:"
          shorebird --version

          echo "=== Shorebird ì¸ì¦ í™•ì¸ ==="
          if [ -z "$SHOREBIRD_TOKEN" ]; then
            echo "âŒ SHOREBIRD_TOKEN í™˜ê²½ë³€ìˆ˜ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤"
            exit 1
          else
            echo "âœ… SHOREBIRD_TOKEN í™˜ê²½ë³€ìˆ˜ê°€ ì„¤ì •ë˜ì—ˆìŠµë‹ˆë‹¤"
          fi

          echo "=== Shorebird CLI ìƒíƒœ í™•ì¸ ==="
          echo "Shorebird ë²„ì „:"
          shorebird --version 2>/dev/null || echo "Shorebird ë²„ì „ í™•ì¸ ì‹¤íŒ¨"

          echo "=== Flutter ë¹Œë“œ í…ŒìŠ¤íŠ¸ ==="
          # íŒ¨ì¹˜ ìƒì„± ì „ì— Flutter ë¹Œë“œê°€ ì„±ê³µí•˜ëŠ”ì§€ í™•ì¸
          echo "ğŸ§ª Flutter IPA ë¹Œë“œ í…ŒìŠ¤íŠ¸ ì¤‘..."
          flutter build ios --release --dart-define=ENVIRONMENT=prod --analyze-size 2>/dev/null || {
            echo "âš ï¸ Flutter ë¹Œë“œ í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨ - ê¸°ë³¸ ë¹Œë“œ í™•ì¸"
            flutter build ios --release --dart-define=ENVIRONMENT=prod || echo "Flutter iOS ë¹Œë“œ í™•ì¸ ì‹¤íŒ¨"
          }

          echo "=== Shorebird ìºì‹œ ì •ë¦¬ ë° iOS íŒ¨ì¹˜ ì¤€ë¹„ ==="
          # Shorebird ìºì‹œ ì •ë¦¬
          shorebird cache clean
          
          # Flutter ìºì‹œ ì •ë¦¬
          flutter clean
          flutter pub get
          
          echo "=== iOS ë¹Œë“œ ë””ë ‰í† ë¦¬ ì¤€ë¹„ ==="
          # iOS ë¹Œë“œ ë””ë ‰í† ë¦¬ ë¯¸ë¦¬ ìƒì„±
          mkdir -p build/ios/iphoneos
          mkdir -p build/ios/Release-iphoneos
          
          echo "=== Shorebird iOS íŒ¨ì¹˜ ìƒì„± ë° ë°°í¬ ==="
          # íŒ¨ì¹˜ ìƒì„± (ê°€ì¥ ìµœì‹  ë¦´ë¦¬ì¦ˆì— ëŒ€í•œ íŒ¨ì¹˜)
          echo "ğŸš€ iOS íŒ¨ì¹˜ ìƒì„± ì‹œì‘ (ìë™ Flutter ë²„ì „ ê°ì§€)..."
          PATCH_RESULT=$(shorebird patch ios \
            --release-version=latest \
            --no-confirm \
            --dart-define=ENVIRONMENT=prod \
            --verbose 2>&1)
          PATCH_EXIT_CODE=$?
          
          echo "íŒ¨ì¹˜ ê²°ê³¼ ì¶œë ¥:"
          echo "$PATCH_RESULT"
          
          # íŒ¨ì¹˜ ê²°ê³¼ í™•ì¸ ë° ì ì ˆí•œ ì²˜ë¦¬
          if [ $PATCH_EXIT_CODE -eq 0 ]; then
            if echo "$PATCH_RESULT" | grep -i "successfully\|completed\|deployed\|published patch"; then
              echo "=== Shorebird iOS íŒ¨ì¹˜ ì„±ê³µ ==="
              echo "âœ… iOS íŒ¨ì¹˜ê°€ Shorebirdë¥¼ í†µí•´ ì„±ê³µì ìœ¼ë¡œ ë°°í¬ë˜ì—ˆìŠµë‹ˆë‹¤"
              echo "ğŸš€ ì‚¬ìš©ìë“¤ì€ ì•±ì„ ì¬ì‹œì‘í•˜ë©´ ìë™ìœ¼ë¡œ íŒ¨ì¹˜ê°€ ì ìš©ë©ë‹ˆë‹¤"
              
              # íŒ¨ì¹˜ ì •ë³´ ì¶”ì¶œ ë° í‘œì‹œ
              if echo "$PATCH_RESULT" | grep -i "published patch"; then
                echo ""
                echo "ğŸ“± íŒ¨ì¹˜ ë°°í¬ ì •ë³´:"
                echo "$PATCH_RESULT" | grep -A 5 -i "ready to publish\|published patch" | tail -6
              fi
            else
              echo "=== Shorebird iOS íŒ¨ì¹˜ ë¶ˆì™„ì „ ==="
              echo "âš ï¸ íŒ¨ì¹˜ ëª…ë ¹ì–´ëŠ” ì„±ê³µí–ˆì§€ë§Œ ê²°ê³¼ê°€ ë¶ˆë¶„ëª…í•©ë‹ˆë‹¤"
              echo "íŒ¨ì¹˜ ê²°ê³¼ë¥¼ ë‹¤ì‹œ í™•ì¸í•´ì£¼ì„¸ìš”"
              exit 1
            fi
          else
            echo "=== Shorebird iOS íŒ¨ì¹˜ ì‹¤íŒ¨ ==="
            echo "âŒ iOS íŒ¨ì¹˜ ìƒì„±/ë°°í¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤ (ì¢…ë£Œ ì½”ë“œ: $PATCH_EXIT_CODE)"
            
            # ì‹¤íŒ¨ ì›ì¸ ë¶„ì„
            if echo "$PATCH_RESULT" | grep -i "no.*account\|profile"; then
              echo "ğŸ” ì„œëª… ê´€ë ¨ ë¬¸ì œë¡œ ë³´ì…ë‹ˆë‹¤:"
              echo "- CodeMagic iOS ì„œëª… ì„¤ì •ì„ í™•ì¸í•˜ì„¸ìš”"
              echo "- Apple Developer ê³„ì • ì—°ê²° ìƒíƒœë¥¼ í™•ì¸í•˜ì„¸ìš”"
              echo "- í”„ë¡œë¹„ì €ë‹ í”„ë¡œíŒŒì¼ ìœ íš¨ì„±ì„ í™•ì¸í•˜ì„¸ìš”"
            elif echo "$PATCH_RESULT" | grep -i "flutter.*build.*fail"; then
              echo "ğŸ” Flutter ë¹Œë“œ ë¬¸ì œë¡œ ë³´ì…ë‹ˆë‹¤:"
              echo "- Flutter ë²„ì „ í˜¸í™˜ì„±ì„ í™•ì¸í•˜ì„¸ìš”"
              echo "- ì˜ì¡´ì„± íŒ¨í‚¤ì§€ë“¤ì„ í™•ì¸í•˜ì„¸ìš”"
            elif echo "$PATCH_RESULT" | grep -i "no.*release"; then
              echo "ğŸ” ê¸°ì¡´ ë¦´ë¦¬ì¦ˆê°€ ì—†ëŠ” ë¬¸ì œë¡œ ë³´ì…ë‹ˆë‹¤:"
              echo "- ë¨¼ì € ì „ì²´ ë¦´ë¦¬ì¦ˆë¥¼ ë°°í¬í•œ í›„ íŒ¨ì¹˜ë¥¼ ì‹œë„í•˜ì„¸ìš”"
            fi
            
            exit 1
          fi

    artifacts:
      - picnic_app/flutter_drive.log

    publishing:
      slack:
        channel: '#codemagic-picnic'
        notify_on_build_start: true
        notify:
          success: true
          failure: true
      email:
        recipients:
          - ironlove77@gmail.com
        notify:
          success: true
          failure: true

  # =================== PICNIC APP Android Patch (Shorebird) ===================
  picnic-app-patch-android:
    name: Picnic App - Android Patch (Shorebird)
    instance_type: mac_mini_m2
    max_build_duration: 60
    environment:
      android_signing:
        - picnic_keystore
      groups:
        - shorebird-config
        - picnic_env
      flutter: 3.32.4
      java: 17
      vars:
        PATH: $PATH:$HOME/.shorebird/bin
        APP_NAME: "picnic_app"
    cache:
      cache_paths:
        - $FLUTTER_ROOT/.pub-cache
        - $HOME/.gradle/caches
        - $HOME/.gradle/wrapper
        - $HOME/.android/build-cache
        - picnic_app/.dart_tool
        - picnic_app/android/.gradle
    triggering:
      events:
        - push
        - tag
      # hotfix, patch ë¸Œëœì¹˜ì™€ patch íƒœê·¸ë¡œ íŠ¸ë¦¬ê±°
      branch_patterns:
        - pattern: 'hotfix/*'
          include: true
        - pattern: 'patch/*'
          include: true
      tag_patterns:
        - pattern: 'picnic-patch-*'
          include: true
      cancel_previous_builds: true
    scripts:
      - name: Install Shorebird CLI
        script: |
          echo "=== Shorebird CLI ì„¤ì¹˜ ì‹œì‘ ==="
          curl --proto '=https' --tlsv1.2 https://raw.githubusercontent.com/shorebirdtech/install/main/install.sh -sSf | bash
          export PATH="$HOME/.shorebird/bin:$PATH"
          
          echo "Shorebird ë²„ì „ í™•ì¸:"
          shorebird --version || echo "Shorebird ì„¤ì¹˜ ì‹¤íŒ¨"

      - name: Get Flutter packages
        script: |
          cd picnic_app
          flutter packages pub get

      - name: Verify Keystore Configuration
        script: |
          echo "=== í‚¤ìŠ¤í† ì–´ í™˜ê²½ ë³€ìˆ˜ í™•ì¸ ==="
          echo "CM_KEYSTORE_PATH: ${CM_KEYSTORE_PATH:-'ë¯¸ì„¤ì •'}"
          echo "CM_KEYSTORE_PASSWORD: ${CM_KEYSTORE_PASSWORD:-'ë¯¸ì„¤ì •'}"
          echo "CM_KEY_ALIAS: ${CM_KEY_ALIAS:-'ë¯¸ì„¤ì •'}"
          echo "CM_KEY_PASSWORD: ${CM_KEY_PASSWORD:-'ë¯¸ì„¤ì •'}"
          
          if [ -z "$CM_KEYSTORE_PATH" ] || [ -z "$CM_KEYSTORE_PASSWORD" ] || [ -z "$CM_KEY_ALIAS" ] || [ -z "$CM_KEY_PASSWORD" ]; then
            echo "âŒ í‚¤ìŠ¤í† ì–´ í™˜ê²½ ë³€ìˆ˜ê°€ ì˜¬ë°”ë¥´ê²Œ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤"
            echo "CodeMagic ëŒ€ì‹œë³´ë“œì—ì„œ 'picnic_keystore' ê·¸ë£¹ ì„¤ì •ì„ í™•ì¸í•´ì£¼ì„¸ìš”"
            exit 1
          fi
          
          if [ -f "$CM_KEYSTORE_PATH" ]; then
            echo "âœ… í‚¤ìŠ¤í† ì–´ íŒŒì¼ ì¡´ì¬: $CM_KEYSTORE_PATH"
            # í‚¤ìŠ¤í† ì–´ ì •ë³´ í™•ì¸
            keytool -list -v -keystore "$CM_KEYSTORE_PATH" -alias "$CM_KEY_ALIAS" -storepass "$CM_KEYSTORE_PASSWORD" | grep -E "(SHA1|SHA256|Subject|Issuer)" | head -3 || echo "í‚¤ìŠ¤í† ì–´ ì •ë³´ í™•ì¸ ì‹¤íŒ¨"
          else
            echo "âŒ í‚¤ìŠ¤í† ì–´ íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: $CM_KEYSTORE_PATH"
            exit 1
          fi

      - name: Configure Gradle for Maximum Optimization (Patch)
        script: |
          cd picnic_app
          
          echo "=== Gradle ë©”ëª¨ë¦¬ ì„¤ì • ìµœëŒ€ ê°•í™” (AAB ë¹Œë“œ ì•ˆì •í™”) ==="
          mkdir -p $HOME/.gradle
          
          # ê¸°ì¡´ gradle.properties ì •ë¦¬ (ì¤‘ë³µ ë°©ì§€)
          rm -f $HOME/.gradle/gradle.properties
          
          # íŒ¨ì¹˜ìš© ìµœëŒ€ ê°•í™” ë©”ëª¨ë¦¬ ì„¤ì • (10GB + ìµœì í™”)
          echo "org.gradle.jvmargs=-Xmx10240m -XX:MaxMetaspaceSize=1536m -XX:+HeapDumpOnOutOfMemoryError -Dfile.encoding=UTF-8" >> $HOME/.gradle/gradle.properties
          echo "org.gradle.daemon=true" >> $HOME/.gradle/gradle.properties
          echo "org.gradle.caching=true" >> $HOME/.gradle/gradle.properties
          echo "org.gradle.parallel=false" >> $HOME/.gradle/gradle.properties
          echo "org.gradle.configureondemand=false" >> $HOME/.gradle/gradle.properties
          echo "org.gradle.workers.max=2" >> $HOME/.gradle/gradle.properties
          echo "android.enableJetifier=true" >> $HOME/.gradle/gradle.properties
          echo "android.useAndroidX=true" >> $HOME/.gradle/gradle.properties
          
          # AAB ë¹Œë“œ ìµœì í™” ì„¤ì • (ë” ë³´ìˆ˜ì  ì ‘ê·¼)
          echo "android.enableR8=true" >> $HOME/.gradle/gradle.properties
          echo "android.enableR8.fullMode=false" >> $HOME/.gradle/gradle.properties
          echo "android.enableD8.desugaring=false" >> $HOME/.gradle/gradle.properties
          echo "android.enableIncrementalDesugaring=false" >> $HOME/.gradle/gradle.properties
          echo "android.bundle.enableUncompressedNativeLibs=false" >> $HOME/.gradle/gradle.properties
          echo "android.aapt2.disableRetainExplicitlyKeptAttributes=true" >> $HOME/.gradle/gradle.properties
          
          # ì¶”ê°€ ë¹Œë“œ ì•ˆì •ì„± ì„¤ì •
          echo "org.gradle.vfs.watch=false" >> $HOME/.gradle/gradle.properties
          echo "kotlin.incremental=false" >> $HOME/.gradle/gradle.properties
          echo "kotlin.incremental.useClasspathSnapshot=false" >> $HOME/.gradle/gradle.properties
          echo "org.gradle.unsafe.configuration-cache=false" >> $HOME/.gradle/gradle.properties
          echo "android.experimental.enableSourceSetPathsMap=false" >> $HOME/.gradle/gradle.properties
          
          echo "âœ… Gradle ì„¤ì • ì™„ë£Œ (íŒ¨ì¹˜ìš© ë©”ëª¨ë¦¬ 10GB + AAB ìµœì í™”)"
          
          # JVM ë©”ëª¨ë¦¬ í™˜ê²½ ë³€ìˆ˜ë„ ì„¤ì •
          export GRADLE_OPTS="-Xmx10240m -XX:MaxMetaspaceSize=1536m -XX:+UseG1GC"
          export _JAVA_OPTIONS="-Xmx10240m"

      - name: Shorebird Android Patch with Enhanced Build Strategy
        script: |
          cd picnic_app
          export PATH="$HOME/.shorebird/bin:$PATH"

          echo "=== Shorebird Android íŒ¨ì¹˜ ì‹œì‘ (AAB ë¹Œë“œ ìµœì í™”) ==="
          echo "Shorebird ë²„ì „ í™•ì¸:"
          shorebird --version

          echo "=== Shorebird ì¸ì¦ í™•ì¸ ==="
          if [ -z "$SHOREBIRD_TOKEN" ]; then
            echo "âŒ SHOREBIRD_TOKEN í™˜ê²½ë³€ìˆ˜ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤"
            exit 1
          else
            echo "âœ… SHOREBIRD_TOKEN í™˜ê²½ë³€ìˆ˜ê°€ ì„¤ì •ë˜ì—ˆìŠµë‹ˆë‹¤"
          fi

          echo "=== í™˜ê²½ ìµœì í™” ë° ì‚¬ì „ ë¹Œë“œ í…ŒìŠ¤íŠ¸ ==="
          # Shorebird ìºì‹œ ì •ë¦¬
          shorebird cache clean
          
          # Flutter ìºì‹œ ì •ë¦¬
          flutter clean
          flutter pub get
          
          # ë©”ëª¨ë¦¬ ì••ë°• ì™„í™”ë¥¼ ìœ„í•œ ì‹œìŠ¤í…œ ì •ë¦¬
          echo "ğŸ§¹ ì‹œìŠ¤í…œ ë©”ëª¨ë¦¬ ì •ë¦¬..."
          rm -rf build/ android/app/build/ android/.gradle/ $HOME/.gradle/caches/
          
          # JVM ë©”ëª¨ë¦¬ ìµœì í™”
          export GRADLE_OPTS="-Xmx10240m -XX:MaxMetaspaceSize=1536m -XX:+UseG1GC -XX:G1HeapRegionSize=32m"
          export _JAVA_OPTIONS="-Xmx10240m -XX:MaxMetaspaceSize=1536m"
          export JAVA_OPTS="-Xmx10240m -XX:MaxMetaspaceSize=1536m"
          
          echo "=== Flutter AAB ë¹Œë“œ ì‚¬ì „ í…ŒìŠ¤íŠ¸ (ë¬¸ì œ ì¡°ê¸° ë°œê²¬) ==="
          # Flutter AAB ë¹Œë“œë¥¼ ë¨¼ì € í…ŒìŠ¤íŠ¸í•´ì„œ ë¬¸ì œê°€ ìˆëŠ”ì§€ í™•ì¸
          echo "ğŸ§ª Flutter AAB ë¹Œë“œ í…ŒìŠ¤íŠ¸ ì‹œì‘..."
          AAB_TEST_RESULT=$(flutter build appbundle --release --dart-define=ENVIRONMENT=prod 2>&1)
          AAB_TEST_EXIT_CODE=$?
          
          if [ $AAB_TEST_EXIT_CODE -eq 0 ]; then
            echo "âœ… Flutter AAB ë¹Œë“œ í…ŒìŠ¤íŠ¸ ì„±ê³µ!"
            echo "ğŸ¯ Shorebird íŒ¨ì¹˜ì—ì„œë„ AAB ë¹Œë“œê°€ ì„±ê³µí•  ê°€ëŠ¥ì„±ì´ ë†’ìŠµë‹ˆë‹¤"
            
            # ì„±ê³µí•œ ë¹Œë“œì˜ AAB íŒŒì¼ì„ Shorebirdê°€ ì˜ˆìƒí•˜ëŠ” ìœ„ì¹˜ë¡œ ë³µì‚¬
            echo "ğŸ“¦ í‘œì¤€ Flutter ë¹Œë“œ ê²°ê³¼ë¬¼ ì¤€ë¹„..."
            
            # AAB íŒŒì¼ íƒì§€ ë° ë³µì‚¬
            if [ -f "build/app/outputs/bundle/release/app-release.aab" ]; then
              AAB_SIZE=$(du -h "build/app/outputs/bundle/release/app-release.aab" | cut -f1)
              echo "âœ… AAB íŒŒì¼ í™•ì¸ë¨: build/app/outputs/bundle/release/app-release.aab (í¬ê¸°: $AAB_SIZE)"
            elif [ -f "android/app/build/outputs/bundle/release/app-release.aab" ]; then
              # ë‹¤ë¥¸ ìœ„ì¹˜ì— ìˆìœ¼ë©´ í‘œì¤€ ìœ„ì¹˜ë¡œ ë³µì‚¬
              mkdir -p build/app/outputs/bundle/release/
              cp "android/app/build/outputs/bundle/release/app-release.aab" "build/app/outputs/bundle/release/app-release.aab"
              AAB_SIZE=$(du -h "build/app/outputs/bundle/release/app-release.aab" | cut -f1)
              echo "âœ… AAB íŒŒì¼ ë³µì‚¬ ì™„ë£Œ: build/app/outputs/bundle/release/app-release.aab (í¬ê¸°: $AAB_SIZE)"
            else
              echo "âš ï¸ AAB íŒŒì¼ì„ ì˜ˆìƒ ìœ„ì¹˜ì—ì„œ ì°¾ì„ ìˆ˜ ì—†ìŒ"
            fi
            
          else
            echo "âŒ Flutter AAB ë¹Œë“œ í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨"
            echo "ğŸ” AAB ë¹Œë“œ ì‹¤íŒ¨ ì›ì¸ ë¶„ì„:"
            
            # êµ¬ì²´ì ì¸ ì˜¤ë¥˜ ë¶„ì„
            if echo "$AAB_TEST_RESULT" | grep -i "java.*heap\|out.*of.*memory"; then
              echo "   - ë©”ëª¨ë¦¬ ë¶€ì¡± ë¬¸ì œ ê°ì§€"
              echo "   - í˜„ì¬ ì„¤ì •: 10GB Heap + G1GC + ZGC"
              echo "   - ì¶”ê°€ ìµœì í™” ì ìš© ì¤‘..."
              
              # ë” ê°•ë ¥í•œ ë©”ëª¨ë¦¬ ì„¤ì •
              export GRADLE_OPTS="-Xmx12288m -XX:MaxMetaspaceSize=2048m -XX:+UseG1GC -XX:+UseZGC -XX:G1HeapRegionSize=32m -XX:+UnlockExperimentalVMOptions"
              export _JAVA_OPTIONS="-Xmx12288m -XX:MaxMetaspaceSize=2048m"
              
              echo "   - ë©”ëª¨ë¦¬ ì„¤ì • 12GBë¡œ ì¦ê°€ ì™„ë£Œ"
              
            elif echo "$AAB_TEST_RESULT" | grep -i "gradle.*fail\|build.*fail"; then
              echo "   - Gradle ë¹Œë“œ ë¬¸ì œ ê°ì§€"
              echo "   - Gradle ë°ëª¬ ì¬ì‹œì‘ ë° ì¶”ê°€ ì •ë¦¬ ì‹¤í–‰"
              
              # Gradle ë°ëª¬ ê°•ì œ ì¢…ë£Œ ë° ì¬ì‹œì‘
              ./gradlew --stop 2>/dev/null || echo "Gradle ë°ëª¬ ì—†ìŒ"
              killall -9 java 2>/dev/null || echo "Java í”„ë¡œì„¸ìŠ¤ ì—†ìŒ"
              
              # ë” ê°•ë ¥í•œ ì •ë¦¬
              rm -rf $HOME/.gradle/daemon/
              rm -rf $HOME/.gradle/caches/
              rm -rf android/app/.gradle/
              
            elif echo "$AAB_TEST_RESULT" | grep -i "depend\|resolve"; then
              echo "   - ì˜ì¡´ì„± í•´ê²° ë¬¸ì œ ê°ì§€"
              echo "   - ì˜ì¡´ì„± ì¬ì„¤ì¹˜ ë° ì •ë¦¬ ì‹¤í–‰"
              
              flutter pub clean
              flutter pub get
              cd android && ./gradlew clean && cd ..
              
            else
              echo "   - ê¸°íƒ€ ë¹Œë“œ ë¬¸ì œ ê°ì§€"
              echo "   - ì „ì²´ í™˜ê²½ ì¬êµ¬ì„±"
            fi
            
            echo "ğŸ”„ ë¬¸ì œ í•´ê²° í›„ ì¬ì‹œë„..."
            
            # ê·¹ë‹¨ì  í•´ê²°ì±…: APKë¡œ ìš°íšŒ í›„ ìˆ˜ë™ AAB ìƒì„±
            echo "ğŸ“± AAB ë¹Œë“œ ì‹¤íŒ¨ ì‹œ APK ë¹Œë“œ í…ŒìŠ¤íŠ¸..."
            APK_TEST_RESULT=$(flutter build apk --release --dart-define=ENVIRONMENT=prod 2>&1)
            APK_TEST_EXIT_CODE=$?
            
            if [ $APK_TEST_EXIT_CODE -eq 0 ]; then
              echo "âœ… APK ë¹Œë“œëŠ” ì„±ê³µí•¨ - AAB ê´€ë ¨ ë¬¸ì œë¡œ íŒë‹¨"
              echo "âš ï¸ Shorebird íŒ¨ì¹˜ì—ì„œ AAB ë¬¸ì œê°€ ë°œìƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤"
            else
              echo "âŒ APK ë¹Œë“œë„ ì‹¤íŒ¨ - ê·¼ë³¸ì ì¸ Flutter ë¹Œë“œ ë¬¸ì œ"
              echo "ğŸš¨ Shorebird íŒ¨ì¹˜ ì‹¤íŒ¨ ê°€ëŠ¥ì„± ë†’ìŒ"
              
              # ìµœí›„ì˜ ìˆ˜ë‹¨: ì™„ì „í•œ ì‹œìŠ¤í…œ ë¦¬ì…‹
              echo "ğŸ”¥ ê·¹ë‹¨ì  í•´ê²°ì±…: ì™„ì „í•œ ë¹Œë“œ í™˜ê²½ ë¦¬ì…‹"
              
              # ëª¨ë“  ìºì‹œì™€ ë¹Œë“œ ê²°ê³¼ë¬¼ ì™„ì „ ì‚­ì œ
              rm -rf build/
              rm -rf android/app/build/
              rm -rf android/.gradle/
              rm -rf $HOME/.gradle/
              rm -rf $HOME/.android/build-cache/
              rm -rf .dart_tool/
              
              # Flutter ìºì‹œë„ ì™„ì „ ì •ë¦¬
              flutter clean
              flutter pub cache clean --force 2>/dev/null || echo "pub cache clean ë¬´ì‹œ"
              flutter pub get
              
              # ìµœì†Œí•œì˜ Gradle ì„¤ì •ìœ¼ë¡œ ì¬êµ¬ì„±
              mkdir -p $HOME/.gradle
              echo "org.gradle.jvmargs=-Xmx8192m -XX:MaxMetaspaceSize=1024m -Dfile.encoding=UTF-8" > $HOME/.gradle/gradle.properties
              echo "org.gradle.daemon=false" >> $HOME/.gradle/gradle.properties
              echo "org.gradle.parallel=false" >> $HOME/.gradle/gradle.properties
              echo "android.enableJetifier=true" >> $HOME/.gradle/gradle.properties
              echo "android.useAndroidX=true" >> $HOME/.gradle/gradle.properties
              
              echo "ğŸ”„ ìµœì†Œ ì„¤ì •ìœ¼ë¡œ ì¬êµ¬ì„± ì™„ë£Œ"
            fi
          fi
          
          echo "=== ë„¤ì´í‹°ë¸Œ ë¼ì´ë¸ŒëŸ¬ë¦¬ ë””ë ‰í† ë¦¬ ë¯¸ë¦¬ ìƒì„± ==="
          # Shorebirdê°€ ì°¾ëŠ” ë””ë ‰í† ë¦¬ë“¤ì„ ë¯¸ë¦¬ ìƒì„±
          mkdir -p build/app/intermediates/stripped_native_libs/stripReleaseDebugSymbols/release/out/lib
          mkdir -p build/app/intermediates/stripped_native_libs/release/out/lib
          
          echo "=== ë„¤ì´í‹°ë¸Œ ë¼ì´ë¸ŒëŸ¬ë¦¬ íŒŒì¼ ë³µì‚¬ (Shorebird Issue #1798 í•´ê²°) ==="
          # Flutterê°€ ìƒì„±í•œ ë„¤ì´í‹°ë¸Œ ë¼ì´ë¸ŒëŸ¬ë¦¬ íŒŒì¼ë“¤ì„ Shorebirdê°€ ê¸°ëŒ€í•˜ëŠ” ìœ„ì¹˜ë¡œ ë³µì‚¬
          echo "ğŸ“ ë„¤ì´í‹°ë¸Œ ë¼ì´ë¸ŒëŸ¬ë¦¬ íŒŒì¼ ê²€ìƒ‰ ì¤‘..."
          find . -name "libapp.so" -type f 2>/dev/null | head -10
          
          # Shorebirdê°€ ê¸°ëŒ€í•˜ëŠ” íƒ€ê²Ÿ ê²½ë¡œ (stripReleaseDebugSymbols ì—†ëŠ” ê²½ë¡œ)
          SHOREBIRD_TARGET_PATH="build/app/intermediates/stripped_native_libs/release/out/lib"
          mkdir -p "$SHOREBIRD_TARGET_PATH"/{armeabi-v7a,arm64-v8a,x86,x86_64}
          
          # ì‹¤ì œ íŒŒì¼ì´ ìˆëŠ” ì†ŒìŠ¤ ê²½ë¡œë“¤ (stripReleaseDebugSymbols í¬í•¨)
          ACTUAL_SOURCE_PATHS=(
            "android/app/build/intermediates/stripped_native_libs/release/stripReleaseDebugSymbols/out/lib"
            "build/app/intermediates/stripped_native_libs/release/stripReleaseDebugSymbols/out/lib"
            "android/app/build/intermediates/merged_native_libs/release/mergeReleaseNativeLibs/out/lib"
            "build/app/intermediates/merged_native_libs/release/mergeReleaseNativeLibs/out/lib"
            "android/app/build/intermediates/stripped_native_libs/release/out/lib"
            "build/app/intermediates/stripped_native_libs/release/out/lib"
          )
          
          # ì†ŒìŠ¤ì—ì„œ íƒ€ê²Ÿìœ¼ë¡œ ë„¤ì´í‹°ë¸Œ ë¼ì´ë¸ŒëŸ¬ë¦¬ ë³µì‚¬
          COPIED_COUNT=0
          FOUND_SOURCE=""
          
          for source in "${ACTUAL_SOURCE_PATHS[@]}"; do
            if [ -d "$source" ] && [ "$(find "$source" -name "*.so" 2>/dev/null | wc -l)" -gt 0 ]; then
              echo "âœ… ë„¤ì´í‹°ë¸Œ ë¼ì´ë¸ŒëŸ¬ë¦¬ ì†ŒìŠ¤ ë°œê²¬: $source"
              FOUND_SOURCE="$source"
              
              # ê° ì•„í‚¤í…ì²˜ë³„ë¡œ ë³µì‚¬
              for arch in armeabi-v7a arm64-v8a x86 x86_64; do
                if [ -d "$source/$arch" ] && [ "$(ls -A "$source/$arch" 2>/dev/null)" ]; then
                  echo "ğŸ“¦ $arch ë¼ì´ë¸ŒëŸ¬ë¦¬ ë³µì‚¬ ì¤‘..."
                  
                  # Shorebirdê°€ ê¸°ëŒ€í•˜ëŠ” ìœ„ì¹˜ë¡œ ë³µì‚¬
                  cp -r "$source/$arch"/* "$SHOREBIRD_TARGET_PATH/$arch/" 2>/dev/null
                  COPY_RESULT=$?
                  
                  # ë³µì‚¬ ì„±ê³µ í™•ì¸
                  if [ $COPY_RESULT -eq 0 ] && [ -f "$SHOREBIRD_TARGET_PATH/$arch/libapp.so" ]; then
                    COPIED_COUNT=$((COPIED_COUNT + 1))
                    FILE_SIZE=$(du -h "$SHOREBIRD_TARGET_PATH/$arch/libapp.so" | cut -f1)
                    echo "  âœ… libapp.so ë³µì‚¬ ì„±ê³µ ($arch, í¬ê¸°: $FILE_SIZE)"
                  fi
                  
                  if [ -f "$SHOREBIRD_TARGET_PATH/$arch/libflutter.so" ]; then
                    FILE_SIZE=$(du -h "$SHOREBIRD_TARGET_PATH/$arch/libflutter.so" | cut -f1)
                    echo "  âœ… libflutter.so ë³µì‚¬ ì„±ê³µ ($arch, í¬ê¸°: $FILE_SIZE)"
                  fi
                fi
              done
              break
            fi
          done
          
          # ë³µì‚¬ ê²°ê³¼ í™•ì¸
          if [ $COPIED_COUNT -gt 0 ]; then
            echo "âœ… ë„¤ì´í‹°ë¸Œ ë¼ì´ë¸ŒëŸ¬ë¦¬ ë³µì‚¬ ì™„ë£Œ ($COPIED_COUNTê°œ ì•„í‚¤í…ì²˜)"
            echo "ğŸ¯ Shorebirdê°€ ì°¾ì„ ê²½ë¡œ: $SHOREBIRD_TARGET_PATH"
          else
            echo "âš ï¸ ë„¤ì´í‹°ë¸Œ ë¼ì´ë¸ŒëŸ¬ë¦¬ ë³µì‚¬ ì‹¤íŒ¨ - íŒ¨ì¹˜ê°€ ì‹¤íŒ¨í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤"
          fi
          
          echo "=== Shorebird Android íŒ¨ì¹˜ ìƒì„± ë° ë°°í¬ (ê°•í™”ëœ ë©”ëª¨ë¦¬ ì„¤ì •) ==="
          echo "ğŸš€ Android íŒ¨ì¹˜ ì‹œì‘ (ì‚¬ì „ ë¹Œë“œ ì™„ë£Œëœ í™˜ê²½)..."
          
          # ìµœì¢… ë©”ëª¨ë¦¬ ì„¤ì • í™•ì¸
          echo "ë©”ëª¨ë¦¬ ì„¤ì • ìƒíƒœ:"
          echo "- GRADLE_OPTS: $GRADLE_OPTS"
          echo "- _JAVA_OPTIONS: $_JAVA_OPTIONS"
          echo "- JAVA_OPTS: $JAVA_OPTS"
          
          # Shorebird ì‘ì—… ë””ë ‰í† ë¦¬ ìµœì í™”
          echo "ğŸ”§ Shorebird í™˜ê²½ ìµœì í™”..."
          
          # 1ì°¨ ì‹œë„: í‘œì¤€ íŒ¨ì¹˜ ëª…ë ¹ì–´
          echo "ğŸ“± 1ì°¨ ì‹œë„: í‘œì¤€ Shorebird íŒ¨ì¹˜..."
          PATCH_RESULT=$(shorebird patch android \
            --release-version=latest \
            --no-confirm \
            --dart-define=ENVIRONMENT=prod 2>&1)
          PATCH_EXIT_CODE=$?
          
          echo "íŒ¨ì¹˜ ê²°ê³¼ ì¶œë ¥:"
          echo "$PATCH_RESULT"
          
          # íŒ¨ì¹˜ ê²°ê³¼ í™•ì¸ ë° ì ì ˆí•œ ì²˜ë¦¬
          if [ $PATCH_EXIT_CODE -eq 0 ]; then
            if echo "$PATCH_RESULT" | grep -i "successfully\|completed\|deployed\|published patch"; then
              echo "=== Shorebird Android íŒ¨ì¹˜ ì„±ê³µ ==="
              echo "âœ… Android íŒ¨ì¹˜ê°€ Shorebirdë¥¼ í†µí•´ ì„±ê³µì ìœ¼ë¡œ ë°°í¬ë˜ì—ˆìŠµë‹ˆë‹¤"
              echo "ğŸš€ ì‚¬ìš©ìë“¤ì€ ì•±ì„ ì¬ì‹œì‘í•˜ë©´ ìë™ìœ¼ë¡œ íŒ¨ì¹˜ê°€ ì ìš©ë©ë‹ˆë‹¤"
              
              # íŒ¨ì¹˜ ì •ë³´ ì¶”ì¶œ ë° í‘œì‹œ
              if echo "$PATCH_RESULT" | grep -i "published patch"; then
                echo ""
                echo "ğŸ“± íŒ¨ì¹˜ ë°°í¬ ì •ë³´:"
                echo "$PATCH_RESULT" | grep -A 5 -i "ready to publish\|published patch" | tail -6
              fi
            else
              echo "=== Shorebird Android íŒ¨ì¹˜ ë¶ˆì™„ì „ ==="
              echo "âš ï¸ íŒ¨ì¹˜ ëª…ë ¹ì–´ëŠ” ì„±ê³µí–ˆì§€ë§Œ ê²°ê³¼ê°€ ë¶ˆë¶„ëª…í•©ë‹ˆë‹¤"
              echo "íŒ¨ì¹˜ ê²°ê³¼ë¥¼ ë‹¤ì‹œ í™•ì¸í•´ì£¼ì„¸ìš”"
              exit 1
            fi
          else
            echo "=== Shorebird Android íŒ¨ì¹˜ 1ì°¨ ì‹¤íŒ¨ ==="
            echo "âŒ 1ì°¨ íŒ¨ì¹˜ ì‹œë„ ì‹¤íŒ¨ (ì¢…ë£Œ ì½”ë“œ: $PATCH_EXIT_CODE)"
            
            # AAB íŒŒì¼ ì°¾ê¸° ë¬¸ì œì¸ì§€ í™•ì¸
            if echo "$PATCH_RESULT" | grep -i "failed.*produce.*aab\|couldn.*find.*aab"; then
              echo "ğŸ” AAB íŒŒì¼ íƒì§€ ì‹¤íŒ¨ ë¬¸ì œë¡œ íŒë‹¨ë¨"
              echo "ğŸ“¦ 2ì°¨ ì‹œë„: ìˆ˜ë™ AAB íŒŒì¼ ë°°ì¹˜ í›„ ì¬ì‹œë„..."
              
              # ëª¨ë“  ê°€ëŠ¥í•œ ìœ„ì¹˜ì—ì„œ AAB íŒŒì¼ ì°¾ê¸°
              echo "ğŸ” ì‹œìŠ¤í…œ ì „ì²´ì—ì„œ AAB íŒŒì¼ ê²€ìƒ‰..."
              find /Users/builder/clone/picnic_app -name "*.aab" -type f 2>/dev/null | head -10
              
              AAB_FOUND=$(find /Users/builder/clone/picnic_app -name "*.aab" -type f 2>/dev/null | head -1)
              if [ -n "$AAB_FOUND" ]; then
                echo "âœ… AAB íŒŒì¼ ë°œê²¬: $AAB_FOUND"
                
                # ì—¬ëŸ¬ ìœ„ì¹˜ì— ë³µì‚¬í•˜ì—¬ Shorebirdê°€ ì°¾ì„ ìˆ˜ ìˆë„ë¡ í•¨
                mkdir -p build/app/outputs/bundle/release/
                mkdir -p android/app/build/outputs/bundle/release/
                
                cp "$AAB_FOUND" build/app/outputs/bundle/release/app-release.aab
                cp "$AAB_FOUND" android/app/build/outputs/bundle/release/app-release.aab
                
                echo "ğŸ”„ 2ì°¨ íŒ¨ì¹˜ ì‹œë„ (AAB íŒŒì¼ ë°°ì¹˜ ì™„ë£Œ)..."
                PATCH_RESULT_2=$(shorebird patch android \
                  --release-version=latest \
                  --no-confirm \
                  --dart-define=ENVIRONMENT=prod 2>&1)
                PATCH_EXIT_CODE_2=$?
                
                if [ $PATCH_EXIT_CODE_2 -eq 0 ]; then
                  echo "âœ… 2ì°¨ ì‹œë„ ì„±ê³µ! AAB íŒŒì¼ ë°°ì¹˜ë¡œ ë¬¸ì œ í•´ê²°ë¨"
                  echo "$PATCH_RESULT_2"
                else
                  echo "âŒ 2ì°¨ ì‹œë„ë„ ì‹¤íŒ¨ (ì¢…ë£Œ ì½”ë“œ: $PATCH_EXIT_CODE_2)"
                  echo "$PATCH_RESULT_2"
                  exit 1
                fi
              else
                echo "âŒ ì‹œìŠ¤í…œì—ì„œ AAB íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŒ"
                exit 1
              fi
            else
              echo "ğŸ” ë‹¤ë¥¸ ì¢…ë¥˜ì˜ ë¹Œë“œ ë¬¸ì œë¡œ ë³´ì…ë‹ˆë‹¤:"
              
              # ì‹¤íŒ¨ ì›ì¸ ë¶„ì„
              if echo "$PATCH_RESULT" | grep -i "keystore\|signing"; then
                echo "- ì„œëª… ê´€ë ¨ ë¬¸ì œ"
              elif echo "$PATCH_RESULT" | grep -i "flutter.*build.*fail\|gradle.*fail"; then
                echo "- Flutter/Gradle ë¹Œë“œ ë¬¸ì œ"
              elif echo "$PATCH_RESULT" | grep -i "no.*release"; then
                echo "- ê¸°ì¡´ ë¦´ë¦¬ì¦ˆ ì—†ìŒ"
              elif echo "$PATCH_RESULT" | grep -i "java.*heap\|out.*of.*memory"; then
                echo "- ë©”ëª¨ë¦¬ ë¶€ì¡±"
              fi
              
              exit 1
            fi
          fi

    artifacts:
      - picnic_app/flutter_drive.log

    publishing:
      slack:
        channel: '#codemagic-picnic'
        notify_on_build_start: true
        notify:
          success: true
          failure: true
      email:
        recipients:
          - ironlove77@gmail.com
        notify:
          success: true
          failure: true