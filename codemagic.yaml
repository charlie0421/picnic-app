workflows:
  # =================== PICNIC APP iOS ===================
  picnic-app-ios:
    name: Picnic App - iOS
    instance_type: mac_mini_m2
    max_build_duration: 120
    integrations:
      app_store_connect: codemagic-picnic
    environment:
      ios_signing:
        distribution_type: app_store
        bundle_identifier: io.iconcasting.picnic.app
      groups:
        - app_store_connect
        - shorebird-config
        - picnic_env
      flutter: 3.32.4
      vars:
        APP_NAME: "picnic_app"
        BUNDLE_ID: "io.iconcasting.picnic.app"
    cache:
      cache_paths:
        - $FLUTTER_ROOT/.pub-cache
        - $HOME/.gradle/caches
        - $HOME/Library/Caches/CocoaPods
    triggering:
      events:
        - push
        - tag
      branch_patterns:
        - pattern: 'production'
          include: true
      tag_patterns:
        - pattern: 'picnic-v*'
          include: true
      cancel_previous_builds: true
    scripts:
      - name: Get Flutter packages and prepare iOS
        script: |
          cd picnic_app
          echo "=== Flutter Ìå®ÌÇ§ÏßÄ ÏÑ§Ïπò ==="
          flutter packages pub get
          
          echo "=== Flutter iOS ÏÑ§Ï†ï ÏÉùÏÑ± (Generated.xcconfig ÌååÏùº ÏÉùÏÑ±) ==="
          flutter precache --ios
          flutter build ios --config-only
          
          echo "=== Generated.xcconfig ÌååÏùº ÌôïÏù∏ ==="
          ls -la ios/Flutter/Generated.xcconfig || echo "‚ö†Ô∏è Generated.xcconfig ÌååÏùºÏù¥ ÏïÑÏßÅ ÏÉùÏÑ±ÎêòÏßÄ ÏïäÏùå"

      - name: Install CocoaPods dependencies
        script: |
          cd picnic_app
          
          echo "=== Generated.xcconfig ÌååÏùº ÌôïÏù∏ ==="
          if [ ! -f "ios/Flutter/Generated.xcconfig" ]; then
            echo "‚ö†Ô∏è Generated.xcconfig ÌååÏùºÏù¥ ÏóÜÏùå - Flutter ÏÑ§Ï†ï Ïû¨ÏÉùÏÑ±"
            flutter build ios --config-only
          fi
          
          echo "‚úÖ Generated.xcconfig ÌååÏùº Ï°¥Ïû¨ ÌôïÏù∏:"
          ls -la ios/Flutter/Generated.xcconfig
          
          echo "=== CocoaPods ÏÑ§Ïπò ÏãúÏûë ==="
          cd ios
          pod install

      - name: Install Shorebird CLI
        script: |
          echo "=== Shorebird CLI ÏÑ§Ïπò ÏãúÏûë ==="
          
          # Í∏∞Ï°¥ Shorebird ÏÑ§Ïπò Í∞ïÏ†ú Ï†úÍ±∞ (Ï∂©Îèå Î∞©ÏßÄ)
          echo "üßπ Í∏∞Ï°¥ Shorebird ÏÑ§Ïπò Ï†ïÎ¶¨ Ï§ë..."
          if [ -d "$HOME/.shorebird" ]; then
            rm -rf "$HOME/.shorebird"
            echo "‚úÖ Í∏∞Ï°¥ Shorebird ÎîîÎ†âÌÜ†Î¶¨ Ï†úÍ±∞ ÏôÑÎ£å"
          fi
          
          # ÏµúÏã† ÏïàÏ†ï Î≤ÑÏ†Ñ ÏÇ¨Ïö© (v1.6.48)
          echo "üîß Shorebird v1.6.48 ÏµúÏã† ÏïàÏ†ï Î≤ÑÏ†Ñ ÏÑ§Ïπò Ï§ë..."
          
          # Í≥µÏãù GitHub ÏÑ§Ïπò Ïä§ÌÅ¨Î¶ΩÌä∏ ÏÇ¨Ïö© (Í∞ÄÏû• ÏïàÏ†ïÏ†Å)
          echo "üì• Í≥µÏãù ÏÑ§Ïπò Ïä§ÌÅ¨Î¶ΩÌä∏Î°ú ÏµúÏã† Shorebird ÏÑ§Ïπò..."
          curl --proto '=https' --tlsv1.2 https://raw.githubusercontent.com/shorebirdtech/install/main/install.sh -sSf | bash
          
          export PATH="$HOME/.shorebird/bin:$PATH"
          
          echo "=== Shorebird ÏÑ§Ïπò ÌôïÏù∏ ==="
          if command -v shorebird >/dev/null 2>&1; then
            shorebird --version
            echo "‚úÖ Shorebird ÏÑ§Ïπò Î∞è ÏÑ§Ï†ï ÏôÑÎ£å"
          else
            echo "‚ùå Shorebird ÏÑ§Ïπò Ïã§Ìå®"
            exit 1
          fi

      - name: Verify iOS Signing Configuration
        script: |
          echo "=== iOS ÏÑúÎ™Ö ÌôòÍ≤Ω ÌôïÏù∏ ==="
          echo "DEVELOPMENT_TEAM: ${DEVELOPMENT_TEAM:-'24SL34R9HR'}"
          
          # Distribution Certificate Ï†ïÎ≥¥ ÌôïÏù∏
          DIST_CERT_INFO=$(security find-identity -v -p codesigning | grep -i distribution | head -1)
          if [ -n "$DIST_CERT_INFO" ]; then
            echo "‚úÖ Distribution Ïù∏Ï¶ùÏÑú: $DIST_CERT_INFO"
          else
            echo "‚ùå Distribution Ïù∏Ï¶ùÏÑúÎ•º Ï∞æÏùÑ Ïàò ÏóÜÏùå"
            echo "ÏÇ¨Ïö© Í∞ÄÎä•Ìïú Ïù∏Ï¶ùÏÑúÎì§:"
            security find-identity -v -p codesigning
            exit 1
          fi
          
          # Provisioning Profile Ï†ïÎ≥¥ ÌôïÏù∏
          PROFILE_COUNT=$(find "$HOME/Library/MobileDevice/Provisioning Profiles" -name "*.mobileprovision" 2>/dev/null | wc -l)
          echo "ÏÑ§ÏπòÎêú ÌîÑÎ°úÎπÑÏ†ÄÎãù ÌîÑÎ°úÌååÏùº Í∞úÏàò: $PROFILE_COUNTÍ∞ú"
          
          if [ "$PROFILE_COUNT" -gt 0 ]; then
            echo "‚úÖ ÌîÑÎ°úÎπÑÏ†ÄÎãù ÌîÑÎ°úÌååÏùº Î™©Î°ù:"
            find "$HOME/Library/MobileDevice/Provisioning Profiles" -name "*.mobileprovision" 2>/dev/null | while read profile; do
              PROFILE_NAME=$(security cms -D -i "$profile" 2>/dev/null | grep -A1 "<key>Name</key>" | tail -1 | sed 's/.*<string>\(.*\)<\/string>.*/\1/' | tr -d '\n')
              echo "  - $(basename "$profile" .mobileprovision): $PROFILE_NAME"
              
              # ÌîÑÎ°úÎπÑÏ†ÄÎãù ÌîÑÎ°úÌååÏùºÏùò Entitlements ÌôïÏù∏
              if [[ "$PROFILE_NAME" == *"picnic"* ]]; then
                echo "    üîç Picnic ÌîÑÎ°úÌååÏùº Entitlements ÌôïÏù∏ Ï§ë..."
                ENTITLEMENTS=$(security cms -D -i "$profile" 2>/dev/null | grep -A 20 "<key>Entitlements</key>" | grep -E "(aps-environment|com.apple.developer.associated-domains|com.apple.developer.applesignin)")
                if [ -n "$ENTITLEMENTS" ]; then
                  echo "    ‚úÖ ÌïÑÏöîÌïú Entitlements Î∞úÍ≤¨:"
                  echo "$ENTITLEMENTS" | head -5
                else
                  echo "    ‚ö†Ô∏è ÌïÑÏöîÌïú EntitlementsÍ∞Ä ÎàÑÎùΩÎê® (Associated Domains, Push Notifications, Sign in with Apple)"
                fi
              fi
            done
          else
            echo "‚ùå ÌîÑÎ°úÎπÑÏ†ÄÎãù ÌîÑÎ°úÌååÏùºÏùÑ Ï∞æÏùÑ Ïàò ÏóÜÏùå"
            exit 1
          fi

      - name: Configure Xcode Project Signing Strategy
        script: |
          cd picnic_app/ios
          
          echo "=== Xcode ÌîÑÎ°úÏ†ùÌä∏ Manual Distribution Signing ÏÑ§Ï†ï ==="
          
          # Manual Signing Í∞ïÏ†ú ÏÑ§Ï†ï (CodeMagic Integration ÏÇ¨Ïö©)
          echo "üìù Manual Distribution Signing ÌôúÏÑ±Ìôî..."
          sed -i '' "s/CODE_SIGN_STYLE = Automatic;/CODE_SIGN_STYLE = Manual;/g" Runner.xcodeproj/project.pbxproj
          sed -i '' "s/CODE_SIGN_STYLE = \"\";/CODE_SIGN_STYLE = Manual;/g" Runner.xcodeproj/project.pbxproj
          
          # Development Team ÏÑ§Ï†ï (ÌïÑÏàò)
          sed -i '' "s/DEVELOPMENT_TEAM = \"\";/DEVELOPMENT_TEAM = \"24SL34R9HR\";/g" Runner.xcodeproj/project.pbxproj
          sed -i '' "s/DEVELOPMENT_TEAM = 24SL34R9HR;/DEVELOPMENT_TEAM = \"24SL34R9HR\";/g" Runner.xcodeproj/project.pbxproj
          
          # Distribution Ïù∏Ï¶ùÏÑú Î∞è ÌîÑÎ°úÌååÏùº Í∞ïÏ†ú ÏÑ§Ï†ï
          echo "üìù Distribution Ïù∏Ï¶ùÏÑú Î∞è ÌîÑÎ°úÌååÏùº Í∞ïÏ†ú ÏÑ§Ï†ï..."
          sed -i '' "s/CODE_SIGN_IDENTITY = \"\"/CODE_SIGN_IDENTITY = \"Apple Distribution\"/g" Runner.xcodeproj/project.pbxproj
          sed -i '' "s/CODE_SIGN_IDENTITY = \"Apple Development\"/CODE_SIGN_IDENTITY = \"Apple Distribution\"/g" Runner.xcodeproj/project.pbxproj
          sed -i '' "s/\"CODE_SIGN_IDENTITY\[sdk=iphoneos\*\]\" = \"iPhone Developer\"/\"CODE_SIGN_IDENTITY[sdk=iphoneos*]\" = \"Apple Distribution\"/g" Runner.xcodeproj/project.pbxproj
          
          # ÌîÑÎ°úÎπÑÏ†ÄÎãù ÌîÑÎ°úÌååÏùº ÏÑ§Ï†ï (ÏÑ±Í≥µÌñàÎçò ÏÑ§Ï†ï)
          sed -i '' "s/PROVISIONING_PROFILE_SPECIFIER = \"\"/PROVISIONING_PROFILE_SPECIFIER = \"picnic_app_profile_2025\"/g" Runner.xcodeproj/project.pbxproj
          
          # PROVISIONING_PROFILE_SPECIFIER Ï∂îÍ∞Ä (Ï°¥Ïû¨ÌïòÏßÄ ÏïäÎäî Í≤ΩÏö∞)
          if ! grep -q "PROVISIONING_PROFILE_SPECIFIER" Runner.xcodeproj/project.pbxproj; then
            sed -i '' '/DEVELOPMENT_TEAM = /a\
				PROVISIONING_PROFILE_SPECIFIER = "picnic_app_profile_2025";' Runner.xcodeproj/project.pbxproj
          fi
          
          # Archive ÎπåÎìúÍ∞Ä Release Íµ¨ÏÑ±ÏùÑ ÏÇ¨Ïö©ÌïòÎèÑÎ°ù Í∞ïÏ†ú
          if [ -f "Runner.xcodeproj/xcshareddata/xcschemes/Runner.xcscheme" ]; then
            echo "üìù Archive Ïä§ÌÇ¥ Release Íµ¨ÏÑ± Í∞ïÏ†ú..."
            sed -i '' 's/buildConfiguration = \"Debug\"/buildConfiguration = \"Release\"/g' Runner.xcodeproj/xcshareddata/xcschemes/Runner.xcscheme
          fi
          
          # Development Í¥ÄÎ†® ÏÑ§Ï†ï ÏôÑÏ†Ñ Ï†úÍ±∞
          sed -i '' "/CODE_SIGN_IDENTITY.*=.*iPhone Developer/d" Runner.xcodeproj/project.pbxproj
          sed -i '' "/CODE_SIGN_IDENTITY.*=.*Apple Development/d" Runner.xcodeproj/project.pbxproj
          sed -i '' "/PROVISIONING_PROFILE_SPECIFIER.*=.*Development/d" Runner.xcodeproj/project.pbxproj
          
          echo "‚úÖ Manual Distribution Signing ÏÑ§Ï†ï ÏôÑÎ£å"
          echo "- CODE_SIGN_STYLE: Manual"
          echo "- DEVELOPMENT_TEAM: 24SL34R9HR"
          echo "- CODE_SIGN_IDENTITY: Apple Distribution"
          echo "- PROVISIONING_PROFILE_SPECIFIER: match AppStore io.iconcasting.picnic.app"

      - name: Shorebird iOS Release (Unified Build & Deploy)
        script: |
          export PATH="$HOME/.shorebird/bin:$PATH"
          cd picnic_app

          echo "=== Shorebird ÌÜµÌï© iOS ÎπåÎìú & Î¶¥Î¶¨Ï¶à ÏãúÏûë ==="
          echo "üéØ Î¶¥Î¶¨Ï¶àÏôÄ Ìå®ÏπòÏùò ÏùºÍ¥ÄÎêú ÎπåÎìú ÌôòÍ≤ΩÏùÑ ÏúÑÌï¥ ShorebirdÎ°ú ÏßÅÏ†ë ÎπåÎìúÌï©ÎãàÎã§"
          echo ""

          echo "=== Shorebird Î≤ÑÏ†Ñ ÌôïÏù∏ ==="
          shorebird --version

          echo "=== Shorebird Ïù∏Ï¶ù ÌôïÏù∏ ==="
          if [ -z "$SHOREBIRD_TOKEN" ]; then
            echo "‚ùå SHOREBIRD_TOKEN ÌôòÍ≤ΩÎ≥ÄÏàòÍ∞Ä ÏÑ§Ï†ïÎêòÏßÄ ÏïäÏïòÏäµÎãàÎã§"
            exit 1
          else
            echo "‚úÖ SHOREBIRD_TOKEN ÌôòÍ≤ΩÎ≥ÄÏàòÍ∞Ä ÏÑ§Ï†ïÎêòÏóàÏäµÎãàÎã§"
          fi

          echo "=== iOS ÏÑúÎ™Ö ÌôòÍ≤Ω ÏµúÏ¢Ö ÌôïÏù∏ ==="
          echo "‚úÖ Manual Distribution Signing ÏÑ§Ï†ï ÏôÑÎ£å"
          echo "‚úÖ Bundle ID: io.iconcasting.picnic.app"
          echo "‚úÖ Distribution Type: App Store"
          echo "‚úÖ Development Team: 24SL34R9HR"
          echo "‚úÖ CODE_SIGN_IDENTITY: Apple Distribution"
          echo "‚úÖ PROVISIONING_PROFILE_SPECIFIER: picnic_app_profile_2025"

          echo "=== Shorebird Ï∫êÏãú Ï†ïÎ¶¨ Î∞è ÌôòÍ≤Ω Ï§ÄÎπÑ ==="
          shorebird cache clean
          flutter clean
          flutter pub get

          echo "=== Shorebird iOS ÌÜµÌï© Î¶¥Î¶¨Ï¶à Ïã§Ìñâ ==="
          echo "üöÄ ShorebirdÎ°ú iOS ÎπåÎìú Î∞è Î¶¥Î¶¨Ï¶à (ÏµúÏã† Flutter ÏóîÏßÑ ÏÇ¨Ïö©)..."
          RELEASE_RESULT=$(shorebird release ios \
            --dart-define=ENVIRONMENT=prod \
            --flutter-version=latest 2>&1)
          RELEASE_EXIT_CODE=$?
          
          echo "Î¶¥Î¶¨Ï¶à Í≤∞Í≥º:"
          echo "$RELEASE_RESULT"
          
          # Î¶¥Î¶¨Ï¶à Í≤∞Í≥º ÌôïÏù∏
          if [ $RELEASE_EXIT_CODE -eq 0 ]; then
            if echo "$RELEASE_RESULT" | grep -i "successfully\|completed\|deployed\|published\|release.*created"; then
              echo "=== Shorebird iOS ÌÜµÌï© Î¶¥Î¶¨Ï¶à ÏÑ±Í≥µ ==="
              echo "‚úÖ iOS Ïï±Ïù¥ Shorebird Flutter ÏóîÏßÑÏúºÎ°ú ÎπåÎìúÎêòÏñ¥ ÏÑ±Í≥µÏ†ÅÏúºÎ°ú Î∞∞Ìè¨ÎêòÏóàÏäµÎãàÎã§"
              echo "üéØ Ïù¥Ï†ú Ìå®Ïπò ÏõåÌÅ¨ÌîåÎ°úÏö∞ÏôÄ ÎèôÏùºÌïú ÎπåÎìú ÌôòÍ≤ΩÏùÑ ÏÇ¨Ïö©Ìï©ÎãàÎã§"
              
              # Î¶¥Î¶¨Ï¶à Ï†ïÎ≥¥ Ï∂îÏ∂ú Î∞è ÌëúÏãú
              if echo "$RELEASE_RESULT" | grep -i "release.*version\|build.*version"; then
                echo ""
                echo "üì± Î¶¥Î¶¨Ï¶à Ï†ïÎ≥¥:"
                echo "$RELEASE_RESULT" | grep -i "release.*version\|build.*version" | head -3
              fi
            else
              echo "=== Shorebird iOS Î¶¥Î¶¨Ï¶à Ïû¨ÏãúÎèÑ ÌïÑÏöî ==="
              echo "‚ö†Ô∏è Î¶¥Î¶¨Ï¶à Í≤∞Í≥ºÍ∞Ä Î∂àÎ∂ÑÎ™ÖÌï©ÎãàÎã§. Ïû¨ÏãúÎèÑÌï©ÎãàÎã§..."
            sleep 5
            
              echo "üîÑ iOS Î¶¥Î¶¨Ï¶à Ïû¨ÏãúÎèÑ (ÏµúÏã† Flutter)..."
              RETRY_RESULT=$(shorebird release ios --dart-define=ENVIRONMENT=prod --flutter-version=latest 2>&1)
            RETRY_EXIT_CODE=$?
              
            if [ $RETRY_EXIT_CODE -eq 0 ]; then
              echo "‚úÖ Ïû¨ÏãúÎèÑ ÏÑ±Í≥µ!"
                echo "$RETRY_RESULT"
            else
              echo "‚ùå Ïû¨ÏãúÎèÑÎèÑ Ïã§Ìå®ÌñàÏäµÎãàÎã§."
                echo "$RETRY_RESULT"
              exit 1
              fi
            fi
          else
            echo "=== Shorebird iOS Î¶¥Î¶¨Ï¶à Ïã§Ìå® ==="
            echo "‚ùå iOS Î¶¥Î¶¨Ï¶àÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§ (Ï¢ÖÎ£å ÏΩîÎìú: $RELEASE_EXIT_CODE)"
            
            # Ïã§Ìå® ÏõêÏù∏ Î∂ÑÏÑù
            if echo "$RELEASE_RESULT" | grep -i "no.*account\|profile"; then
              echo "üîç ÏÑúÎ™Ö Í¥ÄÎ†® Î¨∏Ï†úÎ°ú Î≥¥ÏûÖÎãàÎã§"
            elif echo "$RELEASE_RESULT" | grep -i "flutter.*build.*fail"; then
              echo "üîç Flutter ÎπåÎìú Î¨∏Ï†úÎ°ú Î≥¥ÏûÖÎãàÎã§"
            elif echo "$RELEASE_RESULT" | grep -i "no.*release\|app.*not.*found"; then
              echo "üîç Ïï± Îì±Î°ù Î¨∏Ï†úÎ°ú Î≥¥ÏûÖÎãàÎã§"
            fi
            
            exit 1
          fi

          echo "=== ÏµúÏ¢Ö Í≤∞Í≥º ==="
          echo "‚úÖ Shorebird ÌÜµÌï© iOS ÎπåÎìú & Î¶¥Î¶¨Ï¶à ÏôÑÎ£å!"
          echo "üéØ Ìå®Ïπò ÏõåÌÅ¨ÌîåÎ°úÏö∞ÏôÄ ÎèôÏùºÌïú Shorebird Flutter ÏóîÏßÑ ÏÇ¨Ïö©"
          echo "üîÑ ÎπÑÍ≤∞Ï†ïÎ°†Ï†Å ÎπåÎìú Î¨∏Ï†ú Ìï¥Í≤∞ ÏòàÏÉÅ"

    artifacts:
      - picnic_app/build/ios/**/*.ipa
      - picnic_app/build/ios/**/*.xcarchive
      - picnic_app/flutter_drive.log

    publishing:
      app_store_connect:
        auth: integration
        submit_to_testflight: true
        beta_groups:
          - App Store Connect Users
      slack:
        channel: '#codemagic-picnic'
        notify_on_build_start: true
        notify:
          success: true
          failure: true
      email:
        recipients:
          - ironlove77@gmail.com
        notify:
          success: true
          failure: true

  # =================== PICNIC APP Android ===================
  picnic-app-android:
    name: Picnic App - Android
    instance_type: mac_mini_m2
    max_build_duration: 120
    environment:
      android_signing:
        - picnic_keystore
      groups:
        - google_play
        - shorebird-config
        - picnic_env
      flutter: 3.32.4
      java: 17
      vars:
        PATH: $PATH:$HOME/.shorebird/bin
        APP_NAME: "picnic_app"
        # CodeMagicÏù¥ android_signingÏùÑ Ïù∏ÏãùÌïòÎèÑÎ°ù Í∞ïÏ†ú ÏÑ§Ï†ï
        FLUTTER_BUILD_MODE: "release"
    cache:
      cache_paths:
        - $FLUTTER_ROOT/.pub-cache
        - $HOME/.gradle/caches
        - $HOME/.gradle/wrapper
        - $HOME/.android/build-cache
        - $HOME/Library/Caches/CocoaPods
        - picnic_app/.dart_tool
        - picnic_app/android/.gradle
    triggering:
      events:
        - push
        - tag
      # production Î∏åÎûúÏπò Ìë∏Ïãú Î∞è ÌÉúÍ∑∏Î°ú Ìä∏Î¶¨Í±∞
      branch_patterns:
        - pattern: 'production'
          include: true
      tag_patterns:
        - pattern: 'picnic-v*'
          include: true
      cancel_previous_builds: true
    scripts:
      - name: Install Shorebird CLI
        script: |
          echo "=== Shorebird CLI ÏÑ§Ïπò ÏãúÏûë ==="
          
          # Í∏∞Ï°¥ Shorebird ÏÑ§Ïπò Í∞ïÏ†ú Ï†úÍ±∞ (Ï∂©Îèå Î∞©ÏßÄ)
          echo "üßπ Í∏∞Ï°¥ Shorebird ÏÑ§Ïπò Ï†ïÎ¶¨ Ï§ë..."
          if [ -d "$HOME/.shorebird" ]; then
            rm -rf "$HOME/.shorebird"
            echo "‚úÖ Í∏∞Ï°¥ Shorebird ÎîîÎ†âÌÜ†Î¶¨ Ï†úÍ±∞ ÏôÑÎ£å"
          fi
          
          # ÏµúÏã† ÏïàÏ†ï Î≤ÑÏ†Ñ ÏÇ¨Ïö© (v1.6.48)
          echo "üîß Shorebird v1.6.48 ÏµúÏã† ÏïàÏ†ï Î≤ÑÏ†Ñ ÏÑ§Ïπò Ï§ë..."
          
          # Í≥µÏãù GitHub ÏÑ§Ïπò Ïä§ÌÅ¨Î¶ΩÌä∏ ÏÇ¨Ïö© (Í∞ÄÏû• ÏïàÏ†ïÏ†Å)
          echo "üì• Í≥µÏãù ÏÑ§Ïπò Ïä§ÌÅ¨Î¶ΩÌä∏Î°ú ÏµúÏã† Shorebird ÏÑ§Ïπò..."
          curl --proto '=https' --tlsv1.2 https://raw.githubusercontent.com/shorebirdtech/install/main/install.sh -sSf | bash
          
          export PATH="$HOME/.shorebird/bin:$PATH"
          
          echo "=== Shorebird ÏÑ§Ïπò ÌôïÏù∏ ==="
          if command -v shorebird >/dev/null 2>&1; then
            shorebird --version
            echo "‚úÖ Shorebird ÏÑ§Ïπò Î∞è ÏÑ§Ï†ï ÏôÑÎ£å"
          else
            echo "‚ùå Shorebird ÏÑ§Ïπò Ïã§Ìå®"
            exit 1
          fi

      - name: Get Flutter packages
        script: |
          cd picnic_app
          flutter packages pub get

      - name: Verify Keystore Configuration
        script: |
          echo "=== ÌÇ§Ïä§ÌÜ†Ïñ¥ ÌôòÍ≤Ω Î≥ÄÏàò ÌôïÏù∏ ==="
          echo "CM_KEYSTORE_PATH: ${CM_KEYSTORE_PATH:-'ÎØ∏ÏÑ§Ï†ï'}"
          echo "CM_KEYSTORE_PASSWORD: ${CM_KEYSTORE_PASSWORD:-'ÎØ∏ÏÑ§Ï†ï'}"
          echo "CM_KEY_ALIAS: ${CM_KEY_ALIAS:-'ÎØ∏ÏÑ§Ï†ï'}"
          echo "CM_KEY_PASSWORD: ${CM_KEY_PASSWORD:-'ÎØ∏ÏÑ§Ï†ï'}"
          
          if [ -z "$CM_KEYSTORE_PATH" ] || [ -z "$CM_KEYSTORE_PASSWORD" ] || [ -z "$CM_KEY_ALIAS" ] || [ -z "$CM_KEY_PASSWORD" ]; then
            echo "‚ùå ÌÇ§Ïä§ÌÜ†Ïñ¥ ÌôòÍ≤Ω Î≥ÄÏàòÍ∞Ä Ïò¨Î∞îÎ•¥Í≤å ÏÑ§Ï†ïÎêòÏßÄ ÏïäÏïòÏäµÎãàÎã§"
            echo "CodeMagic ÎåÄÏãúÎ≥¥ÎìúÏóêÏÑú 'picnic_keystore' Í∑∏Î£π ÏÑ§Ï†ïÏùÑ ÌôïÏù∏Ìï¥Ï£ºÏÑ∏Ïöî"
            exit 1
          fi
          
          if [ -f "$CM_KEYSTORE_PATH" ]; then
            echo "‚úÖ ÌÇ§Ïä§ÌÜ†Ïñ¥ ÌååÏùº Ï°¥Ïû¨: $CM_KEYSTORE_PATH"
            # ÌÇ§Ïä§ÌÜ†Ïñ¥ Ï†ïÎ≥¥ ÌôïÏù∏
            keytool -list -v -keystore "$CM_KEYSTORE_PATH" -alias "$CM_KEY_ALIAS" -storepass "$CM_KEYSTORE_PASSWORD" | grep -E "(SHA1|SHA256|Subject|Issuer)" || echo "ÌÇ§Ïä§ÌÜ†Ïñ¥ Ï†ïÎ≥¥ ÌôïÏù∏ Ïã§Ìå®"
          else
            echo "‚ùå ÌÇ§Ïä§ÌÜ†Ïñ¥ ÌååÏùºÏùÑ Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§: $CM_KEYSTORE_PATH"
            exit 1
          fi

      - name: Shorebird Android Release (Unified Build & Deploy)
        script: |
          cd picnic_app
          
          echo "=== Shorebird ÌÜµÌï© Android ÎπåÎìú & Î¶¥Î¶¨Ï¶à ÏãúÏûë ==="
          echo "üéØ Î¶¥Î¶¨Ï¶àÏôÄ Ìå®ÏπòÏùò ÏùºÍ¥ÄÎêú ÎπåÎìú ÌôòÍ≤ΩÏùÑ ÏúÑÌï¥ ShorebirdÎ°ú ÏßÅÏ†ë ÎπåÎìúÌï©ÎãàÎã§"
          echo ""
          
          # Shorebird PATH ÏÑ§Ï†ï
          export PATH="$HOME/.shorebird/bin:$PATH"

          echo "=== Shorebird Î≤ÑÏ†Ñ ÌôïÏù∏ ==="
          shorebird --version

          echo "=== Shorebird Ïù∏Ï¶ù ÌôïÏù∏ ==="
          if [ -z "$SHOREBIRD_TOKEN" ]; then
            echo "‚ùå SHOREBIRD_TOKEN ÌôòÍ≤ΩÎ≥ÄÏàòÍ∞Ä ÏÑ§Ï†ïÎêòÏßÄ ÏïäÏïòÏäµÎãàÎã§"
            exit 1
          else
            echo "‚úÖ SHOREBIRD_TOKEN ÌôòÍ≤ΩÎ≥ÄÏàòÍ∞Ä ÏÑ§Ï†ïÎêòÏóàÏäµÎãàÎã§"
          fi

          echo "=== Android ÏÑúÎ™Ö ÌôòÍ≤Ω ÏµúÏ¢Ö ÌôïÏù∏ ==="
          echo "‚úÖ Android Signing ÏÑ§Ï†ï ÏôÑÎ£å"
          echo "‚úÖ ÌÇ§Ïä§ÌÜ†Ïñ¥ Í≤ΩÎ°ú: $CM_KEYSTORE_PATH"
          echo "‚úÖ ÌÇ§ Î≥ÑÏπ≠: $CM_KEY_ALIAS"
          echo "‚úÖ ÏÑúÎ™Ö Í≤ÄÏ¶ù ÏôÑÎ£å"

          echo "=== Gradle Î©îÎ™®Î¶¨ ÏµúÏ†ÅÌôî ÏÑ§Ï†ï (Shorebird Ìò∏Ìôò) ==="
          mkdir -p $HOME/.gradle
          # ShorebirdÏôÄ Ìò∏ÌôòÎêòÎäî ÏµúÏ†ÅÌôîÎêú Gradle ÏÑ§Ï†ï
          echo "org.gradle.jvmargs=-Xmx6144m -XX:MaxMetaspaceSize=512m -XX:+HeapDumpOnOutOfMemoryError -Dfile.encoding=UTF-8" >> $HOME/.gradle/gradle.properties
          echo "org.gradle.daemon=true" >> $HOME/.gradle/gradle.properties
          echo "org.gradle.caching=true" >> $HOME/.gradle/gradle.properties
          echo "org.gradle.parallel=false" >> $HOME/.gradle/gradle.properties
          echo "android.enableJetifier=true" >> $HOME/.gradle/gradle.properties
          echo "android.useAndroidX=true" >> $HOME/.gradle/gradle.properties
          echo "android.enableR8.fullMode=false" >> $HOME/.gradle/gradle.properties

          echo "=== Shorebird Ï∫êÏãú Ï†ïÎ¶¨ Î∞è ÌôòÍ≤Ω Ï§ÄÎπÑ ==="
          shorebird cache clean
          flutter clean
          flutter pub get

          echo "=== ÏÇ¨Ï†Ñ Flutter ÎπåÎìú (ÎÑ§Ïù¥Ìã∞Î∏å ÎùºÏù¥Î∏åÎü¨Î¶¨ ÏÉùÏÑ±) ==="
          # Shorebird Ïã§Ìñâ Ï†ÑÏóê Flutter ÎπåÎìúÎ°ú ÎÑ§Ïù¥Ìã∞Î∏å ÎùºÏù¥Î∏åÎü¨Î¶¨ ÏÉùÏÑ±
          echo "üîß Flutter AAB ÎπåÎìúÎ•º ÌÜµÌïú ÎÑ§Ïù¥Ìã∞Î∏å ÎùºÏù¥Î∏åÎü¨Î¶¨ ÏÉùÏÑ±..."
          flutter build appbundle --release --dart-define=ENVIRONMENT=prod || {
            echo "‚ö†Ô∏è Flutter ÎπåÎìú Ïã§Ìå® - Í≥ÑÏÜç ÏßÑÌñâ"
          }
          
          echo "=== ÎÑ§Ïù¥Ìã∞Î∏å ÎùºÏù¥Î∏åÎü¨Î¶¨ ÏÇ¨Ï†Ñ Î≥µÏÇ¨ (Shorebird Ìò∏Ìôò) ==="
          # Ïã§Ï†ú ÎÑ§Ïù¥Ìã∞Î∏å ÎùºÏù¥Î∏åÎü¨Î¶¨ ÏúÑÏπòÎì§ (Ïó¨Îü¨ Í∞ÄÎä•Ìïú Í≤ΩÎ°ú)
          POSSIBLE_NATIVE_PATHS=(
            "android/app/build/intermediates/stripped_native_libs/release/stripReleaseDebugSymbols/out/lib"
            "android/app/build/intermediates/stripped_native_libs/release/out/lib"
            "android/app/build/intermediates/merged_native_libs/release/out/lib"
          )
          
          # ShorebirdÍ∞Ä Ï∞æÎäî ÏúÑÏπòÎì§
          EXPECTED_PATHS=(
            "build/app/intermediates/stripped_native_libs/release/out/lib"
            "build/app/intermediates/stripped_native_libs/stripReleaseDebugSymbols/release/out/lib"
          )
          
          NATIVE_FOUND=false
          for REAL_NATIVE_PATH in "${POSSIBLE_NATIVE_PATHS[@]}"; do
            if [ -d "$REAL_NATIVE_PATH" ]; then
              echo "‚úÖ ÎÑ§Ïù¥Ìã∞Î∏å ÎùºÏù¥Î∏åÎü¨Î¶¨ Î∞úÍ≤¨: $REAL_NATIVE_PATH"
              ls -la "$REAL_NATIVE_PATH" 2>/dev/null || echo "ÎîîÎ†âÌÜ†Î¶¨ ÎÇ¥Ïö© ÌôïÏù∏ Î∂àÍ∞Ä"
              NATIVE_FOUND=true
              
              for EXPECTED_PATH in "${EXPECTED_PATHS[@]}"; do
                echo "üìÅ ÏÇ¨Ï†Ñ Î≥µÏÇ¨: $REAL_NATIVE_PATH -> $EXPECTED_PATH"
                mkdir -p "$(dirname "$EXPECTED_PATH")"
                cp -r "$REAL_NATIVE_PATH" "$(dirname "$EXPECTED_PATH")/"
                
                if [ -d "$EXPECTED_PATH" ]; then
                  echo "‚úÖ ÏÇ¨Ï†Ñ Î≥µÏÇ¨ ÏÑ±Í≥µ: $EXPECTED_PATH"
                  find "$EXPECTED_PATH" -name "*.so" | head -3
                else
                  echo "‚ùå ÏÇ¨Ï†Ñ Î≥µÏÇ¨ Ïã§Ìå®: $EXPECTED_PATH"
                fi
              done
              break
            fi
          done
          
          if [ "$NATIVE_FOUND" = false ]; then
            echo "‚ö†Ô∏è ÎÑ§Ïù¥Ìã∞Î∏å ÎùºÏù¥Î∏åÎü¨Î¶¨Î•º Ï∞æÏùÑ Ïàò ÏóÜÏùå"
            echo "üìã Í∞ÄÎä•Ìïú ÏúÑÏπòÎì§ ÌôïÏù∏:"
            find android/app/build/intermediates/ -name "*.so" -type f 2>/dev/null | head -5 || echo "ÎÑ§Ïù¥Ìã∞Î∏å ÎùºÏù¥Î∏åÎü¨Î¶¨ ÌååÏùº ÏóÜÏùå"
          fi
          
          echo "=== Shorebird Android ÌÜµÌï© Î¶¥Î¶¨Ï¶à Ïã§Ìñâ ==="
          echo "üöÄ ShorebirdÎ°ú Android ÎπåÎìú Î∞è Î¶¥Î¶¨Ï¶à (ÏµúÏã† Flutter ÏóîÏßÑ ÏÇ¨Ïö©)..."
          echo "üìã ÎπåÎìú Ï†Ñ ÎîîÎ†âÌÜ†Î¶¨ ÏÉÅÌÉú ÌôïÏù∏..."
          ls -la build/ || echo "build ÎîîÎ†âÌÜ†Î¶¨ ÏóÜÏùå"
          
          RELEASE_RESULT=$(shorebird release android --dart-define=ENVIRONMENT=prod --flutter-version=latest 2>&1)
          RELEASE_EXIT_CODE=$?
          
          echo "üìã ÎπåÎìú ÌõÑ ÎîîÎ†âÌÜ†Î¶¨ ÏÉÅÌÉú ÌôïÏù∏..."
          find build/ -name "*.aab" -type f 2>/dev/null || echo "AAB ÌååÏùº ÏóÜÏùå"
          echo "üìã Gradle ÌÉúÏä§ÌÅ¨Î°ú AAB ÌååÏùº ÏúÑÏπò ÏàòÏ†ï ÌôïÏù∏..."
          ls -la build/app/outputs/bundle/release/ 2>/dev/null || echo "ÏòàÏÉÅ ÏúÑÏπòÏóê AAB ÏóÜÏùå"
          
          echo "Î¶¥Î¶¨Ï¶à Í≤∞Í≥º:"
          echo "$RELEASE_RESULT"
          
          # Î¶¥Î¶¨Ï¶à Í≤∞Í≥º ÌôïÏù∏
          if [ $RELEASE_EXIT_CODE -eq 0 ]; then
            if echo "$RELEASE_RESULT" | grep -i "successfully\|completed\|deployed\|published\|release.*created"; then
              echo "=== Shorebird Android ÌÜµÌï© Î¶¥Î¶¨Ï¶à ÏÑ±Í≥µ ==="
              echo "‚úÖ Android Ïï±Ïù¥ Shorebird Flutter ÏóîÏßÑÏúºÎ°ú ÎπåÎìúÎêòÏñ¥ ÏÑ±Í≥µÏ†ÅÏúºÎ°ú Î∞∞Ìè¨ÎêòÏóàÏäµÎãàÎã§"
              echo "üéØ Ïù¥Ï†ú Ìå®Ïπò ÏõåÌÅ¨ÌîåÎ°úÏö∞ÏôÄ ÎèôÏùºÌïú ÎπåÎìú ÌôòÍ≤ΩÏùÑ ÏÇ¨Ïö©Ìï©ÎãàÎã§"
              
              # Î¶¥Î¶¨Ï¶à Ï†ïÎ≥¥ Ï∂îÏ∂ú Î∞è ÌëúÏãú
              if echo "$RELEASE_RESULT" | grep -i "release.*version\|build.*version"; then
                echo ""
                echo "üì± Î¶¥Î¶¨Ï¶à Ï†ïÎ≥¥:"
                echo "$RELEASE_RESULT" | grep -i "release.*version\|build.*version" | head -3
              fi
            else
              echo "=== Shorebird Android Î¶¥Î¶¨Ï¶à Ïû¨ÏãúÎèÑ ÌïÑÏöî ==="
              echo "‚ö†Ô∏è Î¶¥Î¶¨Ï¶à Í≤∞Í≥ºÍ∞Ä Î∂àÎ∂ÑÎ™ÖÌï©ÎãàÎã§. Ïû¨ÏãúÎèÑÌï©ÎãàÎã§..."
            sleep 5
            
              echo "üîÑ Android Î¶¥Î¶¨Ï¶à Ïû¨ÏãúÎèÑ (ÏµúÏã† Flutter)..."
              RETRY_RESULT=$(shorebird release android --dart-define=ENVIRONMENT=prod --flutter-version=latest 2>&1)
            RETRY_EXIT_CODE=$?
              
            if [ $RETRY_EXIT_CODE -eq 0 ]; then
              echo "‚úÖ Ïû¨ÏãúÎèÑ ÏÑ±Í≥µ!"
                echo "$RETRY_RESULT"
            else
              echo "‚ùå Ïû¨ÏãúÎèÑÎèÑ Ïã§Ìå®ÌñàÏäµÎãàÎã§."
                echo "$RETRY_RESULT"
              exit 1
            fi
            fi
          else
            echo "=== Shorebird Android Î¶¥Î¶¨Ï¶à Ïã§Ìå® ==="
            echo "‚ùå Android Î¶¥Î¶¨Ï¶àÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§ (Ï¢ÖÎ£å ÏΩîÎìú: $RELEASE_EXIT_CODE)"
            
            # Ïã§Ìå® ÏõêÏù∏ Î∂ÑÏÑù
            if echo "$RELEASE_RESULT" | grep -i "keystore\|signing"; then
              echo "üîç ÏÑúÎ™Ö Í¥ÄÎ†® Î¨∏Ï†úÎ°ú Î≥¥ÏûÖÎãàÎã§"
            elif echo "$RELEASE_RESULT" | grep -i "flutter.*build.*fail"; then
              echo "üîç Flutter ÎπåÎìú Î¨∏Ï†úÎ°ú Î≥¥ÏûÖÎãàÎã§"
            elif echo "$RELEASE_RESULT" | grep -i "no.*release\|app.*not.*found"; then
              echo "üîç Ïï± Îì±Î°ù Î¨∏Ï†úÎ°ú Î≥¥ÏûÖÎãàÎã§"
            fi
            
            exit 1
          fi

          echo "=== ÏµúÏ¢Ö Í≤∞Í≥º ==="
          echo "‚úÖ Shorebird ÌÜµÌï© Android ÎπåÎìú & Î¶¥Î¶¨Ï¶à ÏôÑÎ£å!"
          echo "üéØ Ìå®Ïπò ÏõåÌÅ¨ÌîåÎ°úÏö∞ÏôÄ ÎèôÏùºÌïú Shorebird Flutter ÏóîÏßÑ ÏÇ¨Ïö©"
          echo "üîÑ ÎπÑÍ≤∞Ï†ïÎ°†Ï†Å ÎπåÎìú Î¨∏Ï†ú Ìï¥Í≤∞ ÏòàÏÉÅ"
          echo "üì¶ AAB/APK ÌååÏùºÏù¥ ÏûêÎèôÏúºÎ°ú ShorebirdÏóê ÏùòÌï¥ ÏÉùÏÑ± Î∞è Î∞∞Ìè¨Îê®"

    artifacts:
      - picnic_app/build/**/outputs/**/*.aab
      - picnic_app/build/**/outputs/**/*.apk
      - picnic_app/build/**/outputs/**/mapping.txt
      - picnic_app/flutter_drive.log

    publishing:
      google_play:
        credentials: $GCLOUD_SERVICE_ACCOUNT_CREDENTIALS
        track: internal
        submit_as_draft: true
      slack:
        channel: '#codemagic-picnic'
        notify_on_build_start: true
        notify:
          success: true
          failure: true
      email:
        recipients:
          - ironlove77@gmail.com
        notify:
          success: true
          failure: true

  # =================== PICNIC APP iOS Patch (Shorebird) ===================
  picnic-app-patch-ios:
    name: Picnic App - iOS Patch (Shorebird)
    instance_type: mac_mini_m2
    max_build_duration: 60
    integrations:
      app_store_connect: codemagic-picnic
    environment:
      ios_signing:
        distribution_type: app_store
        bundle_identifier: io.iconcasting.picnic.app
      groups:
        - app_store_connect
        - shorebird-config
        - picnic_env
      flutter: 3.32.4
      vars:
        APP_NAME: "picnic_app"
        BUNDLE_ID: "io.iconcasting.picnic.app"
    cache:
      cache_paths:
        - $FLUTTER_ROOT/.pub-cache
        - $HOME/.gradle/caches
        - $HOME/Library/Caches/CocoaPods
    triggering:
      events:
        - push
        - tag
      # hotfix, patch Î∏åÎûúÏπòÏôÄ patch ÌÉúÍ∑∏Î°ú Ìä∏Î¶¨Í±∞
      branch_patterns:
        - pattern: 'hotfix/*'
          include: true
        - pattern: 'patch/*'
          include: true
      tag_patterns:
        - pattern: 'picnic-patch-*'
          include: true
      cancel_previous_builds: true
    scripts:
      - name: Install Shorebird CLI
        script: |
          echo "=== Shorebird CLI ÏÑ§Ïπò ÏãúÏûë ==="
          
          # Í∏∞Ï°¥ Shorebird ÏÑ§Ïπò Í∞ïÏ†ú Ï†úÍ±∞ (Ï∂©Îèå Î∞©ÏßÄ)
          echo "üßπ Í∏∞Ï°¥ Shorebird ÏÑ§Ïπò Ï†ïÎ¶¨ Ï§ë..."
          if [ -d "$HOME/.shorebird" ]; then
            rm -rf "$HOME/.shorebird"
            echo "‚úÖ Í∏∞Ï°¥ Shorebird ÎîîÎ†âÌÜ†Î¶¨ Ï†úÍ±∞ ÏôÑÎ£å"
          fi
          
          # ÏµúÏã† ÏïàÏ†ï Î≤ÑÏ†Ñ ÏÇ¨Ïö© (v1.6.48)
          echo "üîß Shorebird v1.6.48 ÏµúÏã† ÏïàÏ†ï Î≤ÑÏ†Ñ ÏÑ§Ïπò Ï§ë..."
          
          # Í≥µÏãù GitHub ÏÑ§Ïπò Ïä§ÌÅ¨Î¶ΩÌä∏ ÏÇ¨Ïö© (Í∞ÄÏû• ÏïàÏ†ïÏ†Å)
          echo "üì• Í≥µÏãù ÏÑ§Ïπò Ïä§ÌÅ¨Î¶ΩÌä∏Î°ú ÏµúÏã† Shorebird ÏÑ§Ïπò..."
          curl --proto '=https' --tlsv1.2 https://raw.githubusercontent.com/shorebirdtech/install/main/install.sh -sSf | bash
          
          export PATH="$HOME/.shorebird/bin:$PATH"
          
          echo "=== Shorebird ÏÑ§Ïπò ÌôïÏù∏ ==="
          if command -v shorebird >/dev/null 2>&1; then
            shorebird --version
            echo "‚úÖ Shorebird ÏÑ§Ïπò Î∞è ÏÑ§Ï†ï ÏôÑÎ£å"
          else
            echo "‚ùå Shorebird ÏÑ§Ïπò Ïã§Ìå®"
            exit 1
          fi
          
          # PATH ÏÑ§Ï†ïÏùÑ ÌôòÍ≤Ω ÌååÏùºÎ°ú Ï†ÄÏû• (Îã§Ïùå Îã®Í≥ÑÏóêÏÑú ÏÇ¨Ïö©)
          echo "export PATH=\"$HOME/.shorebird/bin:\$PATH\"" > /tmp/shorebird_env.sh
          echo "‚úÖ Shorebird CLI ÏÑ§Ïπò Î∞è ÌôòÍ≤Ω ÏÑ§Ï†ï ÏôÑÎ£å"

      - name: Get Flutter packages and prepare iOS
        script: |
          cd picnic_app
          echo "=== Flutter Ìå®ÌÇ§ÏßÄ ÏÑ§Ïπò ==="
          flutter packages pub get
          
          echo "=== Flutter iOS ÏÑ§Ï†ï ÏÉùÏÑ± ==="
          flutter precache --ios
          flutter build ios --config-only

      - name: Install CocoaPods dependencies
        script: |
          cd picnic_app
          
          echo "=== Generated.xcconfig ÌååÏùº ÌôïÏù∏ ==="
          if [ ! -f "ios/Flutter/Generated.xcconfig" ]; then
            echo "‚ö†Ô∏è Generated.xcconfig ÌååÏùºÏù¥ ÏóÜÏùå - Flutter ÏÑ§Ï†ï Ïû¨ÏÉùÏÑ±"
            flutter build ios --config-only
          fi
          
          echo "‚úÖ Generated.xcconfig ÌååÏùº Ï°¥Ïû¨ ÌôïÏù∏:"
          ls -la ios/Flutter/Generated.xcconfig
          
          echo "=== CocoaPods ÏÑ§Ïπò ÏãúÏûë ==="
          cd ios
          pod install

      - name: Install Shorebird CLI
        script: |
          echo "=== Shorebird CLI ÏÑ§Ïπò ÏãúÏûë ==="
          
          # Í∏∞Ï°¥ Shorebird ÏÑ§Ïπò Í∞ïÏ†ú Ï†úÍ±∞ (Ï∂©Îèå Î∞©ÏßÄ)
          echo "üßπ Í∏∞Ï°¥ Shorebird ÏÑ§Ïπò Ï†ïÎ¶¨ Ï§ë..."
          if [ -d "$HOME/.shorebird" ]; then
            rm -rf "$HOME/.shorebird"
            echo "‚úÖ Í∏∞Ï°¥ Shorebird ÎîîÎ†âÌÜ†Î¶¨ Ï†úÍ±∞ ÏôÑÎ£å"
          fi
          
          # ÏµúÏã† ÏïàÏ†ï Î≤ÑÏ†Ñ ÏÇ¨Ïö© (v1.6.48)
          echo "üîß Shorebird v1.6.48 ÏµúÏã† ÏïàÏ†ï Î≤ÑÏ†Ñ ÏÑ§Ïπò Ï§ë..."
          
          # Í≥µÏãù GitHub ÏÑ§Ïπò Ïä§ÌÅ¨Î¶ΩÌä∏ ÏÇ¨Ïö© (Í∞ÄÏû• ÏïàÏ†ïÏ†Å)
          echo "üì• Í≥µÏãù ÏÑ§Ïπò Ïä§ÌÅ¨Î¶ΩÌä∏Î°ú ÏµúÏã† Shorebird ÏÑ§Ïπò..."
          curl --proto '=https' --tlsv1.2 https://raw.githubusercontent.com/shorebirdtech/install/main/install.sh -sSf | bash
          
          export PATH="$HOME/.shorebird/bin:$PATH"
          
          echo "=== Shorebird ÏÑ§Ïπò ÌôïÏù∏ ==="
          if command -v shorebird >/dev/null 2>&1; then
            shorebird --version
            echo "‚úÖ Shorebird ÏÑ§Ïπò Î∞è ÏÑ§Ï†ï ÏôÑÎ£å"
          else
            echo "‚ùå Shorebird ÏÑ§Ïπò Ïã§Ìå®"
            exit 1
          fi

      - name: Verify iOS Signing Configuration
        script: |
          echo "=== iOS ÏÑúÎ™Ö ÌôòÍ≤Ω ÌôïÏù∏ ==="
          echo "DEVELOPMENT_TEAM: ${DEVELOPMENT_TEAM:-'24SL34R9HR'}"
          
          # Distribution Certificate Ï†ïÎ≥¥ ÌôïÏù∏
          DIST_CERT_INFO=$(security find-identity -v -p codesigning | grep -i distribution | head -1)
          if [ -n "$DIST_CERT_INFO" ]; then
            echo "‚úÖ Distribution Ïù∏Ï¶ùÏÑú: $DIST_CERT_INFO"
          else
            echo "‚ùå Distribution Ïù∏Ï¶ùÏÑúÎ•º Ï∞æÏùÑ Ïàò ÏóÜÏùå"
            echo "ÏÇ¨Ïö© Í∞ÄÎä•Ìïú Ïù∏Ï¶ùÏÑúÎì§:"
            security find-identity -v -p codesigning
            exit 1
          fi
          
          # Provisioning Profile Ï†ïÎ≥¥ ÌôïÏù∏
          PROFILE_COUNT=$(find "$HOME/Library/MobileDevice/Provisioning Profiles" -name "*.mobileprovision" 2>/dev/null | wc -l)
          echo "ÏÑ§ÏπòÎêú ÌîÑÎ°úÎπÑÏ†ÄÎãù ÌîÑÎ°úÌååÏùº Í∞úÏàò: $PROFILE_COUNTÍ∞ú"
          
          if [ "$PROFILE_COUNT" -gt 0 ]; then
            echo "‚úÖ ÌîÑÎ°úÎπÑÏ†ÄÎãù ÌîÑÎ°úÌååÏùº Î™©Î°ù:"
            find "$HOME/Library/MobileDevice/Provisioning Profiles" -name "*.mobileprovision" 2>/dev/null | while read profile; do
              PROFILE_NAME=$(security cms -D -i "$profile" 2>/dev/null | grep -A1 "<key>Name</key>" | tail -1 | sed 's/.*<string>\(.*\)<\/string>.*/\1/' | tr -d '\n')
              echo "  - $(basename "$profile" .mobileprovision): $PROFILE_NAME"
              
              # ÌîÑÎ°úÎπÑÏ†ÄÎãù ÌîÑÎ°úÌååÏùºÏùò Entitlements ÌôïÏù∏
              if [[ "$PROFILE_NAME" == *"picnic"* ]]; then
                echo "    üîç Picnic ÌîÑÎ°úÌååÏùº Entitlements ÌôïÏù∏ Ï§ë..."
                ENTITLEMENTS=$(security cms -D -i "$profile" 2>/dev/null | grep -A 20 "<key>Entitlements</key>" | grep -E "(aps-environment|com.apple.developer.associated-domains|com.apple.developer.applesignin)")
                if [ -n "$ENTITLEMENTS" ]; then
                  echo "    ‚úÖ ÌïÑÏöîÌïú Entitlements Î∞úÍ≤¨:"
                  echo "$ENTITLEMENTS" | head -5
                else
                  echo "    ‚ö†Ô∏è ÌïÑÏöîÌïú EntitlementsÍ∞Ä ÎàÑÎùΩÎê® (Associated Domains, Push Notifications, Sign in with Apple)"
                fi
              fi
            done
          else
            echo "‚ùå ÌîÑÎ°úÎπÑÏ†ÄÎãù ÌîÑÎ°úÌååÏùºÏùÑ Ï∞æÏùÑ Ïàò ÏóÜÏùå"
            exit 1
          fi

      - name: Configure Xcode Project Signing Strategy
        script: |
          cd picnic_app/ios
          
          echo "=== Xcode ÌîÑÎ°úÏ†ùÌä∏ Automatic Signing ÏÑ§Ï†ï ==="
          
          # Automatic Signing Í∞ïÏ†ú ÏÑ§Ï†ï (App Store Connect Integration ÏÇ¨Ïö©)
          echo "üìù Automatic Signing ÌôúÏÑ±Ìôî..."
          sed -i '' "s/CODE_SIGN_STYLE = Manual;/CODE_SIGN_STYLE = Automatic;/g" Runner.xcodeproj/project.pbxproj
          sed -i '' "s/CODE_SIGN_STYLE = \"\";/CODE_SIGN_STYLE = Automatic;/g" Runner.xcodeproj/project.pbxproj
          
          # Development Team ÏÑ§Ï†ï (ÌïÑÏàò)
          sed -i '' "s/DEVELOPMENT_TEAM = \"\";/DEVELOPMENT_TEAM = \"24SL34R9HR\";/g" Runner.xcodeproj/project.pbxproj
          sed -i '' "s/DEVELOPMENT_TEAM = 24SL34R9HR;/DEVELOPMENT_TEAM = \"24SL34R9HR\";/g" Runner.xcodeproj/project.pbxproj
          
          # Distribution Ïù∏Ï¶ùÏÑú Î∞è ÌîÑÎ°úÌååÏùº ÏÑ§Ï†ï
          sed -i '' "s/CODE_SIGN_IDENTITY = \"\"/CODE_SIGN_IDENTITY = \"Apple Distribution\"/g" Runner.xcodeproj/project.pbxproj
          sed -i '' "s/CODE_SIGN_IDENTITY = \"Apple Development\"/CODE_SIGN_IDENTITY = \"Apple Distribution\"/g" Runner.xcodeproj/project.pbxproj
          sed -i '' "s/\"CODE_SIGN_IDENTITY\[sdk=iphoneos\*\]\" = \"iPhone Developer\"/\"CODE_SIGN_IDENTITY[sdk=iphoneos*]\" = \"Apple Distribution\"/g" Runner.xcodeproj/project.pbxproj
          
          # ÌîÑÎ°úÎπÑÏ†ÄÎãù ÌîÑÎ°úÌååÏùº ÏÑ§Ï†ï (ÏÑ±Í≥µÌñàÎçò ÏÑ§Ï†ï)
          sed -i '' "s/PROVISIONING_PROFILE_SPECIFIER = \"\"/PROVISIONING_PROFILE_SPECIFIER = \"picnic_app_profile_2025\"/g" Runner.xcodeproj/project.pbxproj
          
          # PROVISIONING_PROFILE_SPECIFIER Ï∂îÍ∞Ä (Ï°¥Ïû¨ÌïòÏßÄ ÏïäÎäî Í≤ΩÏö∞)
          if ! grep -q "PROVISIONING_PROFILE_SPECIFIER" Runner.xcodeproj/project.pbxproj; then
            sed -i '' '/DEVELOPMENT_TEAM = /a\
				PROVISIONING_PROFILE_SPECIFIER = "picnic_app_profile_2025";' Runner.xcodeproj/project.pbxproj
          fi
          
          echo "‚úÖ Manual Distribution Signing ÏÑ§Ï†ï ÏôÑÎ£å"
          echo "- CODE_SIGN_STYLE: Manual"
          echo "- DEVELOPMENT_TEAM: 24SL34R9HR"
          echo "- CODE_SIGN_IDENTITY: Apple Distribution"
          echo "- PROVISIONING_PROFILE_SPECIFIER: picnic_app_profile_2025"

      - name: Shorebird iOS Patch
        script: |
          cd picnic_app
          
          # ÌôòÍ≤Ω ÌååÏùºÏóêÏÑú PATH ÏÑ§Ï†ï Î°úÎìú
          if [ -f "/tmp/shorebird_env.sh" ]; then
            source /tmp/shorebird_env.sh
          fi
          
          # PATHÎ•º Î™ÖÏãúÏ†ÅÏúºÎ°ú ÏÑ§Ï†ï
          export PATH="$HOME/.shorebird/bin:$PATH"
          
          # Shorebird CLI Ï°¥Ïû¨ ÌôïÏù∏
          if [ ! -f "$HOME/.shorebird/bin/shorebird" ]; then
            echo "‚ùå Shorebird CLIÍ∞Ä ÏÑ§ÏπòÎêòÏßÄ ÏïäÏïòÏäµÎãàÎã§"
            echo "ÏÑ§Ïπò Îã®Í≥ÑÎ•º Îã§Ïãú ÌôïÏù∏Ìï¥Ï£ºÏÑ∏Ïöî"
            exit 1
          fi

          echo "=== Shorebird iOS Ìå®Ïπò ÏãúÏûë ==="
          echo "Shorebird Î≤ÑÏ†Ñ ÌôïÏù∏:"
          "$HOME/.shorebird/bin/shorebird" --version || {
            echo "‚ö†Ô∏è ÏßÅÏ†ë Í≤ΩÎ°úÎ°ú Shorebird Ïã§Ìñâ Ïã§Ìå®, PATH ÌôïÏù∏ Ï§ë..."
            echo "PATH: $PATH"
            echo "which shorebird: $(which shorebird || echo 'not found')"
            echo "Shorebird ÌååÏùº ÌôïÏù∏: $(ls -la $HOME/.shorebird/bin/shorebird 2>/dev/null || echo 'not found')"
            exit 1
          }

          echo "=== Shorebird Ïù∏Ï¶ù ÌôïÏù∏ ==="
          if [ -z "$SHOREBIRD_TOKEN" ]; then
            echo "‚ùå SHOREBIRD_TOKEN ÌôòÍ≤ΩÎ≥ÄÏàòÍ∞Ä ÏÑ§Ï†ïÎêòÏßÄ ÏïäÏïòÏäµÎãàÎã§"
            exit 1
          else
            echo "‚úÖ SHOREBIRD_TOKEN ÌôòÍ≤ΩÎ≥ÄÏàòÍ∞Ä ÏÑ§Ï†ïÎêòÏóàÏäµÎãàÎã§"
          fi

          echo "=== Shorebird CLI ÏÉÅÌÉú ÌôïÏù∏ ==="
          echo "Shorebird Î≤ÑÏ†Ñ:"
          "$HOME/.shorebird/bin/shorebird" --version 2>/dev/null || echo "Shorebird Î≤ÑÏ†Ñ ÌôïÏù∏ Ïã§Ìå®"

          echo "=== Flutter ÎπåÎìú ÌÖåÏä§Ìä∏ ==="
          # Ìå®Ïπò ÏÉùÏÑ± Ï†ÑÏóê Flutter ÎπåÎìúÍ∞Ä ÏÑ±Í≥µÌïòÎäîÏßÄ ÌôïÏù∏
          echo "üß™ Flutter IPA ÎπåÎìú ÌÖåÏä§Ìä∏ Ï§ë..."
          flutter build ios --release --dart-define=ENVIRONMENT=prod --analyze-size 2>/dev/null || {
            echo "‚ö†Ô∏è Flutter ÎπåÎìú ÌÖåÏä§Ìä∏ Ïã§Ìå® - Í∏∞Î≥∏ ÎπåÎìú ÌôïÏù∏"
            flutter build ios --release --dart-define=ENVIRONMENT=prod || echo "Flutter iOS ÎπåÎìú ÌôïÏù∏ Ïã§Ìå®"
          }

          echo "=== Shorebird Ï∫êÏãú Ï†ïÎ¶¨ Î∞è iOS Ìå®Ïπò Ï§ÄÎπÑ ==="
          # Shorebird Ï∫êÏãú Ï†ïÎ¶¨
          "$HOME/.shorebird/bin/shorebird" cache clean
          
          # Flutter Ï∫êÏãú Ï†ïÎ¶¨
          flutter clean
          flutter pub get
          
          echo "=== iOS ÎπåÎìú ÎîîÎ†âÌÜ†Î¶¨ Ï§ÄÎπÑ ==="
          # iOS ÎπåÎìú ÎîîÎ†âÌÜ†Î¶¨ ÎØ∏Î¶¨ ÏÉùÏÑ±
          mkdir -p build/ios/iphoneos
          mkdir -p build/ios/Release-iphoneos

          echo "=== Shorebird iOS Ìå®Ïπò ÏÉùÏÑ± Î∞è Î∞∞Ìè¨ ==="
          # Ìå®Ïπò ÏÉùÏÑ± (Í∞ÄÏû• ÏµúÏã† Î¶¥Î¶¨Ï¶àÏóê ÎåÄÌïú Ìå®Ïπò)
          echo "üöÄ iOS Ìå®Ïπò ÏÉùÏÑ± ÏãúÏûë (ÏûêÎèô Flutter Î≤ÑÏ†Ñ Í∞êÏßÄ)..."
          PATCH_RESULT=$("$HOME/.shorebird/bin/shorebird" patch ios \
            --release-version=latest \
            --no-confirm \
            --dart-define=ENVIRONMENT=prod \
            --verbose 2>&1)
          PATCH_EXIT_CODE=$?
          
          echo "Ìå®Ïπò Í≤∞Í≥º Ï∂úÎ†•:"
          echo "$PATCH_RESULT"
          
          # Ìå®Ïπò Í≤∞Í≥º ÌôïÏù∏ Î∞è Ï†ÅÏ†àÌïú Ï≤òÎ¶¨
          if [ $PATCH_EXIT_CODE -eq 0 ]; then
            if echo "$PATCH_RESULT" | grep -i "successfully\|completed\|deployed\|published patch"; then
              echo "=== Shorebird iOS Ìå®Ïπò ÏÑ±Í≥µ ==="
              echo "‚úÖ iOS Ìå®ÏπòÍ∞Ä ShorebirdÎ•º ÌÜµÌï¥ ÏÑ±Í≥µÏ†ÅÏúºÎ°ú Î∞∞Ìè¨ÎêòÏóàÏäµÎãàÎã§"
              echo "üöÄ ÏÇ¨Ïö©ÏûêÎì§ÏùÄ Ïï±ÏùÑ Ïû¨ÏãúÏûëÌïòÎ©¥ ÏûêÎèôÏúºÎ°ú Ìå®ÏπòÍ∞Ä Ï†ÅÏö©Îê©ÎãàÎã§"
              
              # Ìå®Ïπò Ï†ïÎ≥¥ Ï∂îÏ∂ú Î∞è ÌëúÏãú
              if echo "$PATCH_RESULT" | grep -i "published patch"; then
                echo ""
                echo "üì± Ìå®Ïπò Î∞∞Ìè¨ Ï†ïÎ≥¥:"
                echo "$PATCH_RESULT" | grep -A 5 -i "ready to publish\|published patch" | tail -6
              fi
            else
              echo "=== Shorebird iOS Ìå®Ïπò Î∂àÏôÑÏ†Ñ ==="
              echo "‚ö†Ô∏è Ìå®Ïπò Î™ÖÎ†πÏñ¥Îäî ÏÑ±Í≥µÌñàÏßÄÎßå Í≤∞Í≥ºÍ∞Ä Î∂àÎ∂ÑÎ™ÖÌï©ÎãàÎã§"
              echo "Ìå®Ïπò Í≤∞Í≥ºÎ•º Îã§Ïãú ÌôïÏù∏Ìï¥Ï£ºÏÑ∏Ïöî"
              exit 1
            fi
          else
            echo "=== Shorebird iOS Ìå®Ïπò Ïã§Ìå® ==="
            echo "‚ùå iOS Ìå®Ïπò ÏÉùÏÑ±/Î∞∞Ìè¨Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§ (Ï¢ÖÎ£å ÏΩîÎìú: $PATCH_EXIT_CODE)"
            
            # Ïã§Ìå® ÏõêÏù∏ Î∂ÑÏÑù
            if echo "$PATCH_RESULT" | grep -i "no.*account\|profile"; then
              echo "üîç ÏÑúÎ™Ö Í¥ÄÎ†® Î¨∏Ï†úÎ°ú Î≥¥ÏûÖÎãàÎã§:"
              echo "- CodeMagic iOS ÏÑúÎ™Ö ÏÑ§Ï†ïÏùÑ ÌôïÏù∏ÌïòÏÑ∏Ïöî"
              echo "- Apple Developer Í≥ÑÏ†ï Ïó∞Í≤∞ ÏÉÅÌÉúÎ•º ÌôïÏù∏ÌïòÏÑ∏Ïöî"
              echo "- ÌîÑÎ°úÎπÑÏ†ÄÎãù ÌîÑÎ°úÌååÏùº Ïú†Ìö®ÏÑ±ÏùÑ ÌôïÏù∏ÌïòÏÑ∏Ïöî"
            elif echo "$PATCH_RESULT" | grep -i "flutter.*build.*fail"; then
              echo "üîç Flutter ÎπåÎìú Î¨∏Ï†úÎ°ú Î≥¥ÏûÖÎãàÎã§:"
              echo "- Flutter Î≤ÑÏ†Ñ Ìò∏ÌôòÏÑ±ÏùÑ ÌôïÏù∏ÌïòÏÑ∏Ïöî"
              echo "- ÏùòÏ°¥ÏÑ± Ìå®ÌÇ§ÏßÄÎì§ÏùÑ ÌôïÏù∏ÌïòÏÑ∏Ïöî"
            elif echo "$PATCH_RESULT" | grep -i "no.*release"; then
              echo "üîç Í∏∞Ï°¥ Î¶¥Î¶¨Ï¶àÍ∞Ä ÏóÜÎäî Î¨∏Ï†úÎ°ú Î≥¥ÏûÖÎãàÎã§"
            fi
            
            exit 1
          fi

    artifacts:
      - picnic_app/flutter_drive.log

    publishing:
      slack:
        channel: '#codemagic-picnic'
        notify_on_build_start: true
        notify:
          success: true
          failure: true
      email:
        recipients:
          - ironlove77@gmail.com
        notify:
          success: true
          failure: true

  # =================== PICNIC APP Android Patch (Shorebird) ===================
  picnic-app-patch-android:
    name: Picnic App - Android Patch (Shorebird)
    instance_type: mac_mini_m2
    max_build_duration: 60
    environment:
      android_signing:
        - picnic_keystore
      groups:
        - shorebird-config
        - picnic_env
      flutter: 3.32.4
      java: 17
      vars:
        PATH: $PATH:$HOME/.shorebird/bin
        APP_NAME: "picnic_app"
    cache:
      cache_paths:
        - $FLUTTER_ROOT/.pub-cache
        - $HOME/.gradle/caches
        - $HOME/.gradle/wrapper
        - $HOME/.android/build-cache
        - picnic_app/.dart_tool
        - picnic_app/android/.gradle
    triggering:
      events:
        - push
        - tag
      # hotfix, patch Î∏åÎûúÏπòÏôÄ patch ÌÉúÍ∑∏Î°ú Ìä∏Î¶¨Í±∞
      branch_patterns:
        - pattern: 'hotfix/*'
          include: true
        - pattern: 'patch/*'
          include: true
      tag_patterns:
        - pattern: 'picnic-patch-*'
          include: true
      cancel_previous_builds: true
    scripts:
      - name: Install Shorebird CLI
        script: |
          echo "=== Shorebird CLI ÏÑ§Ïπò ÏãúÏûë ==="
          
          # Í∏∞Ï°¥ Shorebird ÏÑ§Ïπò Í∞ïÏ†ú Ï†úÍ±∞ (Ï∂©Îèå Î∞©ÏßÄ)
          echo "üßπ Í∏∞Ï°¥ Shorebird ÏÑ§Ïπò Ï†ïÎ¶¨ Ï§ë..."
          if [ -d "$HOME/.shorebird" ]; then
            rm -rf "$HOME/.shorebird"
            echo "‚úÖ Í∏∞Ï°¥ Shorebird ÎîîÎ†âÌÜ†Î¶¨ Ï†úÍ±∞ ÏôÑÎ£å"
          fi
          
          # ÏµúÏã† ÏïàÏ†ï Î≤ÑÏ†Ñ ÏÇ¨Ïö© (v1.6.48)
          echo "üîß Shorebird v1.6.48 ÏµúÏã† ÏïàÏ†ï Î≤ÑÏ†Ñ ÏÑ§Ïπò Ï§ë..."
          
          # Í≥µÏãù GitHub ÏÑ§Ïπò Ïä§ÌÅ¨Î¶ΩÌä∏ ÏÇ¨Ïö© (Í∞ÄÏû• ÏïàÏ†ïÏ†Å)
          echo "üì• Í≥µÏãù ÏÑ§Ïπò Ïä§ÌÅ¨Î¶ΩÌä∏Î°ú ÏµúÏã† Shorebird ÏÑ§Ïπò..."
          curl --proto '=https' --tlsv1.2 https://raw.githubusercontent.com/shorebirdtech/install/main/install.sh -sSf | bash
          
          export PATH="$HOME/.shorebird/bin:$PATH"
          
          echo "=== Shorebird ÏÑ§Ïπò ÌôïÏù∏ ==="
          if command -v shorebird >/dev/null 2>&1; then
            shorebird --version
            echo "‚úÖ Shorebird ÏÑ§Ïπò Î∞è ÏÑ§Ï†ï ÏôÑÎ£å"
          else
            echo "‚ùå Shorebird ÏÑ§Ïπò Ïã§Ìå®"
            exit 1
          fi
          
          # PATH ÏÑ§Ï†ïÏùÑ ÌôòÍ≤Ω ÌååÏùºÎ°ú Ï†ÄÏû• (Îã§Ïùå Îã®Í≥ÑÏóêÏÑú ÏÇ¨Ïö©)
          echo "export PATH=\"$HOME/.shorebird/bin:\$PATH\"" > /tmp/shorebird_env.sh
          echo "‚úÖ Shorebird CLI ÏÑ§Ïπò Î∞è ÌôòÍ≤Ω ÏÑ§Ï†ï ÏôÑÎ£å"

      - name: Get Flutter packages
        script: |
          cd picnic_app
          flutter packages pub get

      - name: Verify Keystore Configuration
        script: |
          echo "=== ÌÇ§Ïä§ÌÜ†Ïñ¥ ÌôòÍ≤Ω Î≥ÄÏàò ÌôïÏù∏ ==="
          echo "CM_KEYSTORE_PATH: ${CM_KEYSTORE_PATH:-'ÎØ∏ÏÑ§Ï†ï'}"
          echo "CM_KEYSTORE_PASSWORD: ${CM_KEYSTORE_PASSWORD:-'ÎØ∏ÏÑ§Ï†ï'}"
          echo "CM_KEY_ALIAS: ${CM_KEY_ALIAS:-'ÎØ∏ÏÑ§Ï†ï'}"
          echo "CM_KEY_PASSWORD: ${CM_KEY_PASSWORD:-'ÎØ∏ÏÑ§Ï†ï'}"
          
          if [ -z "$CM_KEYSTORE_PATH" ] || [ -z "$CM_KEYSTORE_PASSWORD" ] || [ -z "$CM_KEY_ALIAS" ] || [ -z "$CM_KEY_PASSWORD" ]; then
            echo "‚ùå ÌÇ§Ïä§ÌÜ†Ïñ¥ ÌôòÍ≤Ω Î≥ÄÏàòÍ∞Ä Ïò¨Î∞îÎ•¥Í≤å ÏÑ§Ï†ïÎêòÏßÄ ÏïäÏïòÏäµÎãàÎã§"
            echo "CodeMagic ÎåÄÏãúÎ≥¥ÎìúÏóêÏÑú 'picnic_keystore' Í∑∏Î£π ÏÑ§Ï†ïÏùÑ ÌôïÏù∏Ìï¥Ï£ºÏÑ∏Ïöî"
            exit 1
          fi
          
          if [ -f "$CM_KEYSTORE_PATH" ]; then
            echo "‚úÖ ÌÇ§Ïä§ÌÜ†Ïñ¥ ÌååÏùº Ï°¥Ïû¨: $CM_KEYSTORE_PATH"
            # ÌÇ§Ïä§ÌÜ†Ïñ¥ Ï†ïÎ≥¥ ÌôïÏù∏
            keytool -list -v -keystore "$CM_KEYSTORE_PATH" -alias "$CM_KEY_ALIAS" -storepass "$CM_KEYSTORE_PASSWORD" | grep -E "(SHA1|SHA256|Subject|Issuer)" | head -3 || echo "ÌÇ§Ïä§ÌÜ†Ïñ¥ Ï†ïÎ≥¥ ÌôïÏù∏ Ïã§Ìå®"
          else
            echo "‚ùå ÌÇ§Ïä§ÌÜ†Ïñ¥ ÌååÏùºÏùÑ Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§: $CM_KEYSTORE_PATH"
            exit 1
          fi

      - name: Configure Gradle Environment (Identical to Release)
        script: |
          cd picnic_app
          
          echo "=== Gradle Î©îÎ™®Î¶¨ ÏµúÏ†ÅÌôî ÏÑ§Ï†ï (Shorebird Ìò∏Ìôò) ==="
          mkdir -p $HOME/.gradle
          # ShorebirdÏôÄ Ìò∏ÌôòÎêòÎäî ÏµúÏ†ÅÌôîÎêú Gradle ÏÑ§Ï†ï
          echo "org.gradle.jvmargs=-Xmx6144m -XX:MaxMetaspaceSize=512m -XX:+HeapDumpOnOutOfMemoryError -Dfile.encoding=UTF-8" >> $HOME/.gradle/gradle.properties
          echo "org.gradle.daemon=true" >> $HOME/.gradle/gradle.properties
          echo "org.gradle.caching=true" >> $HOME/.gradle/gradle.properties
          echo "org.gradle.parallel=false" >> $HOME/.gradle/gradle.properties
          echo "android.enableJetifier=true" >> $HOME/.gradle/gradle.properties
          echo "android.useAndroidX=true" >> $HOME/.gradle/gradle.properties
          echo "android.enableR8.fullMode=false" >> $HOME/.gradle/gradle.properties

      - name: Shorebird Android Patch (Identical to Release)
        script: |
          cd picnic_app
          
          # ÌôòÍ≤Ω ÌååÏùºÏóêÏÑú PATH ÏÑ§Ï†ï Î°úÎìú
          if [ -f "/tmp/shorebird_env.sh" ]; then
            source /tmp/shorebird_env.sh
          fi
          
          export PATH="$HOME/.shorebird/bin:$PATH"

          echo "=== Shorebird Android Ìå®Ïπò ÏãúÏûë (Î¶¥Î¶¨Ï¶àÏôÄ ÎèôÏùºÌïú ÌôòÍ≤Ω) ==="
          echo "Shorebird Î≤ÑÏ†Ñ ÌôïÏù∏:"
          "$HOME/.shorebird/bin/shorebird" --version

          echo "=== Shorebird Ïù∏Ï¶ù ÌôïÏù∏ ==="
          if [ -z "$SHOREBIRD_TOKEN" ]; then
            echo "‚ùå SHOREBIRD_TOKEN ÌôòÍ≤ΩÎ≥ÄÏàòÍ∞Ä ÏÑ§Ï†ïÎêòÏßÄ ÏïäÏïòÏäµÎãàÎã§"
            exit 1
          else
            echo "‚úÖ SHOREBIRD_TOKEN ÌôòÍ≤ΩÎ≥ÄÏàòÍ∞Ä ÏÑ§Ï†ïÎêòÏóàÏäµÎãàÎã§"
          fi

          echo "=== Shorebird Ï∫êÏãú Ï†ïÎ¶¨ Î∞è ÌôòÍ≤Ω Ï§ÄÎπÑ ==="
          "$HOME/.shorebird/bin/shorebird" cache clean
          flutter clean
          flutter pub get
          
          echo "=== ÏÇ¨Ï†Ñ Flutter ÎπåÎìú (ÎÑ§Ïù¥Ìã∞Î∏å ÎùºÏù¥Î∏åÎü¨Î¶¨ ÏÉùÏÑ±) ==="
          # Shorebird Ïã§Ìñâ Ï†ÑÏóê Flutter ÎπåÎìúÎ°ú ÎÑ§Ïù¥Ìã∞Î∏å ÎùºÏù¥Î∏åÎü¨Î¶¨ ÏÉùÏÑ±
          echo "üîß Flutter AAB ÎπåÎìúÎ•º ÌÜµÌïú ÎÑ§Ïù¥Ìã∞Î∏å ÎùºÏù¥Î∏åÎü¨Î¶¨ ÏÉùÏÑ±..."
          flutter build appbundle --release --dart-define=ENVIRONMENT=prod || {
            echo "‚ö†Ô∏è Flutter ÎπåÎìú Ïã§Ìå® - Í≥ÑÏÜç ÏßÑÌñâ"
          }
          
          echo "=== ÎÑ§Ïù¥Ìã∞Î∏å ÎùºÏù¥Î∏åÎü¨Î¶¨ ÏÇ¨Ï†Ñ Î≥µÏÇ¨ (Shorebird Ìò∏Ìôò) ==="
          # Ïã§Ï†ú ÎÑ§Ïù¥Ìã∞Î∏å ÎùºÏù¥Î∏åÎü¨Î¶¨ ÏúÑÏπòÎì§ (Ïó¨Îü¨ Í∞ÄÎä•Ìïú Í≤ΩÎ°ú)
          POSSIBLE_NATIVE_PATHS=(
            "android/app/build/intermediates/stripped_native_libs/release/stripReleaseDebugSymbols/out/lib"
            "android/app/build/intermediates/stripped_native_libs/release/out/lib"
            "android/app/build/intermediates/merged_native_libs/release/out/lib"
          )
          
          # ShorebirdÍ∞Ä Ï∞æÎäî ÏúÑÏπòÎì§
          EXPECTED_PATHS=(
            "build/app/intermediates/stripped_native_libs/release/out/lib"
            "build/app/intermediates/stripped_native_libs/stripReleaseDebugSymbols/release/out/lib"
          )
          
          NATIVE_FOUND=false
          for REAL_NATIVE_PATH in "${POSSIBLE_NATIVE_PATHS[@]}"; do
            if [ -d "$REAL_NATIVE_PATH" ]; then
              echo "‚úÖ ÎÑ§Ïù¥Ìã∞Î∏å ÎùºÏù¥Î∏åÎü¨Î¶¨ Î∞úÍ≤¨: $REAL_NATIVE_PATH"
              ls -la "$REAL_NATIVE_PATH" 2>/dev/null || echo "ÎîîÎ†âÌÜ†Î¶¨ ÎÇ¥Ïö© ÌôïÏù∏ Î∂àÍ∞Ä"
              NATIVE_FOUND=true
              
              for EXPECTED_PATH in "${EXPECTED_PATHS[@]}"; do
                echo "üìÅ ÏÇ¨Ï†Ñ Î≥µÏÇ¨: $REAL_NATIVE_PATH -> $EXPECTED_PATH"
                mkdir -p "$(dirname "$EXPECTED_PATH")"
                cp -r "$REAL_NATIVE_PATH" "$(dirname "$EXPECTED_PATH")/"
                
                if [ -d "$EXPECTED_PATH" ]; then
                  echo "‚úÖ ÏÇ¨Ï†Ñ Î≥µÏÇ¨ ÏÑ±Í≥µ: $EXPECTED_PATH"
                  find "$EXPECTED_PATH" -name "*.so" | head -3
                else
                  echo "‚ùå ÏÇ¨Ï†Ñ Î≥µÏÇ¨ Ïã§Ìå®: $EXPECTED_PATH"
                fi
              done
              break
            fi
          done
          
          if [ "$NATIVE_FOUND" = false ]; then
            echo "‚ö†Ô∏è ÎÑ§Ïù¥Ìã∞Î∏å ÎùºÏù¥Î∏åÎü¨Î¶¨Î•º Ï∞æÏùÑ Ïàò ÏóÜÏùå"
            echo "üìã Í∞ÄÎä•Ìïú ÏúÑÏπòÎì§ ÌôïÏù∏:"
            find android/app/build/intermediates/ -name "*.so" -type f 2>/dev/null | head -5 || echo "ÎÑ§Ïù¥Ìã∞Î∏å ÎùºÏù¥Î∏åÎü¨Î¶¨ ÌååÏùº ÏóÜÏùå"
          fi
          
          echo "=== Shorebird Android Ìå®Ïπò Ïã§Ìñâ ==="
          echo "üöÄ ShorebirdÎ°ú Android Ìå®Ïπò ÏÉùÏÑ± Î∞è Î∞∞Ìè¨..."
          
          PATCH_RESULT=$("$HOME/.shorebird/bin/shorebird" patch android \
            --release-version=latest \
            --no-confirm \
            --dart-define=ENVIRONMENT=prod 2>&1)
          PATCH_EXIT_CODE=$?
          
          echo "Ìå®Ïπò Í≤∞Í≥º:"
          echo "$PATCH_RESULT"
          
          # Ìå®Ïπò Í≤∞Í≥º ÌôïÏù∏
          if [ $PATCH_EXIT_CODE -eq 0 ]; then
            if echo "$PATCH_RESULT" | grep -i "successfully\|completed\|deployed\|published patch"; then
              echo "=== Shorebird Android Ìå®Ïπò ÏÑ±Í≥µ ==="
              echo "‚úÖ Android Ìå®ÏπòÍ∞Ä ShorebirdÎ•º ÌÜµÌï¥ ÏÑ±Í≥µÏ†ÅÏúºÎ°ú Î∞∞Ìè¨ÎêòÏóàÏäµÎãàÎã§"
              echo "üöÄ ÏÇ¨Ïö©ÏûêÎì§ÏùÄ Ïï±ÏùÑ Ïû¨ÏãúÏûëÌïòÎ©¥ ÏûêÎèôÏúºÎ°ú Ìå®ÏπòÍ∞Ä Ï†ÅÏö©Îê©ÎãàÎã§"
              
              # Ìå®Ïπò Ï†ïÎ≥¥ Ï∂îÏ∂ú Î∞è ÌëúÏãú
              if echo "$PATCH_RESULT" | grep -i "published patch"; then
                echo ""
                echo "üì± Ìå®Ïπò Î∞∞Ìè¨ Ï†ïÎ≥¥:"
                echo "$PATCH_RESULT" | grep -i "published patch" | head -3
              fi
            else
              echo "=== Shorebird Android Ìå®Ïπò Ïû¨ÏãúÎèÑ ÌïÑÏöî ==="
              echo "‚ö†Ô∏è Ìå®Ïπò Í≤∞Í≥ºÍ∞Ä Î∂àÎ∂ÑÎ™ÖÌï©ÎãàÎã§. Ïû¨ÏãúÎèÑÌï©ÎãàÎã§..."
              sleep 5
              
              echo "üîÑ Android Ìå®Ïπò Ïû¨ÏãúÎèÑ..."
              RETRY_RESULT=$("$HOME/.shorebird/bin/shorebird" patch android \
                --release-version=latest \
                --no-confirm \
                --dart-define=ENVIRONMENT=prod 2>&1)
              RETRY_EXIT_CODE=$?
              
              if [ $RETRY_EXIT_CODE -eq 0 ]; then
                echo "‚úÖ Ïû¨ÏãúÎèÑ ÏÑ±Í≥µ!"
                echo "$RETRY_RESULT"
              else
                echo "‚ùå Ïû¨ÏãúÎèÑÎèÑ Ïã§Ìå®ÌñàÏäµÎãàÎã§."
                echo "$RETRY_RESULT"
                exit 1
              fi
            fi
          else
            echo "=== Shorebird Android Ìå®Ïπò Ïã§Ìå® ==="
            echo "‚ùå Android Ìå®ÏπòÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§ (Ï¢ÖÎ£å ÏΩîÎìú: $PATCH_EXIT_CODE)"
            
            # Ïã§Ìå® ÏõêÏù∏ Î∂ÑÏÑù
            if echo "$PATCH_RESULT" | grep -i "keystore\|signing"; then
              echo "üîç ÏÑúÎ™Ö Í¥ÄÎ†® Î¨∏Ï†úÎ°ú Î≥¥ÏûÖÎãàÎã§"
            elif echo "$PATCH_RESULT" | grep -i "flutter.*build.*fail\|gradle.*fail"; then
              echo "üîç Flutter/Gradle ÎπåÎìú Î¨∏Ï†úÎ°ú Î≥¥ÏûÖÎãàÎã§"
            elif echo "$PATCH_RESULT" | grep -i "no.*release\|app.*not.*found"; then
              echo "üîç Í∏∞Ï°¥ Î¶¥Î¶¨Ï¶à ÏóÜÏùå Î¨∏Ï†úÎ°ú Î≥¥ÏûÖÎãàÎã§"
            elif echo "$PATCH_RESULT" | grep -i "cannot.*find.*artifacts"; then
              echo "üîç ÎπåÎìú ÏïÑÌã∞Ìå©Ìä∏ Î¨∏Ï†úÎ°ú Î≥¥ÏûÖÎãàÎã§"
            fi
            
            exit 1
          fi

    artifacts:
      - picnic_app/flutter_drive.log

    publishing:
      slack:
        channel: '#codemagic-picnic'
        notify_on_build_start: true
        notify:
          success: true
          failure: true
      email:
        recipients:
          - ironlove77@gmail.com
        notify:
          success: true
          failure: true