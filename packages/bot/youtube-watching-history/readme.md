# 유튜브 계정 관리 & Fargate 실행 아키텍처 (EventBridge 기반)

## 1. 개요

### 목적
- 다수의 Gmail/YouTube 계정을 중앙에서 관리하며, 매 계정마다 "특정 시간에 유튜브 시청" 작업을 자동으로 실행
- 상시 인스턴스를 두지 않고, AWS Fargate에서 컨테이너를 짧게 실행 후 종료 → 비용 절감
- YouTube 시청 이력(원한다면 공식 YouTube API/OAuth)까지 관리자 대시보드(Refine)에서 확인
- 이중 실행 방지, Slack 알림, 로그 추적 등의 기능을 포함

### 핵심 포인트
1. 계정 정보, 예약 시간, 상태(in_use 등)는 Supabase DB에서 관리
2. 스케줄링은 AWS EventBridge(Schedule Rule)로 구현 (Supabase Cron은 사용하지 않음)
3. Fargate 태스크 기동 시 계정 식별자를 전달, 컨테이너 내부에서 Puppeteer 실행
4. 유튜브 자동화 로직은 Node.js + Puppeteer로 Docker 컨테이너에 탑재
5. 완료/에러 시 Slack 알림, 실행 로그를 DB나 CloudWatch Logs에 기록

---

## 2. 기능 구현 방식

### 2.1 YouTube API 기반 기능
YouTube Data API를 사용하여 구현된 기능들입니다. OAuth 2.0 인증이 필요하며, 공식 API를 통해 안정적으로 동작합니다.

#### 주요 기능
1. **채널 관리**
   - 채널 정보 조회 (제목, 구독자 수 등)
   - 채널 구독/구독 취소
   - 구독 상태 확인

2. **동영상 상호작용**
   - 동영상 좋아요/싫어요
   - 댓글 작성
   - 동영상 설명 가져오기

3. **채널 콘텐츠 조회**
   - 채널의 최근 동영상 목록 조회
   - 동영상 통계 정보 조회

#### 장점
- 공식 API를 사용하므로 안정적
- YouTube 정책 준수
- 높은 신뢰성과 안정성
- 상세한 에러 메시지 제공

#### 단점
- API 사용량 제한 (쿼터)
- OAuth 2.0 설정 필요
- 일부 기능 제한 (예: 시청 시간 추적 불가)

### 2.2 Puppeteer(크롬) 기반 기능
Puppeteer를 사용하여 웹 브라우저를 자동화하는 방식으로 구현된 기능들입니다.

#### 주요 기능
1. **시청 이력 관리**
   - 동영상 시청 시간 추적
   - 시청 기록 자동 생성
   - 시청 중인 동영상 정보 수집

2. **자동화된 상호작용**
   - 자동 로그인
   - 동영상 시청 자동화
   - 댓글 자동 작성
   - 좋아요 자동 클릭

3. **데이터 수집**
   - 동영상 메타데이터 수집
   - 댓글 내용 수집
   - 추천 동영상 수집

#### 장점
- API 제한 없음
- 웹 브라우저의 모든 기능 활용 가능
- 시청 시간 추적 가능
- 유연한 데이터 수집

#### 단점
- YouTube UI 변경에 취약
- 브라우저 리소스 사용
- 자동화 감지 위험
- 안정성 문제 가능성

---

## 3. 아키텍처 다이어그램

```ascii
┌─────────────────────────────┐
│         Admin UI            │
│ (Refine)                    │
│ - 계정 등록/편집            │
│ - 예약 시간 설정            │
│ - 실행 상태/로그 조회       │
└─────────────┬───────────────┘
              │ (HTTPS/REST)
              ▼
┌─────────────────────────────────────────┐
│        Supabase (PostgreSQL DB)       │
│ - accounts 테이블 (email, pw, in_use..)│
│ - watch_logs 테이블 (실행 결과 등)     │
│ - youtube_tokens 테이블 (OAuth 토큰)   │
└─────────────┬──────────────────────────┘
              │ (SQL/REST)
              ▼
┌─────────────────────────────────────────┐
│ AWS EventBridge (Schedule Rule)        │
│ - 매 분/매 시간/특정 cron에 따라       │
│   Lambda 혹은 RunTask 직접 호출       │
└─────────────┬──────────────────────────┘
              │
              ├─────────────────────────────┐
              │                             │
              ▼                             ▼
┌─────────────────────────┐    ┌──────────────────────────────────┐
│     YouTube API         │    │ AWS ECS (Fargate)               │
│ - 채널 정보 조회        │    │ - Docker 컨테이너: Node.js      │
│ - 구독 상태 확인        │    │ - 실행 시: 계정 ID 받아        │
│ - 동영상 상호작용       │    │   Supabase에서 pw 조회         │
│ (좋아요, 구독, 댓글)    │    │ - 유튜브 시청 후 watch_logs 기록│
└─────────────┬───────────┘    └─────────────┬──────────────────┘
              │                               │
              ▼                               ▼
┌─────────────────────────┐    ┌──────────────────────────────────┐
│     YouTube 서비스      │    │           Chrome (Puppeteer)     │
│ - 공식 API 엔드포인트    │    │ - 자동 로그인                   │
│ - OAuth 2.0 인증        │    │ - 동영상 시청                   │
└─────────────┬───────────┘    │ - 시청 기록 수집                │
              │                 │ - 동영상 설명/스크립트 수집      │
              │                 └─────────────┬──────────────────┘
              │                               │
              │                               ▼
              │                 ┌─────────────────────────┐
              │                 │         SQS            │
              │                 │ - 시청 완료 이벤트      │
              │                 │ - 동영상 정보 저장      │
              │                 └─────────────┬──────────┘
              │                               │
              │                               ▼
              │                 ┌─────────────────────────┐
              │                 │     AWS Lambda         │
              │                 │ - OpenAI API 호출      │
              │                 │ - 댓글 생성            │
              │                 │ - 좋아요 처리          │
              │                 └─────────────┬──────────┘
              │                               │
              └───────────────────────────────┘
```

### 주요 컴포넌트 설명
1. **Admin UI(Refine)**: 계정과 예약 정보를 편리하게 수정·조회
2. **Supabase**: 유튜브 계정, 예약 스케줄, 실행 로그, OAuth 토큰 등 저장
3. **EventBridge**: 스케줄을 관리. 특정 시간마다(또는 매 분/매 시) 이벤트를 발생
4. **YouTube API**: 공식 API를 통한 유튜브 서비스 접근 (구독, 좋아요, 댓글)
5. **Fargate**: 시청 전용 컨테이너를 서버리스로 실행
6. **Chrome (Puppeteer)**: Fargate 컨테이너 내에서 실행되는 웹 브라우저 자동화 도구
7. **SQS**: 시청 완료 이벤트와 동영상 정보를 임시 저장하고 Lambda로 전달
8. **Lambda**: OpenAI API를 활용한 댓글 생성 및 좋아요 처리

### 기능 분리
1. **YouTube API 기반 기능**
   - 채널 구독/구독 취소
   - 동영상 좋아요/싫어요
   - 댓글 게시
   - 채널 정보 조회
   - 구독 상태 확인

2. **Puppeteer 기반 기능**
   - 동영상 시청
   - 시청 기록 수집
   - 동영상 설명/스크립트 수집
   - 자동 로그인

3. **Lambda 기반 기능**
   - 동영상 설명 분석
   - OpenAI API를 통한 댓글 생성
   - 생성된 댓글을 YouTube API로 전달

### 시청 후 상호작용 프로세스 상세
1. **시점**
   - 동영상 시청 중: Chrome(Puppeteer)이 설명/스크립트 수집
   - 시청 완료 후: 
     1. Chrome(Puppeteer)이 시청 완료 이벤트를 SQS로 전송
     2. SQS 메시지 수신 후 Lambda 실행
     3. Lambda에서 좋아요와 댓글 처리

2. **주체별 역할**
   - **Fargate**
     - Chrome(Puppeteer) 컨테이너 실행 환경 제공
     - 컨테이너 리소스 관리
     - 실행 상태 모니터링

   - **Chrome (Puppeteer)**
     - 동영상 시청
     - 설명/스크립트 수집
     - 시청 완료 시 SQS로 이벤트 전송
     - 시청 완료 후 watch_logs 기록

   - **SQS (Amazon Simple Queue Service)**
     - 시청 완료 이벤트 저장
     - 동영상 정보 저장
     - Lambda 트리거 역할
     - 메시지 지연 전송 가능 (예: 시청 완료 후 5분)

   - **Lambda**
     - SQS 메시지 수신
     - OpenAI API 호출하여 댓글 생성
     - YouTube API를 통해 좋아요 처리
     - 생성된 댓글을 YouTube API로 전달

   - **YouTube API**
     - Lambda로부터 받은 댓글을 게시
     - 좋아요 처리
     - 구독 처리

3. **장점**
   - 시청 완료 후 자연스러운 상호작용
   - 봇 감지 위험 감소
   - 실패 시 재시도 가능
   - 시청과 상호작용의 독립적 스케일링
   - 상호작용 지연 가능 (시청 완료 후 일정 시간 후)

---

## 4. 구현 단계별 실행 아이템

### 4.1 YouTube API 구현
1. **OAuth 2.0 설정**
   - Google Cloud Console에서 프로젝트 생성
   - OAuth 2.0 클라이언트 ID 발급
   - 필요한 스코프 설정 (youtube, youtube.force-ssl)

2. **토큰 관리**
   - Supabase에 토큰 저장
   - 토큰 갱신 로직 구현
   - 토큰 만료 처리

3. **API 서비스 구현**
   - 채널 관리 기능
   - 동영상 상호작용 기능
   - 콘텐츠 조회 기능

### 4.2 Puppeteer 구현
1. **브라우저 설정**
   - Puppeteer 설치 및 설정
   - 헤드리스 모드 설정
   - 사용자 에이전트 설정

2. **자동화 로직**
   - 로그인 자동화
   - 동영상 시청 자동화
   - 상호작용 자동화

3. **데이터 수집**
   - 시청 기록 수집
   - 메타데이터 수집
   - 로그 저장

### 4.3 공통 구현
1. **데이터베이스 스키마**
   - accounts 테이블
   - youtube_tokens 테이블
   - watch_logs 테이블

2. **환경 설정**
   - 환경 변수 관리
   - API 키 관리
   - 로깅 설정

3. **에러 처리**
   - API 에러 처리
   - 브라우저 에러 처리
   - 재시도 로직

---

## 5. 보안 및 정책 고려사항

### 5.1 YouTube API 사용 시
- API 사용량 제한 준수
- OAuth 토큰 보안 관리
- 민감 정보 암호화

### 5.2 Puppeteer 사용 시
- YouTube 서비스 약관 준수
- 자동화 감지 방지
- IP 차단 방지

### 5.3 공통
- 계정 정보 보안
- 로그 보안
- 에러 모니터링

---

## 6. 비용 및 리소스 관리

### 6.1 API 사용 비용
- YouTube API 쿼터 관리
- API 호출 최적화
- 캐싱 전략

### 6.2 Puppeteer 리소스
- 브라우저 리소스 관리
- 메모리 사용량 최적화
- 병렬 실행 제한

### 6.3 AWS 리소스
- Fargate 비용 최적화
- Lambda 실행 비용
- 데이터베이스 비용

---

## 7. 추가 참고 사항

### 7.1 보안
- 이메일/비번 평문 → 가능하면 Secrets Manager 또는 암호화 저장
- **OpenAI API 키** → 환경 변수(Secrets Manager 연동 권장)를 통해 안전하게 관리
- Fargate 태스크 Role → 최소 권한 (DB/SecretsManager 접근 등)

### 7.2 확장성
- 계정이 수백, 수천 개로 늘어난다면 스케줄 호출 횟수 증가. EventBridge + Lambda 성능 주의
- 병렬 Fargate 태스크 실행 시 CPU/Memory/Network 부하

### 7.3 비용
- Fargate는 실행 시간 단위 과금, 짧게 실행 시 비용 효율↑
- EventBridge는 소량 호출은 거의 무료 수준
- Supabase는 플랜/사용량에 따라 비용 검토

### 7.4 YouTube 정책
- 부정 시청(조회수 조작), **자동 구독, 자동 댓글 생성/게시** 등은 YouTube 서비스 약관 위반으로 간주될 가능성이 매우 높습니다.
- 이로 인해 계정 정지, IP 차단 등의 제재를 받을 수 있습니다.
- 테스트/연구 목적 외 상업적 또는 대규모 운영 시에는 심각한 위험을 초래할 수 있으므로 각별한 주의가 필요합니다.

---

## 8. 다운로드/배포 가이드

이 문서는 Markdown 형식이므로, 다음 방법 중 하나로 다운로드할 수 있습니다:

1. **복사 & 붙여넣기**
   - 현재 문서 내용을 전부 복사하여, VSCode / Notion / Obsidian / Google Docs 등 원하는 에디터에 붙여 넣은 뒤, "PDF로 내보내기"
2. **Markdown 파일로 저장**
   - 새로운 .md 파일을 만든 뒤, 이 내용을 저장 → 마크다운 뷰어(예: Typora)에서 PDF나 HTML로 변환
3. **GitHub Gist**
   - 새 Gist를 만들고 이 내용을 넣으면 웹에서 Markdown으로도 볼 수 있고, "Download ZIP" 등으로 받을 수 있음

이 과정을 통해 PDF나 docx 형태로도 자유롭게 배포 가능합니다.