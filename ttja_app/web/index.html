<!DOCTYPE html>
<html>
  <head>
    <base href="$FLUTTER_BASE_HREF" />

    <meta charset="UTF-8" />
    <meta content="IE=Edge" http-equiv="X-UA-Compatible" />
    <meta name="description" content="TTJA" />

    <!-- iOS meta tags & icons -->
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black" />
    <meta name="apple-mobile-web-app-title" content="ttja_app" />
    <link rel="apple-touch-icon" href="icons/Icon-192.png" />

    <!-- Favicon -->
    <link rel="icon" type="image/png" href="favicon.png" />

    <title>ttja_app</title>
    <link rel="manifest" href="manifest.json" />

    <!-- 뷰포트 설정 -->
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <meta name="theme-color" content="#ffffff" />

    <!-- Flutter 초기화 스크립트 -->
    <script src="flutter.js" defer></script>

    <!-- Next.js 리액트 -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>

    <style>
      html,
      body {
        height: 100%;
        margin: 0;
        padding: 0;
        width: 100%;
        overflow: hidden; /* 중요: 외부 스크롤 방지 */
      }

      body {
        display: flex;
        justify-content: center;
        background-color: #ffffff;
      }

      .container {
        display: flex;
        max-width: 1300px;
        width: 100%;
        height: 100%;
        position: relative;
      }

      .sidebar-left,
      .sidebar-right {
        flex: 0 0 393px;
        width: 393px;
        height: 100%;
        display: block; /* 기본값을 block으로 설정 */
        box-sizing: border-box;
        margin: 0;
        padding: 0;
        background-color: #f8f9fa;
        z-index: 5;
      }

      .sidebar-left iframe,
      .sidebar-right iframe {
        width: 100%;
        height: 100%;
        border: none;
      }

      .app-container {
        flex: 0 0 450px;
        width: 450px;
        max-width: 450px;
        min-width: 450px;
        height: 100%;
        overflow: hidden;
        position: relative;
        z-index: 10;
      }

      #flutter_target {
        width: 100%;
        height: 100%;
      }

      #loading {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        display: flex;
        justify-content: center;
        align-items: center;
        background-color: white;
        z-index: 2;
      }

      #error {
        display: none;
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        padding: 20px;
        background-color: rgba(255, 0, 0, 0.1);
        border: 1px solid red;
        border-radius: 5px;
        text-align: center;
        z-index: 999;
      }

      /* 반응형 디자인 */
      @media (max-width: 843px) {
        .sidebar-left,
        .sidebar-right {
          display: none !important; /* !important로 강제 적용 */
        }
        .container {
          justify-content: center;
        }
      }

      @media (min-width: 844px) and (max-width: 1236px) {
        .sidebar-left {
          display: block !important; /* !important로 강제 적용 */
        }
        .sidebar-right {
          display: none !important; /* !important로 강제 적용 */
        }
        .container {
          justify-content: flex-start;
        }
      }

      @media (min-width: 1237px) {
        .sidebar-left,
        .sidebar-right {
          display: block !important; /* !important로 강제 적용 */
        }
        .container {
          justify-content: space-between;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <!-- 좌측 사이드바 -->
      <div class="sidebar-left" id="sidebar-left">
        <iframe frameborder="0" title="Left Sidebar"></iframe>
      </div>

      <!-- Flutter 앱 -->
      <div class="app-container" id="flutter-app-container">
        <div id="loading">
          <img src="splash/img/light-1x.png" alt="Loading..." />
        </div>
        <div id="error">
          <h3>오류가 발생했습니다</h3>
          <p id="error-message">앱을 로드하는 중 문제가 발생했습니다.</p>
          <button onclick="window.location.reload()">다시 시도</button>
        </div>
      </div>

      <!-- 우측 사이드바 -->
      <div class="sidebar-right" id="sidebar-right">
        <iframe frameborder="0" title="Right Sidebar"></iframe>
      </div>
    </div>

    <script>
      // 전역 변수 선언
      let loadingRemoved = false;
      let flutterInitialized = false;
      let sidebarInitialized = false;
      let errorShown = false;
      let initializationAttempts = 0;
      const MAX_INIT_ATTEMPTS = 3;
      let initializationMethod = null;

      // 사이드바 초기화
      function initSidebars() {
        if (sidebarInitialized) {
          console.log('사이드바가 이미 초기화되었습니다.');
          return;
        }

        const isLocalhost =
          window.location.hostname === 'localhost' ||
          window.location.hostname === '127.0.0.1';

        // TTJA Next.js 서버 URL (3002 포트)
        const leftSrc = isLocalhost
          ? 'http://localhost:3002/left-sidebar'
          : './next-export/left-sidebar.html';
        const rightSrc = isLocalhost
          ? 'http://localhost:3002/right-sidebar'
          : './next-export/right-sidebar.html';

        // iframe 요소 찾기
        const leftIframe = document.querySelector('#sidebar-left iframe');
        const rightIframe = document.querySelector('#sidebar-right iframe');

        // iframe이 없는 경우 처리
        if (!leftIframe || !rightIframe) {
          console.error('사이드바 iframe을 찾을 수 없습니다', {
            leftIframe,
            rightIframe,
          });
          return;
        }

        // iframe src 설정
        leftIframe.src = leftSrc;
        rightIframe.src = rightSrc;

        console.log('사이드바 URL 설정 완료:', {
          환경: isLocalhost ? '개발 환경' : '배포 환경',
          왼쪽: leftSrc,
          오른쪽: rightSrc,
        });

        sidebarInitialized = true;

        // 사이드바 상태 업데이트
        updateSidebars();

        // 1초 후 다시 한번 확인
        setTimeout(updateSidebars, 1000);
      }

      // 로딩 화면 제거
      function hideLoading() {
        if (loadingRemoved) return;

        const loading = document.getElementById('loading');
        if (loading) {
          loading.style.display = 'none';
          loadingRemoved = true;
          console.log('로딩 화면 제거 완료');
        }

        // 로딩 화면 제거 후 사이드바 표시 확인
        updateSidebars();
      }

      // Flutter 요소의 이벤트 수신 활성화
      function checkAndFixFlutterElements() {
        // Flutter 엔진이 생성한 요소들 탐색
        setTimeout(() => {
          const canvas = document.querySelector('canvas');
          const glassPanes = document.querySelectorAll('.flt-glass-pane');
          const semanticsElements = document.querySelectorAll('flt-semantics');

          // Canvas 요소 확인
          if (canvas) {
            canvas.style.pointerEvents = 'auto';
            canvas.style.zIndex = '15';
          }

          // 유리 패널 요소 확인
          glassPanes.forEach((pane) => {
            pane.style.pointerEvents = 'auto';
            pane.style.zIndex = '15';
          });

          // 시맨틱스 요소 확인
          semanticsElements.forEach((element) => {
            element.style.pointerEvents = 'auto';
          });

          console.log('Flutter 요소 이벤트 처리 개선 완료');
        }, 500);
      }

      // 사이드바 업데이트
      function updateSidebars() {
        const width = window.innerWidth;
        console.log('현재 화면 너비:', width);

        const leftSidebar = document.getElementById('sidebar-left');
        const rightSidebar = document.getElementById('sidebar-right');

        // 사이드바가 없는 경우 처리
        if (!leftSidebar || !rightSidebar) {
          console.error('사이드바 요소를 찾을 수 없습니다', {
            leftSidebar,
            rightSidebar,
          });
          return;
        }

        if (width >= 1237) {
          // 3칸 모드
          leftSidebar.style.display = 'block';
          rightSidebar.style.display = 'block';
          console.log('3칸 모드 적용 (양쪽 사이드바 표시)');
        } else if (width >= 844) {
          // 2칸 모드
          leftSidebar.style.display = 'block';
          rightSidebar.style.display = 'none';
          console.log('2칸 모드 적용 (좌측 사이드바만 표시)');
        } else {
          // 1칸 모드
          leftSidebar.style.display = 'none';
          rightSidebar.style.display = 'none';
          console.log('1칸 모드 적용 (사이드바 숨김)');
        }

        console.log('사이드바 상태:', {
          leftDisplay: leftSidebar.style.display,
          rightDisplay: rightSidebar.style.display,
        });
      }

      // 오류 표시
      function showError(message, isRetryable = true) {
        // 이미 Flutter가 초기화되었다면 에러 표시하지 않음
        if (flutterInitialized) {
          console.warn('Flutter가 이미 초기화됨 - 에러 무시:', message);
          return;
        }

        const error = document.getElementById('error');
        const errorMessage = document.getElementById('error-message');

        if (error && errorMessage) {
          // 제목 설정
          const titleEl = error.querySelector('h3');
          if (titleEl) {
            titleEl.textContent = isRetryable
              ? '앱 로딩 문제 발생'
              : '앱 로딩 실패';
          }

          // 메시지 설정
          errorMessage.textContent =
            message || '앱을 로드하는 중 오류가 발생했습니다.';

          // 버튼 설정
          const button = error.querySelector('button');
          if (button) {
            button.style.display = isRetryable ? 'block' : 'none';
            button.onclick = isRetryable
              ? retryInitialization
              : function () {
                  window.location.reload();
                };
          }

          error.style.display = 'block';
        }

        errorShown = true;
        console.error('Flutter 오류:', message);

        // 디버깅 정보
        console.info('현재 초기화 시도 횟수:', initializationAttempts);
        console.info('마지막으로 사용한 초기화 방법:', initializationMethod);
        console.info('사이드바 초기화 상태:', sidebarInitialized);
        console.info('브라우저 정보:', navigator.userAgent);
      }

      // 초기화 재시도 함수
      function retryInitialization() {
        console.log('Flutter 초기화 재시도 중...');

        // 재시도 횟수 초과 확인
        if (initializationAttempts >= MAX_INIT_ATTEMPTS) {
          showError(
            '재시도 횟수가 초과되었습니다. 페이지를 새로고침해주세요.',
            false,
          );
          return;
        }

        // 재시도 상태 표시
        const error = document.getElementById('error');
        if (error) {
          const messageEl = error.querySelector('#error-message');
          if (messageEl) {
            messageEl.textContent = '앱을 다시 로드하는 중입니다...';
          }
        }

        // 이전 방법과 다른 방법으로 시도
        setTimeout(() => {
          initializeFlutter(true);
        }, 1000);
      }

      // Flutter 초기화 완료 콜백
      function onFlutterInited() {
        console.log('Flutter 엔진 초기화 완료');
        flutterInitialized = true;
        hideLoading();

        // 오류 숨기기
        if (errorShown) {
          const error = document.getElementById('error');
          if (error) {
            error.style.display = 'none';
            errorShown = false;
          }
        }

        // 이벤트 처리 개선
        checkAndFixFlutterElements();

        // 사이드바 표시 확인
        updateSidebars();
      }

      // 윈도우 크기 변화에 따른 디바운싱
      function debounce(func, wait) {
        let timeout;
        return function () {
          clearTimeout(timeout);
          timeout = setTimeout(() => func.apply(this, arguments), wait);
        };
      }

      // Flutter 초기화 함수
      async function initializeFlutter(isRetry = false) {
        try {
          initializationAttempts++;

          if (isRetry) {
            console.log(`Flutter 초기화 재시도 #${initializationAttempts}`);
          } else {
            console.log('Flutter 초기화 시작');
          }

          // 먼저 사용할 초기화 방식 결정
          if (isRetry) {
            // 재시도 시 다른 방법으로 시도
            if (initializationMethod === 'flutter_loader') {
              initializationMethod = 'direct_load';
            } else if (initializationMethod === 'direct_load') {
              initializationMethod = 'flutter_optimizer';
            } else {
              initializationMethod = 'flutter_loader';
            }
          } else {
            // 첫 시도는 최신 방법으로
            initializationMethod = 'flutter_loader';
          }

          console.log(`초기화 방법: ${initializationMethod}`);

          if (initializationMethod === 'flutter_loader' && window._flutter) {
            // 최신 방식 사용 (load 메서드)
            console.log('Flutter 초기화 - _flutter.loader.load() 사용');

            await window._flutter.loader.load({
              onEntrypointLoaded: function (engineInitializer) {
                // 사용자에게 상태 표시
                const error = document.getElementById('error');
                if (error) {
                  const messageEl = error.querySelector('#error-message');
                  if (messageEl) {
                    messageEl.textContent = 'Flutter 엔진 초기화 중...';
                  }
                  error.style.display = 'block';
                }

                // HTML 렌더러로 초기화
                engineInitializer
                  .initializeEngine({
                    renderer: 'html',
                  })
                  .then(function (appRunner) {
                    // 사용자에게 상태 표시
                    const error = document.getElementById('error');
                    if (error) {
                      const messageEl = error.querySelector('#error-message');
                      if (messageEl) {
                        messageEl.textContent = 'Flutter 앱 실행 중...';
                      }
                    }

                    appRunner.runApp();
                    onFlutterInited();

                    // 클릭 이벤트 문제 해결을 위한 추가 처리
                    setTimeout(checkAndFixFlutterElements, 1000);
                  })
                  .catch(function (error) {
                    console.error('Flutter 엔진 초기화 실패:', error);
                    showError(error.message || '엔진 초기화 중 오류 발생');

                    // 다른 방법으로 자동 재시도
                    if (initializationAttempts < MAX_INIT_ATTEMPTS) {
                      setTimeout(() => initializeFlutter(true), 1000);
                    }
                  });
              },
            });
          } else if (
            initializationMethod === 'flutter_optimizer' &&
            window.flutter_web_optimizer
          ) {
            // Flutter 웹 최적화기 사용
            console.log('Flutter 초기화 - flutter_web_optimizer 사용');
            window.flutter_web_optimizer.loadEntrypoint({
              entrypointUrl: 'main.dart.js',
              onEntrypointLoaded: onFlutterInited,
            });
          } else {
            // 대체 방식 시도
            console.warn('Flutter 초기화 - 직접 스크립트 로드 시도');
            initializationMethod = 'direct_load';

            // 기존 스크립트가 있는지 확인하고 제거
            const existingScript = document.querySelector(
              'script[src="main.dart.js"]',
            );
            if (existingScript) {
              existingScript.remove();
            }

            // 사용자에게 상태 표시
            const error = document.getElementById('error');
            if (error) {
              const messageEl = error.querySelector('#error-message');
              if (messageEl) {
                messageEl.textContent = 'Flutter 스크립트 직접 로드 중...';
              }
              error.style.display = 'block';
            }

            // main.dart.js 직접 로드 시도
            const script = document.createElement('script');
            script.src = 'main.dart.js';
            script.type = 'application/javascript';
            script.onload = function () {
              console.log('main.dart.js 직접 로드 완료');
              setTimeout(onFlutterInited, 1000);
            };
            script.onerror = function (error) {
              console.error('Flutter 스크립트 로드 실패:', error);
              showError('Flutter 스크립트 로드 실패');

              // 다른 방법으로 자동 재시도
              if (initializationAttempts < MAX_INIT_ATTEMPTS) {
                setTimeout(() => initializeFlutter(true), 1000);
              }
            };
            document.body.appendChild(script);
          }
        } catch (error) {
          console.error('Flutter 초기화 과정에서 예외 발생:', error);
          showError(error.message || '알 수 없는 오류가 발생했습니다.');

          // 다른 방법으로 자동 재시도
          if (initializationAttempts < MAX_INIT_ATTEMPTS) {
            setTimeout(() => initializeFlutter(true), 1000);
          } else {
            showError(
              '여러 번의 초기화 시도 후에도 앱을 로드할 수 없습니다.',
              false,
            );
          }
        }
      }

      // 초기화
      document.addEventListener('DOMContentLoaded', function () {
        console.log('DOM 로드 완료, 초기화 시작');

        // 사이드바 초기화
        initSidebars();

        // 윈도우 크기 변화 감지
        window.addEventListener('resize', debounce(updateSidebars, 250));

        // MutationObserver 설정 - DOM 변화 감지
        const observer = new MutationObserver(function () {
          // 사이드바 업데이트
          updateSidebars();

          // Flutter 요소가 추가되면 이벤트 처리 확인
          if (flutterInitialized) {
            checkAndFixFlutterElements();
          }
        });

        // body 요소 변화 감시
        observer.observe(document.body, {
          childList: true,
          subtree: true,
          attributes: true,
        });

        // 자동 로딩 타임아웃 (5초)
        setTimeout(() => {
          if (!loadingRemoved) {
            console.log('타임아웃으로 로딩 화면 제거');
            hideLoading();
          }
        }, 5000);

        // 500ms 후 Flutter 초기화 시작
        setTimeout(() => {
          initializeFlutter();
        }, 500);

        // 사이드바 표시 확인을 위한 추가 호출
        setTimeout(() => {
          console.log('사이드바 표시 상태 강제 확인');
          updateSidebars();
        }, 2000);
      });

      // 페이지 로드 완료 시 별도 확인
      window.addEventListener('load', function () {
        console.log('페이지 로드 완료');

        // 사이드바 표시 확인
        updateSidebars();

        // 5초 후에도 초기화되지 않았다면 상태 메시지 표시
        setTimeout(() => {
          if (!flutterInitialized) {
            console.warn('5초 후에도 Flutter가 초기화되지 않음');
            const error = document.getElementById('error');
            if (error && error.style.display !== 'block') {
              const messageEl = error.querySelector('#error-message');
              if (messageEl) {
                messageEl.textContent =
                  '앱 로딩이 예상보다 오래 걸리고 있습니다. 잠시만 기다려주세요.';
              }
              error.style.display = 'block';
            }
          }
        }, 5000);

        // 최종 상태 확인 (7초 후)
        setTimeout(() => {
          if (!flutterInitialized) {
            console.error('7초 후에도 Flutter가 초기화되지 않음, 상태:', {
              loadingRemoved,
              sidebarInitialized,
              flutterInitialized,
              errorShown,
              initializationAttempts,
              initializationMethod,
            });

            if (initializationAttempts < MAX_INIT_ATTEMPTS) {
              // 마지막 시도
              initializeFlutter(true);
            }
          }

          // 마지막 사이드바 확인
          updateSidebars();
        }, 7000);
      });

      // 리소스 로드 오류 처리
      window.addEventListener(
        'error',
        function (event) {
          if (
            event.target &&
            (event.target.tagName === 'SCRIPT' ||
              event.target.tagName === 'LINK')
          ) {
            if (
              (event.target.src && event.target.src.includes('flutter')) ||
              (event.target.src && event.target.src.includes('main.dart.js'))
            ) {
              console.error('Flutter 리소스 로드 오류:', event);
              showError('Flutter 관련 리소스 로드 실패: ' + event.target.src);
            }
          }
        },
        true,
      );
    </script>
  </body>
</html>
