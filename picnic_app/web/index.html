<!DOCTYPE html>
<html>
  <head>
    <base href="$FLUTTER_BASE_HREF" />

    <meta charset="UTF-8" />
    <meta content="IE=Edge" http-equiv="X-UA-Compatible" />
    <meta name="description" content="Picnic" />

    <!-- iOS meta tags & icons -->
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black" />
    <meta name="apple-mobile-web-app-title" content="picnic_app" />
    <link rel="apple-touch-icon" href="icons/Icon-192.png" />

    <!-- Favicon -->
    <link rel="icon" type="image/png" href="favicon.png" />

    <title>picnic_app</title>
    <link rel="manifest" href="manifest.json" />

    <!-- 뷰포트 설정 -->
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <meta name="theme-color" content="#ffffff" />

    <!-- 
      ====================================================================
      ============ (1) Flutter 환경 설정 스크립트 추가 ====================
      ====================================================================
      flutter.js보다 먼저 _flutter.buildConfig 설정을 해줘야
      FlutterLoader.load() 호출 시 에러가 발생하지 않습니다.
    -->
    <script>
      // _flutter 객체가 없으면 생성
      window._flutter = window._flutter || {};

      // 최신 Flutter 웹 엔진에서 요구하는 빌드 설정
      // (BUILD_MODE, BUILD_NAME, BUILD_NUMBER, 등 필요 항목 자유롭게 추가 가능)
      window._flutter.buildConfig = {
        BUILD_MODE: 'release', // 예: release, debug
        BUILD_NAME: '1.0.0', // 앱 버전명
        BUILD_NUMBER: '1', // 빌드 번호
      };
    </script>

    <!-- 
      ====================================================================
      ============ (2) Flutter 로더 스크립트 로드 =========================
      ====================================================================
      defer를 사용하면 DOM 파싱 이후에 로드되므로, buildConfig가 먼저 선언된 상태를 보장합니다.
    -->
    <script src="flutter.js" defer></script>

    <!-- (선택) Next.js 리액트 라이브러리 예시 (사용하신다면 그대로 유지) -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>

    <style>
      html,
      body {
        height: 100%;
        margin: 0;
        padding: 0;
        width: 100%;
        overflow: hidden;
        background-color: #ffffff;
      }

      body {
        display: flex;
        justify-content: center;
        background-color: #ffffff;
        touch-action: auto; /* 터치 액션 활성화 */
      }

      .container {
        display: flex;
        max-width: 1300px;
        width: 100%;
        height: 100%;
        position: relative;
        background-color: #ffffff;
        padding: 0;
        margin: 0;
      }

      .sidebar-left,
      .sidebar-right {
        flex: 0 0 393px;
        width: 393px;
        height: 100%;
        display: block;
        box-sizing: border-box;
        margin: 0;
        padding: 0;
        background-color: #f8f9fa;
        z-index: 5;
      }

      .sidebar-left iframe,
      .sidebar-right iframe {
        width: 100%;
        height: 100%;
        border: none;
      }

      .app-container {
        flex: 0 0 393px;
        width: 393px;
        max-width: 393px;
        min-width: 393px;
        height: 100%;
        position: relative;
        overflow: hidden;
        z-index: 10;
        background-color: #ffffff;
        margin: 0;
        padding: 0;
      }

      flt-glass-pane,
      flt-scene-host,
      flt-semantics-host,
      flt-text-editing-host,
      canvas,
      #flutter-app-container > * {
        width: 393px !important;
        max-width: 393px !important;
        pointer-events: auto !important;
        touch-action: auto !important;
        background-color: #ffffff !important;
        margin: 0 !important;
        padding: 0 !important;
        box-sizing: border-box !important;
        position: absolute !important;
        left: 0 !important;
      }

      flt-glass-pane > .flutter-loader {
        width: 393px !important;
        left: 0 !important;
        right: 0 !important;
      }

      #splash {
        position: absolute;
        width: 100%;
        height: 100%;
        top: 0;
        left: 0;
        z-index: 2;
        background-color: #ffffff;
      }

      .center {
        margin: 0;
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
      }

      #flutter-error {
        display: none;
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background-color: rgba(255, 0, 0, 0.1);
        border: 1px solid red;
        padding: 20px;
        border-radius: 5px;
        color: red;
        font-family: sans-serif;
        text-align: center;
        max-width: 300px;
        z-index: 999;
      }

      .loading-indicator {
        width: 40px;
        height: 40px;
        margin: 15px auto;
        border: 3px solid rgba(0, 0, 0, 0.1);
        border-radius: 50%;
        border-top-color: #3498db;
        animation: spin 1s ease-in-out infinite;
      }

      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }

      @media (max-width: 843px) {
        .sidebar-left,
        .sidebar-right {
          display: none !important;
        }
        .container {
          justify-content: center;
        }
      }

      @media (min-width: 844px) and (max-width: 1236px) {
        .sidebar-left {
          display: block !important;
        }
        .sidebar-right {
          display: none !important;
        }
        .container {
          justify-content: center;
        }
      }

      @media (min-width: 1237px) {
        .sidebar-left,
        .sidebar-right {
          display: block !important;
        }
        .container {
          justify-content: center;
        }
      }
    </style>
  </head>

  <body>
    <div
      class="container"
      style="background-color: #ffffff; justify-content: center"
    >
      <!-- 좌측 사이드바 -->
      <div class="sidebar-left" id="sidebar-left">
        <iframe frameborder="0" title="Left Sidebar"></iframe>
      </div>

      <!-- 중앙 Flutter 앱 컨테이너 -->
      <div
        class="app-container"
        id="flutter-app-container"
        style="margin: 0; padding: 0"
      >
        <!-- 스플래시 화면 -->
        <picture id="splash">
          <source
            srcset="
              splash/img/light-1x.png 1x,
              splash/img/light-2x.png 2x,
              splash/img/light-3x.png 3x,
              splash/img/light-4x.png 4x
            "
            media="(prefers-color-scheme: light)"
          />
          <source
            srcset="
              splash/img/dark-1x.png 1x,
              splash/img/dark-2x.png 2x,
              splash/img/dark-3x.png 3x,
              splash/img/dark-4x.png 4x
            "
            media="(prefers-color-scheme: dark)"
          />
          <img
            class="center"
            aria-hidden="true"
            src="splash/img/light-1x.png"
            alt=""
          />
        </picture>
      </div>

      <!-- 우측 사이드바 -->
      <div class="sidebar-right" id="sidebar-right">
        <iframe frameborder="0" title="Right Sidebar"></iframe>
      </div>
    </div>

    <!-- 
      ====================================================================
      ============ (3) Flutter 메인 엔트리포인트(main.dart.js) 로드 =======
      ====================================================================
      ※ 아래 경로는 Flutter 빌드 결과물에 맞춰 수정하세요.
      ※ flutter.js가 엔트리포인트를 직접 불러올 수도 있으므로,
        원하는 방식대로 조절하셔도 됩니다.
    -->
    <script src="main.dart.js" type="application/javascript"></script>

    <script>
      // 전역 변수
      let splashRemoved = false;
      let sidebarInitialized = false;
      let flutterInitialized = false;

      // 스플래시 제거 함수
      function removeSplash() {
        if (splashRemoved) return;
        const splash = document.getElementById('splash');
        if (splash) splash.remove();
        splashRemoved = true;
        console.log('스플래시 화면 제거 완료');

        updateSidebars();
        fixFlutterElementsOnce();
      }

      // Flutter 요소 수정 함수 (한 번만 실행)
      function fixFlutterElementsOnce() {
        console.log('Flutter 요소 수정 시작...');
        const flutterElement = document.querySelector('flt-glass-pane');
        if (flutterElement) {
          console.log('Flutter 요소 발견, 스타일 적용 중...');
          flutterElement.style.width = '393px';
          flutterElement.style.maxWidth = '393px';
          flutterElement.style.pointerEvents = 'auto';
          flutterElement.style.touchAction = 'auto';
          flutterElement.style.backgroundColor = '#FFFFFF';
          flutterElement.style.margin = '0';
          flutterElement.style.padding = '0';
          flutterElement.style.left = '0';
          flutterElement.style.position = 'absolute';

          // 모든 자식 요소에도 터치 이벤트 활성화
          const allFlutterElements = flutterElement.querySelectorAll('*');
          allFlutterElements.forEach((el) => {
            if (el.style) {
              el.style.pointerEvents = 'auto';
              el.style.touchAction = 'auto';

              if (
                el.tagName &&
                (el.tagName.toLowerCase().includes('flt-') ||
                  el.tagName.toLowerCase() === 'canvas')
              ) {
                el.style.margin = '0';
                el.style.padding = '0';
                el.style.left = '0';
                if (el.style.position) {
                  el.style.position = 'absolute';
                }
              }
            }
          });
          console.log('Flutter 요소 스타일 적용 완료');
        }
      }

      // 주기적으로 Flutter 요소 스타일 재조정 (1초 간격)
      setInterval(() => {
        const flutterElement = document.querySelector('flt-glass-pane');
        if (flutterElement) {
          flutterElement.style.width = '393px';
          flutterElement.style.maxWidth = '393px';
          flutterElement.style.pointerEvents = 'auto';
          flutterElement.style.touchAction = 'auto';
          flutterElement.style.margin = '0';
          flutterElement.style.padding = '0';
          flutterElement.style.left = '0';
          flutterElement.style.position = 'absolute';

          // 로딩바 크기 조정
          const loaderBar = document.querySelector('.flutter-loader');
          if (loaderBar) {
            loaderBar.style.width = '393px';
            loaderBar.style.left = '0';
            loaderBar.style.right = '0';
            loaderBar.style.margin = '0';
            loaderBar.style.padding = '0';
          }

          // 주요 캔버스 요소 조정
          const canvasElements = document.querySelectorAll('canvas');
          canvasElements.forEach((canvas) => {
            canvas.style.width = '393px';
            canvas.style.maxWidth = '393px';
            canvas.style.margin = '0';
            canvas.style.padding = '0';
            canvas.style.left = '0';
            canvas.style.position = 'absolute';
          });
        }
      }, 1000);

      // Flutter 초기화 완료 콜백
      function onFlutterInited() {
        console.log('Flutter 초기화 완료');
        flutterInitialized = true;

        setTimeout(() => {
          removeSplash();
        }, 500);

        fixFlutterElementsOnce();
      }

      // 디바운스 함수
      function debounce(func, wait) {
        let timeout;
        return function () {
          clearTimeout(timeout);
          timeout = setTimeout(() => func.apply(this, arguments), wait);
        };
      }

      // 사이드바 업데이트 함수
      function updateSidebars() {
        const width = window.innerWidth;
        const leftSidebar = document.getElementById('sidebar-left');
        const rightSidebar = document.getElementById('sidebar-right');
        if (!leftSidebar || !rightSidebar) return;

        if (width >= 1237) {
          leftSidebar.style.display = 'block';
          rightSidebar.style.display = 'block';
        } else if (width >= 844) {
          leftSidebar.style.display = 'block';
          rightSidebar.style.display = 'none';
        } else {
          leftSidebar.style.display = 'none';
          rightSidebar.style.display = 'none';
        }
      }

      // 사이드바 초기화
      function initSidebars() {
        if (sidebarInitialized) return;

        const isLocalhost =
          window.location.hostname === 'localhost' ||
          window.location.hostname === '127.0.0.1';

        const leftSidebarSrc = isLocalhost
          ? 'http://localhost:3001/left-sidebar'
          : 'https://sidebar.picnic.fan/left-sidebar';
        const rightSidebarSrc = isLocalhost
          ? 'http://localhost:3001/right-sidebar'
          : 'https://sidebar.picnic.fan/right-sidebar';

        const leftIframe = document.querySelector('#sidebar-left iframe');
        const rightIframe = document.querySelector('#sidebar-right iframe');

        if (leftIframe && rightIframe) {
          leftIframe.src = leftSidebarSrc;
          rightIframe.src = rightSidebarSrc;
          sidebarInitialized = true;
          updateSidebars();
        }
      }

      // 리사이즈 시 사이드바 업데이트 (디바운스)
      const debouncedResize = debounce(updateSidebars, 250);

      // DOMContentLoaded 이벤트
      document.addEventListener('DOMContentLoaded', () => {
        console.log('DOM 로드 완료');

        // 사이드바 초기화
        initSidebars();
        // 리사이즈 이벤트 등록
        window.addEventListener('resize', debouncedResize);

        // =================================================================
        // (4) Flutter 웹 엔트리포인트 로드
        // =================================================================
        // _flutter.loader가 정상적으로 있는지 확인 후 로드
        if (window._flutter && window._flutter.loader) {
          // entrypointUrl을 지정하지 않으면, 기본값은 "main.dart.js"를 사용
          // 이미 상단에서 <script src="main.dart.js">를 쓴다면 생략 가능
          // 여기서는 명시적으로 entrypointUrl을 넣어 예시로 보여줍니다.
          window._flutter.loader
            .loadEntrypoint({
              entrypointUrl: 'main.dart.js',
              onEntrypointLoaded: (engineInitializer) => {
                // Flutter 엔진 초기화
                engineInitializer
                  .initializeEngine({
                    hostElement: document.getElementById(
                      'flutter-app-container',
                    ),
                    renderer: 'auto', // auto | html | canvaskit
                    canvasKitBaseUrl: '/canvaskit/',
                    width: 393,
                  })
                  .then((appRunner) => {
                    // 실제 Flutter 앱 실행
                    appRunner.runApp();
                    onFlutterInited();
                  });
              },
            })
            .catch((err) => {
              console.error('Flutter 엔트리포인트 로딩 에러:', err);
            });
        } else {
          console.error(
            'window._flutter.loader가 존재하지 않습니다. flutter.js 로드 여부 확인 필요.',
          );
        }
      });
    </script>
  </body>
</html>
